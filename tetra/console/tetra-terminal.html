<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tetra Terminal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --bg-tertiary: #2d2d2d;
            --text-primary: #d4d4d4;
            --text-secondary: #808080;
            --accent: #00d4ff;
            --success: #89d185;
            --warning: #cca700;
            --error: #f14c4c;
            --border: #3c3c3c;
        }

        html, body {
            height: 100%;
            background: var(--bg-primary);
            overflow: hidden;
            font-family: system-ui, -apple-system, sans-serif;
        }

        /* ============================================
           IFRAME MODE - Bare terminal only
           ============================================ */
        body.iframe-mode {
            padding: 0;
        }

        body.iframe-mode #terminal-wrapper {
            height: 100%;
            width: 100%;
        }

        body.iframe-mode #standalone-chrome { display: none; }
        body.iframe-mode #terminal { height: 100%; }

        /* ============================================
           STANDALONE MODE - Full console UI
           ============================================ */
        body.standalone-mode {
            display: flex;
            flex-direction: column;
        }

        body.standalone-mode #standalone-chrome {
            display: flex;
            flex-direction: column;
        }

        /* Header Bar */
        .header-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 40px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 12px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
        }

        .connection-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .connection-indicator .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
        }

        .connection-indicator.connected .dot { background: var(--success); }
        .connection-indicator.connecting .dot { background: var(--warning); animation: pulse 1s infinite; }
        .connection-indicator.error .dot { background: var(--error); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .mode-toggle button {
            padding: 4px 12px;
            font-size: 11px;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-toggle button:hover {
            color: var(--text-primary);
        }

        .mode-toggle button.active {
            background: var(--accent);
            color: var(--bg-primary);
        }

        /* SSH Config Panel */
        .ssh-config {
            display: none;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 12px;
        }

        .ssh-config.visible { display: block; }

        .ssh-config-grid {
            display: grid;
            grid-template-columns: auto 1fr auto 1fr auto;
            gap: 8px;
            align-items: center;
            font-size: 12px;
        }

        .ssh-config label {
            color: var(--text-secondary);
        }

        .ssh-config input {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 4px 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        .ssh-config input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .ssh-config button {
            padding: 4px 12px;
            background: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
        }

        .ssh-config button:hover {
            filter: brightness(1.1);
        }

        /* Terminal Area */
        #terminal-wrapper {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        #terminal {
            width: 100%;
            height: calc(100% - 40px); /* Account for header in standalone */
        }

        body.standalone-mode #terminal {
            height: 100%;
        }

        .xterm { height: 100% !important; }

        /* Status Bar (standalone only) */
        .status-bar {
            height: 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .status-bar .status-left {
            display: flex;
            gap: 16px;
        }

        .status-bar .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
    </style>
</head>
<body>
    <!-- Standalone Chrome (hidden in iframe mode) -->
    <div id="standalone-chrome">
        <div class="header-bar">
            <div class="header-left">
                <span class="header-title">Tetra Terminal</span>
                <div class="connection-indicator" id="connectionStatus">
                    <span class="dot"></span>
                    <span class="text">Disconnected</span>
                </div>
            </div>
            <div class="header-controls">
                <div class="mode-toggle">
                    <button id="btn-local" class="active">Local</button>
                    <button id="btn-ssh">SSH</button>
                </div>
            </div>
        </div>

        <div class="ssh-config" id="sshConfig">
            <div class="ssh-config-grid">
                <label>Host:</label>
                <input type="text" id="ssh-host" placeholder="example.com">
                <label>User:</label>
                <input type="text" id="ssh-user" placeholder="username">
                <button id="btn-connect-ssh">Connect</button>
            </div>
        </div>
    </div>

    <div id="terminal-wrapper">
        <div id="terminal"></div>
    </div>

    <div id="standalone-chrome-footer">
        <div class="status-bar" id="statusBar">
            <div class="status-left">
                <span class="status-item" id="modeStatus">Mode: Local</span>
                <span class="status-item" id="sizeStatus">80x24</span>
            </div>
            <span id="serverStatus">tetra-4444</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script>
    (function() {
        'use strict';

        // =================================================================
        // IFRAME DETECTION (like plenith pattern)
        // =================================================================
        const isIframe = window.parent !== window;
        const params = new URLSearchParams(window.location.search);

        // Apply mode class to body
        document.body.classList.add(isIframe ? 'iframe-mode' : 'standalone-mode');

        // Hide footer in iframe mode
        if (isIframe) {
            const footer = document.getElementById('standalone-chrome-footer');
            if (footer) footer.style.display = 'none';
        }

        // =================================================================
        // CONFIGURATION
        // =================================================================
        const config = {
            mode: params.get('mode') || 'local',
            host: params.get('host') || window.location.hostname || 'localhost',
            port: parseInt(params.get('port') || '4444'),
            sshHost: params.get('sshHost') || '',
            sshUser: params.get('sshUser') || '',
            sshToken: params.get('sshToken') || '',
            autoConnect: params.get('autoConnect') !== 'false'
        };

        // =================================================================
        // TERMINAL SETUP
        // =================================================================
        const term = new Terminal({
            fontFamily: '"JetBrains Mono", "SF Mono", Monaco, "Fira Code", monospace',
            fontSize: 14,
            lineHeight: 1.2,
            cursorBlink: true,
            cursorStyle: 'block',
            theme: {
                background: '#1e1e1e',
                foreground: '#d4d4d4',
                cursor: '#d4d4d4',
                cursorAccent: '#1e1e1e',
                selectionBackground: '#264f78',
                black: '#1e1e1e',
                red: '#f14c4c',
                green: '#89d185',
                yellow: '#cca700',
                blue: '#569cd6',
                magenta: '#c586c0',
                cyan: '#4ec9b0',
                white: '#d4d4d4',
                brightBlack: '#808080',
                brightRed: '#f14c4c',
                brightGreen: '#89d185',
                brightYellow: '#cca700',
                brightBlue: '#569cd6',
                brightMagenta: '#c586c0',
                brightCyan: '#4ec9b0',
                brightWhite: '#ffffff'
            }
        });

        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal'));

        // Delay fit to ensure container is sized
        setTimeout(() => fitAddon.fit(), 50);

        // =================================================================
        // CONNECTION STATE
        // =================================================================
        let socket = null;
        let sshWs = null;
        let connectionMode = config.mode;
        let isConnected = false;

        // =================================================================
        // UI HELPERS (standalone only)
        // =================================================================
        function updateConnectionUI(state, message) {
            if (isIframe) return;

            const indicator = document.getElementById('connectionStatus');
            const text = indicator.querySelector('.text');

            indicator.className = 'connection-indicator ' + state;
            text.textContent = message;

            // Update mode status
            const modeStatus = document.getElementById('modeStatus');
            if (modeStatus) {
                modeStatus.textContent = `Mode: ${connectionMode === 'local' ? 'Local' : 'SSH'}`;
            }
        }

        function updateSizeStatus() {
            if (isIframe) return;
            const sizeStatus = document.getElementById('sizeStatus');
            if (sizeStatus) {
                sizeStatus.textContent = `${term.cols}x${term.rows}`;
            }
        }

        // =================================================================
        // LOCAL CONNECTION (Socket.IO)
        // =================================================================
        function connectLocal() {
            if (socket && socket.connected) return;

            updateConnectionUI('connecting', 'Connecting...');

            const serverUrl = `http://${config.host}:${config.port}`;

            socket = io(serverUrl, {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });

            socket.on('connect', () => {
                isConnected = true;
                connectionMode = 'local';
                updateConnectionUI('connected', `Connected to ${config.host}:${config.port}`);
                term.focus();

                // Notify parent if in iframe
                notifyParent('connected', { mode: 'local', host: config.host, port: config.port });
            });

            socket.on('output', (data) => {
                term.write(data);
                notifyParent('output', { data });
            });

            socket.on('disconnect', () => {
                isConnected = false;
                updateConnectionUI('error', 'Disconnected');
                notifyParent('disconnected', { mode: 'local' });
            });

            socket.on('connect_error', (err) => {
                updateConnectionUI('error', `Error: ${err.message}`);
                notifyParent('error', { message: err.message });
            });
        }

        // =================================================================
        // SSH CONNECTION (WebSocket)
        // =================================================================
        function connectSSH(host, user, token) {
            if (sshWs && sshWs.readyState === WebSocket.OPEN) return;

            updateConnectionUI('connecting', `Connecting to ${user}@${host}...`);

            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${config.host}:${config.port}/ssh-bridge`;

            sshWs = new WebSocket(wsUrl);

            sshWs.onopen = () => {
                sshWs.send(JSON.stringify({
                    type: 'auth',
                    token: token || config.sshToken,
                    host: host || config.sshHost,
                    username: user || config.sshUser
                }));
            };

            sshWs.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    handleSSHMessage(msg);
                } catch (e) {
                    term.write(event.data);
                }
            };

            sshWs.onerror = () => {
                updateConnectionUI('error', 'SSH connection error');
                notifyParent('error', { message: 'SSH connection error' });
            };

            sshWs.onclose = () => {
                isConnected = false;
                updateConnectionUI('error', 'SSH disconnected');
                notifyParent('disconnected', { mode: 'ssh' });
            };
        }

        function handleSSHMessage(msg) {
            switch (msg.type) {
                case 'connected':
                    isConnected = true;
                    connectionMode = 'ssh';
                    updateConnectionUI('connected', `SSH: ${config.sshUser}@${config.sshHost}`);
                    term.focus();
                    notifyParent('connected', { mode: 'ssh', host: config.sshHost, user: config.sshUser });
                    break;
                case 'data':
                case 'output':
                    term.write(msg.data);
                    notifyParent('output', { data: msg.data });
                    break;
                case 'error':
                    updateConnectionUI('error', msg.message || 'SSH error');
                    notifyParent('error', { message: msg.message });
                    break;
                case 'close':
                    isConnected = false;
                    updateConnectionUI('error', 'SSH session ended');
                    break;
            }
        }

        function disconnect() {
            if (socket && socket.connected) {
                socket.disconnect();
                socket = null;
            }
            if (sshWs && sshWs.readyState === WebSocket.OPEN) {
                sshWs.send(JSON.stringify({ type: 'disconnect' }));
                sshWs.close();
                sshWs = null;
            }
            isConnected = false;
            updateConnectionUI('', 'Disconnected');
            notifyParent('disconnected', {});
        }

        // =================================================================
        // TERMINAL INPUT
        // =================================================================
        term.onData((data) => {
            if (connectionMode === 'local' && socket && socket.connected) {
                socket.emit('input', data);
            } else if (connectionMode === 'ssh' && sshWs && sshWs.readyState === WebSocket.OPEN) {
                sshWs.send(JSON.stringify({ type: 'input', data }));
            }
            // Notify parent of user input
            notifyParent('input', { data });
        });

        // =================================================================
        // PARENT WINDOW COMMUNICATION (iframe mode)
        // =================================================================
        function notifyParent(type, data = {}) {
            if (!isIframe) return;
            window.parent.postMessage({
                source: 'tetra-terminal',
                type,
                ...data
            }, '*');
        }

        // Listen for commands from parent
        window.addEventListener('message', (event) => {
            const msg = event.data;
            if (!msg || msg.source === 'tetra-terminal') return; // Ignore own messages

            switch (msg.type) {
                case 'write':
                    term.write(msg.data || '');
                    break;
                case 'writeln':
                    term.writeln(msg.data || '');
                    break;
                case 'clear':
                    term.clear();
                    break;
                case 'focus':
                    term.focus();
                    break;
                case 'resize':
                    fitAddon.fit();
                    break;
                case 'execute':
                    // Execute command in terminal
                    const cmd = msg.command || msg.data || '';
                    if (connectionMode === 'local' && socket && socket.connected) {
                        socket.emit('input', cmd + '\r');
                    } else if (connectionMode === 'ssh' && sshWs && sshWs.readyState === WebSocket.OPEN) {
                        sshWs.send(JSON.stringify({ type: 'input', data: cmd + '\r' }));
                    }
                    break;
                case 'connect':
                    if (msg.mode === 'ssh') {
                        config.sshHost = msg.host || config.sshHost;
                        config.sshUser = msg.user || config.sshUser;
                        config.sshToken = msg.token || config.sshToken;
                        connectSSH();
                    } else {
                        connectLocal();
                    }
                    break;
                case 'disconnect':
                    disconnect();
                    break;
                case 'setConfig':
                    Object.assign(config, msg.config || {});
                    break;
            }
        });

        // Notify parent we're ready (plenith pattern)
        if (isIframe) {
            notifyParent('ready', {
                cols: term.cols,
                rows: term.rows,
                config: { mode: connectionMode }
            });
        }

        // =================================================================
        // STANDALONE UI EVENT HANDLERS
        // =================================================================
        if (!isIframe) {
            const btnLocal = document.getElementById('btn-local');
            const btnSSH = document.getElementById('btn-ssh');
            const sshConfig = document.getElementById('sshConfig');
            const btnConnectSSH = document.getElementById('btn-connect-ssh');

            btnLocal?.addEventListener('click', () => {
                btnLocal.classList.add('active');
                btnSSH.classList.remove('active');
                sshConfig.classList.remove('visible');
                disconnect();
                connectionMode = 'local';
                connectLocal();
            });

            btnSSH?.addEventListener('click', () => {
                btnSSH.classList.add('active');
                btnLocal.classList.remove('active');
                sshConfig.classList.add('visible');
                disconnect();
                connectionMode = 'ssh';
            });

            btnConnectSSH?.addEventListener('click', () => {
                const host = document.getElementById('ssh-host').value;
                const user = document.getElementById('ssh-user').value;
                if (host && user) {
                    config.sshHost = host;
                    config.sshUser = user;
                    connectSSH(host, user);
                }
            });
        }

        // =================================================================
        // RESIZE HANDLING
        // =================================================================
        window.addEventListener('resize', () => {
            fitAddon.fit();
            updateSizeStatus();

            // Send resize to server
            if (connectionMode === 'ssh' && sshWs && sshWs.readyState === WebSocket.OPEN) {
                sshWs.send(JSON.stringify({
                    type: 'resize',
                    cols: term.cols,
                    rows: term.rows
                }));
            }

            notifyParent('resize', { cols: term.cols, rows: term.rows });
        });

        // =================================================================
        // EXPOSE API
        // =================================================================
        window.tetraTerminal = {
            term,
            fitAddon,
            isIframe,
            config,

            // Terminal operations
            write: (data) => term.write(data),
            writeln: (data) => term.writeln(data),
            clear: () => term.clear(),
            focus: () => term.focus(),
            fit: () => fitAddon.fit(),

            // Connection operations
            connect: (mode, options = {}) => {
                if (mode === 'ssh') {
                    Object.assign(config, options);
                    connectSSH(options.host, options.user, options.token);
                } else {
                    connectLocal();
                }
            },
            disconnect,
            isConnected: () => isConnected,
            getMode: () => connectionMode,

            // Execute command
            execute: (cmd) => {
                if (connectionMode === 'local' && socket && socket.connected) {
                    socket.emit('input', cmd + '\r');
                } else if (connectionMode === 'ssh' && sshWs && sshWs.readyState === WebSocket.OPEN) {
                    sshWs.send(JSON.stringify({ type: 'input', data: cmd + '\r' }));
                }
            }
        };

        // =================================================================
        // AUTO-CONNECT
        // =================================================================
        if (config.autoConnect) {
            if (config.mode === 'ssh' && config.sshHost && config.sshUser) {
                connectSSH();
            } else {
                connectLocal();
            }
        }

        // Initial size update
        updateSizeStatus();

    })();
    </script>
</body>
</html>
