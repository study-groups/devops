<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PT100 MERIDIAN</title>
  <style>
    @font-face {
      font-family: 'Fira Code';
      src: url('fonts/FiraCode-Regular.woff2') format('woff2');
      font-weight: 400;
      font-style: normal;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #0a0a0a;
      color: #0f0;
      font-family: 'Fira Code', 'Consolas', monospace;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* CRT Scanline effect */
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: repeating-linear-gradient(
        0deg,
        rgba(0,0,0,0.15) 0px,
        rgba(0,0,0,0.15) 1px,
        transparent 1px,
        transparent 2px
      );
      pointer-events: none;
      z-index: 1000;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .header {
      text-align: center;
      padding: 20px 0;
      border-bottom: 2px solid #0f0;
      margin-bottom: 20px;
    }

    .logo {
      font-size: 32px;
      font-weight: bold;
      letter-spacing: 8px;
      text-shadow: 0 0 10px #0f0, 0 0 20px #0f0;
      animation: glow 2s ease-in-out infinite alternate;
    }

    .subtitle {
      color: #0a0;
      font-size: 12px;
      letter-spacing: 4px;
      margin-top: 5px;
    }

    @keyframes glow {
      from { text-shadow: 0 0 10px #0f0, 0 0 20px #0f0; }
      to { text-shadow: 0 0 15px #0f0, 0 0 30px #0f0, 0 0 40px #0f0; }
    }

    /* Status Bar */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #111;
      border: 1px solid #333;
      padding: 10px 15px;
      margin-bottom: 15px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #f00;
      box-shadow: 0 0 5px #f00;
    }

    .dot.online {
      background: #0f0;
      box-shadow: 0 0 5px #0f0;
    }

    .monogram {
      background: #0f0;
      color: #000;
      padding: 2px 10px;
      font-weight: bold;
      font-size: 14px;
    }

    /* Panels */
    .panel {
      background: #0a0a0a;
      border: 1px solid #0f0;
      margin-bottom: 15px;
    }

    .panel-header {
      background: #0f0;
      color: #000;
      padding: 8px 15px;
      font-weight: bold;
      font-size: 12px;
      letter-spacing: 2px;
    }

    .panel-body {
      padding: 15px;
    }

    /* Game Grid */
    .game-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }

    .game-btn {
      background: #111;
      border: 1px solid #333;
      color: #0f0;
      padding: 15px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      font-size: 12px;
    }

    .game-btn:hover {
      border-color: #0f0;
      background: #1a1a1a;
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
    }

    .game-btn.selected {
      border-color: #0f0;
      background: #0f0;
      color: #000;
    }

    .game-btn .name {
      font-weight: bold;
      font-size: 14px;
      display: block;
      margin-bottom: 5px;
    }

    .game-btn .players {
      color: #888;
      font-size: 10px;
    }

    .game-btn.selected .players {
      color: #333;
    }

    /* Match List */
    .match-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .match-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #111;
      border: 1px solid #333;
      padding: 10px 15px;
      margin-bottom: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .match-item:hover {
      border-color: #0f0;
    }

    .match-item.current {
      border-color: #ff0;
      background: #1a1a00;
    }

    .match-info {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .match-game {
      color: #0ff;
      font-weight: bold;
    }

    .match-players {
      color: #ff0;
    }

    .match-state {
      color: #888;
      font-size: 11px;
    }

    .match-id {
      color: #444;
      font-size: 10px;
    }

    /* Buttons */
    .btn {
      background: #0f0;
      color: #000;
      border: none;
      padding: 10px 20px;
      font-family: inherit;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover {
      background: #0a0;
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
    }

    .btn:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn.danger {
      background: #f00;
      color: #fff;
    }

    .btn.danger:hover {
      background: #a00;
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
    }

    .btn-small {
      padding: 5px 10px;
      font-size: 11px;
    }

    /* Actions */
    .actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      padding: 15px;
      border-top: 1px solid #333;
    }

    /* Input */
    .input-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .input-group label {
      color: #888;
      font-size: 11px;
      min-width: 50px;
    }

    input[type="text"] {
      background: #111;
      border: 1px solid #333;
      color: #0f0;
      padding: 8px 12px;
      font-family: inherit;
      font-size: 14px;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #0f0;
    }

    /* Volume Slider */
    .volume-control {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 15px;
      background: #111;
      border-top: 1px solid #333;
    }

    .volume-control label {
      color: #888;
      font-size: 11px;
      min-width: 50px;
    }

    input[type="range"] {
      -webkit-appearance: none;
      background: #333;
      height: 4px;
      flex: 1;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: #0f0;
      border-radius: 50%;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      box-shadow: 0 0 10px #0f0;
    }

    .volume-value {
      color: #0f0;
      font-size: 12px;
      min-width: 35px;
      text-align: right;
    }

    /* Custom Scrollbars */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #111;
      border: 1px solid #333;
    }

    ::-webkit-scrollbar-thumb {
      background: #0f0;
      border-radius: 0;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #0a0;
      box-shadow: 0 0 5px #0f0;
    }

    ::-webkit-scrollbar-corner {
      background: #111;
    }

    /* Terminal */
    .terminal {
      background: #000;
      border: 1px solid #333;
      padding: 5px;
      min-height: 200px;
      overflow: auto;
      font-size: 11px;
      line-height: 1.2;
    }

    .terminal pre {
      margin: 0;
      white-space: pre;
      font-family: 'Fira Code', Consolas, Monaco, monospace;
    }

    /* Game display - compact monospace */
    .terminal pre.term-game {
      font-size: 11px;
      line-height: 1.1;
      letter-spacing: 0;
    }

    .term-sys { color: #888; }
    .term-in { color: #0ff; }
    .term-out { color: #ff0; }
    .term-err { color: #f00; }
    .term-game { color: #0f0; }

    /* Empty state */
    .empty {
      color: #444;
      text-align: center;
      padding: 20px;
      font-size: 12px;
    }

    /* Current Match Panel */
    .current-match {
      display: none;
      background: #0a1a0a;
      border: 2px solid #0f0;
    }

    .current-match.active {
      display: block;
    }

    .match-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: #0f0;
      color: #000;
    }

    .match-header .title {
      font-weight: bold;
    }

    .match-details {
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 20px;
      color: #333;
      font-size: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">PT100 MERIDIAN</div>
      <div class="subtitle">MULTIPLAYER GAME SYSTEM</div>
    </div>

    <div class="status-bar">
      <div class="status-indicator">
        <div class="dot" id="statusDot"></div>
        <span id="statusText">OFFLINE</span>
      </div>
      <div>
        <span class="monogram" id="playerMonogram" style="display:none">---</span>
      </div>
    </div>

    <!-- Select Game -->
    <div class="panel">
      <div class="panel-header">SELECT GAME</div>
      <div class="panel-body">
        <div class="game-grid">
          <div class="game-btn selected" data-game="trax" onclick="selectGame('trax')">
            <span class="name">TRAX</span>
            <span class="players">1-8 players</span>
          </div>
          <div class="game-btn" data-game="quadrapole" onclick="selectGame('quadrapole')">
            <span class="name">QUADRAPOLE</span>
            <span class="players">1-4 players</span>
          </div>
          <div class="game-btn" data-game="formant" onclick="selectGame('formant')">
            <span class="name">FORMANT</span>
            <span class="players">1-8 players</span>
          </div>
          <div class="game-btn" data-game="magnetar" onclick="selectGame('magnetar')">
            <span class="name">MAGNETAR</span>
            <span class="players">1-2 players</span>
          </div>
        </div>
        <div class="input-group" style="margin-top: 15px;">
          <label>NAME:</label>
          <input type="text" id="playerName" value="PLAYER" maxlength="12" style="text-transform: uppercase;">
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="createBtn" onclick="createMatch()" disabled>CREATE MATCH</button>
      </div>
    </div>

    <!-- Active Matches -->
    <div class="panel">
      <div class="panel-header">
        ACTIVE MATCHES
        <button class="btn btn-small" onclick="refreshMatches()" style="float:right;margin-top:-3px;">REFRESH</button>
      </div>
      <div class="panel-body">
        <div id="matchList" class="match-list">
          <div class="empty">Connecting to server...</div>
        </div>
      </div>
    </div>

    <!-- Current Match -->
    <div class="panel current-match" id="currentMatchPanel">
      <div class="match-header">
        <span class="title">MATCH <span id="currentMatchId">0x00</span></span>
        <span id="currentGameType">TRAX</span>
      </div>
      <div class="match-details">
        <div>
          <div>State: <span id="matchState">LOBBY</span></div>
          <div>Players: <span id="matchPlayerCount">1/8</span></div>
        </div>
        <div>
          <button class="btn" id="startBtn" onclick="startMatch()">START GAME</button>
          <button class="btn btn-small danger" onclick="leaveMatch()">LEAVE</button>
        </div>
      </div>
      <div class="volume-control">
        <label>VOLUME:</label>
        <input type="range" id="volumeSlider" min="0" max="100" value="80" oninput="setVolume(this.value)">
        <span class="volume-value" id="volumeValue">80%</span>
      </div>
    </div>

    <!-- Game Terminal -->
    <div class="panel" id="terminalPanel" style="display:none;">
      <div class="panel-header">GAME OUTPUT</div>
      <div class="panel-body" style="padding:0;">
        <div class="terminal" id="gameTerminal"></div>
      </div>
    </div>

    <!-- Log -->
    <div class="panel">
      <div class="panel-header">SYSTEM LOG</div>
      <div class="panel-body" style="padding:0;">
        <div class="terminal" id="log" style="height:150px;"></div>
      </div>
    </div>

    <div class="footer">
      PT100 MERIDIAN v0.1 | QUASAR SERVER
    </div>
  </div>

<script>
// State
let ws = null;
let playerId = null;
let monogram = null;
let currentMatch = null;
let selectedGame = 'trax';
let heartbeatInterval = null;
let refreshInterval = null;
let gameVolume = 80;

// Volume control
function setVolume(value) {
  gameVolume = parseInt(value);
  document.getElementById('volumeValue').textContent = gameVolume + '%';
  // Send volume to server
  send({ t: 'sound.volume', volume: gameVolume / 100 });
}

// Logging
function log(msg, type = 'sys') {
  const el = document.getElementById('log');
  const time = new Date().toLocaleTimeString('en-US', { hour12: false });
  const line = document.createElement('div');
  line.className = 'term-' + type;
  line.textContent = `[${time}] ${msg}`;
  el.appendChild(line);
  el.scrollTop = el.scrollHeight;
}

function gameLog(content) {
  const el = document.getElementById('gameTerminal');
  const pre = document.createElement('pre');
  pre.className = 'term-game';
  pre.textContent = content;
  el.appendChild(pre);
  el.scrollTop = el.scrollHeight;
}

// UI Updates
function updateStatus(online) {
  document.getElementById('statusDot').className = 'dot' + (online ? ' online' : '');
  document.getElementById('statusText').textContent = online ? 'ONLINE' : 'OFFLINE';
  document.getElementById('createBtn').disabled = !online;
}

function updateMonogram() {
  const el = document.getElementById('playerMonogram');
  if (monogram) {
    el.textContent = monogram;
    el.style.display = 'inline';
  } else {
    el.style.display = 'none';
  }
}

function updateMatchPanel() {
  const panel = document.getElementById('currentMatchPanel');
  if (currentMatch) {
    panel.classList.add('active');
    document.getElementById('currentMatchId').textContent = currentMatch.id;
    document.getElementById('currentGameType').textContent = currentMatch.gameType.toUpperCase();
    document.getElementById('matchState').textContent = currentMatch.state.toUpperCase();
    document.getElementById('matchPlayerCount').textContent = `${currentMatch.playerCount}/${currentMatch.maxPlayers}`;
  } else {
    panel.classList.remove('active');
  }
}

function selectGame(game) {
  selectedGame = game;
  document.querySelectorAll('.game-btn').forEach(btn => {
    btn.classList.toggle('selected', btn.dataset.game === game);
  });
}

// WebSocket
function connect() {
  // Always use port 1985 for QUASAR WebSocket
  const wsUrl = `ws://${location.hostname || 'localhost'}:1985/ws`;
  log(`Connecting to ${wsUrl}...`);

  ws = new WebSocket(wsUrl);

  ws.onopen = () => {
    log('Connected to PT100 MERIDIAN', 'sys');
    updateStatus(true);
    refreshMatches();
    refreshInterval = setInterval(refreshMatches, 3000);
    heartbeatInterval = setInterval(() => {
      if (ws?.readyState === WebSocket.OPEN && playerId) {
        send({ t: 'match.heartbeat' });
      }
    }, 10000);
  };

  ws.onclose = () => {
    log('Disconnected', 'err');
    updateStatus(false);
    playerId = null;
    monogram = null;
    currentMatch = null;
    updateMonogram();
    updateMatchPanel();
    clearInterval(heartbeatInterval);
    clearInterval(refreshInterval);
    // Reconnect after 2 seconds
    setTimeout(connect, 2000);
  };

  ws.onerror = () => log('Connection error', 'err');

  ws.onmessage = (e) => {
    const data = JSON.parse(e.data);
    if (data.t !== 'heartbeat.ack' && data.t !== 'frame') {
      log(`<< ${data.t}`, 'in');
    }
    handleMessage(data);
  };
}

function handleMessage(data) {
  switch (data.t) {
    case 'lobby.joined':
      playerId = data.playerId;
      monogram = data.monogram;
      log(`Assigned ID: ${monogram}`);
      updateMonogram();
      break;

    case 'match.created':
      currentMatch = {
        id: data.matchId,
        state: 'lobby',
        gameType: data.gameType,
        playerCount: data.players?.length || 1,
        maxPlayers: 8
      };
      log(`Match created: ${data.matchId}`);
      updateMatchPanel();
      refreshMatches();
      break;

    case 'match.joined':
      currentMatch = {
        id: data.matchId,
        state: data.state || 'lobby',
        gameType: data.gameType,
        playerCount: data.playerCount || 1,
        maxPlayers: data.maxPlayers || 8
      };
      log(`Joined match: ${data.matchId}`);
      updateMatchPanel();
      break;

    case 'match.started':
      if (currentMatch) {
        currentMatch.state = 'playing';
        log('Match started! Launching game...');
        updateMatchPanel();
        showGameTerminal();
        // Request game bridge spawn
        send({ t: 'bridge.spawn', game: currentMatch.gameType, channel: 0 });
      }
      break;

    case 'bridge.ready':
      log(`Game bridge ready: ${data.game}`);
      break;

    case 'bridge.error':
      log(`Bridge error: ${data.error}`, 'err');
      break;

    case 'frame':
      // Game frame received - display in terminal
      if (data.display) {
        const el = document.getElementById('gameTerminal');
        el.innerHTML = `<pre class="term-game">${data.display}</pre>`;
      }
      break;

    case 'match.ended':
      log(`Match ended: ${data.reason}`);
      currentMatch = null;
      updateMatchPanel();
      hideGameTerminal();
      refreshMatches();
      break;

    case 'player.joined':
      log(`${data.player?.monogram || 'Player'} joined`);
      if (currentMatch) currentMatch.playerCount++;
      updateMatchPanel();
      break;

    case 'player.left':
      log(`${data.player?.monogram || 'Player'} left`);
      if (currentMatch) currentMatch.playerCount--;
      updateMatchPanel();
      break;

    case 'error':
      log(`Error: ${data.error}`, 'err');
      break;

    case 'sync':
      log('Synchronized with server');
      break;
  }
}

function send(msg) {
  if (ws?.readyState === WebSocket.OPEN) {
    log(`>> ${msg.t}`, 'out');
    ws.send(JSON.stringify(msg));
  }
}

// Match Actions
function createMatch() {
  const name = document.getElementById('playerName').value.toUpperCase() || 'PLAYER';
  send({
    t: 'lobby.join',
    gameType: selectedGame,
    name: name,
    createImmediate: true
  });
}

function joinMatch(matchId) {
  const name = document.getElementById('playerName').value.toUpperCase() || 'PLAYER';
  send({
    t: 'match.join',
    matchId: matchId,
    name: name
  });
}

function startMatch() {
  if (!currentMatch) return;
  send({ t: 'match.start', matchId: currentMatch.id });
}

function leaveMatch() {
  send({ t: 'match.leave' });
  currentMatch = null;
  updateMatchPanel();
  hideGameTerminal();
}

function showGameTerminal() {
  document.getElementById('terminalPanel').style.display = 'block';
  document.getElementById('gameTerminal').innerHTML = '<div class="term-sys">Initializing game...</div>';
}

function hideGameTerminal() {
  document.getElementById('terminalPanel').style.display = 'none';
}

async function refreshMatches() {
  try {
    const res = await fetch('/api/matches');
    const data = await res.json();
    const list = document.getElementById('matchList');

    if (!data.matches || data.matches.length === 0) {
      list.innerHTML = '<div class="empty">No active matches. Create one!</div>';
      return;
    }

    list.innerHTML = data.matches.map(m => {
      const isCurrent = currentMatch?.id === m.id;
      const canJoin = m.joinable && !isCurrent;

      return `
        <div class="match-item ${isCurrent ? 'current' : ''}" ${canJoin ? `onclick="joinMatch('${m.id}')"` : ''}>
          <div class="match-info">
            <span class="match-game">${m.gameType.toUpperCase()}</span>
            <span class="match-players">${m.players}/${m.maxPlayers}</span>
            <span class="match-state">[${m.state}]</span>
            <span class="match-id">${m.id}</span>
          </div>
          ${isCurrent ? '<span style="color:#ff0;">YOU</span>' : ''}
          ${canJoin ? '<button class="btn btn-small">JOIN</button>' : ''}
        </div>
      `;
    }).join('');
  } catch (e) {
    // Silently fail on refresh errors
  }
}

// Auto-connect on load
window.addEventListener('load', connect);
</script>
</body>
</html>
