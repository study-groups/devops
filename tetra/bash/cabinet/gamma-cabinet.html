<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GAMMA Cabinet</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100%;
      height: 100%;
    }
    body {
      font-family: 'Courier New', monospace;
      background: #0a0a0a;
      color: #888;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }

    /* ========================================
       HEADER BAR
       ======================================== */
    #header {
      width: 100%;
      max-width: 640px;
      background: linear-gradient(180deg, #1a0a1a 0%, #0a0a1a 100%);
      border: 2px solid #606;
      padding: 8px 12px;
      margin-bottom: 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    #gamma-logo {
      font-size: 14px;
      font-weight: bold;
      color: #f0f;
      text-decoration: none;
      letter-spacing: 1px;
    }
    #gamma-logo:hover { color: #f5f; }
    #match-code {
      font-size: 16px;
      font-weight: bold;
      color: #0ff;
      letter-spacing: 2px;
      min-width: 60px;
    }
    #match-code.offline { color: #444; }
    .timer-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #time-remaining {
      font-size: 14px;
      color: #0f0;
      min-width: 45px;
    }
    #time-remaining.warning { color: #f80; }
    #time-remaining.critical { color: #f00; animation: blink 0.5s infinite; }
    @keyframes blink { 50% { opacity: 0.3; } }
    #extend-btn {
      font-family: 'Courier New', monospace;
      font-size: 10px;
      padding: 2px 6px;
      background: #1a1a1a;
      color: #666;
      border: 1px solid #333;
      cursor: pointer;
    }
    #extend-btn:hover { background: #222; color: #0f0; border-color: #0a0; }
    #game-name {
      flex: 1;
      text-align: right;
      font-size: 12px;
      color: #0ff;
      letter-spacing: 2px;
      text-transform: uppercase;
    }
    #console-reset-btn {
      width: 28px;
      height: 28px;
      background: #200;
      border: 2px solid #500;
      color: #800;
      font-weight: bold;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #console-reset-btn:hover { background: #300; color: #f00; border-color: #700; }
    #console-reset-btn:active { background: #500; color: #fff; }

    /* ========================================
       GAME DISPLAY
       ======================================== */
    #game-display {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.15;
      white-space: pre;
      background: #000;
      padding: 8px;
      border: 2px solid #333;
      border-top: none;
      min-width: 500px;
      min-height: 300px;
      max-width: 640px;
      width: 100%;
      color: #0f0;
      text-align: center;
    }

    /* ========================================
       CONTROL BAR
       ======================================== */
    #control-bar {
      width: 100%;
      max-width: 640px;
      background: #111;
      border: 2px solid #333;
      border-top: none;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
    }

    /* D-Pad */
    .dpad {
      display: grid;
      grid-template-columns: 26px 26px 26px;
      grid-template-rows: 26px 26px 26px;
      gap: 2px;
    }
    .dpad-btn {
      background: #1a1a1a;
      border: 2px solid #333;
      color: #444;
      font-size: 11px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.1s;
    }
    .dpad-btn:hover { background: #222; color: #666; }
    .dpad-btn.active { background: #030; color: #0f0; border-color: #0f0; }
    .dpad-up { grid-column: 2; grid-row: 1; border-radius: 4px 4px 0 0; }
    .dpad-down { grid-column: 2; grid-row: 3; border-radius: 0 0 4px 4px; }
    .dpad-left { grid-column: 1; grid-row: 2; border-radius: 4px 0 0 4px; }
    .dpad-right { grid-column: 3; grid-row: 2; border-radius: 0 4px 4px 0; }
    .dpad-center { grid-column: 2; grid-row: 2; background: #0a0a0a; border-color: #222; cursor: default; color: #222; }

    /* Dial / Paddle Control */
    #dial-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    #dial {
      width: 60px;
      height: 60px;
      background: #0a0a0a;
      border: 3px solid #333;
      border-radius: 50%;
      position: relative;
    }
    #dial-indicator {
      position: absolute;
      top: 8px;
      left: 50%;
      width: 4px;
      height: 20px;
      background: #0f0;
      transform-origin: bottom center;
      transform: translateX(-50%) rotate(0deg);
      border-radius: 2px;
    }
    #dial.active { border-color: #0f0; }
    #dial-keys {
      display: flex;
      gap: 2px;
    }
    .dial-key {
      font-size: 8px;
      color: #333;
      background: #111;
      border: 1px solid #222;
      padding: 2px 4px;
      border-radius: 2px;
    }
    .dial-key.active { color: #0f0; border-color: #0f0; background: #020; }

    /* Brutalist Control Buttons */
    .ctrl-btn {
      font-family: 'Courier New', monospace;
      font-size: 9px;
      font-weight: bold;
      padding: 6px 10px;
      background: #111;
      color: #0a0;
      border: 2px solid #0a0;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .ctrl-btn:hover { background: #1a1a1a; color: #0f0; border-color: #0f0; }
    .ctrl-btn:active { background: #0a0; color: #000; }
    .ctrl-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .ctrl-btn-square {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      font-weight: bold;
      width: 32px;
      height: 32px;
      background: #111;
      color: #a00;
      border: 2px solid #a00;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .ctrl-btn-square:hover { background: #200; color: #f00; border-color: #f00; }
    .ctrl-btn-square:active { background: #a00; color: #000; }

    /* ========================================
       PLAYER DECK
       ======================================== */
    #player-deck {
      width: 100%;
      max-width: 640px;
      background: #0c0c0c;
      border: 2px solid #333;
      border-top: none;
      padding: 10px 16px;
      display: flex;
      justify-content: center;
      gap: 8px;
    }
    .player-slot {
      width: 70px;
      background: #111;
      border: 2px solid #333;
      padding: 6px 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s;
      border-radius: 4px;
    }
    .player-slot:hover { border-color: #555; background: #151515; }
    .player-slot.none { border-color: #333; }
    .player-slot.int { border-color: #0a0; }
    .player-slot.ext { border-color: #06f; }
    .player-slot.you { border-color: #0ff; background: #0a1a1a; }
    .player-slot.human { border-color: #f80; }
    .player-label {
      font-size: 11px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .player-slot.none .player-label { color: #444; }
    .player-slot.int .player-label { color: #0f0; }
    .player-slot.ext .player-label { color: #0af; }
    .player-slot.you .player-label { color: #0ff; }
    .player-slot.human .player-label { color: #f80; }
    .player-state {
      font-size: 10px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 3px 6px;
      background: #1a1a1a;
      border-radius: 2px;
    }
    .player-slot.none .player-state { color: #333; }
    .player-slot.int .player-state { color: #0f0; background: #010; }
    .player-slot.ext .player-state { color: #0af; background: #001; }
    .player-slot.you .player-state { color: #0ff; background: #022; font-size: 11px; }
    .player-slot.human .player-state { color: #f80; background: #110; }

    /* ========================================
       CONNECT BAR
       ======================================== */
    #connect-bar {
      width: 100%;
      max-width: 640px;
      background: #0a0a0a;
      border: 2px solid #222;
      border-top: none;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #connect-bar label {
      font-size: 10px;
      color: #555;
      text-transform: uppercase;
    }
    #code-input {
      font-family: 'Courier New', monospace;
      font-size: 14px;
      padding: 6px 10px;
      background: #111;
      color: #0f0;
      border: 1px solid #333;
      width: 80px;
      text-transform: uppercase;
      letter-spacing: 2px;
      text-align: center;
    }
    #code-input:focus { outline: none; border-color: #0a0; }
    #connect-btn {
      font-family: 'Courier New', monospace;
      font-size: 11px;
      padding: 6px 14px;
      background: #020;
      color: #0a0;
      border: 1px solid #0a0;
      cursor: pointer;
      text-transform: uppercase;
    }
    #connect-btn:hover { background: #030; color: #0f0; }
    .spacer { flex: 1; }
    #nick-display {
      font-size: 11px;
      color: #666;
    }
    #nick-display span { color: #0ff; cursor: pointer; }
    #nick-display span:hover { text-decoration: underline; }
    #connection-status {
      font-size: 10px;
      color: #444;
    }
    #connection-status.connected { color: #0f0; }
    #connection-status.error { color: #f00; }
  </style>
</head>
<body>

  <!-- Header: GAMMA RESET | GAMMA | CODE | TIMER | GAME | GAME RESET -->
  <div id="header">
    <button id="console-reset-btn" title="GAMMA Console Reset">R</button>
    <a id="gamma-logo" href="/" title="GAMMA Lobby">GAMMA</a>
    <span id="match-code" class="offline">----</span>
    <div class="timer-group">
      <span id="time-remaining">--:--</span>
      <button id="extend-btn" title="Extend +5 minutes">+5M</button>
    </div>
    <span id="game-name">---</span>
    <button id="game-reset-btn" class="ctrl-btn-square reset" title="Game Reset">R</button>
  </div>

  <!-- Game Display -->
  <pre id="game-display"></pre>

  <!-- Control Bar -->
  <div id="control-bar">
    <div class="dpad" id="dpad-left">
      <button class="dpad-btn dpad-up" data-dir="up" data-player="1">W</button>
      <button class="dpad-btn dpad-left" data-dir="left" data-player="1">A</button>
      <div class="dpad-btn dpad-center">+</div>
      <button class="dpad-btn dpad-right" data-dir="right" data-player="1">D</button>
      <button class="dpad-btn dpad-down" data-dir="down" data-player="1">S</button>
    </div>

    <div id="dial-container">
      <div id="dial">
        <div id="dial-indicator"></div>
      </div>
      <div id="dial-keys">
        <span class="dial-key" data-key="f">F</span>
        <span class="dial-key" data-key="t">T</span>
        <span class="dial-key" data-key="g">G</span>
        <span class="dial-key" data-key="h">H</span>
      </div>
    </div>

    <div class="dpad" id="dpad-right">
      <button class="dpad-btn dpad-up" data-dir="up" data-player="2">I</button>
      <button class="dpad-btn dpad-left" data-dir="left" data-player="2">J</button>
      <div class="dpad-btn dpad-center">+</div>
      <button class="dpad-btn dpad-right" data-dir="right" data-player="2">L</button>
      <button class="dpad-btn dpad-down" data-dir="down" data-player="2">K</button>
    </div>

    <button id="play-btn" class="ctrl-btn">[START]</button>
  </div>

  <!-- Player Deck -->
  <div id="player-deck">
    <div class="player-slot none" data-slot="p1">
      <div class="player-label">P1</div>
      <div class="player-state">NONE</div>
    </div>
    <div class="player-slot none" data-slot="p2">
      <div class="player-label">P2</div>
      <div class="player-state">NONE</div>
    </div>
    <div class="player-slot none" data-slot="p3">
      <div class="player-label">P3</div>
      <div class="player-state">NONE</div>
    </div>
    <div class="player-slot none" data-slot="p4">
      <div class="player-label">P4</div>
      <div class="player-state">NONE</div>
    </div>
  </div>

  <!-- Connect Bar -->
  <div id="connect-bar">
    <label>CODE</label>
    <input type="text" id="code-input" placeholder="XXXX" maxlength="4" autocomplete="off">
    <button id="connect-btn">CONNECT</button>
    <div class="spacer"></div>
    <div id="nick-display">Nick: <span id="nick-value">---</span></div>
    <div id="connection-status">OFFLINE</div>
  </div>

  <script>
    // ========================================
    // ANSI TO HTML CONVERTER
    // ========================================
    const ANSI_COLORS = {
      '30': '#000', '31': '#a00', '32': '#0a0', '33': '#a50',
      '34': '#00a', '35': '#a0a', '36': '#0aa', '37': '#aaa',
      '90': '#555', '91': '#f55', '92': '#5f5', '93': '#ff5',
      '94': '#55f', '95': '#f5f', '96': '#5ff', '97': '#fff',
      '40': '#000', '41': '#a00', '42': '#0a0', '43': '#a50',
      '44': '#00a', '45': '#a0a', '46': '#0aa', '47': '#aaa'
    };

    function ansiToHtml(text) {
      if (!text) return '';
      let html = '';
      let currentColor = null;
      let i = 0;

      while (i < text.length) {
        // Check for ANSI escape sequence
        if (text[i] === '\x1b' && text[i + 1] === '[') {
          // Find the end of the sequence
          let j = i + 2;
          while (j < text.length && text[j] !== 'm') j++;

          if (text[j] === 'm') {
            const codes = text.slice(i + 2, j).split(';');

            // Close previous span if open
            if (currentColor) {
              html += '</span>';
              currentColor = null;
            }

            // Process codes
            for (const code of codes) {
              if (code === '0' || code === '') {
                // Reset
                currentColor = null;
              } else if (ANSI_COLORS[code]) {
                // Foreground color (30-37, 90-97)
                if (parseInt(code) < 40 || parseInt(code) >= 90) {
                  currentColor = ANSI_COLORS[code];
                  html += `<span style="color:${currentColor}">`;
                }
              } else if (code === '1') {
                // Bold - brighten
                currentColor = currentColor || '#fff';
              } else if (code === '2') {
                // Dim
                currentColor = currentColor || '#666';
              }
            }

            i = j + 1;
            continue;
          }
        }

        // Escape HTML entities
        if (text[i] === '<') html += '&lt;';
        else if (text[i] === '>') html += '&gt;';
        else if (text[i] === '&') html += '&amp;';
        else html += text[i];

        i++;
      }

      // Close any open span
      if (currentColor) html += '</span>';

      return html;
    }

    // ========================================
    // CABINET IDENTITY
    // ========================================
    const Cabinet = {
      init() {
        let data = localStorage.getItem('cabinet');
        if (data) {
          this.data = JSON.parse(data);
          this.data.visits++;
          this.data.lastSeen = Date.now();
        } else {
          this.data = {
            cid: 'cab_' + Math.random().toString(36).substr(2, 6),
            nick: 'Player' + Math.floor(Math.random() * 100),
            visits: 1,
            firstSeen: Date.now(),
            lastSeen: Date.now()
          };
        }
        this.save();
        return this;
      },
      save() { localStorage.setItem('cabinet', JSON.stringify(this.data)); },
      setNick(nick) { this.data.nick = nick.substring(0, 12); this.save(); }
    }.init();

    // ========================================
    // STATE
    // ========================================
    let ws = null;
    let wsUrl = null;
    let matchCode = null;
    let matchExpires = null;
    let timerInterval = null;
    let mySlot = null;
    let gameName = null;
    let playerStates = { p1: 'none', p2: 'none', p3: 'none', p4: 'none' };

    // ========================================
    // DOM ELEMENTS
    // ========================================
    const matchCodeEl = document.getElementById('match-code');
    const timeRemainingEl = document.getElementById('time-remaining');
    const extendBtn = document.getElementById('extend-btn');
    const gameNameEl = document.getElementById('game-name');
    const consoleResetBtn = document.getElementById('console-reset-btn');
    const gameResetBtn = document.getElementById('game-reset-btn');
    const gameDisplayEl = document.getElementById('game-display');
    const playBtn = document.getElementById('play-btn');
    const dial = document.getElementById('dial');
    const dialIndicator = document.getElementById('dial-indicator');
    const codeInput = document.getElementById('code-input');
    const connectBtn = document.getElementById('connect-btn');
    const nickValueEl = document.getElementById('nick-value');
    const connectionStatusEl = document.getElementById('connection-status');
    const playerSlots = document.querySelectorAll('.player-slot');
    const dpadBtns = document.querySelectorAll('.dpad-btn[data-dir]');
    const actionBtns = document.querySelectorAll('.action-btn');

    // ========================================
    // TIMER
    // ========================================
    function updateTimer() {
      if (!matchExpires) {
        timeRemainingEl.textContent = '--:--';
        timeRemainingEl.className = '';
        return;
      }
      const remaining = Math.max(0, matchExpires - Date.now());
      const mins = Math.floor(remaining / 60000);
      const secs = Math.floor((remaining % 60000) / 1000);
      timeRemainingEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

      if (remaining < 60000) {
        timeRemainingEl.className = 'critical';
      } else if (remaining < 120000) {
        timeRemainingEl.className = 'warning';
      } else {
        timeRemainingEl.className = '';
      }
    }

    function startTimer(expires) {
      matchExpires = expires;
      updateTimer();
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimer, 1000);
    }

    // ========================================
    // PLAYER DECK
    // ========================================
    function updatePlayerSlot(slot, state, name) {
      const el = document.querySelector(`.player-slot[data-slot="${slot}"]`);
      if (!el) return;

      el.className = `player-slot ${state}`;
      const stateEl = el.querySelector('.player-state');

      // State display text
      const stateText = {
        'you': 'YOU',
        'human': name || 'HUMAN',
        'int': 'INT',
        'ext': 'EXT',
        'none': '---'
      };
      stateEl.textContent = stateText[state] || '---';

      playerStates[slot] = state;
    }

    // ========================================
    // DIAL CONTROL
    // ========================================
    let dialAngle = 0; // -135 to +135 degrees
    let dialStep = 15; // degrees per click

    function updateDial(angle) {
      dialAngle = Math.max(-135, Math.min(135, angle));
      if (dialIndicator) {
        dialIndicator.style.transform = `translateX(-50%) rotate(${dialAngle}deg)`;
      }
    }

    function activateDial() {
      if (dial) dial.classList.add('active');
    }

    function deactivateDial() {
      if (dial) dial.classList.remove('active');
    }

    // F=CCW, H=CW, T=increase step, G=decrease step
    function turnDialCCW() { updateDial(dialAngle - dialStep); }
    function turnDialCW() { updateDial(dialAngle + dialStep); }
    function increaseDialStep() { dialStep = Math.min(45, dialStep + 5); }
    function decreaseDialStep() { dialStep = Math.max(5, dialStep - 5); }

    function setDialKeyActive(key, active) {
      const el = document.querySelector(`.dial-key[data-key="${key}"]`);
      if (el) el.classList.toggle('active', active);
    }

    // Click cycles: YOU -> INT -> EXT -> NONE -> YOU
    // HUMAN slots (other players) cannot be changed
    function cyclePlayerState(slot) {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;

      const current = playerStates[slot];

      // Can't change another human's slot
      if (current === 'human') return;

      // Cycle order: you -> int -> ext -> none -> you
      const cycle = { 'you': 'int', 'int': 'ext', 'ext': 'none', 'none': 'you' };
      const next = cycle[current] || 'you';

      if (next === 'you') {
        // Take over this slot
        ws.send(JSON.stringify({
          t: 'identify',
          cid: Cabinet.data.cid,
          nick: Cabinet.data.nick,
          visits: Cabinet.data.visits,
          requestSlot: slot,
          takeover: true
        }));
        mySlot = slot;
        activateDial();
      } else {
        // Set to AI mode or none
        if (current === 'you') {
          mySlot = null;
          deactivateDial();
        }
        ws.send(JSON.stringify({ t: 'slot.setAI', slot, mode: next === 'none' ? null : next }));
      }
      updatePlayerSlot(slot, next);
    }

    // ========================================
    // CONTROLS
    // ========================================
    function sendPlay() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ t: 'game.play' }));
      }
    }

    function sendReset() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ t: 'game.reset' }));
      }
    }

    async function extendMatch() {
      if (!matchCode) return;
      try {
        const resp = await fetch('/api/match/extend', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: matchCode })
        });
        const result = await resp.json();
        if (result.ok && result.expires) {
          startTimer(result.expires);
        }
      } catch (e) {
        console.error('[cabinet] Extend failed:', e);
      }
    }

    function sendInput(key, pressed) {
      if (ws && ws.readyState === WebSocket.OPEN && mySlot) {
        ws.send(JSON.stringify({ t: 'input', key, pressed }));
      }
    }

    // ========================================
    // CONNECTION
    // ========================================
    function updateConnectionStatus(status, isError = false) {
      connectionStatusEl.textContent = status;
      connectionStatusEl.className = isError ? 'error' : (status === 'CONNECTED' ? 'connected' : '');
    }

    function updateMatchCode(code) {
      matchCode = code;
      matchCodeEl.textContent = code || '----';
      matchCodeEl.classList.toggle('offline', !code);
    }

    async function joinByCode(code) {
      updateConnectionStatus('RESOLVING...');
      try {
        const resp = await fetch('/api/match/join', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: code.toUpperCase() })
        });

        if (!resp.ok) {
          updateConnectionStatus('NOT FOUND', true);
          return;
        }

        const data = await resp.json();
        if (data.error) {
          updateConnectionStatus(data.error, true);
          return;
        }

        if (data.host) {
          wsUrl = data.host.startsWith('ws://') ? data.host : `ws://${data.host}`;
          if (data.game) {
            gameName = data.game.toUpperCase();
            gameNameEl.textContent = gameName;
          }
          updateMatchCode(code.toUpperCase());

          // Get match info for timer
          try {
            const infoResp = await fetch(`/api/match/${code}`);
            if (infoResp.ok) {
              const info = await infoResp.json();
              if (info.expires) startTimer(info.expires);
            }
          } catch (e) {}

          connect();
        }
      } catch (e) {
        updateConnectionStatus('ERROR', true);
      }
    }

    function connect() {
      if (!wsUrl) return;
      if (ws) ws.close();

      updateConnectionStatus('CONNECTING...');
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        ws.send(JSON.stringify({
          t: 'identify',
          cid: Cabinet.data.cid,
          nick: Cabinet.data.nick,
          visits: Cabinet.data.visits,
          requestSlot: 'AUTO',
          takeover: false
        }));
      };

      ws.onmessage = (e) => {
        try {
          handleMessage(JSON.parse(e.data));
        } catch (err) {
          console.error('[cabinet] Message parse error:', err);
        }
      };

      ws.onclose = () => {
        mySlot = null;
        updateConnectionStatus('DISCONNECTED');
        deactivateDial();
        // Reset player states
        ['p1', 'p2', 'p3', 'p4'].forEach(s => updatePlayerSlot(s, 'none'));
      };

      ws.onerror = () => {
        updateConnectionStatus('ERROR', true);
      };
    }

    function handleMessage(msg) {
      switch (msg.t) {
        case 'welcome':
          mySlot = msg.slot;
          updateConnectionStatus('CONNECTED');
          if (mySlot) activateDial();
          if (msg.game) {
            gameName = msg.game.toUpperCase();
            gameNameEl.textContent = gameName;
          }
          // Update player states from welcome
          if (msg.players) {
            msg.players.forEach(p => {
              const state = p.cid === Cabinet.data.cid ? 'you' : 'human';
              updatePlayerSlot(p.slot, state, p.nick);
            });
          }
          break;

        case 'frame':
          if (msg.display) {
            gameDisplayEl.innerHTML = ansiToHtml(msg.display);
          }
          // Update dial from game state
          if (msg.state && msg.state.paddles && mySlot) {
            const paddle = msg.state.paddles[mySlot];
            if (paddle) {
              // Convert offset to dial angle (-135 to +135)
              const angle = (paddle.offset / 0.63) * 135;
              updateDial(angle);
            }
          }
          break;

        case 'player.join':
          const joinState = msg.cid === Cabinet.data.cid ? 'you' : 'human';
          updatePlayerSlot(msg.slot, joinState, msg.nick);
          break;

        case 'player.leave':
          updatePlayerSlot(msg.slot, 'none');
          break;

        case 'slot.assigned':
          mySlot = msg.slot;
          updatePlayerSlot(msg.slot, 'you', Cabinet.data.nick);
          activateDial();
          break;
      }
    }

    // ========================================
    // KEYBOARD INPUT
    // ========================================
    // Player 1: WASD, Player 2: IJKL, Dial: FTGH
    const keyMap = {
      // Player 1
      'KeyW': { dir: 'up', player: 1 },
      'KeyS': { dir: 'down', player: 1 },
      'KeyA': { dir: 'left', player: 1 },
      'KeyD': { dir: 'right', player: 1 },
      // Player 2
      'KeyI': { dir: 'up', player: 2 },
      'KeyK': { dir: 'down', player: 2 },
      'KeyJ': { dir: 'left', player: 2 },
      'KeyL': { dir: 'right', player: 2 },
    };

    // Dial keys: F=CCW, H=CW, T=faster, G=slower
    const dialKeyMap = {
      'KeyF': { action: 'ccw', key: 'f' },
      'KeyH': { action: 'cw', key: 'h' },
      'KeyT': { action: 'faster', key: 't' },
      'KeyG': { action: 'slower', key: 'g' },
    };

    // Direction -> game input key
    const gameKeyMap = {
      'up': 'w', 'down': 's', 'left': 'a', 'right': 'd'
    };

    const activeKeys = new Set();

    function setDpadBtnActive(dir, player, active) {
      const dpadId = player === 1 ? '#dpad-left' : '#dpad-right';
      const btn = document.querySelector(`${dpadId} .dpad-${dir}`);
      if (btn) btn.classList.toggle('active', active);
    }

    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT') return;
      if (activeKeys.has(e.code)) return;

      // D-pad keys
      const mapping = keyMap[e.code];
      if (mapping) {
        activeKeys.add(e.code);
        setDpadBtnActive(mapping.dir, mapping.player, true);

        // Send game input
        const gameKey = gameKeyMap[mapping.dir];
        if (gameKey) sendInput(gameKey, true);

        // Turn dial on left/right (player 1 controls dial)
        if (mapping.player === 1) {
          if (mapping.dir === 'left') turnDialCCW();
          if (mapping.dir === 'right') turnDialCW();
        }

        e.preventDefault();
        return;
      }

      // Dial keys
      const dialMapping = dialKeyMap[e.code];
      if (dialMapping) {
        activeKeys.add(e.code);
        setDialKeyActive(dialMapping.key, true);

        if (dialMapping.action === 'ccw') turnDialCCW();
        if (dialMapping.action === 'cw') turnDialCW();
        if (dialMapping.action === 'faster') increaseDialStep();
        if (dialMapping.action === 'slower') decreaseDialStep();

        e.preventDefault();
      }
    });

    document.addEventListener('keyup', (e) => {
      if (!activeKeys.has(e.code)) return;

      const mapping = keyMap[e.code];
      if (mapping) {
        activeKeys.delete(e.code);
        setDpadBtnActive(mapping.dir, mapping.player, false);

        const gameKey = gameKeyMap[mapping.dir];
        if (gameKey) sendInput(gameKey, false);
        return;
      }

      const dialMapping = dialKeyMap[e.code];
      if (dialMapping) {
        activeKeys.delete(e.code);
        setDialKeyActive(dialMapping.key, false);
      }
    });

    // ========================================
    // EVENT LISTENERS
    // ========================================
    let isPlaying = false;

    playBtn.addEventListener('click', () => {
      if (!isPlaying) {
        sendReset();  // game.reset starts gameplay
        isPlaying = true;
        playBtn.textContent = '[PAUSE]';
      } else {
        // Send pause
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ t: 'game.pause' }));
        }
        isPlaying = false;
        playBtn.textContent = '[START]';
      }
    });

    gameResetBtn.addEventListener('click', () => {
      // Game reset - shows ASCIIPONG boot animation
      sendPlay();  // game.play shows boot animation
      isPlaying = false;
      playBtn.textContent = '[START]';
    });

    consoleResetBtn.addEventListener('click', () => {
      // GAMMA console reset - show colorful boot screen
      renderBootScreen();
      isPlaying = false;
      playBtn.textContent = '[START]';
      if (ws) ws.close();
    });
    extendBtn.addEventListener('click', extendMatch);

    connectBtn.addEventListener('click', () => {
      const code = codeInput.value.trim();
      if (code.length === 4) {
        joinByCode(code);
      }
    });

    codeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const code = codeInput.value.trim();
        if (code.length === 4) {
          joinByCode(code);
        }
      }
    });

    // Player slot clicks - click to cycle through states
    playerSlots.forEach(slot => {
      slot.addEventListener('click', () => {
        cyclePlayerState(slot.dataset.slot);
      });
    });

    // Nick editing
    nickValueEl.textContent = Cabinet.data.nick;
    nickValueEl.addEventListener('click', () => {
      const newNick = prompt('Enter nickname:', Cabinet.data.nick);
      if (newNick) {
        Cabinet.setNick(newNick);
        nickValueEl.textContent = Cabinet.data.nick;
      }
    });

    // ========================================
    // AUTO-JOIN FROM URL
    // ========================================
    const pathMatch = location.pathname.match(/\/match\/([A-Z0-9]{4})\/?/i);
    if (pathMatch) {
      const code = pathMatch[1].toUpperCase();
      codeInput.value = code;
      setTimeout(() => joinByCode(code), 100);
    }

    // ========================================
    // BOOT SCREEN
    // ========================================
    function renderBootScreen() {
      const colors = ['#f0f', '#0ff', '#0f0', '#ff0', '#f80', '#f55'];
      const gammaArt = [
        '██████╗  █████╗ ███╗   ███╗███╗   ███╗ █████╗ ',
        '██╔════╝ ██╔══██╗████╗ ████║████╗ ████║██╔══██╗',
        '██║  ███╗███████║██╔████╔██║██╔████╔██║███████║',
        '██║   ██║██╔══██║██║╚██╔╝██║██║╚██╔╝██║██╔══██║',
        '╚██████╔╝██║  ██║██║ ╚═╝ ██║██║ ╚═╝ ██║██║  ██║',
        ' ╚═════╝ ╚═╝  ╚═╝╚═╝     ╚═╝╚═╝     ╚═╝╚═╝  ╚═╝'
      ];

      let html = '\n\n';

      // Color each line of GAMMA differently
      gammaArt.forEach((line, i) => {
        const color = colors[i % colors.length];
        html += `<span style="color:${color}">${line}</span>\n`;
      });

      html += '\n';
      html += '<span style="color:#0ff">A N S I</span>   <span style="color:#f0f">C A B I N E T</span>\n';
      html += '\n';
      html += '<span style="color:#888">Enter match code or wait for auto-connect...</span>\n';

      gameDisplayEl.innerHTML = html;
    }

    // Show boot screen on load if no auto-join
    if (!pathMatch) {
      renderBootScreen();
    }
  </script>
</body>
</html>
