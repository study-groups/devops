{
  "metadata": {
    "title": "TKM Setup Guide",
    "description": "Interactive walkthrough for setting up SSH key management with TKM",
    "version": "1.0.0",
    "author": "tetra",
    "difficulty": "beginner",
    "estimatedTime": "15 minutes",
    "tags": ["tkm", "ssh", "keys", "security"],
    "context": {
      "org": "{{org}}",
      "interactive": true
    }
  },
  "theme": {
    "tds": "default"
  },
  "features": {
    "terminalAnimation": true,
    "keyboardNavigation": true,
    "progressPersistence": true
  },
  "steps": [
    {
      "id": "intro",
      "title": "Welcome to TKM",
      "content": [
        {
          "type": "paragraph",
          "text": "TKM (Tetra Key Manager) manages SSH keys for your organization **{{org}}**. By the end of this guide, you'll have secure SSH access to all your environments."
        },
        {
          "type": "learn-box",
          "title": "What You'll Learn",
          "items": [
            "How TKM organizes keys by organization",
            "Generating ED25519 SSH keys",
            "Automatic SSH config management",
            "Testing connectivity to your servers"
          ]
        }
      ],
      "terminal": [
        {"type": "comment", "text": "# TKM - Tetra Key Manager"},
        {"type": "comment", "text": "# Organization: {{org}}"},
        {"type": "blank"},
        {"type": "prompt", "text": "$"},
        {"type": "command", "text": "tkm help"},
        {"type": "output", "text": "tkm - Tetra Key Manager"},
        {"type": "blank"},
        {"type": "output", "text": "USAGE"},
        {"type": "output", "text": "    tkm <command> [args]"},
        {"type": "blank"},
        {"type": "output", "text": "COMMANDS"},
        {"type": "output", "text": "    status     Show keys for current org"},
        {"type": "output", "text": "    init       Create key directory"},
        {"type": "output", "text": "    generate   Generate SSH keys"},
        {"type": "output", "text": "    deploy     Push keys to servers"},
        {"type": "output", "text": "    test       Verify connectivity"}
      ]
    },
    {
      "id": "check-org",
      "title": "Check Organization",
      "content": [
        {
          "type": "paragraph",
          "text": "First, let's verify that **{{org}}** is your active organization. TKM stores keys in `~/.ssh/{{org}}/` to keep them separate from other projects."
        },
        {
          "type": "you-try",
          "title": "Run This Command",
          "commands": ["org status"],
          "copyable": true
        }
      ],
      "terminal": [
        {"type": "prompt", "text": "$"},
        {"type": "command", "text": "org status"},
        {"type": "output-success", "text": "Active: {{org}}"},
        {"type": "output", "text": "Config: ~/tetra/orgs/{{org}}/tetra.toml"}
      ],
      "validation": {
        "type": "command",
        "check": "org_active",
        "expected": "{{org}}",
        "hint": "Run: org switch {{org}}"
      }
    },
    {
      "id": "view-environments",
      "title": "View Environments",
      "content": [
        {
          "type": "paragraph",
          "text": "Your organization has environments defined in `tetra.toml`. TKM will create SSH keys for each environment."
        },
        {
          "type": "you-try",
          "title": "List Environments",
          "commands": ["org env list"],
          "copyable": true
        }
      ],
      "terminal": [
        {"type": "prompt", "text": "$"},
        {"type": "command", "text": "org env list"},
        {"type": "output", "text": "Environments for: {{org}}"},
        {"type": "blank"},
        {"type": "output", "text": "  dev          root@{{dev_host}}"},
        {"type": "output", "text": "  staging      root@{{staging_host}}"},
        {"type": "output", "text": "  prod         root@{{prod_host}}"}
      ]
    },
    {
      "id": "tkm-status-before",
      "title": "Check Current Key Status",
      "content": [
        {
          "type": "paragraph",
          "text": "Let's see what keys exist (if any) for **{{org}}**."
        },
        {
          "type": "you-try",
          "title": "Check TKM Status",
          "commands": ["tkm status"],
          "copyable": true
        }
      ],
      "terminal": [
        {"type": "prompt", "text": "$"},
        {"type": "command", "text": "tkm status"},
        {"type": "output", "text": "TKM Status: {{org}}"},
        {"type": "output", "text": "Keys: ~/.ssh/{{org}}/"},
        {"type": "blank"},
        {"type": "output-warning", "text": "(no keys found)"},
        {"type": "output", "text": "Run: tkm init && tkm gen all"}
      ]
    },
    {
      "id": "tkm-init",
      "title": "Initialize Key Directory",
      "content": [
        {
          "type": "paragraph",
          "text": "Create the key directory for **{{org}}**. This sets up `~/.ssh/{{org}}/` with proper permissions (700)."
        },
        {
          "type": "you-try",
          "title": "Initialize TKM",
          "commands": ["tkm init"],
          "copyable": true
        }
      ],
      "terminal": [
        {"type": "prompt", "text": "$"},
        {"type": "command", "text": "tkm init"},
        {"type": "output-success", "text": "Created: ~/.ssh/{{org}}/"},
        {"type": "output", "text": "Permissions: 700"}
      ],
      "validation": {
        "type": "file-exists",
        "check": "~/.ssh/{{org}}",
        "hint": "Run: tkm init"
      }
    },
    {
      "id": "tkm-generate",
      "title": "Generate SSH Keys",
      "content": [
        {
          "type": "paragraph",
          "text": "Now generate ED25519 keys for all environments. TKM creates two keys per environment:"
        },
        {
          "type": "list",
          "items": [
            "`<env>_root` - For root/admin access",
            "`<env>_{{work_user}}` - For application deployment"
          ]
        },
        {
          "type": "you-try",
          "title": "Generate All Keys",
          "commands": ["tkm gen all"],
          "copyable": true
        }
      ],
      "terminal": [
        {"type": "prompt", "text": "$"},
        {"type": "command", "text": "tkm gen all"},
        {"type": "output", "text": "Generating keys for: {{org}}"},
        {"type": "blank"},
        {"type": "output", "text": "  dev_root"},
        {"type": "output-success", "text": "    Generated: ~/.ssh/{{org}}/dev_root"},
        {"type": "output", "text": "    SHA256:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"},
        {"type": "blank"},
        {"type": "output", "text": "  dev_{{work_user}}"},
        {"type": "output-success", "text": "    Generated: ~/.ssh/{{org}}/dev_{{work_user}}"},
        {"type": "output", "text": "    SHA256:YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY"},
        {"type": "blank"},
        {"type": "output", "text": "  staging_root"},
        {"type": "output-success", "text": "    Generated: ~/.ssh/{{org}}/staging_root"},
        {"type": "blank"},
        {"type": "output", "text": "  prod_root"},
        {"type": "output-success", "text": "    Generated: ~/.ssh/{{org}}/prod_root"},
        {"type": "blank"},
        {"type": "output", "text": "Updated: ~/.ssh/config"}
      ],
      "details": [
        {
          "type": "explanation",
          "title": "Why ED25519?",
          "content": "ED25519 is a modern elliptic curve algorithm that's faster and more secure than RSA. It produces shorter keys (68 chars vs 400+) with equivalent security to RSA-3072.",
          "difficulty": "intermediate"
        }
      ]
    },
    {
      "id": "verify-keys",
      "title": "Verify Generated Keys",
      "content": [
        {
          "type": "paragraph",
          "text": "Check that your keys were created correctly."
        },
        {
          "type": "you-try",
          "title": "List Keys",
          "commands": ["tkm list"],
          "copyable": true
        }
      ],
      "terminal": [
        {"type": "prompt", "text": "$"},
        {"type": "command", "text": "tkm list"},
        {"type": "output", "text": "Keys in ~/.ssh/{{org}}/"},
        {"type": "blank"},
        {"type": "output", "text": "  dev_root"},
        {"type": "output", "text": "  dev_{{work_user}}"},
        {"type": "output", "text": "  staging_root"},
        {"type": "output", "text": "  prod_root"}
      ]
    },
    {
      "id": "ssh-config",
      "title": "SSH Config",
      "content": [
        {
          "type": "paragraph",
          "text": "TKM automatically updates `~/.ssh/config` with Match blocks. This means you can SSH directly without specifying the key path."
        },
        {
          "type": "you-try",
          "title": "View SSH Config",
          "commands": ["tkm config"],
          "copyable": true
        }
      ],
      "terminal": [
        {"type": "prompt", "text": "$"},
        {"type": "command", "text": "tkm config"},
        {"type": "output", "text": "SSH config for: {{org}}"},
        {"type": "blank"},
        {"type": "output", "text": "# tkm: {{org}} dev"},
        {"type": "output", "text": "Match Host {{dev_host}} User root"},
        {"type": "output", "text": "    IdentityFile ~/.ssh/{{org}}/dev_root"},
        {"type": "blank"},
        {"type": "output", "text": "Match Host {{dev_host}} User {{work_user}}"},
        {"type": "output", "text": "    IdentityFile ~/.ssh/{{org}}/dev_{{work_user}}"}
      ],
      "details": [
        {
          "type": "explanation",
          "title": "Why Match blocks?",
          "content": "TKM uses `Match Host <ip> User <user>` instead of Host aliases. This allows direct SSH to the IP while still using the correct key based on which user you're logging in as.",
          "difficulty": "advanced"
        }
      ]
    },
    {
      "id": "deploy-keys",
      "title": "Deploy Keys to Servers",
      "content": [
        {
          "type": "paragraph",
          "text": "Now push your public keys to the remote servers. This adds them to `~/.ssh/authorized_keys` on each server."
        },
        {
          "type": "warning-box",
          "title": "Initial Access Required",
          "text": "You need existing SSH access (via password or another key) to deploy keys. If this is a fresh server, you may need to use `--key` to specify a bootstrap key."
        },
        {
          "type": "you-try",
          "title": "Deploy Keys",
          "commands": ["tkm deploy all"],
          "copyable": true
        }
      ],
      "terminal": [
        {"type": "prompt", "text": "$"},
        {"type": "command", "text": "tkm deploy all"},
        {"type": "output", "text": "Deploying keys for: {{org}}"},
        {"type": "blank"},
        {"type": "output", "text": "  dev ({{dev_host}})"},
        {"type": "output-success", "text": "    root: deployed"},
        {"type": "output-success", "text": "    {{work_user}}: deployed"},
        {"type": "blank"},
        {"type": "output", "text": "  staging ({{staging_host}})"},
        {"type": "output-success", "text": "    root: deployed"},
        {"type": "blank"},
        {"type": "output", "text": "  prod ({{prod_host}})"},
        {"type": "output-success", "text": "    root: deployed"}
      ]
    },
    {
      "id": "test-connectivity",
      "title": "Test SSH Connectivity",
      "content": [
        {
          "type": "paragraph",
          "text": "Verify that you can connect to all environments."
        },
        {
          "type": "you-try",
          "title": "Test All Connections",
          "commands": ["tkm test"],
          "copyable": true
        }
      ],
      "terminal": [
        {"type": "prompt", "text": "$"},
        {"type": "command", "text": "tkm test"},
        {"type": "output", "text": "Testing SSH for: {{org}}"},
        {"type": "blank"},
        {"type": "output", "text": "  dev ({{dev_host}})"},
        {"type": "output-success", "text": "    root: OK (42ms)"},
        {"type": "output-success", "text": "    {{work_user}}: OK (38ms)"},
        {"type": "blank"},
        {"type": "output", "text": "  staging ({{staging_host}})"},
        {"type": "output-success", "text": "    root: OK (45ms)"},
        {"type": "blank"},
        {"type": "output", "text": "  prod ({{prod_host}})"},
        {"type": "output-success", "text": "    root: OK (41ms)"},
        {"type": "blank"},
        {"type": "output-success", "text": "All connections successful!"}
      ]
    },
    {
      "id": "summary",
      "title": "Setup Complete!",
      "content": [
        {
          "type": "paragraph",
          "text": "You've successfully set up SSH key management for **{{org}}**!"
        },
        {
          "type": "learn-box",
          "title": "What You've Done",
          "items": [
            "Created key directory: `~/.ssh/{{org}}/`",
            "Generated ED25519 keys for all environments",
            "Updated SSH config with Match blocks",
            "Deployed keys to remote servers",
            "Verified connectivity"
          ]
        },
        {
          "type": "info-box",
          "title": "Next Steps",
          "text": "You can now SSH directly: `ssh root@{{dev_host}}` or use deploy commands like `deploy push myapp dev`."
        }
      ],
      "terminal": [
        {"type": "comment", "text": "# Quick reference"},
        {"type": "prompt", "text": "$"},
        {"type": "command", "text": "ssh root@{{dev_host}}"},
        {"type": "output-success", "text": "Welcome to dev.{{org}}"},
        {"type": "output", "text": "root@dev:~#"}
      ]
    }
  ]
}
