{
  "metadata": {
    "title": "Deploy Reference",
    "version": "0.0.18",
    "description": "Target-based deployment using tetra-deploy.toml",
    "author": "tetra",
    "created": "2024-12-05",
    "updated": "2025-12-08T22:32:19Z",
    "sidebar_position": "left",
    "theme": {
      "primary": "#2563eb",
      "accent": "#3b82f6"
    }
  },
  "groups": [
    {
      "id": "overview",
      "title": "Overview",
      "topics": [
        {
          "id": "mental-model",
          "title": "Mental Model",
          "content": [
            {
              "type": "paragraph",
              "text": "Deploy combines org infrastructure (hosts, users) with target config (what to deploy, where)."
            },
            {
              "type": "table",
              "headers": [
                "Layer",
                "Location",
                "Purpose"
              ],
              "rows": [
                [
                  "Org",
                  "$TETRA_DIR/orgs/{org}/tetra.toml",
                  "Host IPs, SSH users per env"
                ],
                [
                  "Target",
                  "$TETRA_DIR/orgs/{org}/targets/{name}.toml",
                  "Remote path, commands, domain"
                ]
              ]
            }
          ]
        },
        {
          "id": "what-happens",
          "title": "What Happens: deploy push docs prod",
          "content": [
            {
              "type": "paragraph",
              "text": "When you run deploy push docs prod:"
            },
            {
              "type": "list",
              "style": "ordered",
              "items": [
                "Resolve target: Find $TETRA_DIR/orgs/{org}/targets/docs.toml",
                "Load org config: Get host, auth_user, work_user for 'prod' env from org's tetra.toml",
                "Load target config: Read [target] section (name, remote, domain)",
                "Load deploy arrays: Read [deploy] pre, commands, post arrays",
                "Run [pre] commands: Execute locally from target dir (e.g., npm run build)",
                "Run [commands]: Execute with {{variables}} expanded (e.g., rsync to remote)",
                "Run [post] commands: Execute after main commands (e.g., chown, service restart)"
              ]
            },
            {
              "type": "code-block",
              "language": "text",
              "code": "========================================\nDeploy: docs -> prod\n========================================\n\nTarget: /home/user/.tetra/orgs/myorg/targets/docs.toml\nRemote: root@192.0.2.1:/var/www/docs\nDomain: docs.example.com\n\n[pre]\n  $ npm run build\n\n[commands]\n  $ rsync -avz dist/ root@192.0.2.1:/var/www/docs/\n\n[post]\n  $ ssh root@192.0.2.1 'chown -R devops:devops /var/www/docs'\n\n========================================\nDone\n========================================"
            }
          ]
        },
        {
          "id": "quick-start",
          "title": "Quick Start",
          "content": [
            {
              "type": "code-block",
              "language": "bash",
              "code": "# Check setup\norg status\ndeploy status\n\n# Preview\ndeploy push --dry-run docs prod\n\n# Deploy\ndeploy push docs prod"
            }
          ]
        }
      ]
    },
    {
      "id": "commands",
      "title": "Commands",
      "topics": [
        {
          "id": "main-commands",
          "title": "Main Commands",
          "content": [
            {
              "type": "command-list",
              "commands": [
                {
                  "code": "deploy status",
                  "description": "Show active org and available targets"
                },
                {
                  "code": "deploy doctor",
                  "description": "Audit deployment setup"
                },
                {
                  "code": "deploy push <target> <env>",
                  "description": "Full deployment pipeline"
                },
                {
                  "code": "deploy push <env>",
                  "description": "Deploy cwd (uses ./tetra-deploy.toml)"
                },
                {
                  "code": "deploy push --dry-run <target> <env>",
                  "description": "Preview what would run"
                },
                {
                  "code": "deploy show <target> <env>",
                  "description": "Show resolved config"
                },
                {
                  "code": "deploy help",
                  "description": "Show help"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "id": "configuration",
      "title": "Configuration",
      "topics": [
        {
          "id": "tetra-deploy-toml",
          "title": "tetra-deploy.toml",
          "content": [
            {
              "type": "code-block",
              "language": "toml",
              "code": "[target]\nname = \"docs\"\nremote = \"/var/www/docs\"\ndomain = \"docs.example.com\"\n\n[deploy]\npre = [\"npm run build\"]\ncommands = [\"rsync -avz dist/ {{ssh}}:{{remote}}/\"]\npost = [\"ssh {{ssh}} 'chown -R {{work_user}}:{{work_user}} {{remote}}'\"]"
            }
          ]
        },
        {
          "id": "template-variables",
          "title": "Template Variables",
          "content": [
            {
              "type": "table",
              "headers": [
                "Variable",
                "Source",
                "Example"
              ],
              "rows": [
                [
                  "{{host}}",
                  "org env IP",
                  "192.0.2.1"
                ],
                [
                  "{{auth_user}}",
                  "org SSH login",
                  "root"
                ],
                [
                  "{{work_user}}",
                  "org app owner",
                  "devops"
                ],
                [
                  "{{ssh}}",
                  "auth_user@host",
                  "root@192.0.2.1"
                ],
                [
                  "{{name}}",
                  "target.name",
                  "docs"
                ],
                [
                  "{{remote}}",
                  "target.remote",
                  "/var/www/docs"
                ],
                [
                  "{{domain}}",
                  "target.domain",
                  "docs.example.com"
                ],
                [
                  "{{env}}",
                  "environment",
                  "prod"
                ]
              ]
            }
          ]
        }
      ]
    },
    {
      "id": "examples",
      "title": "Examples",
      "topics": [
        {
          "id": "static-site",
          "title": "Static Site",
          "content": [
            {
              "type": "code-block",
              "language": "toml",
              "code": "# targets/docs.toml\n[target]\nname = \"docs\"\nremote = \"/var/www/docs\"\ndomain = \"docs.example.com\"\n\n[deploy]\npre = [\"npm run build\"]\ncommands = [\"rsync -avz --delete dist/ {{ssh}}:{{remote}}/\"]"
            }
          ]
        },
        {
          "id": "node-service",
          "title": "Node Service",
          "content": [
            {
              "type": "code-block",
              "language": "toml",
              "code": "[target]\nname = \"api\"\nremote = \"/home/{{work_user}}/api\"\n\n[deploy]\npre = [\"npm ci\", \"npm run build\"]\ncommands = [\"rsync -avz --exclude='node_modules' . {{ssh}}:{{remote}}/\"]\npost = [\n    \"ssh {{ssh}} 'cd {{remote}} && npm ci --production'\",\n    \"ssh {{ssh}} 'tsm restart api'\"\n]"
            }
          ]
        },
        {
          "id": "cwd-mode",
          "title": "CWD Mode",
          "content": [
            {
              "type": "paragraph",
              "text": "Deploy from current directory using local tetra-deploy.toml:"
            },
            {
              "type": "code-block",
              "language": "bash",
              "code": "cd ~/src/myproject\ndeploy push prod    # uses ./tetra-deploy.toml"
            }
          ]
        }
      ]
    },
    {
      "id": "structure",
      "title": "Structure",
      "topics": [
        {
          "id": "directory-layout",
          "title": "Directory Layout",
          "content": [
            {
              "type": "code-block",
              "language": "text",
              "code": "$TETRA_DIR/orgs/{org}/\n├── tetra.toml         # Org config (hosts, users)\n└── targets/\n    ├── docs.toml      # Deploy config\n    └── api.toml"
            }
          ]
        }
      ]
    },
    {
      "id": "troubleshooting",
      "title": "Troubleshooting",
      "topics": [
        {
          "id": "common-issues",
          "title": "Common Issues",
          "content": [
            {
              "type": "table",
              "headers": [
                "Issue",
                "Solution"
              ],
              "rows": [
                [
                  "No active org",
                  "org switch <name>"
                ],
                [
                  "Target not found",
                  "Check targets/ dir"
                ],
                [
                  "SSH failed",
                  "tkm test"
                ],
                [
                  "rsync fails",
                  "ssh {{ssh}} 'mkdir -p {{remote}}'"
                ]
              ]
            }
          ]
        },
        {
          "id": "debugging",
          "title": "Debugging",
          "content": [
            {
              "type": "code-block",
              "language": "bash",
              "code": "deploy doctor\ndeploy show myapp prod\ndeploy push --dry-run myapp prod"
            }
          ]
        }
      ]
    }
  ]
}
