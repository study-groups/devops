{
  "metadata": {
    "title": "Games Reference",
    "tagline": "Game asset deployment to S3",
    "version": "0.0.1",
    "description": "Reference for deploy games - syncing local game builds to DigitalOcean Spaces (S3)",
    "author": "tetra",
    "created": "2025-12-07T00:00:00Z",
    "updated": "2025-12-13T19:06:47Z"
  },
  "groups": [
    {
      "id": "overview",
      "title": "Overview",
      "topics": [
        {
          "id": "architecture",
          "title": "Architecture",
          "content": [
            {
              "type": "paragraph",
              "text": "Games are stored in DigitalOcean Spaces (S3-compatible) and served to clients via the arcade server's proxy. Local game builds sync to S3; no server filesystem push is needed."
            },
            {
              "type": "code-block",
              "language": "text",
              "code": "Local dev                    S3 (DO Spaces)               Arcade Server\n~/pj/pja-games/             s3://pja-games/              /api/game-files/\n├── cheap-golf/      sync   ├── cheap-golf/                     │\n├── grid-ranger/     ────►  ├── grid-ranger/                    │\n└── pong/                   └── pong/                           ▼\n                                                          iframe in /play/[game]"
            },
            {
              "type": "paragraph",
              "text": "The arcade server proxies S3 to clients via /api/game-files/[...path]. It checks local filesystem first (for local-only games like pja-docs), then falls back to S3."
            }
          ]
        },
        {
          "id": "quick-start",
          "title": "Quick Start",
          "content": [
            {
              "type": "code-block",
              "language": "bash",
              "code": "# List local games\ndeploy games list\n\n# Preview sync to S3\ndeploy games sync --dry-run\n\n# Sync all games to S3\ndeploy games sync\n\n# Sync single game\ndeploy games sync cheap-golf"
            }
          ]
        },
        {
          "id": "prerequisites",
          "title": "Prerequisites",
          "content": [
            {
              "type": "paragraph",
              "text": "Before using deploy games, ensure the spaces module is loaded and configured:"
            },
            {
              "type": "table",
              "headers": [
                "Requirement",
                "Check",
                "Setup"
              ],
              "rows": [
                [
                  "Spaces module",
                  "type spaces_sync",
                  "source $TETRA_SRC/bash/spaces/includes.sh"
                ],
                [
                  "S3 credentials",
                  "spaces_list pja-games:",
                  "Configure DO Spaces API keys"
                ],
                [
                  "Local games dir",
                  "ls ~/pj/pja-games",
                  "Build games to local directory"
                ]
              ]
            }
          ]
        }
      ]
    },
    {
      "id": "configuration",
      "title": "Configuration",
      "topics": [
        {
          "id": "tetra-toml",
          "title": "tetra.toml Configuration",
          "content": [
            {
              "type": "paragraph",
              "text": "Games configuration lives in the organization's tetra.toml [games] section:"
            },
            {
              "type": "code-block",
              "language": "toml",
              "code": "[games]\nlocal_path = \"~/pj/pja-games\"\ns3_bucket = \"pja-games\""
            },
            {
              "type": "table",
              "headers": [
                "Key",
                "Default",
                "Description"
              ],
              "rows": [
                [
                  "local_path",
                  "~/pj/pja-games",
                  "Local directory containing game builds"
                ],
                [
                  "s3_bucket",
                  "pja-games",
                  "DigitalOcean Spaces bucket name"
                ]
              ]
            }
          ]
        },
        {
          "id": "directory-structure",
          "title": "Directory Structure",
          "content": [
            {
              "type": "paragraph",
              "text": "Each game is a directory containing its build output (HTML, JS, assets):"
            },
            {
              "type": "code-block",
              "language": "text",
              "code": "~/pj/pja-games/\n├── cheap-golf/           # Game directory\n│   ├── index.html        # Entry point\n│   ├── game.js           # Game code\n│   └── assets/           # Images, sounds, etc.\n├── grid-ranger/\n├── pong/\n└── pja-docs/             # Excluded (local-only)"
            },
            {
              "type": "paragraph",
              "text": "The pja-docs directory and .zip files are automatically excluded from sync."
            }
          ]
        },
        {
          "id": "exclusions",
          "title": "Exclusions",
          "content": [
            {
              "type": "paragraph",
              "text": "These items are automatically excluded from sync:"
            },
            {
              "type": "list",
              "items": [
                "pja-docs/ - Local-only documentation",
                "*.zip files - Archived builds"
              ]
            }
          ]
        }
      ]
    },
    {
      "id": "commands",
      "title": "Commands",
      "topics": [
        {
          "id": "list-command",
          "title": "deploy games list",
          "content": [
            {
              "type": "paragraph",
              "text": "List games in local directory or S3 bucket."
            },
            {
              "type": "command-list",
              "commands": [
                {
                  "code": "deploy games list",
                  "description": "List local games (default)"
                },
                {
                  "code": "deploy games list --local",
                  "description": "List local games (explicit)"
                },
                {
                  "code": "deploy games list -l",
                  "description": "List local games (short flag)"
                },
                {
                  "code": "deploy games list --s3",
                  "description": "List games in S3 bucket"
                },
                {
                  "code": "deploy games list -s",
                  "description": "List S3 games (short flag)"
                }
              ]
            },
            {
              "type": "code-block",
              "language": "bash",
              "code": "$ deploy games list\nLocal games (~/pj/pja-games):\n  cheap-golf\n  grid-ranger\n  pong\n\n$ deploy games list --s3\nS3 games (pja-games):\n  cheap-golf\n  grid-ranger"
            }
          ]
        },
        {
          "id": "sync-command",
          "title": "deploy games sync",
          "content": [
            {
              "type": "paragraph",
              "text": "Sync game(s) from local directory to S3 bucket."
            },
            {
              "type": "command-list",
              "commands": [
                {
                  "code": "deploy games sync",
                  "description": "Sync all games to S3"
                },
                {
                  "code": "deploy games sync <game>",
                  "description": "Sync single game to S3"
                },
                {
                  "code": "deploy games sync --dry-run",
                  "description": "Preview sync without uploading"
                },
                {
                  "code": "deploy games sync -n <game>",
                  "description": "Dry-run for single game"
                }
              ]
            },
            {
              "type": "code-block",
              "language": "bash",
              "code": "$ deploy games sync cheap-golf\nSyncing: cheap-golf -> s3://pja-games/cheap-golf/\nupload: index.html\nupload: game.js\nupload: assets/sprite.png\n\n$ deploy games sync\nSyncing all games to S3...\n\n=== cheap-golf ===\n(files synced)\n\n=== grid-ranger ===\n(files synced)\n\n=== pong ===\n(files synced)\n\nSynced 3 games"
            }
          ]
        },
        {
          "id": "status-command",
          "title": "deploy games status",
          "content": [
            {
              "type": "paragraph",
              "text": "Compare local games vs S3 bucket contents."
            },
            {
              "type": "command-list",
              "commands": [
                {
                  "code": "deploy games status",
                  "description": "Show sync status for all games"
                }
              ]
            },
            {
              "type": "code-block",
              "language": "bash",
              "code": "$ deploy games status\nGame Status\n===========\n\nGame                 Local      S3\n----                 -----      --\ncheap-golf           yes        yes\ngrid-ranger          yes        yes\npong                 yes        --\nold-game             --         yes"
            },
            {
              "type": "paragraph",
              "text": "Games with 'yes' in Local but '--' in S3 need to be synced. Games with '--' in Local but 'yes' in S3 may be orphaned."
            }
          ]
        },
        {
          "id": "help-command",
          "title": "deploy games help",
          "content": [
            {
              "type": "command-list",
              "commands": [
                {
                  "code": "deploy games help",
                  "description": "Show help for games subcommand"
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "id": "workflows",
      "title": "Workflows",
      "topics": [
        {
          "id": "new-game-workflow",
          "title": "Adding a New Game",
          "content": [
            {
              "type": "code-block",
              "language": "bash",
              "code": "# 1. Build game to local directory\ncd ~/src/my-game\nnpm run build\ncp -r dist ~/pj/pja-games/my-game\n\n# 2. Verify it appears in list\ndeploy games list\n\n# 3. Preview sync\ndeploy games sync --dry-run my-game\n\n# 4. Sync to S3\ndeploy games sync my-game\n\n# 5. Verify in S3\ndeploy games list --s3"
            }
          ]
        },
        {
          "id": "update-game-workflow",
          "title": "Updating a Game",
          "content": [
            {
              "type": "code-block",
              "language": "bash",
              "code": "# 1. Rebuild game locally\ncd ~/src/cheap-golf\nnpm run build\ncp -r dist/* ~/pj/pja-games/cheap-golf/\n\n# 2. Sync changes to S3\ndeploy games sync cheap-golf"
            },
            {
              "type": "paragraph",
              "text": "The sync command uses rsync internally, so only changed files are uploaded."
            }
          ]
        },
        {
          "id": "bulk-sync-workflow",
          "title": "Bulk Sync All Games",
          "content": [
            {
              "type": "code-block",
              "language": "bash",
              "code": "# Check what needs syncing\ndeploy games status\n\n# Preview all syncs\ndeploy games sync --dry-run\n\n# Sync everything\ndeploy games sync"
            }
          ]
        },
        {
          "id": "verify-workflow",
          "title": "Verifying Deployment",
          "content": [
            {
              "type": "code-block",
              "language": "bash",
              "code": "# Compare local vs S3\ndeploy games status\n\n# List S3 contents\ndeploy games list --s3\n\n# Direct S3 inspection\nspaces_list pja-games:cheap-golf/"
            }
          ]
        }
      ]
    },
    {
      "id": "integration",
      "title": "Integration",
      "topics": [
        {
          "id": "spaces-module",
          "title": "Spaces Module",
          "content": [
            {
              "type": "paragraph",
              "text": "Deploy games uses the tetra spaces module for S3 operations:"
            },
            {
              "type": "table",
              "headers": [
                "Function",
                "Used For"
              ],
              "rows": [
                [
                  "spaces_sync",
                  "Upload game directories to S3"
                ],
                [
                  "spaces_list",
                  "List S3 bucket contents"
                ]
              ]
            },
            {
              "type": "code-block",
              "language": "bash",
              "code": "# Ensure spaces module is loaded\nsource $TETRA_SRC/bash/spaces/includes.sh\n\n# Test connectivity\nspaces_list pja-games:"
            }
          ]
        },
        {
          "id": "arcade-server",
          "title": "Arcade Server Integration",
          "content": [
            {
              "type": "paragraph",
              "text": "The arcade server proxies S3 game files to clients. No server push is needed after S3 sync."
            },
            {
              "type": "code-block",
              "language": "text",
              "code": "Client Request               Server Behavior\n─────────────────────────────────────────────────────\nGET /play/cheap-golf    ->   Render game page with iframe\nGET /api/game-files/    ->   Check local, then proxy S3\n    cheap-golf/index.html"
            },
            {
              "type": "paragraph",
              "text": "The game manifest (src/lib/data/games.json) defines available games and their access control. Deploy games only handles asset sync - manifest updates are separate."
            }
          ]
        },
        {
          "id": "org-toml",
          "title": "Org Configuration",
          "content": [
            {
              "type": "paragraph",
              "text": "Games configuration is read from the active organization's tetra.toml using org_toml_get:"
            },
            {
              "type": "code-block",
              "language": "bash",
              "code": "# Check current games config\norg_toml_get \"games.local_path\"\norg_toml_get \"games.s3_bucket\"\n\n# Edit org config\norg edit"
            }
          ]
        }
      ]
    },
    {
      "id": "troubleshooting",
      "title": "Troubleshooting",
      "topics": [
        {
          "id": "common-issues",
          "title": "Common Issues",
          "content": [
            {
              "type": "table",
              "headers": [
                "Issue",
                "Cause",
                "Solution"
              ],
              "rows": [
                [
                  "spaces module not loaded",
                  "Module not sourced",
                  "source $TETRA_SRC/bash/spaces/includes.sh"
                ],
                [
                  "directory not found",
                  "Wrong local_path",
                  "Check [games] in tetra.toml"
                ],
                [
                  "Game not found",
                  "Game dir doesn't exist",
                  "Build game to local_path first"
                ],
                [
                  "S3 access denied",
                  "Missing credentials",
                  "Configure DO Spaces API keys"
                ],
                [
                  "Nothing synced",
                  "All files up to date",
                  "Use --dry-run to see file list"
                ]
              ]
            }
          ]
        },
        {
          "id": "diagnostics",
          "title": "Diagnostics",
          "content": [
            {
              "type": "code-block",
              "language": "bash",
              "code": "# Check spaces module\ntype spaces_sync\ntype spaces_list\n\n# Check config\norg_toml_get \"games.local_path\"\norg_toml_get \"games.s3_bucket\"\n\n# Check local directory\nls -la ~/pj/pja-games/\n\n# Check S3 connectivity\nspaces_list pja-games:\n\n# Verbose sync\ndeploy games sync --dry-run"
            }
          ]
        }
      ]
    }
  ]
}
