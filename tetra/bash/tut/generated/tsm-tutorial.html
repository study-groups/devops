<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSM Tutorial</title>

    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --bg-primary: #0d1117;
    --bg-secondary: #161b22;
    --bg-tertiary: #21262d;
    --text-primary: #c9d1d9;
    --text-secondary: #8b949e;
    --accent-primary: #58a6ff;
    --accent-secondary: #1f6feb;
    --success: #3fb950;
    --warning: #d29922;
    --error: #f85149;
    --border: #30363d;
    --highlight: #388bfd26;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
    background: var(--bg-primary);
    min-height: 100vh;
    padding: 0;
    color: var(--text-primary);
    margin: 0;
}

.container {
    max-width: 1600px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    align-items: start;
    padding: 1rem;
}

.panel {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
    min-height: 600px;
}

.narrative-panel {
    margin-right: 0.5rem;
}

.terminal-panel {
    position: sticky;
    top: 1rem;
    margin-left: 0.5rem;
    max-height: calc(100vh - 2rem);
    overflow: hidden;
}

.panel-header {
    padding: 0.75rem 1rem;
    font-weight: 600;
    font-size: 0.85rem;
    letter-spacing: 0.3px;
    border-bottom: 1px solid var(--border);
    background: var(--bg-tertiary);
    color: var(--text-secondary);
}

/* Narrative Styles */
.narrative-content {
    padding: 2rem;
    line-height: 1.7;
    overflow-y: auto;
}

.step {
    margin-bottom: 3rem;
    display: none;
}

.step.active {
    display: block;
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.step-number {
    display: inline-block;
    background: var(--bg-tertiary);
    color: var(--accent-primary);
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
    margin-bottom: 1rem;
    border: 1px solid var(--border);
    font-family: 'Courier New', monospace;
}

.step h2 {
    color: var(--text-primary);
    margin-bottom: 1rem;
    font-size: 1.4rem;
    font-weight: 600;
}

.step h3 {
    color: var(--text-primary);
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-size: 1.1rem;
    font-weight: 600;
}

.step p {
    margin-bottom: 1rem;
    color: var(--text-secondary);
}

.subtitle {
    font-style: italic;
    font-size: 0.95rem;
}

.you-try {
    background: var(--bg-tertiary);
    border: 1px solid var(--warning);
    padding: 1.25rem;
    margin: 1.5rem 0;
    border-radius: 6px;
}

.you-try-header {
    font-weight: 700;
    color: var(--warning);
    margin-bottom: 0.75rem;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.you-try-header::before {
    content: "‚Üí";
    font-size: 1.2rem;
    font-weight: bold;
}

.you-try p {
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.command-hint {
    background: var(--bg-primary);
    padding: 0.75rem 1rem;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    color: var(--accent-primary);
    margin-top: 0.5rem;
    border: 1px solid var(--border);
    overflow-x: auto;
}

.learn-box {
    background: var(--bg-tertiary);
    border: 1px solid var(--accent-secondary);
    padding: 1.25rem;
    margin: 1.5rem 0;
    border-radius: 6px;
}

.learn-box-header {
    font-weight: 700;
    color: var(--accent-primary);
    margin-bottom: 0.75rem;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.learn-box-header::before {
    content: "‚Ñπ";
    font-size: 1.2rem;
    font-weight: bold;
}

.learn-box ul {
    margin-left: 1.5rem;
    color: var(--text-secondary);
}

.learn-box li {
    margin-bottom: 0.4rem;
}

.learn-box p {
    color: var(--text-secondary);
}

.warning-box {
    background: var(--bg-tertiary);
    border: 1px solid var(--warning);
    padding: 1.25rem;
    margin: 1.5rem 0;
    border-radius: 6px;
}

.warning-box-header {
    font-weight: 700;
    color: var(--warning);
    margin-bottom: 0.75rem;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.warning-box-header::before {
    content: "‚ö†";
    font-size: 1.2rem;
    font-weight: bold;
}

/* Details Section */
.details-section {
    margin: 2rem 0;
    border: 1px solid var(--accent-secondary);
    border-radius: 6px;
    overflow: hidden;
}

.details-section.collapsed .details-content {
    display: none;
}

.details-toggle {
    padding: 1rem;
    background: var(--bg-tertiary);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    user-select: none;
    transition: background 0.2s;
}

.details-toggle:hover {
    background: var(--bg-primary);
}

.details-icon {
    font-size: 1.2rem;
}

.details-title {
    flex: 1;
    font-weight: 600;
    color: var(--accent-primary);
}

.details-arrow {
    color: var(--text-secondary);
    transition: transform 0.3s;
}

.details-section:not(.collapsed) .details-arrow {
    transform: rotate(180deg);
}

.details-content {
    padding: 1.5rem;
    background: var(--bg-secondary);
}

.details-content h4 {
    color: var(--accent-primary);
    font-size: 1rem;
    margin-bottom: 0.5rem;
}

.details-content p {
    color: var(--text-secondary);
    margin-bottom: 1rem;
    line-height: 1.6;
}

.detail-explanation,
.detail-code-dive,
.detail-architecture,
.detail-gotcha,
.detail-performance {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: var(--bg-tertiary);
    border-radius: 4px;
}

.detail-gotcha {
    border-left: 3px solid var(--warning);
}

/* Terminal Styles */
.terminal-window {
    background: var(--bg-primary);
    height: 100%;
    min-height: 600px;
    max-height: calc(100vh - 2rem);
    font-family: 'Courier New', Monaco, monospace;
    font-size: 13px;
    position: relative;
    display: flex;
    flex-direction: column;
}

.terminal-titlebar {
    background: var(--bg-tertiary);
    padding: 0.5rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
}

.terminal-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.dot-red { background: #ff5f56; }
.dot-yellow { background: #ffbd2e; }
.dot-green { background: #27c93f; }

.terminal-title {
    margin-left: 1rem;
    color: var(--text-secondary);
    font-size: 0.75rem;
}

.terminal-content {
    padding: 1.5rem;
    color: var(--text-primary);
    overflow-y: auto;
    flex: 1;
}

.terminal-line {
    margin-bottom: 0.5rem;
    display: none;
}

.terminal-line.visible {
    display: block;
    animation: terminalFadeIn 0.3s ease-in;
}

@keyframes terminalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.prompt {
    color: var(--success);
}

.command {
    color: var(--accent-primary);
}

.output {
    color: var(--text-secondary);
}

.output-header {
    color: var(--accent-primary);
    font-weight: bold;
}

.output-success {
    color: var(--success);
}

.output-warning {
    color: var(--warning);
}

.output-error {
    color: var(--error);
}

.comment {
    color: var(--text-secondary);
    opacity: 0.7;
}

.highlight {
    background: var(--highlight);
    padding: 0 0.2rem;
}

/* Navigation */
.navigation {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border);
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 100;
}

.nav-button {
    padding: 0.6rem 1.5rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.nav-button:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.nav-prev:hover:not(:disabled) {
    background: var(--bg-tertiary);
    border-color: var(--accent-primary);
}

.nav-next {
    background: var(--accent-secondary);
    border-color: var(--accent-secondary);
    color: white;
}

.nav-next:hover:not(:disabled) {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
}

.progress {
    text-align: center;
    color: var(--text-secondary);
    font-size: 0.85rem;
    padding: 0.5rem;
    flex: 1;
    font-family: 'Courier New', monospace;
}

/* Header */
.tutorial-header {
    text-align: center;
    color: var(--text-primary);
    padding: 2rem 1rem 1rem;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border);
}

.tutorial-header h1 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    font-weight: 700;
    color: var(--accent-primary);
}

.tutorial-header p {
    font-size: 1rem;
    color: var(--text-secondary);
}

code {
    background: var(--bg-tertiary);
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    color: var(--accent-primary);
    border: 1px solid var(--border);
}

ul {
    color: var(--text-secondary);
}

@media (max-width: 1200px) {
    .container {
        grid-template-columns: 1fr;
    }

    .terminal-panel {
        position: relative;
        top: 0;
        max-height: 600px;
        margin-left: 0;
        margin-top: 1rem;
    }

    .narrative-panel {
        margin-right: 0;
    }
}
    </style>
    <style>
/* Design Token Editor - FAB and Panel Styles */

/* Floating Action Button */
.design-fab {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--accent-secondary);
    border: 2px solid var(--accent-primary);
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 1000;
}

.design-fab:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(0,0,0,0.5);
}

/* Design Panel */
.design-panel {
    position: fixed;
    bottom: 5rem;
    right: 2rem;
    width: 320px;
    max-height: 70vh;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    display: none;
    flex-direction: column;
    z-index: 999;
    overflow: hidden;
}

.design-panel.visible {
    display: flex;
    animation: designPanelSlideUp 0.3s ease;
}

@keyframes designPanelSlideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.design-panel-header {
    padding: 1rem;
    background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border);
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.design-panel-close {
    cursor: pointer;
    color: var(--text-secondary);
    font-size: 1.2rem;
}

.design-panel-content {
    padding: 1rem;
    overflow-y: auto;
    flex: 1;
}

/* Styled scrollbar for design panel */
.design-panel-content::-webkit-scrollbar {
    width: 8px;
}

.design-panel-content::-webkit-scrollbar-track {
    background: var(--bg-primary);
    border-radius: 4px;
}

.design-panel-content::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 4px;
}

.design-panel-content::-webkit-scrollbar-thumb:hover {
    background: var(--accent-primary);
}

/* Token Groups and Items */
.token-group {
    margin-bottom: 1.5rem;
}

.token-group-title {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-secondary);
    margin-bottom: 0.75rem;
    font-weight: 600;
}

.token-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
}

.token-swatch {
    width: 32px;
    height: 32px;
    border-radius: 4px;
    border: 1px solid var(--border);
    flex-shrink: 0;
}

.token-info {
    flex: 1;
    min-width: 0;
}

.token-name {
    font-size: 0.75rem;
    font-family: 'Courier New', monospace;
    color: var(--text-secondary);
    margin-bottom: 0.15rem;
}

.token-value {
    font-size: 0.7rem;
    font-family: 'Courier New', monospace;
    color: var(--accent-primary);
}

.token-picker {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

/* Font Controls */
.font-select {
    width: 100%;
    padding: 0.5rem;
    background: var(--bg-primary);
    color: var(--text-primary);
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.85rem;
    cursor: pointer;
    margin-top: 0.5rem;
}

.font-select:focus {
    outline: none;
    border-color: var(--accent-primary);
}

.font-input {
    width: 100%;
    padding: 0.5rem;
    background: var(--bg-primary);
    color: var(--text-primary);
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.8rem;
    font-family: 'Courier New', monospace;
    margin-top: 0.5rem;
}

.font-input:focus {
    outline: none;
    border-color: var(--accent-primary);
}

.font-input::placeholder {
    color: var(--text-secondary);
    opacity: 0.5;
}

.add-font-btn {
    width: 100%;
    padding: 0.4rem;
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    margin-top: 0.5rem;
    transition: all 0.2s ease;
}

.add-font-btn:hover {
    border-color: var(--accent-primary);
    color: var(--accent-primary);
}

/* Font Example Toggle */
.font-example-toggle {
    font-size: 0.75rem;
    color: var(--accent-primary);
    cursor: pointer;
    margin-top: 0.5rem;
    display: inline-block;
    user-select: none;
}

.font-example-toggle:hover {
    text-decoration: underline;
}

.font-example-content {
    display: none;
    margin-top: 0.5rem;
    padding: 0.75rem;
    background: var(--bg-tertiary);
    border-radius: 4px;
    font-size: 0.7rem;
    color: var(--text-secondary);
    line-height: 1.6;
}

.font-example-content.expanded {
    display: block;
}

.font-example-content ol {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
}

.font-example-content li {
    margin-bottom: 0.5rem;
}

.font-example-content code {
    background: var(--bg-primary);
    padding: 0.2rem 0.4rem;
    border-radius: 2px;
    font-size: 0.65rem;
}

/* Panel Action Buttons */
.design-panel-buttons {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

.design-panel-btn {
    flex: 1;
    padding: 0.5rem;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.copy-tokens-btn {
    background: var(--accent-secondary);
    color: white;
    border-color: var(--accent-primary);
}

.copy-tokens-btn:hover {
    background: var(--accent-primary);
}

.copy-tokens-btn.copied {
    background: var(--success);
    border-color: var(--success);
}

.load-tokens-btn {
    background: var(--bg-tertiary);
    border-color: var(--border);
    color: var(--text-primary);
}

.load-tokens-btn:hover {
    border-color: var(--accent-primary);
    color: var(--accent-primary);
}

.reset-tokens-btn {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border-color: var(--border);
}

.reset-tokens-btn:hover {
    background: var(--bg-primary);
    border-color: var(--warning);
    color: var(--warning);
}

/* Element Inspector Panel */
#elementInspectorPanel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 600px;
    max-width: 90vw;
    max-height: 80vh;
    background: var(--bg-secondary);
    border: 2px solid var(--accent-primary);
    border-radius: 8px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    display: none;
    flex-direction: column;
    z-index: 10001;
    overflow: hidden;
}

#elementInspectorPanel.visible {
    display: flex;
}

#elementInspectorPanel .inspector-header {
    padding: 1rem;
    background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border);
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: move;
    user-select: none;
}

#elementInspectorPanel .inspector-content {
    padding: 1rem;
    overflow-y: auto;
    flex: 1;
    font-size: 0.85rem;
}

#elementInspectorPanel .inspector-content::-webkit-scrollbar {
    width: 12px;
}

#elementInspectorPanel .inspector-content::-webkit-scrollbar-track {
    background: var(--bg-primary);
    border-radius: 6px;
    margin: 4px;
}

#elementInspectorPanel .inspector-content::-webkit-scrollbar-thumb {
    background: var(--accent-secondary);
    border-radius: 6px;
    border: 2px solid var(--bg-primary);
}

#elementInspectorPanel .inspector-content::-webkit-scrollbar-thumb:hover {
    background: var(--accent-primary);
}
    </style>
    <style>
        :root {
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
        }
    </style>
</head>
<body>
    <div class="tutorial-header">
        <h1>TSM Tutorial</h1>
        <p>Master the Tetra Service Manager</p>
    </div>
    <div class="navigation">
        <button class="nav-button nav-prev" onclick="prevStep()" id="prevBtn" disabled>‚Üê Previous</button>
        <div class="progress" id="progress">Step 1 of 11</div>
        <button class="nav-button nav-next" onclick="nextStep()" id="nextBtn">Next ‚Üí</button>
    </div>
    <div class="container">
        <!-- Narrative Panel (Left) -->
        <div class="panel narrative-panel">
            <div class="panel-header">Tutorial Guide</div>
            <div class="narrative-content">
                <!-- Step 0: Welcome to TSM -->
                <div class="step active" data-step="0">
                    <span class="step-number">Step 1</span>
                    <h2>Welcome to TSM</h2>
                    <p class="subtitle">The Tetra Service Manager</p>
                    <p>TSM (Tetra Service Manager) is tetra's built-in process orchestrator. It manages long-running services, allocates named ports, handles logging, and monitors process health.</p>
                    <p>Unlike systemd or supervisord, TSM is lightweight, bash-native, and deeply integrated with tetra's architecture patterns.</p>
                    <div class="learn-box">
                        <div class="learn-box-header">What You'll Learn</div>
                        <ul>
                            <li>How to start and stop services with TSM</li>
                            <li>Understanding service definitions and manifests</li>
                            <li>Port allocation and named ports</li>
                            <li>Log management and monitoring</li>
                            <li>Process inspection and health checks</li>
                        </ul>
                    </div>
                    <div class="learn-box">
                        <div class="learn-box-header">Prerequisites</div>
                        <p>Before starting, ensure you have:</p>
                        <ul>
                            <li>Tetra installed and sourced</li>
                            <li>A terminal window open</li>
                            <li>Basic familiarity with bash commands</li>
                        </ul>
                    </div>
                </div>

                <!-- Step 1: Bootstrap TSM -->
                <div class="step" data-step="1">
                    <span class="step-number">Step 2</span>
                    <h2>Bootstrap TSM</h2>
                    <p class="subtitle">Load the TSM module</p>
                    <p>TSM is a tetra module, so we load it the standard way: source its includes.sh file. This sets up TSM_SRC and TSM_DIR globals and initializes the service manager.</p>
                    <div class="you-try">
                        <div class="you-try-header">Load TSM</div>
                        <p>First, ensure tetra is loaded, then source TSM:</p>
                        <div class="command-hint">
cd ~/tetra
<br>
source ~/tetra/tetra.sh
<br>
source "$TETRA_SRC/bash/tsm/includes.sh"
                        </div>
                    </div>
                    <p>TSM is now loaded! Let's verify it's working by checking the help.</p>
                    <div class="you-try">
                        <div class="you-try-header">Check TSM Help</div>
                        <div class="command-hint">
tsm help
                        </div>
                    </div>
                    <div class="details-section collapsed">
                        <div class="details-toggle" onclick="toggleDetails(this)">
                            <span class="details-icon">üîç</span>
                            <span class="details-title">Under the Hood</span>
                            <span class="details-arrow">‚ñº</span>
                        </div>
                        <div class="details-content">
                            <div class="detail-explanation">
                                <h4>What happens when TSM loads?</h4>
                                <p>The includes.sh file sets TSM_SRC and TSM_DIR, creates runtime directories, and sources tsm.sh which loads all TSM components in dependency order: core utilities, process management, port resolution, logging, and monitoring.</p>
                            </div>
                            <div class="detail-code-dive">
                                <h4>Strong globals pattern</h4>
                                <p>null</p>
                            </div>
                            <div class="detail-architecture">
                                <h4>TSM directory structure</h4>
                                <p>TSM uses dual directories:

**TSM_SRC** (source code, in git):
  - bash/tsm/core/        # Core functionality
  - bash/tsm/process/     # Process management
  - bash/tsm/system/      # System integration
  - bash/tsm/services/    # Service definitions

**TSM_DIR** (runtime data, ephemeral):
  - tsm/runtime/processes/  # Process metadata
  - tsm/logs/               # Service logs
  - tsm/sockets/            # Unix domain sockets

This separation allows git to track code while ignoring runtime state.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: List Available Services -->
                <div class="step" data-step="2">
                    <span class="step-number">Step 3</span>
                    <h2>List Available Services</h2>
                    <p class="subtitle">Discover what services TSM knows about</p>
                    <p>TSM manages services defined in the services/ directory. Each service has a definition file that specifies how to start it, what ports it needs, and other metadata.</p>
                    <div class="you-try">
                        <div class="you-try-header">List Available Services</div>
                        <div class="command-hint">
tsm list available
                        </div>
                    </div>
                    <p>You'll see services like 'chroma' (vector database), 'devpages' (dev server), and others that are available to start.</p>
                    <div class="details-section collapsed">
                        <div class="details-toggle" onclick="toggleDetails(this)">
                            <span class="details-icon">üîç</span>
                            <span class="details-title">Under the Hood</span>
                            <span class="details-arrow">‚ñº</span>
                        </div>
                        <div class="details-content">
                            <div class="detail-explanation">
                                <h4>Service definitions</h4>
                                <p>Services are defined in bash/tsm/services/definitions.sh. Each service has:
- A unique name
- Start command
- Named port(s)
- Health check endpoint
- Log location
- Restart policy</p>
                            </div>
                            <div class="detail-code-dive">
                                <h4>Example service definition</h4>
                                <p>null</p>
                            </div>
                            <div class="detail-gotcha">
                                <h4>Service vs Process</h4>
                                <p>TSM distinguishes between:
- **Service**: A definition (how to start something)
- **Process**: A running instance of a service

One service can have multiple processes (think: scaled workers).</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Start a Service -->
                <div class="step" data-step="3">
                    <span class="step-number">Step 4</span>
                    <h2>Start a Service</h2>
                    <p class="subtitle">Launch a managed process</p>
                    <p>Starting a service with TSM is simple: tsm start <service-name>. TSM will allocate ports, set up logging, and manage the process lifecycle.</p>
                    <div class="you-try">
                        <div class="you-try-header">Start a Service</div>
                        <p>Let's start the chroma service (if you have it installed):</p>
                        <div class="command-hint">
tsm start chroma
                        </div>
                    </div>
                    <div class="learn-box">
                        <div class="learn-box-header">What TSM Does</div>
                        <ul>
                            <li>Allocates the named port 'chroma-api'</li>
                            <li>Creates a unique process ID</li>
                            <li>Stores process metadata in TSM_DIR/runtime/processes/</li>
                            <li>Redirects stdout/stderr to TSM_DIR/logs/</li>
                            <li>Starts the service in the background</li>
                            <li>Registers the process for monitoring</li>
                        </ul>
                    </div>
                    <div class="details-section collapsed">
                        <div class="details-toggle" onclick="toggleDetails(this)">
                            <span class="details-icon">üîç</span>
                            <span class="details-title">Under the Hood</span>
                            <span class="details-arrow">‚ñº</span>
                        </div>
                        <div class="details-content">
                            <div class="detail-explanation">
                                <h4>Process metadata</h4>
                                <p>When TSM starts a service, it creates a metadata file in TSM_DIR/runtime/processes/<id>.json containing:
- Service name
- PID
- Port allocations
- Start time
- Command line
- Environment variables
- Log paths

This metadata persists across terminal sessions.</p>
                            </div>
                            <div class="detail-architecture">
                                <h4>Port allocation strategy</h4>
                                <p>TSM uses **named ports** instead of hardcoding numbers:

1. Service requests port by name (e.g., 'chroma-api')
2. TSM checks system/ports.sh for default
3. If port is in use, TSM finds next available
4. Allocation is recorded in TSM_DIR/runtime/ports.db
5. Service is started with PORT env var set

This prevents port conflicts and makes configuration explicit.</p>
                            </div>
                            <div class="detail-gotcha">
                                <h4>Background processes</h4>
                                <p>TSM uses bash's job control to manage background processes. The process is started with nohup and redirected to logs. TSM monitors it via PID file, not job ID.</p>
                            </div>
                            <div class="detail-performance">
                                <h4>Startup time</h4>
                                <p>TSM startup overhead is minimal (~50ms) because it's pure bash. Compare to systemd (300ms+) or Docker (1s+). Services start at native speed.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Inspect Running Processes -->
                <div class="step" data-step="4">
                    <span class="step-number">Step 5</span>
                    <h2>Inspect Running Processes</h2>
                    <p class="subtitle">View process details and metadata</p>
                    <p>TSM provides detailed inspection of running processes. You can view metadata, logs, resource usage, and health status.</p>
                    <div class="you-try">
                        <div class="you-try-header">Inspect a Process</div>
                        <p>Use the process ID from the previous step:</p>
                        <div class="command-hint">
tsm show tsm-chroma-1732567890
                        </div>
                    </div>
                    <div class="details-section collapsed">
                        <div class="details-toggle" onclick="toggleDetails(this)">
                            <span class="details-icon">üîç</span>
                            <span class="details-title">Under the Hood</span>
                            <span class="details-arrow">‚ñº</span>
                        </div>
                        <div class="details-content">
                            <div class="detail-explanation">
                                <h4>Health checks</h4>
                                <p>TSM performs periodic health checks:
1. PID exists (via kill -0)
2. Port is listening (via netstat)
3. HTTP endpoint returns 200 (if configured)
4. No recent crashes (log parsing)

Health status: healthy, degraded, unhealthy, crashed</p>
                            </div>
                            <div class="detail-code-dive">
                                <h4>Resource monitoring</h4>
                                <p>null</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 5: View Service Logs -->
                <div class="step" data-step="5">
                    <span class="step-number">Step 6</span>
                    <h2>View Service Logs</h2>
                    <p class="subtitle">Access stdout and stderr</p>
                    <p>Every service managed by TSM has its output captured to structured log files. You can view logs with tsm logs or tail them in real-time.</p>
                    <div class="you-try">
                        <div class="you-try-header">View Logs</div>
                        <div class="command-hint">
tsm logs tsm-chroma-1732567890
<br>
tsm logs tsm-chroma-1732567890 --follow
                        </div>
                    </div>
                    <div class="details-section collapsed">
                        <div class="details-toggle" onclick="toggleDetails(this)">
                            <span class="details-icon">üîç</span>
                            <span class="details-title">Under the Hood</span>
                            <span class="details-arrow">‚ñº</span>
                        </div>
                        <div class="details-content">
                            <div class="detail-explanation">
                                <h4>Structured logging</h4>
                                <p>TSM logs are timestamped and can be queried. The tsm_logs_query.sh module provides grep-like functionality:

tsm logs <id> --since '5m ago'
tsm logs <id> --level ERROR
tsm logs <id> --grep 'startup'</p>
                            </div>
                            <div class="detail-architecture">
                                <h4>Log rotation</h4>
                                <p>TSM implements log rotation:
- Max file size: 10MB (configurable)
- Rotated logs: <id>.log.1, <id>.log.2, etc.
- Max rotations: 5 (keeps last 50MB)
- Old logs compressed with gzip

Patrol system runs cleanup daily.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 6: Port Management -->
                <div class="step" data-step="6">
                    <span class="step-number">Step 7</span>
                    <h2>Port Management</h2>
                    <p class="subtitle">Understanding named ports</p>
                    <p>TSM uses 'named ports' instead of hardcoded port numbers. This makes services portable and prevents conflicts.</p>
                    <div class="you-try">
                        <div class="you-try-header">List Ports</div>
                        <div class="command-hint">
tsm ports
                        </div>
                    </div>
                    <div class="learn-box">
                        <div class="learn-box-header">Named Port Benefits</div>
                        <ul>
                            <li>Services request by name, not number</li>
                            <li>TSM allocates from available pool</li>
                            <li>Prevents port conflicts automatically</li>
                            <li>Environment-specific overrides (dev vs prod)</li>
                            <li>Clear service inventory</li>
                        </ul>
                    </div>
                    <div class="details-section collapsed">
                        <div class="details-toggle" onclick="toggleDetails(this)">
                            <span class="details-icon">üîç</span>
                            <span class="details-title">Under the Hood</span>
                            <span class="details-arrow">‚ñº</span>
                        </div>
                        <div class="details-content">
                            <div class="detail-explanation">
                                <h4>Port resolution algorithm</h4>
                                <p>When a service requests a named port:
1. Look up default in system/ports.sh
2. Check if default is available (netstat)
3. If taken, increment and retry (8000 ‚Üí 8001 ‚Üí 8002...)
4. Record allocation in TSM_DIR/runtime/ports.db
5. Set $PORT environment variable
6. Return allocated port to caller</p>
                            </div>
                            <div class="detail-code-dive">
                                <h4>Port database</h4>
                                <p>null</p>
                            </div>
                            <div class="detail-gotcha">
                                <h4>Port cleanup</h4>
                                <p>When a process stops, TSM should release its port. If TSM crashes, stale allocations may remain. Use 'tsm ports cleanup' to remove allocations for dead processes.</p>
                            </div>
                            <div class="detail-comparison">
                                <h4>Port strategies</h4>
                                <p>Different approaches to port management:</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 7: Stop a Service -->
                <div class="step" data-step="7">
                    <span class="step-number">Step 8</span>
                    <h2>Stop a Service</h2>
                    <p class="subtitle">Graceful and forceful shutdown</p>
                    <p>Stopping services with TSM is clean and safe. TSM sends SIGTERM first (graceful), waits, then SIGKILL if needed (forceful).</p>
                    <div class="you-try">
                        <div class="you-try-header">Stop a Service</div>
                        <div class="command-hint">
tsm stop tsm-chroma-1732567890
                        </div>
                    </div>
                    <div class="warning-box">
                        <div class="warning-box-header">Graceful Shutdown</div>
                        <p>TSM waits 10 seconds for graceful shutdown. Services should handle SIGTERM to clean up resources (close files, flush buffers, etc.).</p>
                    </div>
                    <div class="details-section collapsed">
                        <div class="details-toggle" onclick="toggleDetails(this)">
                            <span class="details-icon">üîç</span>
                            <span class="details-title">Under the Hood</span>
                            <span class="details-arrow">‚ñº</span>
                        </div>
                        <div class="details-content">
                            <div class="detail-explanation">
                                <h4>Shutdown sequence</h4>
                                <p>TSM's stop process:
1. Send SIGTERM (signal 15)
2. Poll PID every 500ms
3. After 10s timeout, send SIGKILL (signal 9)
4. Remove process metadata file
5. Release allocated ports
6. Mark logs as archived
7. Trigger cleanup hooks</p>
                            </div>
                            <div class="detail-gotcha">
                                <h4>Zombie processes</h4>
                                <p>If a parent process doesn't wait() for its children, they become zombies (defunct). TSM monitors for this and warns. Services should properly manage child processes or use process groups.</p>
                            </div>
                            <div class="detail-further-reading">
                                <h4>Related Topics</h4>
                                <p>null</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 8: Restart Services -->
                <div class="step" data-step="8">
                    <span class="step-number">Step 9</span>
                    <h2>Restart Services</h2>
                    <p class="subtitle">Update running services</p>
                    <p>Restarting is simply stop + start with the same configuration. Useful after config changes or code updates.</p>
                    <div class="you-try">
                        <div class="you-try-header">Restart a Service</div>
                        <div class="command-hint">
tsm restart tsm-chroma-1732567890
                        </div>
                    </div>
                </div>

                <!-- Step 9: Advanced Features -->
                <div class="step" data-step="9">
                    <span class="step-number">Step 10</span>
                    <h2>Advanced Features</h2>
                    <p class="subtitle">Multi-user, monitoring, and integrations</p>
                    <p>TSM includes advanced features for production use:</p>
                    <div class="learn-box">
                        <div class="learn-box-header">Production Features</div>
                        <ul>
                            <li>Multi-user support (user namespaces)</li>
                            <li>Resource limits (CPU, memory)</li>
                            <li>Automatic restart on failure</li>
                            <li>Health monitoring and alerting</li>
                            <li>Systemd integration (optional)</li>
                            <li>Remote management via SSH</li>
                        </ul>
                    </div>
                    <div class="code-block">
                        <pre><code class="language-bash"># Multi-user example
export TSM_USER=alice
tsm start myservice  # Runs as alice

# Resource limits
tsm start myservice --memory 512M --cpu 50%

# Auto-restart
tsm start myservice --restart always

# Remote management
tsm remote host1 list</code></pre>
                        <div class="code-caption">Advanced TSM usage</div>
                    </div>
                    <div class="details-section collapsed">
                        <div class="details-toggle" onclick="toggleDetails(this)">
                            <span class="details-icon">üîç</span>
                            <span class="details-title">Under the Hood</span>
                            <span class="details-arrow">‚ñº</span>
                        </div>
                        <div class="details-content">
                            <div class="detail-architecture">
                                <h4>Multi-user implementation</h4>
                                <p>TSM uses separate directories per user:

TSM_DIR/
  alice/
    runtime/processes/
    logs/
  bob/
    runtime/processes/
    logs/

Each user has isolated namespace for process IDs, ports, and logs. Root can view all users.</p>
                            </div>
                            <div class="detail-explanation">
                                <h4>Auto-restart mechanism</h4>
                                <p>TSM's patrol system (system/patrol.sh) runs every 60 seconds:
1. Check all processes with restart policy
2. Detect crashed processes (PID gone)
3. Check restart count and backoff
4. Restart with exponential backoff (1s, 2s, 4s, 8s...)
5. Alert if restart limit exceeded</p>
                            </div>
                            <div class="detail-performance">
                                <h4>Resource overhead</h4>
                                <p>TSM itself is lightweight:
- Process spawning: <50ms
- Monitoring overhead: <1% CPU
- Memory per process: ~2MB metadata
- Disk: ~10KB metadata + logs

Compare to Docker (100MB+ per container) or systemd (complex unit files).</p>
                            </div>
                            <div class="detail-history">
                                <h4>Why TSM exists</h4>
                                <p>TSM was created because:
1. systemd too heavy for dev environments
2. Docker overkill for simple processes
3. Wanted bash-native solution
4. Needed tight tetra integration
5. Named ports solve real pain point

TSM is opinionated but practical.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 10: Mastering TSM -->
                <div class="step" data-step="10">
                    <span class="step-number">Step 11</span>
                    <h2>Mastering TSM</h2>
                    <p class="subtitle">You're now a TSM expert!</p>
                    <p>Congratulations! You've learned how to use TSM to manage services, allocate ports, view logs, and monitor processes.</p>
                    <div class="learn-box">
                        <div class="learn-box-header">What You Learned</div>
                        <ul>
                            <li>Loading TSM and listing services</li>
                            <li>Starting and stopping services</li>
                            <li>Named port allocation system</li>
                            <li>Log viewing and management</li>
                            <li>Process inspection and monitoring</li>
                            <li>Advanced features (multi-user, auto-restart)</li>
                        </ul>
                    </div>
                    <p>Next steps:</p>
                    <ul style="margin-left: 2rem; margin-bottom: 1rem;">
                        <li>Create your own service definition</li>
                        <li>Integrate TSM with systemd for production</li>
                        <li>Explore tsm_repl for interactive management</li>
                        <li>Read the source: bash/tsm/README.md</li>
                    </ul>
                    <div class="learn-box">
                        <div class="learn-box-header">Quick Reference</div>
                        <div class="command-hint">
tsm help
<br>
tsm list [available]
<br>
tsm start <service>
<br>
tsm stop <id>
<br>
tsm logs <id> [--follow]
<br>
tsm ports
<br>
tsm monitor
<br>
tsm repl
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <!-- Terminal Panel (Right) -->
        <div class="panel terminal-panel">
            <div class="panel-header">Terminal Output</div>
            <div class="terminal-window">
                <div class="terminal-titlebar">
                    <div class="terminal-dot dot-red"></div>
                    <div class="terminal-dot dot-yellow"></div>
                    <div class="terminal-dot dot-green"></div>
                    <div class="terminal-title">bash - tutorial</div>
                </div>
                <div class="terminal-content" id="terminal">
                    <!-- Terminal content populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Design Token Editor -->
<!-- Design Token Editor - FAB Button -->
<button class="design-fab" onclick="toggleDesignPanel()" id="designFab">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="28" height="28">
        <circle cx="50" cy="50" r="45" fill="#ffffff" opacity="0.15"/>
        <rect x="25" y="30" width="18" height="18" rx="3" fill="#58a6ff"/>
        <rect x="47" y="30" width="18" height="18" rx="3" fill="#3fb950"/>
        <rect x="69" y="30" width="18" height="18" rx="3" fill="#d29922"/>
        <rect x="25" y="52" width="18" height="18" rx="3" fill="#f85149"/>
        <rect x="47" y="52" width="18" height="18" rx="3" fill="#c9d1d9"/>
        <rect x="69" y="52" width="18" height="18" rx="3" fill="#8b949e"/>
        <circle cx="50" cy="50" r="45" fill="none" stroke="#ffffff" stroke-width="2" opacity="0.8"/>
    </svg>
</button>

<!-- Design Token Panel -->
<div class="design-panel" id="designPanel">
    <div class="design-panel-header">
        <span>Design Tokens</span>
        <span class="design-panel-close" onclick="toggleDesignPanel()">&times;</span>
    </div>
    <div class="design-panel-content">
        <!-- Background Colors -->
        <div class="token-group">
            <div class="token-group-title">Background</div>
            <div class="token-item">
                <input type="color" class="token-picker" value="#0d1117" onchange="updateToken('--bg-primary', this.value)">
                <div class="token-swatch" style="background: var(--bg-primary)"></div>
                <div class="token-info">
                    <div class="token-name">--bg-primary</div>
                    <div class="token-value" id="token-bg-primary">#0d1117</div>
                </div>
            </div>
            <div class="token-item">
                <input type="color" class="token-picker" value="#161b22" onchange="updateToken('--bg-secondary', this.value)">
                <div class="token-swatch" style="background: var(--bg-secondary)"></div>
                <div class="token-info">
                    <div class="token-name">--bg-secondary</div>
                    <div class="token-value" id="token-bg-secondary">#161b22</div>
                </div>
            </div>
            <div class="token-item">
                <input type="color" class="token-picker" value="#21262d" onchange="updateToken('--bg-tertiary', this.value)">
                <div class="token-swatch" style="background: var(--bg-tertiary)"></div>
                <div class="token-info">
                    <div class="token-name">--bg-tertiary</div>
                    <div class="token-value" id="token-bg-tertiary">#21262d</div>
                </div>
            </div>
        </div>

        <!-- Text Colors -->
        <div class="token-group">
            <div class="token-group-title">Text</div>
            <div class="token-item">
                <input type="color" class="token-picker" value="#c9d1d9" onchange="updateToken('--text-primary', this.value)">
                <div class="token-swatch" style="background: var(--text-primary)"></div>
                <div class="token-info">
                    <div class="token-name">--text-primary</div>
                    <div class="token-value" id="token-text-primary">#c9d1d9</div>
                </div>
            </div>
            <div class="token-item">
                <input type="color" class="token-picker" value="#8b949e" onchange="updateToken('--text-secondary', this.value)">
                <div class="token-swatch" style="background: var(--text-secondary)"></div>
                <div class="token-info">
                    <div class="token-name">--text-secondary</div>
                    <div class="token-value" id="token-text-secondary">#8b949e</div>
                </div>
            </div>
        </div>

        <!-- Accent Colors -->
        <div class="token-group">
            <div class="token-group-title">Accent</div>
            <div class="token-item">
                <input type="color" class="token-picker" value="#58a6ff" onchange="updateToken('--accent-primary', this.value)">
                <div class="token-swatch" style="background: var(--accent-primary)"></div>
                <div class="token-info">
                    <div class="token-name">--accent-primary</div>
                    <div class="token-value" id="token-accent-primary">#58a6ff</div>
                </div>
            </div>
            <div class="token-item">
                <input type="color" class="token-picker" value="#1f6feb" onchange="updateToken('--accent-secondary', this.value)">
                <div class="token-swatch" style="background: var(--accent-secondary)"></div>
                <div class="token-info">
                    <div class="token-name">--accent-secondary</div>
                    <div class="token-value" id="token-accent-secondary">#1f6feb</div>
                </div>
            </div>
        </div>

        <!-- Status Colors -->
        <div class="token-group">
            <div class="token-group-title">Status</div>
            <div class="token-item">
                <input type="color" class="token-picker" value="#3fb950" onchange="updateToken('--success', this.value)">
                <div class="token-swatch" style="background: var(--success)"></div>
                <div class="token-info">
                    <div class="token-name">--success</div>
                    <div class="token-value" id="token-success">#3fb950</div>
                </div>
            </div>
            <div class="token-item">
                <input type="color" class="token-picker" value="#d29922" onchange="updateToken('--warning', this.value)">
                <div class="token-swatch" style="background: var(--warning)"></div>
                <div class="token-info">
                    <div class="token-name">--warning</div>
                    <div class="token-value" id="token-warning">#d29922</div>
                </div>
            </div>
            <div class="token-item">
                <input type="color" class="token-picker" value="#f85149" onchange="updateToken('--error', this.value)">
                <div class="token-swatch" style="background: var(--error)"></div>
                <div class="token-info">
                    <div class="token-name">--error</div>
                    <div class="token-value" id="token-error">#f85149</div>
                </div>
            </div>
        </div>

        <!-- Border Color -->
        <div class="token-group">
            <div class="token-group-title">Border</div>
            <div class="token-item">
                <input type="color" class="token-picker" value="#30363d" onchange="updateToken('--border', this.value)">
                <div class="token-swatch" style="background: var(--border)"></div>
                <div class="token-info">
                    <div class="token-name">--border</div>
                    <div class="token-value" id="token-border">#30363d</div>
                </div>
            </div>
        </div>

        <!-- Fonts -->
        <div class="token-group">
            <div class="token-group-title">Fonts</div>

            <div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-primary); border-radius: 4px; border: 1px solid var(--border);">
                <label style="font-size: 0.75rem; color: var(--text-secondary); display: block; margin-bottom: 0.5rem;">Add Google Font</label>
                <input type="text" class="font-input" id="fontCdnUrl" placeholder="https://fonts.googleapis.com/css2?family=...">
                <input type="text" class="font-input" id="fontFamily" placeholder="'Font Name', sans-serif">
                <button class="add-font-btn" onclick="addCustomFont()">Add Font to Page</button>

                <div class="font-example-toggle" onclick="toggleFontExample()">
                    &#9656; Show example
                </div>

                <div class="font-example-content" id="fontExampleContent">
                    <strong>Example: Science Gothic</strong>
                    <ol>
                        <li>Visit <a href="https://fonts.google.com/specimen/Science+Gothic" target="_blank" style="color: var(--accent-primary);">fonts.google.com/specimen/Science+Gothic</a></li>
                        <li>Click <strong>"Get font"</strong> button (top right)</li>
                        <li>Click <strong>"Get embed code"</strong> in the sidebar</li>
                        <li>Copy the URL from the <code>&lt;link&gt;</code> tag</li>
                        <li>Copy the CSS font-family value</li>
                        <li>Paste both values into the fields above</li>
                        <li>Click "Add Font to Page"</li>
                    </ol>
                </div>
            </div>

            <div style="margin-bottom: 0.75rem;">
                <label style="font-size: 0.75rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Heading Font</label>
                <select class="font-select" onchange="updateFont('heading', this.value)" id="headingFont">
                    <option value="-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif">System (Default)</option>
                    <option value="'Courier New', monospace">Courier New</option>
                    <option value="Monaco, monospace">Monaco</option>
                    <option value="'SF Mono', monospace">SF Mono</option>
                    <option value="'Roboto Mono', monospace">Roboto Mono</option>
                    <option value="Georgia, serif">Georgia</option>
                    <option value="'Times New Roman', serif">Times New Roman</option>
                </select>
            </div>
            <div style="margin-bottom: 0.75rem;">
                <label style="font-size: 0.75rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Body Font</label>
                <select class="font-select" onchange="updateFont('body', this.value)" id="bodyFont">
                    <option value="-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif">System (Default)</option>
                    <option value="'Courier New', monospace">Courier New</option>
                    <option value="Monaco, monospace">Monaco</option>
                    <option value="'SF Mono', monospace">SF Mono</option>
                    <option value="'Roboto Mono', monospace">Roboto Mono</option>
                    <option value="Georgia, serif">Georgia</option>
                    <option value="Arial, sans-serif">Arial</option>
                </select>
            </div>
            <div>
                <label style="font-size: 0.75rem; color: var(--text-secondary); display: block; margin-bottom: 0.25rem;">Code Font</label>
                <select class="font-select" onchange="updateFont('code', this.value)" id="codeFont">
                    <option value="'Courier New', Monaco, monospace">Courier New (Default)</option>
                    <option value="Monaco, monospace">Monaco</option>
                    <option value="'SF Mono', monospace">SF Mono</option>
                    <option value="'Roboto Mono', monospace">Roboto Mono</option>
                    <option value="Consolas, monospace">Consolas</option>
                    <option value="'Fira Code', monospace">Fira Code</option>
                </select>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="design-panel-buttons">
            <button class="design-panel-btn copy-tokens-btn" onclick="copyTokens()" id="copyTokensBtn">
                Copy CSS
            </button>
            <button class="design-panel-btn load-tokens-btn" onclick="loadTokens()" id="loadTokensBtn">
                Load CSS
            </button>
            <button class="design-panel-btn reset-tokens-btn" onclick="resetTokens()" id="resetTokensBtn">
                Reset
            </button>
        </div>
    </div>
</div>
    <script>
        let currentStep = 0;
        const totalSteps = 11 - 1;

        // Terminal content for each step
        const terminalContent = {
            0: [
                { type: 'comment', text: "# Welcome to TSM - Tetra Service Manager" },
                { type: 'comment', text: "# Let's learn how to manage services the tetra way" },
                { type: 'blank', text: "" },
                { type: 'comment', text: "# TSM provides:" },
                { type: 'output', text: "  ‚úì Service lifecycle management (start/stop/restart)" },
                { type: 'output', text: "  ‚úì Named port allocation" },
                { type: 'output', text: "  ‚úì Structured logging" },
                { type: 'output', text: "  ‚úì Health monitoring" },
                { type: 'output', text: "  ‚úì Multi-user support" }
            ],
            1: [
                { type: 'prompt', text: "$ ", inline: true },
                { type: 'command', text: "cd ~/tetra" },
                { type: 'prompt', text: "$ ", inline: true },
                { type: 'command', text: "source ~/tetra/tetra.sh" },
                { type: 'output-success', text: "‚úì Tetra initialized" },
                { type: 'output', text: "TETRA_SRC=/Users/you/tetra" },
                { type: 'output', text: "TETRA_DIR=/Users/you/tetra_dir" },
                { type: 'blank', text: "" },
                { type: 'prompt', text: "$ ", inline: true },
                { type: 'command', text: "source \"$TETRA_SRC/bash/tsm/includes.sh\"" },
                { type: 'output-success', text: "‚úì TSM loaded" },
                { type: 'output', text: "TSM_SRC=/Users/you/tetra/bash/tsm" },
                { type: 'output', text: "TSM_DIR=/Users/you/tetra_dir/tsm" },
                { type: 'blank', text: "" },
                { type: 'prompt', text: "$ ", inline: true },
                { type: 'command', text: "tsm help" },
                { type: 'output-header', text: "TSM - Tetra Service Manager" },
                { type: 'output', text: "Usage: tsm <command> [args]" },
                { type: 'blank', text: "" },
                { type: 'output', text: "Service Lifecycle:" },
                { type: 'output', text: "  start <service>      Start a service" },
                { type: 'output', text: "  stop <id>            Stop a service" },
                { type: 'output', text: "  restart <id>         Restart a service" },
                { type: 'output', text: "  list                 List running services" }
            ],
            2: [
                { type: 'prompt', text: "$ ", inline: true },
                { type: 'command', text: "tsm list available" },
                { type: 'blank', text: "" },
                { type: 'output-header', text: "Available Services:" },
                { type: 'output-header', text: "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" },
                { type: 'blank', text: "" },
                { type: 'output-success', text: "chroma          Vector database for RAG" },
                { type: 'output', text: "  Port: chroma-api (default 8000)" },
                { type: 'output', text: "  Command: chroma run --path $CHROMA_DIR/data" },
                { type: 'blank', text: "" },
                { type: 'output-success', text: "devpages        Development page server" },
                { type: 'output', text: "  Port: devpages-http (default 8080)" },
                { type: 'output', text: "  Command: python -m http.server" },
                { type: 'blank', text: "" },
                { type: 'output', text: "Total: 2 services available" }
            ],
            3: [
                { type: 'prompt', text: "$ ", inline: true },
                { type: 'command', text: "tsm start chroma" },
                { type: 'blank', text: "" },
                { type: 'output', text: "Starting service: chroma" },
                { type: 'output', text: "Allocating port chroma-api ‚Üí 8000" },
                { type: 'output', text: "Process ID: tsm-chroma-1732567890" },
                { type: 'output', text: "Log: /Users/you/tetra_dir/tsm/logs/chroma-1732567890.log" },
                { type: 'blank', text: "" },
                { type: 'output-success', text: "‚úì Service started successfully" },
                { type: 'output', text: "PID: 12345" },
                { type: 'output', text: "Port: http://localhost:8000" },
                { type: 'blank', text: "" },
                { type: 'comment', text: "# Check if it's running:" },
                { type: 'prompt', text: "$ ", inline: true },
                { type: 'command', text: "tsm list" },
                { type: 'blank', text: "" },
                { type: 'output-header', text: "Running Services:" },
                { type: 'output', text: "ID                      SERVICE   PID    PORT   STATUS   UPTIME" },
                { type: 'output-success', text: "tsm-chroma-1732567890  chroma    12345  8000   healthy  5s", highlight: true }
            ],
            4: [
                { type: 'prompt', text: "$ ", inline: true },
                { type: 'command', text: "tsm show tsm-chroma-1732567890" },
                { type: 'blank', text: "" },
                { type: 'output-header', text: "Process Details:" },
                { type: 'output-header', text: "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" },
                { type: 'blank', text: "" },
                { type: 'output', text: "ID:         tsm-chroma-1732567890" },
                { type: 'output', text: "Service:    chroma" },
                { type: 'output', text: "PID:        12345" },
                { type: 'output-success', text: "Status:     healthy" },
                { type: 'output', text: "Uptime:     2m 15s" },
                { type: 'blank', text: "" },
                { type: 'output', text: "Ports:" },
                { type: 'output', text: "  chroma-api ‚Üí localhost:8000" },
                { type: 'blank', text: "" },
                { type: 'output', text: "Resources:" },
                { type: 'output', text: "  CPU:    2.3%" },
                { type: 'output', text: "  Memory: 145MB" },
                { type: 'blank', text: "" },
                { type: 'output', text: "Logs:" },
                { type: 'output', text: "  /Users/you/tetra_dir/tsm/logs/chroma-1732567890.log" }
            ],
            5: [
                { type: 'prompt', text: "$ ", inline: true },
                { type: 'command', text: "tsm logs tsm-chroma-1732567890" },
                { type: 'blank', text: "" },
                { type: 'output', text: "[2025-11-25 10:30:00] Starting Chroma server" },
                { type: 'output', text: "[2025-11-25 10:30:01] Loading data from /Users/you/tetra_dir/chroma/data" },
                { type: 'output-success', text: "[2025-11-25 10:30:02] Server listening on port 8000" },
                { type: 'output', text: "[2025-11-25 10:30:05] Collection 'tetra-docs' loaded (1234 vectors)" },
                { type: 'blank', text: "" },
                { type: 'comment', text: "# Use --follow to tail logs in real-time:" },
                { type: 'prompt', text: "$ ", inline: true },
                { type: 'command', text: "tsm logs tsm-chroma-1732567890 --follow" },
                { type: 'output', text: "[2025-11-25 10:32:15] Query received: similarity search" },
                { type: 'output', text: "[2025-11-25 10:32:16] Returned 10 results in 45ms" }
            ],
            6: [
                { type: 'prompt', text: "$ ", inline: true },
                { type: 'command', text: "tsm ports" },
                { type: 'blank', text: "" },
                { type: 'output-header', text: "Named Port Allocations:" },
                { type: 'output-header', text: "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" },
                { type: 'blank', text: "" },
                { type: 'output', text: "NAME              PORT   STATUS      PROCESS" },
                { type: 'output-success', text: "chroma-api        8000   LISTENING   tsm-chroma-1732567890" },
                { type: 'output', text: "devpages-http     8080   available   -" },
                { type: 'output', text: "rag-api           8001   available   -" },
                { type: 'blank', text: "" },
                { type: 'comment', text: "# Allocate a specific port:" },
                { type: 'prompt', text: "$ ", inline: true },
                { type: 'command', text: "tsm port assign my-service 9000" },
                { type: 'output-success', text: "‚úì Port my-service ‚Üí 9000 reserved" }
            ],
            7: [
                { type: 'prompt', text: "$ ", inline: true },
                { type: 'command', text: "tsm stop tsm-chroma-1732567890" },
                { type: 'blank', text: "" },
                { type: 'output', text: "Stopping process: tsm-chroma-1732567890" },
                { type: 'output', text: "Sending SIGTERM to PID 12345..." },
                { type: 'output', text: "Waiting for graceful shutdown (10s timeout)..." },
                { type: 'blank', text: "" },
                { type: 'output-success', text: "‚úì Process stopped gracefully" },
                { type: 'output', text: "Releasing port chroma-api (8000)" },
                { type: 'output', text: "Cleaning up metadata" },
                { type: 'blank', text: "" },
                { type: 'comment', text: "# Verify it stopped:" },
                { type: 'prompt', text: "$ ", inline: true },
                { type: 'command', text: "tsm list" },
                { type: 'output', text: "No running services" }
            ],
            8: [
                { type: 'prompt', text: "$ ", inline: true },
                { type: 'command', text: "tsm restart tsm-chroma-1732567890" },
                { type: 'blank', text: "" },
                { type: 'output', text: "Restarting process: tsm-chroma-1732567890" },
                { type: 'output', text: "Stopping..." },
                { type: 'output-success', text: "‚úì Stopped" },
                { type: 'output', text: "Starting..." },
                { type: 'output-success', text: "‚úì Started with new PID: 12456" }
            ],
            9: [
                { type: 'comment', text: "# Multi-user TSM" },
                { type: 'prompt', text: "$ ", inline: true },
                { type: 'command', text: "tsm users" },
                { type: 'output-header', text: "TSM Users:" },
                { type: 'output-success', text: "alice    3 processes" },
                { type: 'output-success', text: "bob      1 process" },
                { type: 'blank', text: "" },
                { type: 'comment', text: "# Monitor all services" },
                { type: 'prompt', text: "$ ", inline: true },
                { type: 'command', text: "tsm monitor" },
                { type: 'output', text: "ID                      CPU   MEM    STATUS" },
                { type: 'output-success', text: "tsm-chroma-1732567890   2.3%  145MB  healthy" },
                { type: 'output-success', text: "tsm-devpages-1732567891 0.1%  12MB   healthy" }
            ],
            10: [
                { type: 'output-header', text: "üéâ Congratulations!" },
                { type: 'blank', text: "" },
                { type: 'output-success', text: "You've mastered TSM - Tetra Service Manager" },
                { type: 'blank', text: "" },
                { type: 'output', text: "Key concepts learned:" },
                { type: 'output-success', text: "  ‚úì Service lifecycle (start/stop/restart)" },
                { type: 'output-success', text: "  ‚úì Named port system" },
                { type: 'output-success', text: "  ‚úì Log management" },
                { type: 'output-success', text: "  ‚úì Process monitoring" },
                { type: 'blank', text: "" },
                { type: 'comment', text: "# Keep learning:" },
                { type: 'prompt', text: "$ ", inline: true },
                { type: 'command', text: "tsm repl" },
                { type: 'output', text: "TSM REPL - Interactive service manager" },
                { type: 'output', text: "Type 'help' for commands, 'exit' to quit" },
                { type: 'blank', text: "" },
                { type: 'output', text: "TSM: Tetra Service Manager" },
                { type: 'output', text: "Manage services the tetra way. üöÄ" }
            ]
        };


function renderTerminal(step) {
    const terminal = document.getElementById('terminal');
    terminal.innerHTML = '';

    const content = terminalContent[step] || [];

    content.forEach((line, index) => {
        setTimeout(() => {
            const lineDiv = document.createElement('div');
            lineDiv.className = `terminal-line ${line.type}`;

            if (line.type === 'blank') {
                lineDiv.innerHTML = '&nbsp;';
            } else if (line.inline) {
                const span = document.createElement('span');
                span.textContent = line.text;
                lineDiv.appendChild(span);
                lineDiv.style.display = 'inline';
            } else {
                if (line.highlight) {
                    const span = document.createElement('span');
                    span.className = 'highlight';
                    span.textContent = line.text;
                    lineDiv.appendChild(span);
                } else {
                    lineDiv.textContent = line.text;
                }
            }

            terminal.appendChild(lineDiv);
            lineDiv.classList.add('visible');

            // Auto-scroll to bottom
            terminal.scrollTop = terminal.scrollHeight;
        }, index * 100);
    });
}

function updateStep() {
    // Hide all steps
    document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active');
    });

    // Show current step
    const currentStepEl = document.querySelector(`[data-step="${currentStep}"]`);
    if (currentStepEl) {
        currentStepEl.classList.add('active');
    }

    // Update buttons
    document.getElementById('prevBtn').disabled = currentStep === 0;
    document.getElementById('nextBtn').disabled = currentStep === totalSteps;

    if (currentStep === totalSteps) {
        document.getElementById('nextBtn').textContent = '‚úì Complete';
    } else {
        document.getElementById('nextBtn').textContent = 'Next ‚Üí';
    }

    // Update progress
    document.getElementById('progress').textContent = `Step ${currentStep + 1} of ${totalSteps + 1}`;

    // Update terminal
    renderTerminal(currentStep);

    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function nextStep() {
    if (currentStep < totalSteps) {
        currentStep++;
        updateStep();
    }
}

function prevStep() {
    if (currentStep > 0) {
        currentStep--;
        updateStep();
    }
}

function toggleDetails(element) {
    const section = element.closest('.details-section');
    section.classList.toggle('collapsed');
}

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowRight' && currentStep < totalSteps) {
        nextStep();
    } else if (e.key === 'ArrowLeft' && currentStep > 0) {
        prevStep();
    }
});

// Initialize
updateStep();

        // Design Token Editor
// Design Token Editor - JavaScript

// Default tokens for reset
const defaultTokens = {
    '--bg-primary': '#0d1117',
    '--bg-secondary': '#161b22',
    '--bg-tertiary': '#21262d',
    '--text-primary': '#c9d1d9',
    '--text-secondary': '#8b949e',
    '--accent-primary': '#58a6ff',
    '--accent-secondary': '#1f6feb',
    '--success': '#3fb950',
    '--warning': '#d29922',
    '--error': '#f85149',
    '--border': '#30363d',
    '--highlight': '#388bfd26'
};

const defaultFonts = {
    heading: "-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
    body: "-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
    code: "'Courier New', Monaco, monospace"
};

// Track loaded Google Fonts
const loadedGoogleFonts = [];

// Toggle design panel visibility
function toggleDesignPanel() {
    const panel = document.getElementById('designPanel');
    panel.classList.toggle('visible');
}

// Update a CSS custom property
function updateToken(tokenName, value) {
    document.documentElement.style.setProperty(tokenName, value);
    const displayId = 'token-' + tokenName.replace('--', '').replace(/-/g, '-');
    const displayEl = document.getElementById(displayId);
    if (displayEl) {
        displayEl.textContent = value;
    }

    // Update corresponding color picker
    const picker = document.querySelector(`input[onchange*="${tokenName}"]`);
    if (picker) {
        picker.value = value;
    }
}

// Update font for a specific element type
function updateFont(type, font) {
    switch(type) {
        case 'heading':
            document.querySelectorAll('h1, h2, h3, .step-number').forEach(el => {
                el.style.fontFamily = font;
            });
            break;
        case 'body':
            document.body.style.fontFamily = font;
            break;
        case 'code':
            document.querySelectorAll('code, .command-hint, .terminal-content, .token-name, .token-value').forEach(el => {
                el.style.fontFamily = font;
            });
            break;
    }
}

// Toggle font example visibility
function toggleFontExample() {
    const content = document.getElementById('fontExampleContent');
    const toggle = document.querySelector('.font-example-toggle');

    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        toggle.innerHTML = '&#9656; Show example';
    } else {
        content.classList.add('expanded');
        toggle.innerHTML = '&#9662; Hide example';
    }
}

// Add a custom Google Font
function addCustomFont() {
    const cdnUrl = document.getElementById('fontCdnUrl').value.trim();
    const fontFamily = document.getElementById('fontFamily').value.trim();

    if (!cdnUrl || !fontFamily) {
        alert('Please enter both CDN URL and font-family value');
        return;
    }

    // Validate Google Fonts URL
    if (!cdnUrl.includes('fonts.googleapis.com')) {
        alert('Please use a valid Google Fonts URL (fonts.googleapis.com)');
        return;
    }

    // Add font link to document head
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = cdnUrl;
    link.id = 'custom-font-' + Date.now();
    document.head.appendChild(link);

    // Wait for font to load before applying
    link.onload = () => {
        console.log('Font loaded successfully:', fontFamily);

        // Store in loaded fonts tracker
        const existing = loadedGoogleFonts.find(f => f.fontFamily === fontFamily);
        if (!existing) {
            loadedGoogleFonts.push({ cdnUrl, fontFamily });
        }

        // Add to all dropdowns
        const dropdowns = ['headingFont', 'bodyFont', 'codeFont'];
        dropdowns.forEach(id => {
            const select = document.getElementById(id);
            if (!select) return;

            const existingOption = Array.from(select.options).find(opt => opt.value === fontFamily);
            if (!existingOption) {
                const option = document.createElement('option');
                option.value = fontFamily;
                option.textContent = fontFamily.replace(/['"]/g, '') + ' (Custom)';
                select.insertBefore(option, select.firstChild);
            }
        });

        // Auto-select and apply the font to headings
        const headingSelect = document.getElementById('headingFont');
        if (headingSelect) {
            headingSelect.value = fontFamily;
            updateFont('heading', fontFamily);
        }

        // Visual feedback
        const btn = document.querySelector('.add-font-btn');
        const originalText = btn.textContent;
        btn.textContent = '‚úì Font Added & Applied!';
        btn.style.background = 'var(--success)';
        btn.style.borderColor = 'var(--success)';
        btn.style.color = 'white';

        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '';
            btn.style.borderColor = '';
            btn.style.color = '';
        }, 1000);

        // Clear inputs
        document.getElementById('fontCdnUrl').value = '';
        document.getElementById('fontFamily').value = '';
    };

    link.onerror = () => {
        console.error('Failed to load font:', cdnUrl);
        alert('Failed to load font. Please check the URL and try again.');
        link.remove();
    };
}

// Reset all tokens to defaults
function resetTokens() {
    // Reset colors
    Object.entries(defaultTokens).forEach(([token, value]) => {
        updateToken(token, value);
    });

    // Reset fonts
    const headingFont = document.getElementById('headingFont');
    const bodyFont = document.getElementById('bodyFont');
    const codeFont = document.getElementById('codeFont');

    if (headingFont) headingFont.value = defaultFonts.heading;
    if (bodyFont) bodyFont.value = defaultFonts.body;
    if (codeFont) codeFont.value = defaultFonts.code;

    updateFont('heading', defaultFonts.heading);
    updateFont('body', defaultFonts.body);
    updateFont('code', defaultFonts.code);

    // Clear custom font inputs
    const fontCdnUrl = document.getElementById('fontCdnUrl');
    const fontFamily = document.getElementById('fontFamily');
    if (fontCdnUrl) fontCdnUrl.value = '';
    if (fontFamily) fontFamily.value = '';

    // Visual feedback
    const btn = document.getElementById('resetTokensBtn');
    if (btn) {
        const originalText = btn.textContent;
        btn.textContent = 'Reset!';
        setTimeout(() => {
            btn.textContent = originalText;
        }, 1000);
    }
}

// Copy current tokens as CSS
function copyTokens() {
    const tokens = [
        '--bg-primary', '--bg-secondary', '--bg-tertiary',
        '--text-primary', '--text-secondary',
        '--accent-primary', '--accent-secondary',
        '--success', '--warning', '--error',
        '--border', '--highlight'
    ];

    const style = getComputedStyle(document.documentElement);

    // Generate CSS custom properties
    let cssOutput = ':root {\n';
    tokens.forEach(token => {
        const value = style.getPropertyValue(token).trim();
        cssOutput += `    ${token}: ${value};\n`;
    });
    cssOutput += '}\n\n';

    // Add Google Fonts CDN URLs
    if (loadedGoogleFonts.length > 0) {
        cssOutput += '/* Google Fonts CDN */\n';
        loadedGoogleFonts.forEach(font => {
            cssOutput += `/* @import url('${font.cdnUrl}'); */\n`;
            cssOutput += `/* GoogleFont: ${font.fontFamily} | ${font.cdnUrl} */\n`;
        });
        cssOutput += '\n';
    }

    // Add font info
    cssOutput += '/* Fonts */\n';
    const headingFont = document.getElementById('headingFont');
    const bodyFont = document.getElementById('bodyFont');
    const codeFont = document.getElementById('codeFont');

    if (headingFont) cssOutput += `/* Heading: ${headingFont.value} */\n`;
    if (bodyFont) cssOutput += `/* Body: ${bodyFont.value} */\n`;
    if (codeFont) cssOutput += `/* Code: ${codeFont.value} */\n`;

    // Copy to clipboard
    navigator.clipboard.writeText(cssOutput).then(() => {
        const btn = document.getElementById('copyTokensBtn');
        if (btn) {
            const originalText = btn.textContent;
            btn.textContent = '‚úì Copied!';
            btn.classList.add('copied');

            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('copied');
            }, 2000);
        }
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy tokens to clipboard');
    });
}

// Load tokens from pasted CSS
function loadTokens() {
    const cssText = prompt('Paste the CSS (including :root { } and font comments):');

    if (!cssText) return;

    try {
        // Extract color tokens
        const tokenRegex = /--([a-z-]+):\s*([^;]+);/g;
        let match;

        while ((match = tokenRegex.exec(cssText)) !== null) {
            const tokenName = '--' + match[1];
            const value = match[2].trim();

            if (defaultTokens.hasOwnProperty(tokenName)) {
                updateToken(tokenName, value);
            }
        }

        // Extract and load Google Fonts
        const googleFontRegex = /\/\*\s*GoogleFont:\s*([^|]+)\|\s*([^*]+)\*\//g;
        let fontMatch;
        const fontsToLoad = [];

        while ((fontMatch = googleFontRegex.exec(cssText)) !== null) {
            const fontFamily = fontMatch[1].trim();
            const cdnUrl = fontMatch[2].trim();
            fontsToLoad.push({ fontFamily, cdnUrl });
        }

        // Load extracted Google Fonts
        fontsToLoad.forEach(font => {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = font.cdnUrl;
            link.id = 'custom-font-' + Date.now();
            document.head.appendChild(link);

            const existing = loadedGoogleFonts.find(f => f.fontFamily === font.fontFamily);
            if (!existing) {
                loadedGoogleFonts.push(font);
            }

            // Add to dropdowns
            link.onload = () => {
                const dropdowns = ['headingFont', 'bodyFont', 'codeFont'];
                dropdowns.forEach(id => {
                    const select = document.getElementById(id);
                    if (!select) return;

                    const existingOption = Array.from(select.options).find(opt => opt.value === font.fontFamily);
                    if (!existingOption) {
                        const option = document.createElement('option');
                        option.value = font.fontFamily;
                        option.textContent = font.fontFamily.replace(/['"]/g, '') + ' (Custom)';
                        select.insertBefore(option, select.firstChild);
                    }
                });
            };
        });

        // Extract font preferences from comments
        const headingMatch = cssText.match(/\/\*\s*Heading:\s*(.+?)\s*\*\//);
        const bodyMatch = cssText.match(/\/\*\s*Body:\s*(.+?)\s*\*\//);
        const codeMatch = cssText.match(/\/\*\s*Code:\s*(.+?)\s*\*\//);

        if (headingMatch) {
            const font = headingMatch[1].trim();
            const headingFont = document.getElementById('headingFont');
            if (headingFont) {
                headingFont.value = font;
                updateFont('heading', font);
            }
        }

        if (bodyMatch) {
            const font = bodyMatch[1].trim();
            const bodyFont = document.getElementById('bodyFont');
            if (bodyFont) {
                bodyFont.value = font;
                updateFont('body', font);
            }
        }

        if (codeMatch) {
            const font = codeMatch[1].trim();
            const codeFont = document.getElementById('codeFont');
            if (codeFont) {
                codeFont.value = font;
                updateFont('code', font);
            }
        }

        // Visual feedback
        const btn = document.getElementById('loadTokensBtn');
        if (btn) {
            const originalText = btn.textContent;
            const fontCount = fontsToLoad.length;
            btn.textContent = fontCount > 0 ? `‚úì Loaded! (${fontCount} font${fontCount > 1 ? 's' : ''})` : '‚úì Loaded!';
            btn.style.background = 'var(--success)';
            btn.style.borderColor = 'var(--success)';
            btn.style.color = 'white';

            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
                btn.style.borderColor = '';
                btn.style.color = '';
            }, 3000);
        }

    } catch (err) {
        console.error('Failed to parse CSS:', err);
        alert('Failed to parse CSS. Make sure it includes :root { } block and font comments.');
    }
}

// Close design panel when clicking outside
document.addEventListener('click', (e) => {
    const panel = document.getElementById('designPanel');
    const fab = document.getElementById('designFab');
    if (panel && panel.classList.contains('visible') &&
        !panel.contains(e.target) &&
        !fab.contains(e.target)) {
        panel.classList.remove('visible');
    }
});

// ============================================
// Element Design Token Inspector (Shift-Hold)
// ============================================
(function() {
    let longPressTimer = null;
    let progressTimer = null;
    let currentElement = null;
    let progressOverlay = null;
    let startTime = 0;
    const LONG_PRESS_DURATION = 1000; // 1 second

    // Create progress overlay element
    function createProgressOverlay() {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            pointer-events: none;
            border: 3px solid var(--accent-primary);
            border-radius: 4px;
            background: radial-gradient(circle, transparent 0%, rgba(88, 166, 255, 0.1) 100%);
            z-index: 10000;
            transition: opacity 0.2s;
        `;
        overlay.innerHTML = `
            <div style="
                position: absolute;
                top: -30px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--bg-secondary);
                border: 2px solid var(--accent-primary);
                border-radius: 20px;
                padding: 4px 12px;
                font-size: 11px;
                font-family: 'Courier New', monospace;
                color: var(--accent-primary);
                white-space: nowrap;
            ">
                <span class="progress-text">0.0s / 1.0s</span>
            </div>
        `;
        document.body.appendChild(overlay);
        return overlay;
    }

    // Update progress overlay position and progress
    function updateProgressOverlay(element, progress) {
        if (!progressOverlay) return;

        const rect = element.getBoundingClientRect();
        progressOverlay.style.left = rect.left + 'px';
        progressOverlay.style.top = rect.top + 'px';
        progressOverlay.style.width = rect.width + 'px';
        progressOverlay.style.height = rect.height + 'px';

        const elapsed = (progress * LONG_PRESS_DURATION / 100) / 1000;
        const progressText = progressOverlay.querySelector('.progress-text');
        if (progressText) {
            progressText.textContent = `${elapsed.toFixed(1)}s / 1.0s`;
        }

        const alpha = Math.min(0.3, progress / 100 * 0.3);
        progressOverlay.style.background = `radial-gradient(circle, rgba(88, 166, 255, ${alpha}) 0%, rgba(88, 166, 255, ${alpha * 0.3}) 100%)`;
    }

    // Generate XPath for element
    function getXPath(element) {
        if (element.id) {
            return `//*[@id="${element.id}"]`;
        }
        if (element === document.body) {
            return '/html/body';
        }

        let ix = 0;
        const siblings = element.parentNode?.childNodes || [];
        for (let i = 0; i < siblings.length; i++) {
            const sibling = siblings[i];
            if (sibling === element) {
                const parentPath = element.parentNode ? getXPath(element.parentNode) : '';
                return `${parentPath}/${element.tagName.toLowerCase()}[${ix + 1}]`;
            }
            if (sibling.nodeType === 1 && sibling.tagName === element.tagName) {
                ix++;
            }
        }
        return '';
    }

    // Extract design tokens from element
    function extractDesignTokens(element) {
        const computed = window.getComputedStyle(element);
        return {
            element: {
                tag: element.tagName.toLowerCase(),
                classes: Array.from(element.classList).join(', ') || 'none',
                id: element.id || 'none',
                xpath: getXPath(element)
            },
            colors: {
                background: computed.backgroundColor,
                color: computed.color,
                borderColor: computed.borderTopColor
            },
            typography: {
                fontFamily: computed.fontFamily,
                fontSize: computed.fontSize,
                fontWeight: computed.fontWeight,
                lineHeight: computed.lineHeight,
                letterSpacing: computed.letterSpacing
            },
            spacing: {
                padding: computed.padding,
                margin: computed.margin
            },
            border: {
                width: computed.borderWidth,
                style: computed.borderStyle,
                radius: computed.borderRadius
            },
            layout: {
                display: computed.display,
                width: computed.width,
                height: computed.height
            }
        };
    }

    // Display extracted tokens
    function displayElementTokens(element, tokens) {
        console.log('Selected Element Tokens:', tokens);

        let inspectorPanel = document.getElementById('elementInspectorPanel');
        if (!inspectorPanel) {
            inspectorPanel = createElementInspectorPanel();
        }

        populateInspectorPanel(inspectorPanel, element, tokens);
        inspectorPanel.classList.add('visible');
        inspectorPanel.style.display = 'flex';
    }

    // Create element inspector panel
    function createElementInspectorPanel() {
        const panel = document.createElement('div');
        panel.id = 'elementInspectorPanel';

        panel.innerHTML = `
            <div class="inspector-header">
                <span>Element Design Tokens <span style="font-size: 0.7rem; color: var(--text-secondary); font-weight: normal;">(drag to move)</span></span>
                <span class="close-inspector" style="cursor: pointer; color: var(--text-secondary); font-size: 1.5rem; padding: 0 0.5rem;">&times;</span>
            </div>
            <div class="inspector-content"></div>
        `;

        makeDraggable(panel);

        panel.querySelector('.close-inspector').addEventListener('click', () => {
            closeInspectorPanel();
        });

        document.body.appendChild(panel);
        return panel;
    }

    // Make panel draggable
    function makeDraggable(panel) {
        const header = panel.querySelector('.inspector-header');
        let isDragging = false;
        let initialX, initialY;

        header.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('close-inspector')) return;

            isDragging = true;
            initialX = e.clientX - (parseInt(panel.style.left) || 0);
            initialY = e.clientY - (parseInt(panel.style.top) || 0);
            panel.style.transform = 'none';
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                e.preventDefault();
                panel.style.left = (e.clientX - initialX) + 'px';
                panel.style.top = (e.clientY - initialY) + 'px';
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });
    }

    // Close inspector panel
    function closeInspectorPanel() {
        const panel = document.getElementById('elementInspectorPanel');
        if (panel) {
            panel.classList.remove('visible');
            panel.style.display = 'none';
        }
    }

    // Populate inspector panel with token data
    function populateInspectorPanel(panel, element, tokens) {
        const content = panel.querySelector('.inspector-content');

        let html = `
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-primary); border-radius: 4px; border: 1px solid var(--border);">
                <div style="font-weight: 600; color: var(--accent-primary); margin-bottom: 0.5rem;">Element Info</div>
                <div style="font-family: 'Courier New', monospace; color: var(--text-secondary); font-size: 0.8rem;">
                    <div style="margin-bottom: 0.5rem;"><strong>Tag:</strong> &lt;${tokens.element.tag}&gt;</div>
                    <div style="margin-bottom: 0.5rem;"><strong>ID:</strong> ${tokens.element.id}</div>
                    <div style="margin-bottom: 0.5rem;"><strong>Classes:</strong> ${tokens.element.classes}</div>
                    <div style="margin-bottom: 0.5rem;">
                        <strong>XPath:</strong>
                        <div style="
                            background: var(--bg-secondary);
                            padding: 0.5rem;
                            border-radius: 3px;
                            margin-top: 0.25rem;
                            word-break: break-all;
                            color: var(--accent-primary);
                            font-size: 0.75rem;
                            border: 1px solid var(--border);
                            cursor: pointer;
                        " onclick="navigator.clipboard.writeText('${tokens.element.xpath}').then(() => {
                            this.style.background = 'var(--success)';
                            this.style.color = 'white';
                            setTimeout(() => {
                                this.style.background = 'var(--bg-secondary)';
                                this.style.color = 'var(--accent-primary)';
                            }, 1000);
                        })" title="Click to copy">${tokens.element.xpath}</div>
                    </div>
                </div>
            </div>
        `;

        html += createTokenSection('Colors', tokens.colors);
        html += createTokenSection('Typography', tokens.typography);
        html += createTokenSection('Spacing', tokens.spacing);
        html += createTokenSection('Border', tokens.border);
        html += createTokenSection('Layout', tokens.layout);

        content.innerHTML = html;
    }

    // Create a token section
    function createTokenSection(title, tokens) {
        let html = `
            <div style="margin-bottom: 1.5rem;">
                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">${title}</div>
        `;

        for (const [key, value] of Object.entries(tokens)) {
            const isColor = title === 'Colors';
            const colorSwatch = isColor && value !== 'rgba(0, 0, 0, 0)' && value !== 'transparent'
                ? `<div style="width: 24px; height: 24px; background: ${value}; border: 1px solid var(--border); border-radius: 3px; flex-shrink: 0;"></div>`
                : '';

            html += `
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;">
                    ${colorSwatch}
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${key}</div>
                        <div style="font-family: 'Courier New', monospace; font-size: 0.7rem; color: var(--accent-primary); overflow: hidden; text-overflow: ellipsis;">${value}</div>
                    </div>
                </div>
            `;
        }

        html += '</div>';
        return html;
    }

    // Handle shift-mousedown to show inspector
    function handleShiftMouseDown(e) {
        if (!e.shiftKey) return;

        if (e.target.closest('#designPanel') ||
            e.target.closest('#elementInspectorPanel') ||
            e.target.closest('.design-fab')) {
            return;
        }

        e.preventDefault();
        e.stopPropagation();

        currentElement = e.target;
        startTime = Date.now();

        progressOverlay = createProgressOverlay();
        updateProgressOverlay(currentElement, 0);

        let progress = 0;
        progressTimer = setInterval(() => {
            progress = ((Date.now() - startTime) / LONG_PRESS_DURATION) * 100;
            updateProgressOverlay(currentElement, progress);

            if (progress >= 100) {
                clearInterval(progressTimer);
            }
        }, 50);

        longPressTimer = setTimeout(() => {
            longPressTimer = null;

            const tokens = extractDesignTokens(currentElement);
            displayElementTokens(currentElement, tokens);

            if (progressTimer) {
                clearInterval(progressTimer);
                progressTimer = null;
            }
            if (progressOverlay) {
                progressOverlay.remove();
                progressOverlay = null;
            }
        }, LONG_PRESS_DURATION);
    }

    // Handle mouseup to cleanup
    function handleMouseUp(e) {
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }
        if (progressTimer) {
            clearInterval(progressTimer);
            progressTimer = null;
        }
        if (progressOverlay) {
            progressOverlay.remove();
            progressOverlay = null;
        }
        currentElement = null;
    }

    // Handle Escape key to close inspector
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeInspectorPanel();
        }
    });

    // Inspector is sticky - only closes via X button or Escape key
    // (click outside no longer closes it)

    // Attach event listeners
    document.addEventListener('mousedown', handleShiftMouseDown, true);
    document.addEventListener('mouseup', handleMouseUp, true);

    console.log('Design token inspector initialized: Shift-Hold (1 sec) to show, Escape/Click-outside/√ó to close');
})();
    </script>
</body>
</html>
