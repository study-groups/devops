<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <link rel="stylesheet" href="shared.css">
    <style>
        body { padding: 8px; overflow-y: auto; font-size: 11px; }

        /* Tabs */
        .tabs { display: flex; gap: 2px; margin-bottom: 8px; border-bottom: 1px solid var(--border); align-items: center; }
        .tab { padding: 6px 12px; cursor: pointer; color: var(--ink-muted); border-bottom: 2px solid transparent; }
        .tab:hover { color: var(--ink); }
        .tab.active { color: var(--four); border-bottom-color: var(--four); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-search { margin-left: auto; background: var(--paper-dark); border: 1px solid var(--border); color: var(--ink); padding: 3px 8px; font-size: 10px; width: 100px; margin-bottom: 2px; }
        .tab-search:focus { outline: none; border-color: var(--four); width: 140px; }
        .tab-search::placeholder { color: var(--ink-muted); }

        /* Sections */
        h2 { font-size: 10px; text-transform: uppercase; color: var(--ink-muted); margin: 0 0 6px 0; padding-bottom: 4px; border-bottom: 1px solid var(--border); }
        .section { margin-bottom: 12px; }

        /* Grid layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }

        /* Stat cards - compact */
        .stat { background: var(--paper-mid); border: 1px solid var(--border); border-radius: 2px; padding: 6px 8px; }
        .stat-val { font-size: 16px; font-weight: bold; color: var(--four); }
        .stat-lbl { font-size: 9px; color: var(--ink-muted); text-transform: uppercase; }
        .stat.warn .stat-val { color: var(--three); }
        .stat.bad .stat-val { color: var(--one); }
        .stat.good .stat-val { color: var(--two); }

        /* Buttons */
        .btn-row { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
        .btn { background: var(--paper-mid); border: 1px solid var(--border); color: var(--ink); padding: 4px 8px; font-size: 10px; cursor: pointer; border-radius: 2px; }
        .btn:hover { border-color: var(--four); }
        .btn.danger { border-color: var(--one); color: var(--one); }
        .btn.danger:hover { background: var(--one); color: var(--paper); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* Log */
        .log { background: var(--paper-dark); border: 1px solid var(--border); border-radius: 2px; padding: 6px; font-family: var(--font-mono); font-size: 9px; max-height: 120px; overflow-y: auto; white-space: pre-wrap; }
        .log-entry { margin-bottom: 2px; }
        .log-entry.ok { color: var(--two); }
        .log-entry.err { color: var(--one); }
        .log-entry.warn { color: var(--three); }
        .log-entry.info { color: var(--ink-muted); }

        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th, td { padding: 4px 6px; text-align: left; border-bottom: 1px solid var(--border); }
        th { color: var(--ink-muted); font-weight: normal; text-transform: uppercase; font-size: 9px; }
        .fast { color: var(--two); }
        .med { color: var(--three); }
        .slow { color: var(--one); }

        /* Inputs */
        .input-row { display: flex; gap: 6px; align-items: center; }
        .input-row label { font-size: 10px; color: var(--ink-muted); }
        input[type="number"] { background: var(--paper-dark); border: 1px solid var(--border); color: var(--ink); padding: 3px 6px; font-size: 10px; width: 50px; border-radius: 2px; }
        input:focus { outline: none; border-color: var(--four); }

        /* Key-value list */
        .kv { display: flex; gap: 8px; padding: 3px 0; border-bottom: 1px solid var(--border); }
        .kv:last-child { border-bottom: none; }
        .kv-k { color: var(--ink-muted); min-width: 80px; font-size: 10px; }
        .kv-v { color: var(--ink); font-family: var(--font-mono); font-size: 10px; word-break: break-all; }

        /* Help content */
        .help-section { margin-bottom: 16px; }
        .help-section h3 { font-size: 11px; color: var(--four); margin: 0 0 6px 0; }
        .help-section p { margin: 0 0 6px 0; color: var(--ink-muted); line-height: 1.4; }
        .help-section code { background: var(--paper-dark); padding: 1px 4px; border-radius: 2px; font-size: 10px; }
        .help-section ul { margin: 0; padding-left: 16px; }
        .help-section li { margin-bottom: 4px; color: var(--ink-muted); }
        .concept { background: var(--paper-mid); border-left: 2px solid var(--four); padding: 6px 8px; margin: 6px 0; }
        .concept-title { font-weight: bold; color: var(--ink); font-size: 10px; }
        .concept-desc { color: var(--ink-muted); font-size: 10px; margin-top: 2px; }

        /* Help UI - sub-tabs */
        .help-subtabs { display: flex; gap: 2px; flex-wrap: wrap; margin-bottom: 10px; }
        .help-subtab { background: var(--paper-mid); border: 1px solid var(--border); color: var(--ink-muted); padding: 4px 10px; font-size: 9px; cursor: pointer; }
        .help-subtab:hover { border-color: var(--ink-muted); color: var(--ink); }
        .help-subtab.active { background: var(--four); border-color: var(--four); color: var(--paper); }
        .help-subtab.all { font-weight: bold; }
        .help-panel { display: none; }
        .help-panel.active { display: block; }
        .help-panel.search-active .help-section { display: none; }
        .help-panel.search-active .help-section.match { display: block; }
        .search-highlight { background: var(--three); color: var(--paper); padding: 0 2px; border-radius: 2px; }
        .help-no-results { color: var(--ink-muted); font-style: italic; padding: 20px; text-align: center; display: none; }
        .help-no-results.show { display: block; }
        .help-code { background: var(--paper-dark); border: 1px solid var(--border); border-radius: 2px; padding: 8px; font-family: var(--font-mono); font-size: 9px; overflow-x: auto; white-space: pre; margin: 6px 0; color: var(--ink-muted); }

        /* Help ALL article view */
        .help-article { padding: 0 4px; }
        .help-article .help-category { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 16px; }
        .help-article .help-category:last-child { border-bottom: none; }
        .help-article .category-title { font-size: 12px; font-weight: bold; color: var(--four); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>
    <script src="/js/terrain-iframe.js"></script>
    <script src="/js/help-data.js"></script>

    <div class="tabs">
        <div class="tab active" data-tab="admin">Admin</div>
        <div class="tab" data-tab="api">API</div>
        <div class="tab" data-tab="help">Help</div>
        <input type="text" class="tab-search" id="help-search" placeholder="Search...">
    </div>

    <!-- ADMIN TAB -->
    <div id="tab-admin" class="tab-content active">

        <!-- Environment Context -->
        <div class="section">
            <h2>Context</h2>
            <div class="grid-2">
                <div>
                    <div class="kv"><span class="kv-k">Org</span><span class="kv-v" id="ctx-org">-</span></div>
                    <div class="kv"><span class="kv-k">Env</span><span class="kv-v" id="ctx-env">-</span></div>
                    <div class="kv"><span class="kv-k">User</span><span class="kv-v" id="ctx-user">-</span></div>
                </div>
                <div>
                    <div class="kv"><span class="kv-k">Host</span><span class="kv-v" id="ctx-host">-</span></div>
                    <div class="kv"><span class="kv-k">Remote</span><span class="kv-v" id="ctx-remote">-</span></div>
                    <div class="kv"><span class="kv-k">Services</span><span class="kv-v" id="ctx-services">-</span></div>
                </div>
            </div>
        </div>

        <!-- API Health / Cache -->
        <div class="section">
            <h2>API / Cache</h2>
            <div class="grid-4" id="api-stats">
                <div class="stat"><div class="stat-val" id="api-health">-</div><div class="stat-lbl">Health</div></div>
                <div class="stat"><div class="stat-val" id="api-cached">-</div><div class="stat-lbl">Cached</div></div>
                <div class="stat"><div class="stat-val" id="api-ttl">5s</div><div class="stat-lbl">Cache TTL</div></div>
                <div class="stat"><div class="stat-val" id="api-latency">-</div><div class="stat-lbl">Latency</div></div>
            </div>
            <div class="btn-row">
                <button class="btn" data-action="check-health">Check Health</button>
                <button class="btn" data-action="refresh-all">Refresh All</button>
            </div>
        </div>

        <!-- Capture Storage -->
        <div class="section">
            <h2>Captures</h2>
            <div class="grid-3">
                <div class="stat"><div class="stat-val" id="cap-count">-</div><div class="stat-lbl">Total</div></div>
                <div class="stat"><div class="stat-val" id="cap-size">-</div><div class="stat-lbl">Size</div></div>
                <div class="stat"><div class="stat-val" id="cap-sessions">-</div><div class="stat-lbl">Sessions</div></div>
            </div>
            <div class="btn-row">
                <div class="input-row">
                    <label>Keep:</label>
                    <input type="number" id="keep-days" value="7" min="1" max="365">
                    <span>days</span>
                </div>
                <button class="btn" data-action="preview-groom">Preview</button>
                <button class="btn danger" id="btn-groom" data-action="run-groom" disabled>Delete</button>
            </div>
        </div>

        <!-- Iframe Timings -->
        <div class="section">
            <h2>Panel Timings</h2>
            <table>
                <thead><tr><th>Panel</th><th>View</th><th>Load</th><th>Status</th></tr></thead>
                <tbody id="timing-body"><tr><td colspan="4" style="color:var(--ink-muted)">Waiting...</td></tr></tbody>
            </table>
        </div>

        <!-- Activity Log -->
        <div class="section">
            <h2>Log</h2>
            <div class="log" id="log"><div class="log-entry info">Ready</div></div>
        </div>
    </div>

    <!-- API TAB -->
    <div id="tab-api" class="tab-content">
        <div class="help-section">
            <h3>TSM (Service Manager)</h3>
            <table>
                <thead><tr><th>Method</th><th>Endpoint</th><th>Description</th></tr></thead>
                <tbody>
                    <tr><td>GET</td><td><code>/api/tsm/ls</code></td><td>List services (JSON, cached 5s)</td></tr>
                    <tr><td>GET</td><td><code>/api/tsm/status</code></td><td>Service status summary</td></tr>
                    <tr><td>GET</td><td><code>/api/tsm/health</code></td><td>Health check (tsm doctor)</td></tr>
                    <tr><td>GET</td><td><code>/api/tsm/info/:svc</code></td><td>Service metadata</td></tr>
                    <tr><td>GET</td><td><code>/api/tsm/logs/:svc</code></td><td>Service logs (lines, since, format)</td></tr>
                    <tr><td>POST</td><td><code>/api/tsm/start/:svc</code></td><td>Start service</td></tr>
                    <tr><td>POST</td><td><code>/api/tsm/stop/:svc</code></td><td>Stop service</td></tr>
                    <tr><td>POST</td><td><code>/api/tsm/restart/:svc</code></td><td>Restart service</td></tr>
                    <tr><td>POST</td><td><code>/api/tsm/patrol</code></td><td>Run patrol check</td></tr>
                </tbody>
            </table>
        </div>

        <div class="help-section">
            <h3>Caddy (Reverse Proxy)</h3>
            <table>
                <thead><tr><th>Method</th><th>Endpoint</th><th>Description</th></tr></thead>
                <tbody>
                    <tr><td>GET</td><td><code>/api/caddy/info</code></td><td>Caddy version and info</td></tr>
                    <tr><td>GET</td><td><code>/api/caddy/status</code></td><td>Status with upstreams</td></tr>
                    <tr><td>GET</td><td><code>/api/caddy/routes</code></td><td>Parsed route list</td></tr>
                    <tr><td>GET</td><td><code>/api/caddy/config</code></td><td>Caddyfile source</td></tr>
                    <tr><td>GET</td><td><code>/api/caddy/config/running</code></td><td>Live config from admin API</td></tr>
                    <tr><td>GET</td><td><code>/api/caddy/logs</code></td><td>Access logs (lines, host, status)</td></tr>
                    <tr><td>GET</td><td><code>/api/caddy/errors</code></td><td>Error logs</td></tr>
                    <tr><td>GET</td><td><code>/api/caddy/stats</code></td><td>Request stats summary</td></tr>
                    <tr><td>GET</td><td><code>/api/caddy/fail2ban</code></td><td>Fail2ban jail status</td></tr>
                    <tr><td>POST</td><td><code>/api/caddy/reload</code></td><td>Reload Caddy config</td></tr>
                </tbody>
            </table>
        </div>

        <div class="help-section">
            <h3>Capture (Screenshots/DOM)</h3>
            <table>
                <thead><tr><th>Method</th><th>Endpoint</th><th>Description</th></tr></thead>
                <tbody>
                    <tr><td>POST</td><td><code>/api/capture</code></td><td>Create new capture</td></tr>
                    <tr><td>GET</td><td><code>/api/capture/list</code></td><td>List captures (limit, session)</td></tr>
                    <tr><td>GET</td><td><code>/api/capture/sessions</code></td><td>List capture sessions</td></tr>
                    <tr><td>GET</td><td><code>/api/capture/:org/:id</code></td><td>Get capture metadata</td></tr>
                    <tr><td>GET</td><td><code>/api/capture/:org/:id/file/:f</code></td><td>Get capture file</td></tr>
                    <tr><td>DELETE</td><td><code>/api/capture/:org/:id</code></td><td>Delete capture</td></tr>
                    <tr><td>GET</td><td><code>/api/capture/journeys</code></td><td>List journeys</td></tr>
                    <tr><td>POST</td><td><code>/api/capture/journeys/:org/:n</code></td><td>Create journey</td></tr>
                </tbody>
            </table>
        </div>

        <div class="help-section">
            <h3>Deploy</h3>
            <table>
                <thead><tr><th>Method</th><th>Endpoint</th><th>Description</th></tr></thead>
                <tbody>
                    <tr><td>GET</td><td><code>/api/deploy/status</code></td><td>Deployment status</td></tr>
                    <tr><td>GET</td><td><code>/api/deploy/targets</code></td><td>List deploy targets</td></tr>
                    <tr><td>GET</td><td><code>/api/deploy/history</code></td><td>Deployment history</td></tr>
                    <tr><td>POST</td><td><code>/api/deploy/deploy</code></td><td>Trigger deployment</td></tr>
                    <tr><td>GET</td><td><code>/api/deploy/show/:t/:e</code></td><td>Show target/env config</td></tr>
                </tbody>
            </table>
        </div>

        <div class="help-section">
            <h3>Logs</h3>
            <table>
                <thead><tr><th>Method</th><th>Endpoint</th><th>Description</th></tr></thead>
                <tbody>
                    <tr><td>GET</td><td><code>/api/logs</code></td><td>Service logs (service, lines, since)</td></tr>
                    <tr><td>GET</td><td><code>/api/logs/stream</code></td><td>SSE log stream</td></tr>
                    <tr><td>GET</td><td><code>/api/logs/activity</code></td><td>Activity log</td></tr>
                    <tr><td>POST</td><td><code>/api/logs/activity</code></td><td>Add activity entry</td></tr>
                </tbody>
            </table>
        </div>

        <div class="help-section">
            <h3>Core / Orgs / Envs</h3>
            <table>
                <thead><tr><th>Method</th><th>Endpoint</th><th>Description</th></tr></thead>
                <tbody>
                    <tr><td>GET</td><td><code>/api/tetra/ping</code></td><td>Simple health ping</td></tr>
                    <tr><td>GET</td><td><code>/api/tetra/health/deep</code></td><td>Deep health check</td></tr>
                    <tr><td>GET</td><td><code>/api/tetra/health/modules</code></td><td>Module health status</td></tr>
                    <tr><td>GET</td><td><code>/api/orgs</code></td><td>List organizations</td></tr>
                    <tr><td>GET</td><td><code>/api/orgs/:org</code></td><td>Org details</td></tr>
                    <tr><td>GET</td><td><code>/api/environments</code></td><td>List environments</td></tr>
                    <tr><td>GET</td><td><code>/api/environments/test</code></td><td>Test env connectivity</td></tr>
                    <tr><td>POST</td><td><code>/api/environments/exec</code></td><td>Execute remote command</td></tr>
                </tbody>
            </table>
        </div>

        <div class="help-section">
            <h3>Query Parameters</h3>
            <p>Most endpoints accept these common params:</p>
            <ul>
                <li><code>org</code> - Organization (default: tetra)</li>
                <li><code>env</code> - Environment (default: local)</li>
                <li><code>user</code> - SSH user override for remote</li>
            </ul>
            <p>Use <code>Terrain.State.apiUrl('/api/foo')</code> to auto-append context params.</p>
        </div>
    </div>

    <!-- HELP TAB -->
    <div id="tab-help" class="tab-content">
        <div class="help-subtabs" id="help-subtabs"></div>
        <div id="help-content"></div>
    </div>

    <script>
        const logEl = document.getElementById('log');
        let pendingDeletes = [];

        // Logging with status indicators
        const LOG_ICONS = { ok: '✓', err: '✗', warn: '⚠', info: '·' };
        function log(msg, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString('en-US', {hour12:false});
            const icon = LOG_ICONS[type] || '·';
            entry.textContent = `${icon} ${time} ${msg}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            if (logEl.children.length > 50) logEl.firstChild.remove();
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        // Update context display
        function updateContext() {
            document.getElementById('ctx-org').textContent = Terrain.State.org;
            document.getElementById('ctx-env').textContent = Terrain.State.env;
            document.getElementById('ctx-user').textContent = Terrain.State.user || '(default)';
        }

        // Check TSM health and populate context
        async function checkHealth() {
            const start = Date.now();
            try {
                const res = await fetch(Terrain.State.apiUrl('/api/tsm/ls'));
                const data = await res.json();
                const latency = Date.now() - start;

                // Determine health status: API error, TSM error, or OK
                const hasError = !res.ok || data.error;
                const serviceCount = data.services?.length || 0;

                // Health indicator
                const healthEl = document.getElementById('api-health');
                const healthCard = healthEl.closest('.stat');
                if (hasError) {
                    healthEl.textContent = 'ERR';
                    healthCard.className = 'stat bad';
                } else if (serviceCount === 0) {
                    healthEl.textContent = 'WARN';
                    healthCard.className = 'stat warn';
                } else {
                    healthEl.textContent = 'OK';
                    healthCard.className = 'stat good';
                }

                // Cache and latency
                document.getElementById('api-cached').textContent = data.cached ? 'Yes' : 'No';
                document.getElementById('api-latency').textContent = latency + 'ms';
                document.getElementById('api-latency').closest('.stat').className =
                    'stat ' + (latency > 2000 ? 'bad' : latency > 500 ? 'warn' : 'good');

                // Context from TSM response
                document.getElementById('ctx-host').textContent = data.host || 'localhost';
                document.getElementById('ctx-remote').textContent = data.remote ? 'Yes' : 'No';
                document.getElementById('ctx-services').textContent = serviceCount;

                // Log with appropriate status
                if (data.error) {
                    log(`TSM error: ${data.error}`, 'err');
                    if (data.hint) log(`  → ${data.hint}`, 'info');
                } else if (serviceCount === 0) {
                    log(`TSM reachable, 0 services running, ${latency}ms`, 'info');
                } else {
                    log(`TSM OK: ${serviceCount} services, ${latency}ms${data.cached ? ' (cached)' : ''}`, 'ok');
                }
            } catch (e) {
                document.getElementById('api-health').textContent = 'ERR';
                document.getElementById('api-health').closest('.stat').className = 'stat bad';
                log(`API unreachable: ${e.message}`, 'err');
            }
        }

        // Load capture stats
        async function loadCaptures() {
            try {
                const [capRes, sessRes] = await Promise.all([
                    fetch(Terrain.State.apiUrl('/api/capture/list') + '&limit=1000'),
                    fetch(Terrain.State.apiUrl('/api/capture/sessions'))
                ]);
                const captures = await capRes.json();
                const sessions = await sessRes.json();

                document.getElementById('cap-count').textContent = captures.length;
                document.getElementById('cap-sessions').textContent = sessions.length;
                document.getElementById('cap-size').textContent = `~${Math.round(captures.length * 0.5)}MB`;

                const countEl = document.getElementById('cap-count').closest('.stat');
                countEl.className = 'stat ' + (captures.length > 200 ? 'bad' : captures.length > 100 ? 'warn' : '');

                log(`${captures.length} captures, ${sessions.length} sessions`);
            } catch (e) {
                log(`Failed to load captures: ${e.message}`, 'err');
            }
        }

        // Preview groom
        async function previewGroom() {
            const keepDays = parseInt(document.getElementById('keep-days').value) || 7;
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - keepDays);

            try {
                const res = await fetch(Terrain.State.apiUrl('/api/capture/list') + '&limit=1000');
                const captures = await res.json();
                pendingDeletes = captures.filter(c => new Date(c.timestamp) < cutoff);

                const btn = document.getElementById('btn-groom');
                if (pendingDeletes.length === 0) {
                    log(`No captures older than ${keepDays} days`, 'ok');
                    btn.disabled = true;
                    btn.textContent = 'Delete';
                } else {
                    log(`Found ${pendingDeletes.length} to delete (>${keepDays}d old)`);
                    btn.disabled = false;
                    btn.textContent = `Delete ${pendingDeletes.length}`;
                }
            } catch (e) {
                log(`Preview failed: ${e.message}`, 'err');
            }
        }

        // Run groom
        async function runGroom() {
            if (!pendingDeletes.length) return;
            const btn = document.getElementById('btn-groom');
            btn.disabled = true;
            btn.textContent = 'Deleting...';

            let ok = 0, fail = 0;
            for (const c of pendingDeletes) {
                try {
                    const res = await fetch(`/api/capture/${Terrain.State.org}/${c.id}`, { method: 'DELETE' });
                    res.ok ? ok++ : fail++;
                } catch { fail++; }
            }

            log(`Deleted ${ok}${fail ? `, ${fail} failed` : ''}`, fail ? 'err' : 'ok');
            pendingDeletes = [];
            btn.textContent = 'Delete';
            loadCaptures();
        }

        // Update timing table
        function updateTimings(timings) {
            const tbody = document.getElementById('timing-body');
            if (!timings?.length) {
                tbody.innerHTML = '<tr><td colspan="4" style="color:var(--ink-muted)">No data</td></tr>';
                return;
            }
            tbody.innerHTML = timings.map(t => {
                const cls = t.duration > 2000 ? 'slow' : t.duration > 500 ? 'med' : 'fast';
                return `<tr><td>${t.panel}</td><td>${t.view}</td><td class="${cls}">${t.duration}ms</td><td class="${cls}">${t.duration > 2000 ? 'SLOW' : t.duration > 500 ? 'OK' : 'FAST'}</td></tr>`;
            }).join('');
        }

        // Action handlers
        Terrain.Iframe
            .on('check-health', checkHealth)
            .on('refresh-all', () => { checkHealth(); loadCaptures(); })
            .on('preview-groom', previewGroom)
            .on('run-groom', runGroom);

        // Listen for timing updates
        Terrain.Bus.subscribe('*', msg => {
            if (msg.type === 'timing-update' && msg.timings) updateTimings(msg.timings);
        });

        // Listen for env changes
        Terrain.State.onEnvChange(() => {
            updateContext();
            checkHealth();
            loadCaptures();
            log(`Context changed: ${Terrain.State.org}/${Terrain.State.env}`);
        });

        // ========================================================================
        // Help System
        // ========================================================================

        let activeHelpPanel = 'all';
        let helpSearchTimeout = null;

        function renderAllArticle() {
            let html = '<div class="help-article">';
            for (const [id, cat] of Object.entries(HELP_DATA)) {
                html += `<div class="help-category" data-category="${id}">`;
                html += `<div class="category-title">${cat.title}</div>`;
                html += cat.sections.map(s => renderHelpSection(s)).join('');
                html += '</div>';
            }
            html += '</div>';
            return html;
        }

        function initHelp() {
            if (!window.HELP_DATA) return;

            const subtabsEl = document.getElementById('help-subtabs');
            const contentEl = document.getElementById('help-content');
            const searchEl = document.getElementById('help-search');

            // Render sub-tabs with ALL first
            subtabsEl.innerHTML = '<div class="help-subtab all active" data-panel="all">ALL</div>' +
                Object.entries(HELP_DATA).map(([id, cat]) =>
                    `<div class="help-subtab" data-panel="${id}">${cat.title}</div>`
                ).join('');

            // Render ALL panel + individual category panels
            contentEl.innerHTML =
                `<div class="help-panel active" data-panel="all">${renderAllArticle()}</div>` +
                Object.entries(HELP_DATA).map(([id, cat]) =>
                    renderHelpCategory(id, cat)
                ).join('');

            // Sub-tab click handlers
            subtabsEl.querySelectorAll('.help-subtab').forEach(tab => {
                tab.addEventListener('click', () => {
                    subtabsEl.querySelectorAll('.help-subtab').forEach(t => t.classList.remove('active'));
                    contentEl.querySelectorAll('.help-panel').forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    const panel = contentEl.querySelector(`[data-panel="${tab.dataset.panel}"]`);
                    if (panel) panel.classList.add('active');
                    activeHelpPanel = tab.dataset.panel;
                    searchEl.value = '';
                    clearSearch();
                });
            });

            // Search functionality - also switches to Help tab
            searchEl.addEventListener('input', (e) => {
                clearTimeout(helpSearchTimeout);
                helpSearchTimeout = setTimeout(() => {
                    if (e.target.value.trim()) {
                        // Switch to Help tab if not already there
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        document.querySelector('[data-tab="help"]').classList.add('active');
                        document.getElementById('tab-help').classList.add('active');
                    }
                    performSearch(e.target.value);
                }, 150);
            });
        }

        function performSearch(query) {
            const contentEl = document.getElementById('help-content');
            const subtabsEl = document.getElementById('help-subtabs');
            const q = query.toLowerCase().trim();

            if (!q) {
                clearSearch();
                return;
            }

            // Switch to ALL panel for search results
            subtabsEl.querySelectorAll('.help-subtab').forEach(t => t.classList.remove('active'));
            subtabsEl.querySelector('[data-panel="all"]').classList.add('active');
            contentEl.querySelectorAll('.help-panel').forEach(p => p.classList.remove('active'));
            const allPanel = contentEl.querySelector('[data-panel="all"]');
            allPanel.classList.add('active', 'search-active');

            // Search and highlight matching sections
            let hasResults = false;
            allPanel.querySelectorAll('.help-section').forEach(section => {
                const text = section.textContent.toLowerCase();
                const keywords = section.dataset.keywords || '';
                const matches = text.includes(q) || keywords.includes(q);
                section.classList.toggle('match', matches);
                if (matches) hasResults = true;
            });

            // Hide categories with no matches
            allPanel.querySelectorAll('.help-category').forEach(cat => {
                const hasMatch = cat.querySelector('.help-section.match');
                cat.style.display = hasMatch ? '' : 'none';
            });

            // Update subtab highlights
            subtabsEl.querySelectorAll('.help-subtab:not(.all)').forEach(tab => {
                const catId = tab.dataset.panel;
                const cat = allPanel.querySelector(`[data-category="${catId}"]`);
                tab.style.opacity = cat?.querySelector('.help-section.match') ? '1' : '0.4';
            });
        }

        function clearSearch() {
            const contentEl = document.getElementById('help-content');
            const subtabsEl = document.getElementById('help-subtabs');

            contentEl.querySelectorAll('.help-panel').forEach(panel => {
                panel.classList.remove('search-active');
                panel.classList.toggle('active', panel.dataset.panel === activeHelpPanel);
                panel.querySelectorAll('.help-section').forEach(s => s.classList.remove('match'));
            });

            // Show all categories
            contentEl.querySelectorAll('.help-category').forEach(cat => {
                cat.style.display = '';
            });

            subtabsEl.querySelectorAll('.help-subtab').forEach(tab => {
                tab.style.opacity = '1';
            });
        }

        // Initialize help on load
        initHelp();

        // Initialize
        Terrain.Iframe.init({
            name: 'admin',
            onReady: () => {
                updateContext();
                checkHealth();
                loadCaptures();
                Terrain.Iframe.send({ type: 'request-timings', source: 'admin' });
            }
        });
    </script>
</body>
</html>
