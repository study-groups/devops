<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <link rel="stylesheet" href="shared.css">
    <script src="js/iframe-base.js"></script>
    <script src="js/api-cache.js"></script>
    <style>
        body { padding: 8px; overflow-y: auto; font-size: 11px; }

        /* Tabs */
        .tabs { display: flex; gap: 2px; margin-bottom: 8px; border-bottom: 1px solid var(--border); align-items: center; }
        .tab { padding: 6px 12px; cursor: pointer; color: var(--ink-muted); border-bottom: 2px solid transparent; }
        .tab:hover { color: var(--ink); }
        .tab.active { color: var(--four); border-bottom-color: var(--four); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-search { margin-left: auto; background: var(--paper-dark); border: 1px solid var(--border); color: var(--ink); padding: 3px 8px; font-size: 10px; width: 100px; margin-bottom: 2px; }
        .tab-search:focus { outline: none; border-color: var(--four); width: 140px; }
        .tab-search::placeholder { color: var(--ink-muted); }

        /* Buttons (grid, stat, section, h2, log-entry now in shared.css) */
        .btn-row { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
        .btn { background: var(--paper-mid); border: 1px solid var(--border); color: var(--ink); padding: 4px 8px; font-size: 10px; cursor: pointer; border-radius: 2px; }
        .btn:hover { border-color: var(--four); }
        .btn.danger { border-color: var(--one); color: var(--one); }
        .btn.danger:hover { background: var(--one); color: var(--paper); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th, td { padding: 4px 6px; text-align: left; border-bottom: 1px solid var(--border); }
        th { color: var(--ink-muted); font-weight: normal; text-transform: uppercase; font-size: 9px; }
        .fast { color: var(--two); }
        .med { color: var(--three); }
        .slow { color: var(--one); }

        /* Smoke test grid */
        .smoke-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .smoke-item { background: transparent; border: 1px solid var(--border); border-radius: 3px; padding: 6px 8px; font-size: 11px; display: flex; align-items: center; gap: 8px; }
        .smoke-item .name { color: #a78bfa; font-weight: 700; flex: 1; }
        .smoke-item .time { color: #a78bfa; font-family: var(--font-mono); min-width: 32px; text-align: right; font-weight: 700; }
        .smoke-item.pending .name { opacity: 0.6; }
        .smoke-item.pending .time { opacity: 0.6; }
        .smoke-item.running { border-color: var(--three); }
        .smoke-item.running .time { color: var(--three); }
        .smoke-item.pass { border-color: var(--two); }
        .smoke-item.pass .time { color: var(--two); }
        .smoke-item.fail { border-color: var(--one); }
        .smoke-item.fail .name { color: var(--one); }
        .smoke-item.fail .time { color: var(--one); }
        .smoke-item.disabled .name { color: var(--ink-muted); }
        .smoke-item.disabled .time { color: var(--ink-muted); }

        /* Toggle switch */
        .iframe-toggle { width: 28px; height: 16px; background: var(--paper-dark); border: 1px solid var(--border); border-radius: 8px; position: relative; cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
        .iframe-toggle:hover { border-color: var(--ink-muted); }
        .iframe-toggle::after { content: ''; position: absolute; width: 12px; height: 12px; background: var(--ink-muted); border-radius: 50%; top: 1px; left: 1px; transition: transform 0.2s, background 0.2s; }
        .iframe-toggle.enabled { background: var(--four); border-color: var(--four); }
        .iframe-toggle.enabled::after { transform: translateX(12px); background: #c4b5fd; }
        .iframe-toggle.enabled:hover { background: #7c6ff0; }

        /* Inputs */
        .input-row { display: flex; gap: 6px; align-items: center; }
        .input-row label { font-size: 10px; color: var(--ink-muted); }
        input[type="number"] { background: var(--paper-dark); border: 1px solid var(--border); color: var(--ink); padding: 3px 6px; font-size: 10px; width: 50px; border-radius: 2px; }
        input:focus { outline: none; border-color: var(--four); }

        /* Key-value list */
        .kv { display: flex; gap: 8px; padding: 3px 0; border-bottom: 1px solid var(--border); }
        .kv:last-child { border-bottom: none; }
        .kv-k { color: var(--ink-muted); min-width: 80px; font-size: 10px; }
        .kv-v { color: var(--ink); font-family: var(--font-mono); font-size: 10px; word-break: break-all; }

        /* Help content */
        .help-section { margin-bottom: 16px; }
        .help-section h3 { font-size: 11px; color: var(--four); margin: 0 0 6px 0; }
        .help-section p { margin: 0 0 6px 0; color: var(--ink-muted); line-height: 1.4; }
        .help-section code { background: var(--paper-dark); padding: 1px 4px; border-radius: 2px; font-size: 10px; }
        .help-section ul { margin: 0; padding-left: 16px; }
        .help-section li { margin-bottom: 4px; color: var(--ink-muted); }
        .concepts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 8px; }
        .concept { background: var(--paper-mid); border-left: 2px solid var(--four); padding: 5px 8px; }
        .concept-title { font-weight: bold; color: var(--four); font-size: 10px; font-family: var(--font-mono); }
        .concept-desc { color: var(--ink-muted); font-size: 9px; line-height: 1.3; margin-top: 2px; }

        /* Help UI - sub-tabs */
        .help-subtabs { display: flex; gap: 2px; flex-wrap: wrap; margin-bottom: 10px; }
        .help-subtab { background: var(--paper-mid); border: 1px solid var(--border); color: var(--ink-muted); padding: 4px 10px; font-size: 9px; cursor: pointer; }
        .help-subtab:hover { border-color: var(--ink-muted); color: var(--ink); }
        .help-subtab.active { background: var(--four); border-color: var(--four); color: var(--paper); }
        .help-subtab.all { font-weight: bold; }
        .help-panel { display: none; }
        .help-panel.active { display: block; }
        .help-panel.search-active .help-section { display: none; }
        .help-panel.search-active .help-section.match { display: block; }
        .search-highlight { background: var(--three); color: var(--paper); padding: 0 2px; border-radius: 2px; }
        .help-no-results { color: var(--ink-muted); font-style: italic; padding: 20px; text-align: center; display: none; }
        .help-no-results.show { display: block; }
        .help-code { background: var(--paper-dark); border: 1px solid var(--border); border-radius: 2px; padding: 8px; font-family: var(--font-mono); font-size: 9px; overflow-x: auto; white-space: pre; margin: 6px 0; color: var(--ink-muted); }

        /* Help ALL article view */
        .help-article { padding: 0 4px; }
        .help-article .help-category { margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 16px; }
        .help-article .help-category:last-child { border-bottom: none; }
        .help-article .category-title { font-size: 12px; font-weight: bold; color: var(--four); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }

        /* API Reference */
        .api-stats { font-size: 9px; color: var(--ink-muted); margin-bottom: 8px; padding: 4px 8px; background: var(--paper-mid); border-radius: 2px; }
        .api-section { margin-bottom: 12px; }
        .api-section-header { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px 8px; background: var(--paper-mid); border-radius: 2px; margin: 0; font-size: 11px; user-select: none; }
        .api-section-header:hover { background: var(--paper-light); }
        .api-section-header.static { cursor: default; }
        .api-section-header.static:hover { background: var(--paper-mid); }
        .api-toggle { font-size: 8px; color: var(--ink-muted); width: 12px; }
        .api-title { color: var(--four); font-weight: 600; }
        .api-count { font-size: 9px; color: var(--ink-muted); background: var(--paper-dark); padding: 1px 5px; border-radius: 8px; }
        .api-base { font-size: 9px; color: var(--ink-muted); font-family: var(--font-mono); margin-left: auto; }
        .api-table { margin-top: 4px; }
        .api-table.collapsed { display: none; }
        .api-table th:last-child, .api-table td:last-child { width: 50px; text-align: right; }
        .api-row { transition: background 0.1s; }
        .api-row:hover { background: var(--paper-mid); }
        .api-method { font-size: 9px; font-weight: 600; padding: 1px 4px; border-radius: 2px; }
        .method-get { color: var(--two); }
        .method-post { color: var(--three); }
        .method-put { color: var(--four); }
        .method-delete { color: var(--one); }
        .api-path { font-size: 9px; color: var(--ink); }
        .api-desc { color: var(--ink-muted); }
        .api-actions { display: flex; gap: 4px; justify-content: flex-end; }
        .api-btn { background: none; border: 1px solid var(--border); color: var(--ink-muted); padding: 3px 8px; font-size: 9px; cursor: pointer; border-radius: 2px; opacity: 0; transition: opacity 0.15s; }
        .api-row:hover .api-btn { opacity: 1; }
        .api-btn:hover { border-color: var(--four); color: var(--four); }
        .api-params { padding: 8px; font-size: 10px; }
        .api-params p { margin: 0 0 6px 0; color: var(--ink-muted); }
        .api-params ul { margin: 0; padding-left: 16px; }
        .api-params li { margin-bottom: 4px; color: var(--ink-muted); }
        .api-params code { background: var(--paper-dark); padding: 1px 4px; border-radius: 2px; }
        .api-response-panel { background: var(--paper-dark); border: 1px solid var(--two); border-radius: 4px; margin-bottom: 12px; }
        .api-response-header { display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; background: var(--paper-mid); border-bottom: 1px solid var(--border); font-size: 10px; color: var(--two); }
        .api-response-actions { display: flex; gap: 6px; align-items: center; }
        .api-response-copy { opacity: 1; }
        .api-response-close { background: none; border: none; color: var(--ink-muted); cursor: pointer; font-size: 14px; padding: 0 4px; }
        .api-response-close:hover { color: var(--one); }
        .api-response-body { margin: 0; padding: 8px; font-size: 9px; max-height: 200px; overflow: auto; color: var(--ink); }
        #tab-api mark { background: var(--three); color: var(--paper); padding: 0 2px; border-radius: 2px; }

        /* API Form */
        .api-form-row { background: var(--paper-dark); }
        .api-form { padding: 8px 12px; border-left: 2px solid var(--four); }
        .api-form-fields { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; }
        .api-form-field { display: flex; flex-direction: column; gap: 2px; min-width: 120px; }
        .api-form-field label { font-size: 9px; color: var(--ink-muted); }
        .api-form-field input { background: var(--paper-mid); border: 1px solid var(--border); color: var(--ink); padding: 4px 8px; font-size: 10px; border-radius: 2px; font-family: var(--font-mono); }
        .api-form-field input:focus { outline: none; border-color: var(--four); }
        .api-form-field input::placeholder { color: var(--ink-muted); opacity: 0.6; }
        .api-form-hint { font-size: 8px; color: var(--ink-muted); opacity: 0.7; }
        .api-form-actions { display: flex; gap: 6px; }
        .api-form-actions .api-btn { opacity: 1; }
        .api-form-actions .api-btn.send { border-color: var(--two); color: var(--two); }
        .api-form-actions .api-btn.send:hover { background: var(--two); color: var(--paper); }
    </style>
</head>
<body>
    <script src="/js/terrain-iframe.js"></script>
    <script src="/js/help-data.js"></script>
    <script src="/js/api-reference.js"></script>

    <div class="tabs">
        <div class="tab active" data-tab="admin">Admin</div>
        <div class="tab" data-tab="api">API</div>
        <div class="tab" data-tab="help">Help</div>
        <input type="text" class="tab-search" id="help-search" placeholder="Search...">
    </div>

    <!-- ADMIN TAB -->
    <div id="tab-admin" class="tab-content active">

        <!-- Iframe Smoke Tests -->
        <div class="section">
            <h2>Iframes <span style="font-weight:normal;text-transform:none;margin-left:8px" id="smoke-status"></span></h2>
            <div class="smoke-grid" id="smoke-grid"></div>
            <div class="btn-row">
                <button class="btn" data-action="check-iframes">Check</button>
                <button class="btn" data-action="run-iframes">Run</button>
            </div>
        </div>

        <!-- Environment Context -->
        <div class="section">
            <h2>Context</h2>
            <div class="grid-2">
                <div>
                    <div class="kv"><span class="kv-k">Org</span><span class="kv-v" id="ctx-org">-</span></div>
                    <div class="kv"><span class="kv-k">Env</span><span class="kv-v" id="ctx-env">-</span></div>
                    <div class="kv"><span class="kv-k">User</span><span class="kv-v" id="ctx-user">-</span></div>
                </div>
                <div>
                    <div class="kv"><span class="kv-k">Host</span><span class="kv-v" id="ctx-host">-</span></div>
                    <div class="kv"><span class="kv-k">Remote</span><span class="kv-v" id="ctx-remote">-</span></div>
                    <div class="kv"><span class="kv-k">Services</span><span class="kv-v" id="ctx-services">-</span></div>
                </div>
            </div>
        </div>

        <!-- API Health / Cache -->
        <div class="section">
            <h2>API / Cache</h2>
            <div class="grid-4" id="api-stats">
                <div class="stat"><div class="stat-val" id="api-health">-</div><div class="stat-lbl">Health</div></div>
                <div class="stat"><div class="stat-val" id="api-cached">-</div><div class="stat-lbl">Cached</div></div>
                <div class="stat"><div class="stat-val" id="api-ttl">5s</div><div class="stat-lbl">Cache TTL</div></div>
                <div class="stat"><div class="stat-val" id="api-latency">-</div><div class="stat-lbl">Latency</div></div>
            </div>
            <div class="btn-row">
                <button class="btn" data-action="check-health">Check Health</button>
                <button class="btn" data-action="refresh-all">Refresh All</button>
                <button class="btn" data-action="clear-cache">Clear Cache</button>
            </div>
        </div>

        <!-- Capture Storage -->
        <div class="section">
            <h2>Captures</h2>
            <div class="grid-3">
                <div class="stat"><div class="stat-val" id="cap-count">-</div><div class="stat-lbl">Total</div></div>
                <div class="stat"><div class="stat-val" id="cap-size">-</div><div class="stat-lbl">Size</div></div>
                <div class="stat"><div class="stat-val" id="cap-sessions">-</div><div class="stat-lbl">Sessions</div></div>
            </div>
            <div class="btn-row">
                <div class="input-row">
                    <label>Keep:</label>
                    <input type="number" id="keep-days" value="7" min="1" max="365">
                    <span>days</span>
                </div>
                <button class="btn" data-action="preview-groom">Preview</button>
                <button class="btn danger" id="btn-groom" data-action="run-groom" disabled>Delete</button>
            </div>
        </div>

        <!-- Iframe Timings -->
        <div class="section">
            <h2>Panel Timings</h2>
            <table>
                <thead><tr><th>Panel</th><th>View</th><th>Load</th><th>Status</th></tr></thead>
                <tbody id="timing-body"><tr><td colspan="4" style="color:var(--ink-muted)">Waiting...</td></tr></tbody>
            </table>
        </div>

        <!-- Activity Log -->
        <div class="section">
            <h2>Log</h2>
            <div class="log" id="log"><div class="log-entry info">Ready</div></div>
        </div>
    </div>

    <!-- API TAB -->
    <div id="tab-api" class="tab-content">
        <div id="api-reference"></div>
    </div>

    <!-- HELP TAB -->
    <div id="tab-help" class="tab-content">
        <div class="help-subtabs" id="help-subtabs"></div>
        <div id="help-content"></div>
    </div>

    <script>
        // Initialize iframe base (provides: loading states, error handling, parent comms)
        IframeBase.init({
            onStateChange: (state) => log(`State: org=${state.org} env=${state.env}`, 'info'),
            onRefresh: () => { loadStats(); log('Refresh requested', 'info'); }
        });

        const logEl = document.getElementById('log');
        let pendingDeletes = [];

        // Logging with status indicators
        const LOG_ICONS = { ok: '✓', err: '✗', warn: '⚠', info: '·' };
        function log(msg, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString('en-US', {hour12:false});
            const icon = LOG_ICONS[type] || '·';
            entry.textContent = `${icon} ${time} ${msg}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            if (logEl.children.length > 50) logEl.firstChild.remove();
        }

        // Tab switching with persistence
        const ADMIN_TAB_KEY = 'admin-active-tab';

        function setActiveTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const tab = document.querySelector(`.tab[data-tab="${tabId}"]`);
            const content = document.getElementById('tab-' + tabId);
            if (tab && content) {
                tab.classList.add('active');
                content.classList.add('active');
                localStorage.setItem(ADMIN_TAB_KEY, tabId);
            }
        }

        // Initialize tab from URL param or localStorage
        function initTab() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlTab = urlParams.get('tab');
            const savedTab = localStorage.getItem(ADMIN_TAB_KEY);
            const tabId = urlTab || savedTab || 'admin';
            setActiveTab(tabId);
        }

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => setActiveTab(tab.dataset.tab));
        });

        initTab();

        // Initialize API Reference
        ApiReference.init('api-reference', 'help-search');

        // Update context display
        function updateContext() {
            document.getElementById('ctx-org').textContent = Terrain.State.org;
            document.getElementById('ctx-env').textContent = Terrain.State.env;
            document.getElementById('ctx-user').textContent = Terrain.State.user || '(default)';
        }

        // Check TSM health and populate context (using ApiCache)
        async function checkHealth() {
            const start = Date.now();
            const url = Terrain.State.apiUrl('/api/tsm/ls');
            try {
                // Use ApiCache with 5s TTL
                const data = await ApiCache.fetch(url, { ttl: 5000 });
                const latency = Date.now() - start;

                // Update cache stats display
                const cacheStats = ApiCache.stats();
                document.getElementById('api-cached').textContent = cacheStats.count;

                // Determine health status: API error, TSM error, or OK
                const hasError = data.error;
                const serviceCount = data.services?.length || 0;

                // Health indicator
                const healthEl = document.getElementById('api-health');
                const healthCard = healthEl.closest('.stat');
                if (hasError) {
                    healthEl.textContent = 'ERR';
                    healthCard.className = 'stat bad';
                } else if (serviceCount === 0) {
                    healthEl.textContent = 'WARN';
                    healthCard.className = 'stat warn';
                } else {
                    healthEl.textContent = 'OK';
                    healthCard.className = 'stat good';
                }

                // Latency
                document.getElementById('api-latency').textContent = latency + 'ms';
                document.getElementById('api-latency').closest('.stat').className =
                    'stat ' + (latency > 2000 ? 'bad' : latency > 500 ? 'warn' : 'good');

                // Context from TSM response
                document.getElementById('ctx-host').textContent = data.host || 'localhost';
                document.getElementById('ctx-remote').textContent = data.remote ? 'Yes' : 'No';
                document.getElementById('ctx-services').textContent = serviceCount;

                // Log with appropriate status
                const fromCache = latency < 10 && cacheStats.count > 0;
                if (data.error) {
                    log(`TSM error: ${data.error}`, 'err');
                    if (data.hint) log(`  → ${data.hint}`, 'info');
                } else if (serviceCount === 0) {
                    log(`TSM reachable, 0 services running, ${latency}ms`, 'info');
                } else {
                    log(`TSM OK: ${serviceCount} services, ${latency}ms${fromCache ? ' (cached)' : ''}`, 'ok');
                }
            } catch (e) {
                document.getElementById('api-health').textContent = 'ERR';
                document.getElementById('api-health').closest('.stat').className = 'stat bad';
                log(`API unreachable: ${e.message}`, 'err');
            }
        }

        // Load capture stats
        async function loadCaptures() {
            try {
                const [capRes, sessRes] = await Promise.all([
                    fetch(Terrain.State.apiUrl('/api/capture/list') + '&limit=1000'),
                    fetch(Terrain.State.apiUrl('/api/capture/sessions'))
                ]);
                const captures = await capRes.json();
                const sessions = await sessRes.json();

                document.getElementById('cap-count').textContent = captures.length;
                document.getElementById('cap-sessions').textContent = sessions.length;
                document.getElementById('cap-size').textContent = `~${Math.round(captures.length * 0.5)}MB`;

                const countEl = document.getElementById('cap-count').closest('.stat');
                countEl.className = 'stat ' + (captures.length > 200 ? 'bad' : captures.length > 100 ? 'warn' : '');

                log(`${captures.length} captures, ${sessions.length} sessions`);
            } catch (e) {
                log(`Failed to load captures: ${e.message}`, 'err');
            }
        }

        // Preview groom
        async function previewGroom() {
            const keepDays = parseInt(document.getElementById('keep-days').value) || 7;
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - keepDays);

            try {
                const res = await fetch(Terrain.State.apiUrl('/api/capture/list') + '&limit=1000');
                const captures = await res.json();
                pendingDeletes = captures.filter(c => new Date(c.timestamp) < cutoff);

                const btn = document.getElementById('btn-groom');
                if (pendingDeletes.length === 0) {
                    log(`No captures older than ${keepDays} days`, 'ok');
                    btn.disabled = true;
                    btn.textContent = 'Delete';
                } else {
                    log(`Found ${pendingDeletes.length} to delete (>${keepDays}d old)`);
                    btn.disabled = false;
                    btn.textContent = `Delete ${pendingDeletes.length}`;
                }
            } catch (e) {
                log(`Preview failed: ${e.message}`, 'err');
            }
        }

        // Run groom
        async function runGroom() {
            if (!pendingDeletes.length) return;
            const btn = document.getElementById('btn-groom');
            btn.disabled = true;
            btn.textContent = 'Deleting...';

            let ok = 0, fail = 0;
            for (const c of pendingDeletes) {
                try {
                    const res = await fetch(`/api/capture/${Terrain.State.org}/${c.id}`, { method: 'DELETE' });
                    res.ok ? ok++ : fail++;
                } catch { fail++; }
            }

            log(`Deleted ${ok}${fail ? `, ${fail} failed` : ''}`, fail ? 'err' : 'ok');
            pendingDeletes = [];
            btn.textContent = 'Delete';
            loadCaptures();
        }

        // Update timing table
        function updateTimings(timings) {
            const tbody = document.getElementById('timing-body');
            if (!timings?.length) {
                tbody.innerHTML = '<tr><td colspan="4" style="color:var(--ink-muted)">No data</td></tr>';
                return;
            }
            tbody.innerHTML = timings.map(t => {
                const cls = t.duration > 2000 ? 'slow' : t.duration > 500 ? 'med' : 'fast';
                return `<tr><td>${t.panel}</td><td>${t.view}</td><td class="${cls}">${t.duration}ms</td><td class="${cls}">${t.duration > 2000 ? 'SLOW' : t.duration > 500 ? 'OK' : 'FAST'}</td></tr>`;
            }).join('');
        }

        // ========================================================================
        // Iframe Smoke Tests
        // ========================================================================

        let IFRAMES = [];
        let iframeConfig = {};
        const smokeResults = {};

        async function loadIframeConfig() {
            try {
                const res = await fetch('/api/iframes');
                const data = await res.json();
                IFRAMES = data.iframes || [];
                iframeConfig = {};
                IFRAMES.forEach(f => { iframeConfig[f.id] = f; });
                return IFRAMES;
            } catch (e) {
                log('Failed to load iframe config: ' + e.message, 'err');
                return [];
            }
        }

        function renderSmokeGrid() {
            const grid = document.getElementById('smoke-grid');
            const statusEl = document.getElementById('smoke-status');

            const enabled = IFRAMES.filter(f => f.enabled).length;
            statusEl.textContent = `${enabled}/${IFRAMES.length} enabled`;

            grid.innerHTML = IFRAMES.map(f => {
                const disabledClass = f.enabled ? '' : ' disabled';
                const toggleClass = f.enabled ? ' enabled' : '';
                return `<div class="smoke-item pending${disabledClass}" data-iframe="${f.id}">
                    <div class="iframe-toggle${toggleClass}" data-iframe="${f.id}" title="${f.enabled ? 'Disable' : 'Enable'}"></div>
                    <span class="name">${f.id}</span>
                    <span class="time">--</span>
                </div>`;
            }).join('');

            // Add toggle click handlers
            grid.querySelectorAll('.iframe-toggle').forEach(toggle => {
                toggle.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const id = toggle.dataset.iframe;
                    const iframe = iframeConfig[id];
                    if (!iframe) return;

                    const newEnabled = !iframe.enabled;
                    toggle.classList.toggle('enabled', newEnabled);

                    try {
                        const res = await fetch(`/api/iframes/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ enabled: newEnabled })
                        });
                        if (res.ok) {
                            iframe.enabled = newEnabled;
                            const item = toggle.closest('.smoke-item');
                            item.classList.toggle('disabled', !newEnabled);
                            log(`${id}: ${newEnabled ? 'enabled' : 'disabled'}`, 'ok');

                            // Update status count
                            const enabled = IFRAMES.filter(f => f.enabled).length;
                            statusEl.textContent = `${enabled}/${IFRAMES.length} enabled`;
                        }
                    } catch (e) {
                        log(`Failed to update ${id}: ${e.message}`, 'err');
                        toggle.classList.toggle('enabled', iframe.enabled);
                    }
                });
            });
        }

        async function initSmokeGrid() {
            await loadIframeConfig();
            renderSmokeGrid();
        }

        // Check iframe existence (HEAD request - fast)
        async function checkIframe(name) {
            const item = document.querySelector(`.smoke-item[data-iframe="${name}"]`);
            if (!item) return;

            const iframe = iframeConfig[name];
            if (!iframe?.enabled) {
                item.querySelector('.time').textContent = '--';
                return;
            }

            item.className = item.className.replace(/pending|pass|fail/, 'running');
            item.querySelector('.time').textContent = '...';

            const url = iframe.src.startsWith('http') ? iframe.src : `${name}.iframe.html?org=${Terrain.State.org}&env=${Terrain.State.env}`;
            const start = Date.now();

            try {
                const res = await fetch(url, { method: 'HEAD' });
                const duration = Date.now() - start;
                smokeResults[name] = { ok: res.ok, duration };

                item.className = item.className.replace('running', res.ok ? 'pass' : 'fail');
                item.querySelector('.time').textContent = res.ok ? `${duration}ms` : 'ERR';
            } catch (e) {
                smokeResults[name] = { ok: false, error: e.message };
                item.className = item.className.replace('running', 'fail');
                item.querySelector('.time').textContent = 'ERR';
            }
        }

        // Run iframe (actually load and execute JS)
        async function runIframe(name) {
            const item = document.querySelector(`.smoke-item[data-iframe="${name}"]`);
            if (!item) return;

            const iframe = iframeConfig[name];
            if (!iframe?.enabled) {
                item.querySelector('.time').textContent = '--';
                return;
            }

            item.className = item.className.replace(/pending|pass|fail/, 'running');
            item.querySelector('.time').textContent = '...';

            const url = iframe.src.startsWith('http') ? iframe.src : `${name}.iframe.html?org=${Terrain.State.org}&env=${Terrain.State.env}`;
            const start = Date.now();

            return new Promise(resolve => {
                const testFrame = document.createElement('iframe');
                testFrame.style.cssText = 'position:absolute;width:1px;height:1px;opacity:0;pointer-events:none;';
                testFrame.src = url;

                const timeout = setTimeout(() => {
                    cleanup();
                    smokeResults[name] = { ok: false, error: 'timeout' };
                    item.className = item.className.replace('running', 'fail');
                    item.querySelector('.time').textContent = '>5s';
                    resolve();
                }, 5000);

                function cleanup() {
                    clearTimeout(timeout);
                    if (testFrame.parentNode) testFrame.remove();
                }

                testFrame.onload = () => {
                    const duration = Date.now() - start;
                    cleanup();
                    smokeResults[name] = { ok: true, duration };
                    item.className = item.className.replace('running', 'pass');
                    item.querySelector('.time').textContent = `${duration}ms`;
                    resolve();
                };

                testFrame.onerror = () => {
                    cleanup();
                    smokeResults[name] = { ok: false, error: 'load error' };
                    item.className = item.className.replace('running', 'fail');
                    item.querySelector('.time').textContent = 'ERR';
                    resolve();
                };

                document.body.appendChild(testFrame);
            });
        }

        async function checkAllIframes() {
            const statusEl = document.getElementById('smoke-status');
            statusEl.textContent = 'Checking...';
            log('Checking iframe files (HEAD)');

            const enabledIframes = IFRAMES.filter(f => f.enabled);
            await Promise.all(enabledIframes.map(f => checkIframe(f.id)));

            const passed = Object.values(smokeResults).filter(r => r.ok).length;
            const total = enabledIframes.length;
            statusEl.textContent = `${passed}/${total} exist`;
            log(`Check: ${passed}/${total} files exist`, passed === total ? 'ok' : 'warn');
        }

        async function runAllIframes() {
            const statusEl = document.getElementById('smoke-status');
            statusEl.textContent = 'Loading...';
            log('Running iframe load tests');

            const enabledIframes = IFRAMES.filter(f => f.enabled);
            for (const iframe of enabledIframes) {
                await runIframe(iframe.id);
            }

            const passed = Object.values(smokeResults).filter(r => r.ok).length;
            const total = enabledIframes.length;
            const avgTime = Math.round(
                Object.values(smokeResults)
                    .filter(r => r.ok && r.duration)
                    .reduce((sum, r) => sum + r.duration, 0) / (passed || 1)
            ) || 0;

            statusEl.textContent = `${passed}/${total} OK, avg ${avgTime}ms`;
            log(`Run: ${passed}/${total} loaded, avg ${avgTime}ms`, passed === total ? 'ok' : 'warn');
        }

        initSmokeGrid();

        // Action handlers
        Terrain.Iframe
            .on('check-health', checkHealth)
            .on('refresh-all', () => { checkHealth(); loadCaptures(); })
            .on('clear-cache', () => {
                ApiCache.clear();
                document.getElementById('api-cached').textContent = '0';
                log('Cache cleared', 'info');
            })
            .on('preview-groom', previewGroom)
            .on('run-groom', runGroom)
            .on('check-iframes', checkAllIframes)
            .on('run-iframes', runAllIframes);

        // Listen for timing updates
        Terrain.Bus.subscribe('*', msg => {
            if (msg.type === 'timing-update' && msg.timings) updateTimings(msg.timings);
        });

        // Listen for env changes
        Terrain.State.onEnvChange(() => {
            updateContext();
            checkHealth();
            loadCaptures();
            log(`Context changed: ${Terrain.State.org}/${Terrain.State.env}`);
        });

        // ========================================================================
        // Help System
        // ========================================================================

        let activeHelpPanel = 'all';
        let helpSearchTimeout = null;

        function renderAllArticle() {
            let html = '<div class="help-article">';
            for (const [id, cat] of Object.entries(HELP_DATA)) {
                html += `<div class="help-category" data-category="${id}">`;
                html += `<div class="category-title">${cat.title}</div>`;
                html += cat.sections.map(s => renderHelpSection(s)).join('');
                html += '</div>';
            }
            html += '</div>';
            return html;
        }

        function initHelp() {
            if (!window.HELP_DATA) return;

            const subtabsEl = document.getElementById('help-subtabs');
            const contentEl = document.getElementById('help-content');
            const searchEl = document.getElementById('help-search');

            // Render sub-tabs with ALL first
            subtabsEl.innerHTML = '<div class="help-subtab all active" data-panel="all">ALL</div>' +
                Object.entries(HELP_DATA).map(([id, cat]) =>
                    `<div class="help-subtab" data-panel="${id}">${cat.title}</div>`
                ).join('');

            // Render ALL panel + individual category panels
            contentEl.innerHTML =
                `<div class="help-panel active" data-panel="all">${renderAllArticle()}</div>` +
                Object.entries(HELP_DATA).map(([id, cat]) =>
                    renderHelpCategory(id, cat)
                ).join('');

            // Sub-tab click handlers
            subtabsEl.querySelectorAll('.help-subtab').forEach(tab => {
                tab.addEventListener('click', () => {
                    subtabsEl.querySelectorAll('.help-subtab').forEach(t => t.classList.remove('active'));
                    contentEl.querySelectorAll('.help-panel').forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    const panel = contentEl.querySelector(`[data-panel="${tab.dataset.panel}"]`);
                    if (panel) panel.classList.add('active');
                    activeHelpPanel = tab.dataset.panel;
                    searchEl.value = '';
                    clearSearch();
                });
            });

            // Search functionality - searches current tab (API or Help)
            searchEl.addEventListener('input', (e) => {
                clearTimeout(helpSearchTimeout);
                helpSearchTimeout = setTimeout(() => {
                    const query = e.target.value.trim();
                    const activeTab = localStorage.getItem(ADMIN_TAB_KEY) || 'admin';

                    if (query) {
                        // If on Admin tab, switch to API for search
                        if (activeTab === 'admin') {
                            setActiveTab('api');
                        }
                    }

                    // Search API tab
                    if (typeof ApiReference !== 'undefined') {
                        ApiReference.render(query);
                    }

                    // Also search Help tab
                    performSearch(query);
                }, 150);
            });
        }

        function performSearch(query) {
            const contentEl = document.getElementById('help-content');
            const subtabsEl = document.getElementById('help-subtabs');
            const q = query.toLowerCase().trim();

            if (!q) {
                clearSearch();
                return;
            }

            // Switch to ALL panel for search results
            subtabsEl.querySelectorAll('.help-subtab').forEach(t => t.classList.remove('active'));
            subtabsEl.querySelector('[data-panel="all"]').classList.add('active');
            contentEl.querySelectorAll('.help-panel').forEach(p => p.classList.remove('active'));
            const allPanel = contentEl.querySelector('[data-panel="all"]');
            allPanel.classList.add('active', 'search-active');

            // Search and highlight matching sections
            let hasResults = false;
            allPanel.querySelectorAll('.help-section').forEach(section => {
                const text = section.textContent.toLowerCase();
                const keywords = section.dataset.keywords || '';
                const matches = text.includes(q) || keywords.includes(q);
                section.classList.toggle('match', matches);
                if (matches) hasResults = true;
            });

            // Hide categories with no matches
            allPanel.querySelectorAll('.help-category').forEach(cat => {
                const hasMatch = cat.querySelector('.help-section.match');
                cat.style.display = hasMatch ? '' : 'none';
            });

            // Update subtab highlights
            subtabsEl.querySelectorAll('.help-subtab:not(.all)').forEach(tab => {
                const catId = tab.dataset.panel;
                const cat = allPanel.querySelector(`[data-category="${catId}"]`);
                tab.style.opacity = cat?.querySelector('.help-section.match') ? '1' : '0.4';
            });
        }

        function clearSearch() {
            const contentEl = document.getElementById('help-content');
            const subtabsEl = document.getElementById('help-subtabs');

            contentEl.querySelectorAll('.help-panel').forEach(panel => {
                panel.classList.remove('search-active');
                panel.classList.toggle('active', panel.dataset.panel === activeHelpPanel);
                panel.querySelectorAll('.help-section').forEach(s => s.classList.remove('match'));
            });

            // Show all categories
            contentEl.querySelectorAll('.help-category').forEach(cat => {
                cat.style.display = '';
            });

            subtabsEl.querySelectorAll('.help-subtab').forEach(tab => {
                tab.style.opacity = '1';
            });
        }

        // Initialize help on load
        initHelp();

        // Initialize
        Terrain.Iframe.init({
            name: 'admin',
            onReady: () => {
                updateContext();
                checkHealth();
                loadCaptures();
                Terrain.Iframe.send({ type: 'request-timings', source: 'admin' });
            }
        });
    </script>
</body>
</html>
