<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Deploy</title>
    <link rel="stylesheet" href="shared.css">
    <link rel="stylesheet" href="iframe-base.css">
    <style>
        body { padding: 12px; }

        /* Target cards - base */
        .target {
            background: var(--paper-mid);
            margin-bottom: 6px;
            border-radius: 4px;
            border: 1px solid var(--border);
            padding: 10px 14px;
            transition: border-color 0.15s;
        }
        .target:hover { border-color: var(--four); }
        .target.has-output { border-color: var(--two); }

        /* Header row: name + actions + toggle */
        .target-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .target-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .target-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        .target-toggle {
            font-size: 14px;
            font-weight: 300;
            color: var(--ink-muted);
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            cursor: pointer;
            border-radius: 3px;
            margin-left: 8px;
        }
        .target-toggle:hover { background: var(--paper-dark); color: var(--four); }

        /* Subtitle (description) */
        .target-subtitle {
            color: var(--ink-muted);
            font-size: 9px;
            margin-top: 6px;
            padding-left: 2px;
        }

        /* Collapsed state */
        .target.icon .target-details { display: none; }
        .target.icon .target-subtitle { display: none; }

        /* Expanded state */
        .target.expanded .target-details {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 4px 12px;
            padding: 12px 0 0 0;
            margin-top: 10px;
            border-top: 1px solid var(--border);
            font-size: 9px;
            color: var(--ink-muted);
            line-height: 1.5;
        }

        .target-name {
            color: var(--four);
            font-weight: 700;
            font-size: 12px;
        }
        .target-active {
            color: var(--two);
            font-size: 8px;
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .detail-label {
            color: var(--ink-muted);
            text-align: right;
            white-space: nowrap;
        }
        .detail-label.env-name { color: var(--three); font-weight: 600; }
        .detail-value { color: var(--ink); }
        .detail-row { display: contents; }
        .env-branch { color: var(--four); font-style: italic; font-size: 8px; margin-left: 8px; }
        .toml-path { opacity: 0.5; }
        .toml-path .detail-value { font-family: monospace; font-size: 8px; }

        /* Pipeline flow (step-by-step visualization) */
        .pipeline-flow {
            display: flex;
            align-items: center;
            gap: 2px;
            flex-wrap: wrap;
        }
        .step {
            font-size: 8px;
            padding: 1px 5px;
            border-radius: 2px;
            background: var(--paper-dark);
            color: var(--ink-muted);
            font-family: monospace;
        }
        .step-remote { color: var(--three); }
        .step-build { color: var(--two); }
        .step-push { color: var(--four); font-weight: 600; }
        .step-arrow { color: var(--ink-muted); font-size: 8px; margin: 0 1px; }
        .step-count {
            font-size: 7px;
            margin-left: 3px;
            opacity: 0.6;
        }

        .pipeline-tags, .remote-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .pipeline-tag, .remote-tag {
            font-size: 8px;
            padding: 1px 5px;
            border-radius: 2px;
            background: var(--paper-dark);
            color: var(--ink-muted);
        }
        .pipeline-tag { color: var(--four); cursor: default; }

        .env-select, .pipeline-select {
            background: var(--paper-dark);
            border: 1px solid var(--border);
            color: var(--ink);
            padding: 2px 6px;
            font-size: 9px;
            border-radius: 2px;
        }
        .deploy-btn {
            padding: 3px 8px;
            font-size: 9px;
        }
        .deploy-btn.danger {
            background: #f59e0b;
            border-color: #f59e0b;
            color: #000;
            font-weight: 600;
        }
        .deploy-btn.danger:hover {
            background: #d97706;
            border-color: #d97706;
        }

        /* History filter indicator */
        .history-filter {
            display: none;
            align-items: center;
            gap: 6px;
            font-size: 9px;
            color: var(--four);
            padding: 2px 8px;
            margin-bottom: 4px;
        }
        .filter-clear {
            cursor: pointer;
            font-size: 12px;
            color: var(--ink-muted);
            padding: 0 4px;
        }
        .filter-clear:hover { color: var(--one); }

        /* History items */
        .history-item {
            padding: 4px 8px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.1s;
        }
        .history-item:hover { background: var(--paper-mid); }

        .history-row {
            display: flex;
            gap: 8px;
            font-size: 10px;
            font-family: monospace;
            align-items: baseline;
        }
        .history-item .timestamp { color: var(--ink-muted); min-width: 56px; text-align: right; flex-shrink: 0; }
        .history-item .h-target { color: var(--four); min-width: 70px; flex-shrink: 0; }
        .history-item .h-pipeline { color: var(--two); min-width: 52px; flex-shrink: 0; font-size: 9px; }
        .history-item .h-env { color: var(--three); min-width: 44px; flex-shrink: 0; }
        .history-item .h-status { min-width: 52px; flex-shrink: 0; }
        .history-item .h-status.success { color: var(--two); }
        .history-item .h-status.failed { color: var(--one); }
        .history-item .h-duration { color: var(--ink-muted); text-align: right; min-width: 36px; }

        .history-details {
            display: none;
            padding: 6px 8px 6px 64px;
            font-size: 9px;
            font-family: monospace;
            color: var(--ink-muted);
            line-height: 1.2;
        }
        .history-item.expanded .history-details { display: block; }
        .history-details .hd-line { display: block; padding: 1px 0; }
        .hd-label { color: var(--ink-muted); opacity: 0.6; display: inline-block; min-width: 52px; }
        .hd-value { color: var(--ink); }
        .hd-steps { color: var(--two); font-size: 8px; }

        /* Ghost delete button */
        .h-delete {
            color: var(--ink-muted);
            opacity: 0;
            cursor: pointer;
            padding: 1px 4px;
            font-size: 8px;
            border: 1px solid transparent;
            border-radius: 2px;
            transition: opacity 0.1s, color 0.1s, border-color 0.1s;
            margin-left: auto;
        }
        .history-item:hover .h-delete { opacity: 0.5; }
        .h-delete:hover { opacity: 1 !important; color: var(--ink); border-color: var(--border); }
        .h-delete.confirming {
            opacity: 1 !important;
            color: var(--one);
            border-color: var(--one);
        }

        /* Delete animation */
        .history-item.deleting { pointer-events: none; }
        .history-item.deleted {
            opacity: 0;
            height: 0 !important;
            padding: 0 !important;
            overflow: hidden;
            transition: opacity 0.15s, height 0.15s;
        }

        /* Output container */
        .output-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 8px;
            background: var(--paper-dark);
            border-bottom: 1px solid var(--border);
            border-radius: 3px 3px 0 0;
        }
        .output-label {
            font-size: 9px;
            font-weight: 700;
            color: var(--four);
        }
        .output-close {
            cursor: pointer;
            font-size: 14px;
            color: var(--ink-muted);
            padding: 0 4px;
            line-height: 1;
        }
        .output-close:hover { color: var(--one); }
        .output-pre {
            margin: 0;
            padding: 8px;
            font-size: 9px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
            color: var(--ink);
            background: var(--paper-dark);
            border-radius: 0 0 3px 3px;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.5;
        }

        /* Inline per-target output */
        .target-output {
            margin-top: 8px;
            padding-left: 20px;
        }
        .target.icon .target-output { display: none; }

        /* Deploy output formatting */
        .out-header { color: var(--four); font-weight: 700; }
        .out-dryrun { color: var(--three); font-weight: 700; }
        .out-step { color: var(--two); font-weight: 600; }
        .out-rule { color: var(--ink-muted); opacity: 0.4; }
        .out-done { color: var(--two); }
        .out-cmd { color: var(--ink); opacity: 0.8; }

        /* Streaming indicator */
        .streaming-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--two);
            border-radius: 50%;
            margin-right: 6px;
            animation: pulse 1s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .output-header.streaming {
            border-left: 2px solid var(--two);
            padding-left: 6px;
        }
        .output-pre.streaming {
            border-left: 2px solid var(--two);
        }

        /* TOML Editor */
        .target-editor { padding: 8px 0 0 20px; display: none; }
        .target-editor.active { display: block; }
        .target.icon .target-editor { display: none; }
        .editor-hints { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 4px; font-size: 8px; }
        .editor-hint { padding: 1px 5px; border-radius: 2px; background: var(--paper-dark); cursor: pointer; }
        .editor-hint:hover { opacity: 0.8; }
        .editor-hint.section { color: var(--four); }
        .editor-hint.var { color: var(--three); }
        .editor-textarea {
            width: 100%; min-height: 200px; max-height: 400px; resize: vertical;
            font-family: monospace; font-size: 9px; line-height: 1.5;
            background: var(--paper-dark); color: var(--ink); border: 1px solid var(--border);
            border-radius: 3px; padding: 8px; tab-size: 4;
        }
        .editor-actions { display: flex; gap: 8px; margin-top: 4px; align-items: center; }
        .editor-msg { font-size: 9px; margin-left: 8px; }

        /* CLI Help section */
        .help-toggle {
            cursor: pointer;
            user-select: none;
        }
        .help-toggle:hover { color: var(--four); }
        .help-body { display: none; }
        .help-section.open .help-body { display: block; }
        .help-section.open .help-arrow { transform: rotate(90deg); }
        .help-arrow {
            display: inline-block;
            font-size: 8px;
            margin-right: 4px;
            transition: transform 0.15s;
        }
        .help-body {
            padding: 8px 0 4px 4px;
            font-size: 9px;
            font-family: monospace;
            line-height: 1.8;
            color: var(--ink-muted);
        }
        .help-body .h-section { color: var(--four); font-weight: 700; margin-top: 8px; display: block; }
        .help-body .h-cmd { color: var(--three); }
        .help-body .h-arg { color: var(--two); }
        .help-body .h-desc { color: var(--ink-muted); }
        .help-body .h-example { color: var(--ink); opacity: 0.8; }
        .help-body .h-comment { color: var(--ink-muted); opacity: 0.5; }
        .help-body .h-org { color: var(--four); font-weight: 700; }
        .help-body .h-target { color: var(--three); }
        .help-body .h-pipeline { color: var(--two); }
        .help-body .h-env { color: var(--two); font-style: italic; }
    </style>
</head>
<body>
    <div class="iframe-header flat">
        <span>Deploy</span>
        <span class="refresh" data-action="refresh">&#8635;</span>
    </div>

    <div class="section">
        <div class="section-title">Targets</div>
        <div id="targets">
            <div class="empty">Loading...</div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Recent Deployments <span style="font-weight:400;font-size:8px;color:var(--ink-muted);margin-left:8px">$TETRA_DIR/deploy/logs/deploy.log</span></div>
        <div id="history-filter" class="history-filter"></div>
        <div id="history">
            <div class="empty">Loading...</div>
        </div>
    </div>

    <div id="output-container" style="display: none;">
        <div class="section-title">Output</div>
        <div id="output" class="output"></div>
    </div>

    <div class="section help-section" id="help-section">
        <div class="section-title help-toggle" onclick="document.getElementById('help-section').classList.toggle('open')">
            <span class="help-arrow">&#9654;</span> CLI Reference
        </div>
        <div class="help-body">
            <span class="h-section">Address Format</span>
            <span class="h-org">org</span>:<span class="h-target">target</span>:<span class="h-pipeline">pipeline</span> <span class="h-env">env</span> <span class="h-desc">[-n]</span>

            <span class="h-section">Direct Mode</span>
            <span class="h-cmd">deploy</span> <span class="h-target">pbase</span>:<span class="h-pipeline">full</span> <span class="h-env">dev</span>        <span class="h-comment"># deploy target:pipeline to env</span>
            <span class="h-cmd">deploy</span> <span class="h-target">pbase</span>:<span class="h-pipeline">quick</span> <span class="h-env">dev</span>          <span class="h-comment"># quick pipeline</span>
            <span class="h-cmd">deploy</span> <span class="h-target">pbase</span>:<span class="h-pipeline">status</span> <span class="h-env">dev</span>         <span class="h-comment"># check status</span>
            <span class="h-cmd">deploy</span> <span class="h-target">pbase</span>:<span class="h-pipeline">full</span> <span class="h-env">dev</span> <span class="h-desc">-n</span>     <span class="h-comment"># dry run</span>

            <span class="h-section">Context Mode</span>
            <span class="h-cmd">deploy set</span> <span class="h-org">pixeljam-arcade</span> <span class="h-target">pbase</span> <span class="h-env">dev</span>  <span class="h-comment"># set context</span>
            <span class="h-cmd">deploy info</span>                              <span class="h-comment"># show context</span>
            <span class="h-cmd">deploy</span>                                   <span class="h-comment"># deploy with context</span>
            <span class="h-cmd">deploy</span> <span class="h-desc">-n</span>                                <span class="h-comment"># dry run with context</span>
            <span class="h-cmd">deploy clear</span>                             <span class="h-comment"># clear context</span>

            <span class="h-section">Config</span>
            <span class="h-cmd">deploy show</span> <span class="h-target">pbase</span> <span class="h-env">dev</span>               <span class="h-comment"># show resolved config</span>
            <span class="h-cmd">deploy list</span>                              <span class="h-comment"># list all targets</span>
            <span class="h-cmd">deploy history</span>                           <span class="h-comment"># recent deployments</span>
            <span class="h-cmd">$EDITOR $DEPLOY_RESOLVED_TOML</span>            <span class="h-comment"># edit target TOML</span>

            <span class="h-section">Aliases</span>
            <span class="h-cmd">deploy</span> <span class="h-target">pbase</span>:<span class="h-pipeline">q</span> <span class="h-env">dev</span>   <span class="h-comment"># quick</span>    <span class="h-cmd">deploy</span> <span class="h-target">pbase</span>:<span class="h-pipeline">r</span> <span class="h-env">dev</span>   <span class="h-comment"># restart</span>    <span class="h-cmd">deploy</span> <span class="h-target">pbase</span>:<span class="h-pipeline">s</span> <span class="h-env">dev</span>   <span class="h-comment"># status</span>

            <span class="h-section">Pipeline Steps</span>
            <span class="h-arg">remote:X</span>  <span class="h-desc">Run command X on server via SSH</span>
            <span class="h-arg">build:X</span>   <span class="h-desc">Run build command X locally</span>
            <span class="h-arg">push</span>      <span class="h-desc">Transfer files to remote server</span>
            <span class="h-arg">post:X</span>    <span class="h-desc">Post-deploy command on server</span>
        </div>
    </div>

    <script src="/js/terrain-iframe.js"></script>
    <script src="/js/iframe-init.js"></script>
    <script src="/js/deploy.js"></script>
</body>
</html>
