<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Infrastructure</title>
    <link rel="stylesheet" href="shared.css">
    <link rel="stylesheet" href="infra.css">
    <script src="js/terrain-iframe.js"></script>
</head>
<body>
    <div class="iframe-header" style="padding: 0 0 8px 0; border: none;">
        <div class="infra-tabs">
            <span class="infra-tab active" data-tab="servers">Servers</span>
            <span class="infra-tab" data-tab="storage">Storage</span>
            <span class="infra-tab" data-tab="backups">Backups</span>
            <span class="infra-tab" data-tab="info">Info</span>
        </div>
        <span class="refresh icon-refresh" data-action="refresh"></span>
    </div>

    <div id="tab-servers" class="tab-content active">
        <div class="legend">
            <div class="legend-item"><div class="legend-dot important"></div> Important</div>
            <div class="legend-item"><div class="legend-dot active"></div> Active</div>
            <div class="legend-item"><div class="legend-dot cleanup"></div> Cleanup</div>
        </div>
        <div class="server-grid" id="server-grid"></div>
    </div>

    <div id="tab-storage" class="tab-content">
        <div class="storage-panel">
            <div class="storage-header">
                <span class="storage-title">S3/Spaces Storage</span>
                <span class="storage-status" id="storage-status">Checking...</span>
            </div>
            <div class="storage-config" id="storage-config">
                <div class="loading">Loading storage configuration...</div>
            </div>
            <div class="storage-browser" id="storage-browser">
                <!-- Populated by JS -->
            </div>
            <div class="storage-actions">
                <h4>Quick Commands</h4>
                <div class="cmd">org storage status          # Check connectivity
org storage test            # Upload/download test
tsm logs export all         # Export all logs to S3</div>
                <h4>Configuration</h4>
                <div class="cmd"># Set credentials
export DO_SPACES_KEY="your-key"
export DO_SPACES_SECRET="your-secret"

# Initialize bucket
org storage init</div>
            </div>
        </div>
    </div>

    <div id="tab-backups" class="tab-content">
        <div class="info-panel">
            <h3>Backup Status</h3>
            <div id="backup-status">
                <div class="empty">Loading backup status...</div>
            </div>
            <h3>Quick Commands</h3>
            <div class="cmd">cd /media/mricos/1TB/do-backups
./backup-do4-n2.sh --dry-run   # Preview
./backup-do4-n2.sh              # Execute</div>
            <h3>Collect Inventory</h3>
            <div class="cmd">TETRA_ORG=nodeholder ~/tetra/browser/collect-inventory.sh
# or single server:
~/tetra/browser/collect-inventory.sh do4-n2</div>
        </div>
    </div>

    <div id="tab-info" class="tab-content">
        <div class="info-panel">
            <h3>Infrastructure Browser</h3>
            <p>Survey, backup, and manage server infrastructure for the active org.</p>

            <h3>Org Repos</h3>
            <div class="cmd">Config repos (per-org):
  tetra-config, nodeholder-config, pja-config
  transreal-config, phm-config

Games repos (per-org):
  tetra-games

Registry: $TETRA_DIR/orgs/repos.toml
  → symlink to tetra/repos.toml</div>

            <h3>Clone Workflow</h3>
            <div class="cmd"># Bootstrap on new machine
cd $TETRA_DIR/orgs
git clone git@github.com:mricos/tetra-config.git tetra
ln -s tetra/repos.toml repos.toml
git clone git@github.com:mricos/tetra-games.git tetra/games

# For orgs with infrastructure
org import nh nodeholder  # NH → sections/10-infrastructure.toml
org build nodeholder       # sections/*.toml → tetra.toml</div>

            <h3>Architecture</h3>
            <div class="cmd">~/tetra/orgs/{org}/
├── sections/        # TOML source files
├── tetra.toml       # Built config (org build)
├── tsm/             # Service definitions
├── games/           # Cloned games repo
└── repos.toml       # Symlink (tetra only)

~/tetra/browser/
├── server.py        # Standalone browser server
└── collect-inventory.sh</div>

            <h3>Backup Config (backup.toml)</h3>
            <p>Define per-server include/exclude rules:</p>
            <div class="cmd">[servers.do4-n2]
ip = "68.183.248.67"
priority = 1
status = "important"
include = ["/home/mricos", "/home/devops"]
exclude = ["ds-env", "nltk_data", "dist"]</div>

            <h3>Workflow</h3>
            <p>1. <code>collect-inventory.sh</code> - Survey all servers</p>
            <p>2. Review in this panel - drill into users/dirs</p>
            <p>3. Edit <code>backup.toml</code> - set include/exclude</p>
            <p>4. <code>backup-{server}.sh --dry-run</code> - Preview</p>
            <p>5. <code>backup-{server}.sh</code> - Execute backup</p>

            <h3>Excludes (default)</h3>
            <p>node_modules, __pycache__, .venv, venv, .cache, .npm, dist, build, ds-env, nltk_data</p>
        </div>
    </div>

    <div class="detail-panel" id="detail-panel">
        <span class="detail-close">&times;</span>
        <div id="detail-body"></div>
    </div>

    <!-- Fallback data when API unavailable -->
    <script type="application/json" id="fallback-data">
    {
        "org": "nodeholder",
        "servers": {
            "do4-n2": {
                "ip": "68.183.248.67",
                "floating_ip": "167.99.0.123",
                "priority": 1,
                "status": "important",
                "description": "Production server",
                "include": ["/home/mricos", "/home/devops"],
                "exclude": ["ds-env", "nltk_data", "dist"]
            },
            "do4": {
                "ip": "159.65.106.21",
                "priority": 2,
                "status": "active",
                "description": "NFS server, many users",
                "include": ["/home/mricos", "/home/devops"]
            },
            "do5": {
                "ip": "138.68.2.192",
                "priority": 3,
                "status": "active",
                "description": "study-groups.org",
                "include": ["/home/mricos", "/home/devops"]
            },
            "do1": {
                "ip": "192.34.62.148",
                "priority": 4,
                "status": "cleanup",
                "description": "Ubuntu 16.04 EOL",
                "include": ["/home/mricos"]
            },
            "do3-fedora-nyc1": {
                "ip": "174.138.110.75",
                "priority": 5,
                "status": "cleanup",
                "description": "Stopped docker"
            },
            "do6": {
                "ip": "138.68.143.119",
                "priority": 6,
                "status": "cleanup",
                "description": "Idle server"
            },
            "ghost-sfo2-01": {
                "ip": "159.65.74.83",
                "priority": 7,
                "status": "cleanup",
                "description": "Ghost blog, docker"
            },
            "nodeholder-qa": {
                "ip": "165.232.139.55",
                "priority": 8,
                "status": "cleanup",
                "description": "QA server"
            }
        },
        "inventory": {}
    }
    </script>

    <script src="infra.js"></script>
</body>
</html>
