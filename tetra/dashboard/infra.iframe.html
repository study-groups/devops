<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Infrastructure</title>
    <link rel="stylesheet" href="shared.css">
    <style>
        body {
            font-size: 11px;
            padding: 12px;
            height: 100vh;
            overflow-y: auto;
        }

        /* Tabs */
        .infra-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 12px;
        }
        .infra-tab {
            padding: 6px 12px;
            font-size: 10px;
            color: var(--ink-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .infra-tab:hover { color: var(--ink); }
        .infra-tab.active {
            color: var(--ink);
            border-bottom-color: var(--four);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Server cards */
        .server-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
        }
        .server-card {
            background: var(--paper-mid);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 10px;
            cursor: pointer;
            transition: border-color 0.15s;
        }
        .server-card:hover { border-color: var(--four); }
        .server-card.important { border-left: 3px solid var(--one); }
        .server-card.active { border-left: 3px solid var(--two); }
        .server-card.cleanup { border-left: 3px solid var(--ink-muted); opacity: 0.7; }

        .server-name {
            font-weight: 600;
            color: var(--two);
            margin-bottom: 4px;
        }
        .server-ip {
            font-size: 9px;
            color: var(--ink-muted);
            font-family: monospace;
        }
        .server-desc {
            font-size: 9px;
            color: var(--ink);
            margin-top: 6px;
        }
        .server-stats {
            display: flex;
            gap: 10px;
            margin-top: 8px;
            font-size: 9px;
            color: var(--ink-muted);
        }
        .server-badge {
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 8px;
            background: var(--paper-light);
            float: right;
        }
        .server-badge.important { background: rgba(255,107,107,0.2); color: var(--one); }
        .server-badge.cleanup { background: var(--paper-light); color: var(--ink-muted); }

        /* User list inside card */
        .user-list {
            margin-top: 8px;
            border-top: 1px solid var(--border);
            padding-top: 6px;
        }
        .user-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 9px;
        }
        .user-name { color: var(--three); }
        .user-size { color: var(--ink-muted); }

        /* Detail panel */
        .detail-panel {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 320px;
            height: 100%;
            background: var(--paper-mid);
            border-left: 1px solid var(--border);
            padding: 12px;
            overflow-y: auto;
            z-index: 100;
        }
        .detail-panel.open { display: block; }
        .detail-close {
            position: absolute;
            top: 8px;
            right: 12px;
            cursor: pointer;
            color: var(--ink-muted);
            font-size: 16px;
        }
        .detail-close:hover { color: var(--ink); }
        .detail-title {
            color: var(--two);
            font-size: 14px;
            margin-bottom: 12px;
        }
        .detail-section {
            margin: 12px 0;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }
        .detail-section-title {
            color: var(--three);
            font-size: 9px;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        /* Directory tree */
        .dir-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 6px;
            margin: 2px 0;
            background: var(--paper-dark);
            border-radius: 2px;
            font-size: 9px;
        }
        .dir-item:hover { background: var(--paper-light); }
        .dir-item.excluded { opacity: 0.5; text-decoration: line-through; }
        .dir-name { color: var(--two); }
        .dir-size { color: var(--ink-muted); }

        /* Command display */
        .cmd {
            background: var(--paper-dark);
            padding: 8px;
            border-radius: 2px;
            font-size: 9px;
            margin: 6px 0;
            border-left: 2px solid var(--four);
            word-break: break-all;
        }

        /* Buttons */
        .btn {
            padding: 4px 8px;
            border: 1px solid var(--border);
            background: var(--paper-light);
            color: var(--ink);
            font-size: 9px;
            border-radius: 2px;
            cursor: pointer;
            margin-right: 4px;
        }
        .btn:hover { border-color: var(--four); }
        .btn.primary { background: var(--four); border-color: var(--four); }

        /* Info panel */
        .info-panel { padding: 8px 0; font-size: 10px; line-height: 1.5; }
        .info-panel h3 { color: var(--three); font-size: 11px; margin: 16px 0 8px 0; }
        .info-panel h3:first-child { margin-top: 0; }
        .info-panel code { background: var(--paper-mid); padding: 1px 4px; border-radius: 2px; font-size: 9px; color: var(--two); }

        /* Legend */
        .legend {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 9px;
            color: var(--ink-muted);
        }
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-dot { width: 8px; height: 3px; border-radius: 1px; }
        .legend-dot.important { background: var(--one); }
        .legend-dot.active { background: var(--two); }
        .legend-dot.cleanup { background: var(--ink-muted); }
    </style>
</head>
<body>
    <div class="iframe-header" style="padding: 0 0 8px 0; border: none;">
        <div class="infra-tabs">
            <span class="infra-tab active" data-tab="servers">Servers</span>
            <span class="infra-tab" data-tab="backups">Backups</span>
            <span class="infra-tab" data-tab="info">Info</span>
        </div>
        <span class="refresh icon-refresh" data-action="refresh"></span>
    </div>

    <div id="tab-servers" class="tab-content active">
        <div class="legend">
            <div class="legend-item"><div class="legend-dot important"></div> Important</div>
            <div class="legend-item"><div class="legend-dot active"></div> Active</div>
            <div class="legend-item"><div class="legend-dot cleanup"></div> Cleanup</div>
        </div>
        <div class="server-grid" id="server-grid"></div>
    </div>

    <div id="tab-backups" class="tab-content">
        <div class="info-panel">
            <h3>Backup Status</h3>
            <div id="backup-status">
                <div class="empty">Loading backup status...</div>
            </div>
            <h3>Quick Commands</h3>
            <div class="cmd">cd /media/mricos/1TB/do-backups
./backup-do4-n2.sh --dry-run   # Preview
./backup-do4-n2.sh              # Execute</div>
            <h3>Collect Inventory</h3>
            <div class="cmd">TETRA_ORG=nodeholder ~/tetra/browser/collect-inventory.sh
# or single server:
~/tetra/browser/collect-inventory.sh do4-n2</div>
        </div>
    </div>

    <div id="tab-info" class="tab-content">
        <div class="info-panel">
            <h3>Infrastructure Browser</h3>
            <p>Survey, backup, and manage server infrastructure for the active org.</p>

            <h3>Architecture</h3>
            <div class="cmd">~/tetra/orgs/{org}/
├── backup.toml      # Backup rules & excludes
├── servers.json     # Server inventory
└── inventory/       # Cached file listings
    ├── do4-n2.json
    └── ...

~/tetra/browser/
├── server.py        # Standalone browser server
└── collect-inventory.sh</div>

            <h3>Backup Config (backup.toml)</h3>
            <p>Define per-server include/exclude rules:</p>
            <div class="cmd">[servers.do4-n2]
ip = "68.183.248.67"
priority = 1
status = "important"
include = ["/home/mricos", "/home/devops"]
exclude = ["ds-env", "nltk_data", "dist"]</div>

            <h3>Workflow</h3>
            <p>1. <code>collect-inventory.sh</code> - Survey all servers</p>
            <p>2. Review in this panel - drill into users/dirs</p>
            <p>3. Edit <code>backup.toml</code> - set include/exclude</p>
            <p>4. <code>backup-{server}.sh --dry-run</code> - Preview</p>
            <p>5. <code>backup-{server}.sh</code> - Execute backup</p>

            <h3>Excludes (default)</h3>
            <p>node_modules, __pycache__, .venv, venv, .cache, .npm, dist, build, ds-env, nltk_data</p>
        </div>
    </div>

    <div class="detail-panel" id="detail-panel">
        <span class="detail-close" onclick="closeDetail()">&times;</span>
        <div id="detail-body"></div>
    </div>

    <script>
        // Server data - loaded from org config
        let orgData = {
            servers: {},
            inventory: {}
        };

        // Tab switching
        document.querySelectorAll('.infra-tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.infra-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            };
        });

        // Load org data
        async function loadData() {
            try {
                // Try to load from tetra browser API
                const resp = await fetch('/api/infra/data');
                if (resp.ok) {
                    orgData = await resp.json();
                } else {
                    // Fallback to embedded data
                    orgData = getEmbeddedData();
                }
            } catch (e) {
                orgData = getEmbeddedData();
            }
            renderServers();
        }

        // Embedded fallback data from backup.toml
        function getEmbeddedData() {
            return {
                org: 'nodeholder',
                servers: {
                    'do4-n2': { ip: '68.183.248.67', priority: 1, status: 'important', description: 'Production server', include: ['/home/mricos', '/home/devops'], exclude: ['ds-env', 'nltk_data', 'dist'] },
                    'do4': { ip: '159.65.106.21', priority: 2, status: 'active', description: 'NFS server, many users', include: ['/home/mricos', '/home/devops'] },
                    'do5': { ip: '138.68.2.192', priority: 3, status: 'active', description: 'study-groups.org', include: ['/home/mricos', '/home/devops'] },
                    'do1': { ip: '192.34.62.148', priority: 4, status: 'cleanup', description: 'Ubuntu 16.04 EOL', include: ['/home/mricos'] },
                    'do3-fedora-nyc1': { ip: '174.138.110.75', priority: 5, status: 'cleanup', description: 'Stopped docker' },
                    'do6': { ip: '138.68.143.119', priority: 6, status: 'cleanup', description: 'Idle server' },
                    'ghost-sfo2-01': { ip: '159.65.74.83', priority: 7, status: 'cleanup', description: 'Ghost blog, docker' },
                    'nodeholder-qa': { ip: '165.232.139.55', priority: 8, status: 'cleanup', description: 'QA server' }
                },
                inventory: {}
            };
        }

        function renderServers() {
            const grid = document.getElementById('server-grid');
            grid.innerHTML = '';

            const servers = Object.entries(orgData.servers)
                .sort((a, b) => (a[1].priority || 99) - (b[1].priority || 99));

            servers.forEach(([name, cfg]) => {
                const inv = orgData.inventory[name] || {};
                const status = cfg.status || 'unknown';
                const homeUsers = inv.home ? Object.keys(inv.home) : [];

                const card = document.createElement('div');
                card.className = 'server-card ' + status;
                card.onclick = () => showDetail(name);

                let usersHtml = '';
                if (homeUsers.length > 0) {
                    usersHtml = '<div class="user-list">';
                    homeUsers.slice(0, 3).forEach(u => {
                        usersHtml += `<div class="user-item"><span class="user-name">${u}</span><span class="user-size">${inv.home[u].size || '?'}</span></div>`;
                    });
                    if (homeUsers.length > 3) usersHtml += `<div class="user-item" style="color:var(--ink-muted)">+${homeUsers.length - 3} more</div>`;
                    usersHtml += '</div>';
                }

                card.innerHTML = `
                    <span class="server-badge ${status}">${status}</span>
                    <div class="server-name">${name}</div>
                    <div class="server-ip">${cfg.ip}</div>
                    <div class="server-desc">${cfg.description || ''}</div>
                    <div class="server-stats">
                        <span>${homeUsers.length} users</span>
                        ${inv.system ? `<span>${inv.system.disk_used} disk</span>` : ''}
                    </div>
                    ${usersHtml}
                `;
                grid.appendChild(card);
            });
        }

        function showDetail(name) {
            const cfg = orgData.servers[name];
            const inv = orgData.inventory[name] || {};
            const panel = document.getElementById('detail-panel');
            const body = document.getElementById('detail-body');

            let html = `<div class="detail-title">${name}</div>
                <div style="font-size:10px;color:var(--ink-muted);margin-bottom:8px;">${cfg.ip}</div>
                <p style="font-size:10px;">${cfg.description || ''}</p>`;

            if (inv.system) {
                html += `<div class="detail-section">
                    <div class="detail-section-title">System</div>
                    <div style="font-size:9px;">
                        OS: ${inv.system.os}<br>
                        Disk: ${inv.system.disk_used} (${inv.system.disk_avail} free)<br>
                        Uptime: ${inv.system.uptime}
                    </div>
                </div>`;
            }

            if (inv.home && Object.keys(inv.home).length > 0) {
                html += `<div class="detail-section"><div class="detail-section-title">/home</div>`;
                for (const [user, data] of Object.entries(inv.home)) {
                    html += `<div style="margin:8px 0;"><strong style="color:var(--three)">${user}</strong> <span style="color:var(--ink-muted)">${data.size}</span></div>`;
                    if (data.dirs && data.dirs.length > 0) {
                        data.dirs.forEach(d => {
                            const excluded = cfg.exclude && cfg.exclude.includes(d.name);
                            html += `<div class="dir-item ${excluded ? 'excluded' : ''}">
                                <span class="dir-name">${d.name}/</span>
                                <span class="dir-size">${d.size}</span>
                            </div>`;
                        });
                    }
                }
                html += '</div>';
            }

            if (inv.www && Object.keys(inv.www).length > 0) {
                html += `<div class="detail-section"><div class="detail-section-title">/var/www</div>`;
                for (const [site, data] of Object.entries(inv.www)) {
                    html += `<div class="dir-item"><span class="dir-name">${site}/</span><span class="dir-size">${data.size}</span></div>`;
                }
                html += '</div>';
            }

            html += `<div class="detail-section">
                <div class="detail-section-title">Actions</div>
                <button class="btn" onclick="copyText('ssh root@${cfg.ip}')">SSH</button>
                <button class="btn" onclick="copyText('./backup-${name}.sh --dry-run')">Dry Run</button>
                <button class="btn primary" onclick="copyText('./backup-${name}.sh')">Backup</button>
                <div class="cmd">ssh root@${cfg.ip}</div>
            </div>`;

            body.innerHTML = html;
            panel.classList.add('open');
        }

        function closeDetail() {
            document.getElementById('detail-panel').classList.remove('open');
        }

        function copyText(text) {
            navigator.clipboard.writeText(text);
        }

        // Refresh handler
        document.querySelector('[data-action="refresh"]').onclick = loadData;

        // Init
        loadData();
    </script>
</body>
</html>
