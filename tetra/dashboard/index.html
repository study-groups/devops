<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TETRA Console</title>
    <link rel="stylesheet" href="shared.css">
    <style>
        :root {
            /* Dashboard-specific layout variables */
            --grip: #444;
            --header-height: 40px;
            --panel-header-height: 32px;
            --divider-size: 6px;
            --top-height: 50%;
            --left-top-width: 50%;
            --left-bot-width: 50%;
        }

        body {
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        .dashboard {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Main header */
        .header {
            height: var(--header-height);
            background: var(--paper-mid);
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 16px;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--one);
        }
        .logo span { color: var(--two); }

        .global-org {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-left: 24px;
        }

        .org-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--ink-muted);
            padding: 4px 10px;
            font-family: inherit;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.15s;
        }

        .org-btn:hover {
            border-color: var(--ink-muted);
            color: var(--ink);
        }

        .org-btn.active {
            background: var(--four);
            border-color: var(--four);
            color: var(--ink);
        }

        .status {
            margin-left: auto;
            display: flex;
            gap: 12px;
            align-items: center;
            font-size: 11px;
            color: var(--ink-muted);
        }

        /* Pane container */
        .panes {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .pane-row {
            display: flex;
            overflow: hidden;
        }
        .pane-row.top { height: var(--top-height); }
        .pane-row.bottom { flex: 1; }

        /* Panel */
        .panel {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--paper-dark);
        }

        .panel-header {
            height: var(--panel-header-height);
            background: var(--paper-mid);
            padding: 0 8px;
            font-size: 10px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .panel-header select {
            background: transparent;
            border: none;
            color: var(--ink-muted);
            font-family: inherit;
            font-size: 10px;
            padding: 2px 6px;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .panel-header select:hover {
            color: var(--ink);
        }

        .panel-header select:focus {
            outline: none;
            color: var(--ink);
        }

        .panel-header .view-select {
            font-weight: 600;
        }

        .env-btns {
            display: flex;
            gap: 2px;
        }

        .env-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--ink-muted);
            padding: 1px 6px;
            font-family: inherit;
            font-size: 9px;
            cursor: pointer;
            border-radius: 2px;
            display: inline-flex;
            gap: 0;
        }

        .env-btn .user-prefix {
            opacity: 0.5;
            cursor: pointer;
            padding-right: 1px;
        }

        .env-btn .user-prefix:hover {
            opacity: 1;
        }

        /* Hide user prefix when not in console view */
        .panel:not([data-view="console"]) .env-btn .user-prefix {
            display: none;
        }

        .env-btn:hover {
            border-color: var(--ink-muted);
            color: var(--ink);
        }

        .env-btn.active {
            border-color: var(--two);
            color: var(--two);
        }

        .env-btn.active[data-env="dev"],
        .env-btn.active[data-env="staging"] {
            border-color: var(--three);
            color: var(--three);
        }

        .env-btn.active[data-env="prod"] {
            border-color: var(--one);
            color: var(--one);
        }

        .panel-header .refresh-btn {
            background: none;
            border: none;
            color: var(--ink-muted);
            font-size: 14px;
            cursor: pointer;
            padding: 2px 6px;
            margin-left: auto;
        }
        .panel-header .refresh-btn:hover { color: var(--ink); }

        .panel-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .panel-content iframe {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Dividers */
        .divider {
            background: var(--border);
            flex-shrink: 0;
            position: relative;
        }

        .divider-h {
            height: var(--divider-size);
            cursor: row-resize;
        }

        .divider-v {
            width: var(--divider-size);
            cursor: col-resize;
        }

        .divider:hover, .divider.active {
            background: var(--four);
        }
    </style>
</head>
<body>
    <script src="/js/terrain-iframe.js"></script>
    <div class="dashboard">
        <header class="header">
            <div class="logo">TETRA<span>.</span>CONSOLE</div>
            <div class="global-org">
                <button class="org-btn" data-org="nodeholder">NH</button>
                <button class="org-btn" data-org="pixeljam-arcade">PJ</button>
                <button class="org-btn active" data-org="tetra">TETRA</button>
            </div>
            <div class="status">
                <span id="status-text">local</span>
            </div>
        </header>

        <div class="panes">
            <!-- Top row -->
            <div class="pane-row top">
                <div class="panel" data-panel="top-left" data-view="console" style="width: var(--left-top-width)">
                    <div class="panel-header">
                        <select class="view-select">
                            <option value="console">Console</option>
                            <option value="tsm">TSM</option>
                            <option value="deploy">Deploy</option>
                            <option value="logs">Logs</option>
                            <option value="caddy">Caddy</option>
                            <option value="capture">Capture</option>
                            <option value="playwright">Playwright</option>
                            <option value="tests">Tests</option>
                            <option value="developer">Developer</option>
                        </select>
                        <div class="env-btns">
                            <button class="env-btn active" data-env="local">local</button>
                            <button class="env-btn" data-env="dev" data-user="root"><span class="user-prefix">r:</span>dev</button>
                            <button class="env-btn" data-env="staging" data-user="root"><span class="user-prefix">r:</span>stg</button>
                            <button class="env-btn" data-env="prod" data-user="root"><span class="user-prefix">r:</span>prod</button>
                        </div>
                        <button class="refresh-btn" title="Refresh">&#x21bb;</button>
                    </div>
                    <div class="panel-content">
                        <iframe src="console.iframe.html?env=local&org=tetra"></iframe>
                    </div>
                </div>
                <div class="divider divider-v" id="divider-top-v"></div>
                <div class="panel" data-panel="top-right" data-view="tsm" style="flex: 1">
                    <div class="panel-header">
                        <select class="view-select">
                            <option value="console">Console</option>
                            <option value="tsm" selected>TSM</option>
                            <option value="deploy">Deploy</option>
                            <option value="logs">Logs</option>
                            <option value="caddy">Caddy</option>
                            <option value="capture">Capture</option>
                            <option value="playwright">Playwright</option>
                            <option value="tests">Tests</option>
                            <option value="developer">Developer</option>
                        </select>
                        <div class="env-btns">
                            <button class="env-btn active" data-env="local">local</button>
                            <button class="env-btn" data-env="dev" data-user="root"><span class="user-prefix">r:</span>dev</button>
                            <button class="env-btn" data-env="staging" data-user="root"><span class="user-prefix">r:</span>stg</button>
                            <button class="env-btn" data-env="prod" data-user="root"><span class="user-prefix">r:</span>prod</button>
                        </div>
                        <button class="refresh-btn" title="Refresh">&#x21bb;</button>
                    </div>
                    <div class="panel-content">
                        <iframe src="tsm.iframe.html?env=local&org=tetra"></iframe>
                    </div>
                </div>
            </div>

            <!-- Horizontal divider -->
            <div class="divider divider-h" id="divider-h"></div>

            <!-- Bottom row -->
            <div class="pane-row bottom">
                <div class="panel" data-panel="bottom-left" data-view="deploy" style="width: var(--left-bot-width)">
                    <div class="panel-header">
                        <select class="view-select">
                            <option value="console">Console</option>
                            <option value="tsm">TSM</option>
                            <option value="deploy" selected>Deploy</option>
                            <option value="logs">Logs</option>
                            <option value="caddy">Caddy</option>
                            <option value="capture">Capture</option>
                            <option value="playwright">Playwright</option>
                            <option value="tests">Tests</option>
                            <option value="developer">Developer</option>
                        </select>
                        <div class="env-btns">
                            <button class="env-btn active" data-env="local">local</button>
                            <button class="env-btn" data-env="dev" data-user="root"><span class="user-prefix">r:</span>dev</button>
                            <button class="env-btn" data-env="staging" data-user="root"><span class="user-prefix">r:</span>stg</button>
                            <button class="env-btn" data-env="prod" data-user="root"><span class="user-prefix">r:</span>prod</button>
                        </div>
                        <button class="refresh-btn" title="Refresh">&#x21bb;</button>
                    </div>
                    <div class="panel-content">
                        <iframe src="deploy.iframe.html?env=local&org=tetra"></iframe>
                    </div>
                </div>
                <div class="divider divider-v" id="divider-bot-v"></div>
                <div class="panel" data-panel="bottom-right" data-view="logs" style="flex: 1">
                    <div class="panel-header">
                        <select class="view-select">
                            <option value="console">Console</option>
                            <option value="tsm">TSM</option>
                            <option value="deploy">Deploy</option>
                            <option value="logs" selected>Logs</option>
                            <option value="caddy">Caddy</option>
                            <option value="capture">Capture</option>
                            <option value="playwright">Playwright</option>
                            <option value="tests">Tests</option>
                            <option value="developer">Developer</option>
                        </select>
                        <div class="env-btns">
                            <button class="env-btn active" data-env="local">local</button>
                            <button class="env-btn" data-env="dev" data-user="root"><span class="user-prefix">r:</span>dev</button>
                            <button class="env-btn" data-env="staging" data-user="root"><span class="user-prefix">r:</span>stg</button>
                            <button class="env-btn" data-env="prod" data-user="root"><span class="user-prefix">r:</span>prod</button>
                        </div>
                        <button class="refresh-btn" title="Refresh">&#x21bb;</button>
                    </div>
                    <div class="panel-content">
                        <iframe src="logs.iframe.html?env=local&org=tetra"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================================================
        // TETRA Console - Unified Panel Manager
        // ========================================================================

        const VIEWS = {
            console: { src: 'console.iframe.html' },
            tsm: { src: 'tsm.iframe.html' },
            deploy: { src: 'deploy.iframe.html' },
            logs: { src: 'logs.iframe.html' },
            caddy: { src: 'caddy.iframe.html' },
            capture: { src: 'capture.iframe.html' },
            playwright: { src: 'playwright.iframe.html' },
            tests: { src: 'tests.iframe.html' },
            developer: { src: 'developer.iframe.html' }
        };

        const STORAGE_KEY = 'tetra-console-state';

        // State
        let environments = {};

        // Elements
        const root = document.documentElement;
        const panes = document.querySelector('.panes');
        const panels = document.querySelectorAll('.panel');

        // ========================================================================
        // API Fetching
        // ========================================================================

        async function fetchEnvironments(org) {
            try {
                const res = await fetch(`/api/environments?org=${encodeURIComponent(org)}`);
                if (res.ok) {
                    const data = await res.json();
                    environments[org] = Object.keys(data);
                    return environments[org];
                }
            } catch (e) {
                console.warn(`[Console] Failed to fetch environments for ${org}:`, e);
            }
            return ['local'];
        }

        // ========================================================================
        // Panel Management
        // ========================================================================

        function getActiveOrg() {
            const activeBtn = document.querySelector('.org-btn.active');
            return activeBtn?.dataset.org || 'tetra';
        }

        async function updateEnvSelect(panel) {
            const envSelect = panel.querySelector('.env-select');
            if (!envSelect) return;

            const org = getActiveOrg();
            const envs = environments[org] || await fetchEnvironments(org);
            const current = envSelect.value;

            envSelect.innerHTML = envs.map(env =>
                `<option value="${env}" ${env === current ? 'selected' : ''}>${env}</option>`
            ).join('');

            // Reset to local if current env not available
            if (!envs.includes(current)) {
                envSelect.value = 'local';
            }

            updateEnvClass(envSelect);
        }

        function updateEnvClass(envSelect) {
            envSelect.classList.remove('status-local', 'status-remote', 'status-prod');
            const env = envSelect.value;
            if (env === 'local') {
                envSelect.classList.add('status-local');
            } else if (env === 'prod' || env === 'production') {
                envSelect.classList.add('status-prod');
            } else {
                envSelect.classList.add('status-remote');
            }
        }

        function updatePanelIframe(panel, envChangeOnly = false) {
            const viewSelect = panel.querySelector('.view-select');
            const activeEnvBtn = panel.querySelector('.env-btn.active');
            const iframe = panel.querySelector('iframe');

            const view = viewSelect.value;
            const env = activeEnvBtn?.dataset.env || 'local';
            const user = activeEnvBtn?.dataset.user || '';
            const org = getActiveOrg();

            // Track current view for CSS (shows/hides user prefix)
            panel.dataset.view = view;

            const viewConfig = VIEWS[view];
            if (!viewConfig) return;

            const params = new URLSearchParams({ env, org });
            if (user) params.set('user', user);
            const newSrc = `${viewConfig.src}?${params}`;

            // If only env changed, send message instead of reloading
            if (envChangeOnly && iframe.contentWindow) {
                sendToPanel(panel, {
                    type: 'env-change',
                    env,
                    org,
                    user
                });
            } else {
                iframe.src = newSrc;
            }

            // Save state
            savePanelState();
        }

        function refreshPanel(panel) {
            const iframe = panel.querySelector('iframe');
            if (iframe) {
                iframe.src = iframe.src;
            }
        }

        // ========================================================================
        // Event Handlers
        // ========================================================================

        panels.forEach(panel => {
            const viewSelect = panel.querySelector('.view-select');
            const envBtns = panel.querySelectorAll('.env-btn');
            const refreshBtn = panel.querySelector('.refresh-btn');

            if (viewSelect) {
                viewSelect.addEventListener('change', () => updatePanelIframe(panel));
            }

            envBtns.forEach(btn => {
                // Handle prefix clicks separately to prevent bubbling issues
                const prefix = btn.querySelector('.user-prefix');
                if (prefix) {
                    prefix.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const env = btn.dataset.env;
                        // Environment-specific user options
                        const userMap = {
                            dev: ['root', 'dev'],
                            staging: ['root', 'stg'],
                            prod: ['root', 'prod']
                        };
                        const users = userMap[env] || ['root', 'dev'];
                        const current = btn.dataset.user || 'root';
                        const idx = users.indexOf(current);
                        const next = users[(idx + 1) % users.length];
                        btn.dataset.user = next;
                        prefix.textContent = next[0] + ':';

                        // If this button is active, reconnect with new user
                        if (btn.classList.contains('active')) {
                            updatePanelIframe(panel, true);
                        }
                    });
                }

                btn.addEventListener('click', (e) => {
                    // Toggle active state and connect
                    envBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updatePanelIframe(panel, true);
                });
            });

            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => refreshPanel(panel));
            }
        });

        // Global org buttons
        const orgBtns = document.querySelectorAll('.org-btn');
        orgBtns.forEach(btn => {
            btn.addEventListener('click', async () => {
                // Update button states
                orgBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Update all panels with new org
                for (const panel of panels) {
                    await updateEnvSelect(panel);
                    updatePanelIframe(panel);
                }
            });
        });

        // ========================================================================
        // State Persistence
        // ========================================================================

        function savePanelState() {
            const activeOrgBtn = document.querySelector('.org-btn.active');
            const state = {
                globalOrg: activeOrgBtn?.dataset.org || 'tetra',
                panes: {
                    topHeight: getComputedStyle(root).getPropertyValue('--top-height').trim(),
                    leftTopWidth: getComputedStyle(root).getPropertyValue('--left-top-width').trim(),
                    leftBotWidth: getComputedStyle(root).getPropertyValue('--left-bot-width').trim()
                },
                panels: {}
            };

            panels.forEach(panel => {
                const id = panel.dataset.panel;
                state.panels[id] = {
                    view: panel.querySelector('.view-select')?.value,
                    env: panel.querySelector('.env-select')?.value
                };
            });

            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function loadPanelState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return;

                const state = JSON.parse(saved);

                // Restore global org
                if (state.globalOrg) {
                    orgBtns.forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.org === state.globalOrg);
                    });
                }

                // Restore pane sizes
                if (state.panes) {
                    if (state.panes.topHeight) root.style.setProperty('--top-height', state.panes.topHeight);
                    if (state.panes.leftTopWidth) root.style.setProperty('--left-top-width', state.panes.leftTopWidth);
                    if (state.panes.leftBotWidth) root.style.setProperty('--left-bot-width', state.panes.leftBotWidth);
                }

                // Restore panel state
                if (state.panels) {
                    panels.forEach(panel => {
                        const id = panel.dataset.panel;
                        const panelState = state.panels[id];
                        if (!panelState) return;

                        const viewSelect = panel.querySelector('.view-select');
                        const envSelect = panel.querySelector('.env-select');

                        if (viewSelect && panelState.view) viewSelect.value = panelState.view;
                        if (envSelect && panelState.env) {
                            envSelect.value = panelState.env;
                            updateEnvClass(envSelect);
                        }

                        updatePanelIframe(panel);
                    });
                }
            } catch (e) {
                console.warn('[Console] Failed to load state:', e);
            }
        }

        // ========================================================================
        // Resizer
        // ========================================================================

        const dividerH = document.getElementById('divider-h');
        const dividerTopV = document.getElementById('divider-top-v');
        const dividerBotV = document.getElementById('divider-bot-v');

        let dragging = null;
        let startX, startY, startLeftTop, startLeftBot, startTop;

        function onMouseDown(e, type) {
            dragging = type;
            startX = e.clientX;
            startY = e.clientY;
            startLeftTop = parseFloat(getComputedStyle(root).getPropertyValue('--left-top-width'));
            startLeftBot = parseFloat(getComputedStyle(root).getPropertyValue('--left-bot-width'));
            startTop = parseFloat(getComputedStyle(root).getPropertyValue('--top-height'));

            document.body.style.cursor = type === 'h' ? 'row-resize' : 'col-resize';
            e.target.classList.add('active');
            document.querySelectorAll('iframe').forEach(f => f.style.pointerEvents = 'none');
        }

        dividerH.addEventListener('mousedown', (e) => onMouseDown(e, 'h'));
        dividerTopV.addEventListener('mousedown', (e) => onMouseDown(e, 'top-v'));
        dividerBotV.addEventListener('mousedown', (e) => onMouseDown(e, 'bot-v'));

        document.addEventListener('mousemove', (e) => {
            if (!dragging) return;

            const panesRect = panes.getBoundingClientRect();
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;

            if (dragging === 'h') {
                const newTop = Math.max(20, Math.min(80, startTop + (dy / panesRect.height) * 100));
                root.style.setProperty('--top-height', newTop + '%');
            }
            if (dragging === 'top-v') {
                const newLeftTop = Math.max(20, Math.min(80, startLeftTop + (dx / panesRect.width) * 100));
                root.style.setProperty('--left-top-width', newLeftTop + '%');
            }
            if (dragging === 'bot-v') {
                const newLeftBot = Math.max(20, Math.min(80, startLeftBot + (dx / panesRect.width) * 100));
                root.style.setProperty('--left-bot-width', newLeftBot + '%');
            }
        });

        document.addEventListener('mouseup', () => {
            if (dragging) {
                document.body.style.cursor = '';
                document.querySelectorAll('.divider').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('iframe').forEach(f => f.style.pointerEvents = '');
                savePanelState();
                dragging = null;
            }
        });

        // ========================================================================
        // Message Bus Setup (using Terrain.Bus from terrain-iframe.js)
        // ========================================================================

        // Configure Terrain.Bus for parent mode
        Terrain.Bus.configure({ panels });

        // Developer panels subscribe to ALL messages for visualization
        Terrain.Bus.subscribe('*', (msg) => {
            panels.forEach(panel => {
                if (panel.dataset.view === 'developer') {
                    const iframe = panel.querySelector('iframe');
                    if (iframe?.contentWindow) {
                        iframe.contentWindow.postMessage(msg, '*');
                    }
                }
            });
        });

        // ========================================================================
        // Iframe Message Handler
        // ========================================================================

        window.addEventListener('message', (e) => {
            const msg = e.data;
            if (!msg || typeof msg !== 'object') return;

            const from = msg.source || msg.from || 'unknown';

            // Publish incoming message (source -> parent)
            Terrain.Bus._notify({ ...msg, _from: from, _to: 'parent' });

            // Route log-watch-change to all panels
            if (msg.type === 'log-watch-change') {
                Terrain.Bus.broadcast(msg, e.source);
                return;
            }

            if (msg.source !== 'terrain') return;

            console.log('[Console] Message:', msg);

            if (msg.type === 'ready') {
                console.log('[Console] Panel ready:', msg.from);
            }
        });

        function sendToPanel(panel, data) {
            const fullMsg = {
                ...data,
                source: 'terrain',
                timestamp: Date.now()
            };
            Terrain.Bus.route(panel, fullMsg);
        }

        // ========================================================================
        // Initialize
        // ========================================================================

        async function init() {
            // Prefetch environments for all orgs
            await Promise.all([
                fetchEnvironments('tetra'),
                fetchEnvironments('pixeljam-arcade'),
                fetchEnvironments('nodeholder')
            ]);

            // Update env selects for current org
            for (const panel of panels) {
                await updateEnvSelect(panel);
            }

            // Load saved state
            loadPanelState();
        }

        init();
    </script>
</body>
</html>
