<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Caddy</title>
    <link rel="stylesheet" href="shared.css">
    <style>
        body {
            font-size: 11px;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--paper-mid);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .panel-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--ink-muted);
        }
        .status-dot.online { background: var(--two); }
        .status-dot.offline { background: var(--one); }
        .status-dot.loading { background: var(--three); animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
        .header-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 10px;
        }
        .env-badge {
            background: var(--four);
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-weight: 600;
        }
        .env-badge.local { background: var(--two); }
        .env-badge.prod { background: var(--one); }

        .refresh-toggle {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: var(--paper-dark);
            border: 1px solid var(--border);
            border-radius: 3px;
            color: var(--ink);
            cursor: pointer;
            font-size: 9px;
        }
        .refresh-toggle:hover { background: var(--paper-light); }
        .refresh-toggle.paused { opacity: 0.6; }
        .refresh-toggle.paused .refresh-icon { animation: none; }
        .refresh-icon {
            font-size: 12px;
            animation: spin 2s linear infinite;
        }
        .refresh-toggle.paused .refresh-icon { animation: none; }
        .refresh-status { font-family: var(--font-mono); }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--paper-dark);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .tab {
            padding: 8px 14px;
            font-size: 10px;
            color: var(--ink-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab:hover { color: var(--ink); background: var(--paper-mid); }
        .tab.active { color: var(--ink); border-bottom-color: var(--four); }
        .tab .count {
            margin-left: 4px;
            background: var(--one);
            color: white;
            padding: 1px 5px;
            border-radius: 8px;
            font-size: 9px;
        }
        .tab .count.zero { background: var(--paper-light); color: var(--ink-muted); }

        /* Content */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        .content.hidden { display: none; }

        /* Section */
        .section { margin-bottom: 16px; }
        .section-title {
            font-size: 9px;
            color: var(--ink-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Status Grid */
        .grid { display: grid; gap: 8px; }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .card {
            background: var(--paper-mid);
            padding: 10px;
            border-radius: 3px;
        }
        .card .label { font-size: 9px; color: var(--ink-muted); margin-bottom: 2px; }
        .card .value { font-size: 12px; font-weight: 600; font-family: var(--font-mono); }
        .card .value.good { color: var(--two); }
        .card .value.warn { color: var(--three); }
        .card .value.bad { color: var(--one); }

        /* Routes */
        .route-list { background: var(--paper-mid); border-radius: 3px; }
        .route {
            display: grid;
            grid-template-columns: minmax(80px, 1fr) 20px minmax(100px, 1fr);
            padding: 6px 10px;
            border-bottom: 1px solid var(--paper-dark);
            font-size: 10px;
            font-family: var(--font-mono);
        }
        .route:last-child { border-bottom: none; }
        .route-path { color: var(--four); }
        .route-arrow { color: var(--ink-muted); text-align: center; }
        .route-upstream { color: var(--two); }

        /* Logs */
        .log-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        .log-toolbar input {
            flex: 1;
            min-width: 120px;
            padding: 5px 8px;
            background: var(--paper-mid);
            border: 1px solid var(--border);
            color: var(--ink);
            font-size: 10px;
            border-radius: 2px;
        }
        .log-toolbar .btn {
            padding: 4px 8px;
            font-size: 9px;
            background: var(--paper-mid);
            border: 1px solid var(--border);
            color: var(--ink);
            cursor: pointer;
            border-radius: 2px;
        }
        .log-toolbar .btn:hover { background: var(--paper-light); }
        .log-toolbar .btn.active { background: var(--four); color: white; border-color: var(--four); }
        .log-toolbar .btn.btn-ghost { background: transparent; border: 1px dashed var(--border); color: var(--ink-muted); }
        .log-toolbar .btn.btn-ghost:hover { border-style: solid; color: var(--ink); }
        .log-toolbar .btn.btn-ghost.active { background: transparent; border: 1px solid var(--four); color: var(--four); text-decoration: line-through; }
        .log-toolbar .btn.following { background: var(--two); color: white; border-color: var(--two); animation: pulse-follow 1s infinite; }
        @keyframes pulse-follow { 0%,100%{opacity:1} 50%{opacity:0.7} }
        .time-filters {
            display: flex;
            gap: 2px;
            background: var(--paper-dark);
            padding: 2px;
            border-radius: 3px;
        }
        .time-filters .time-btn {
            padding: 3px 6px;
            font-size: 9px;
            border: none;
            background: transparent;
        }
        .time-filters .time-btn:hover { background: var(--paper-mid); }
        .time-filters .time-btn.active { background: var(--four); color: white; }
        .filter-presets {
            display: flex;
            gap: 2px;
        }
        .preset-btn {
            padding: 3px 6px;
            font-size: 9px;
            background: var(--paper-mid);
            border: 1px solid var(--border);
            color: var(--ink-muted);
            cursor: pointer;
            border-radius: 2px;
        }
        .preset-btn:hover { background: var(--paper-light); color: var(--ink); }
        .preset-btn.active { background: var(--four); color: white; border-color: var(--four); }
        .toggle-label {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 9px;
            color: var(--ink-muted);
            cursor: pointer;
        }
        .toggle-label input { width: 12px; height: 12px; }
        .log-container {
            background: var(--paper-mid);
            border-radius: 3px;
            font-family: var(--font-mono);
            font-size: 10px;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 280px);
        }
        #logs {
            flex: 1;
            overflow-y: auto;
        }
        .log-header {
            display: grid;
            grid-template-columns: 70px 36px 45px 90px 1fr 80px 45px;
            gap: 6px;
            padding: 5px 8px;
            background: var(--paper-dark);
            color: var(--ink-muted);
            font-size: 9px;
            text-transform: uppercase;
        }
        .log-col-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .log-col-header:hover { color: var(--ink); }
        .log-col-header.active { color: var(--four); }
        .log-col-header.aggregated { color: var(--two); }
        .sort-indicator { font-size: 8px; opacity: 0.5; }
        .log-col-header.active .sort-indicator { opacity: 1; }
        .aggregated-row {
            background: var(--paper-mid);
            border-left: 2px solid var(--two);
        }
        .aggregated-row .agg-count {
            color: var(--two);
            font-weight: 600;
            font-family: var(--font-mono);
        }
        .aggregated-row .agg-value {
            color: var(--ink);
            font-family: var(--font-mono);
        }
        .log-row {
            display: grid;
            grid-template-columns: 70px 36px 45px 90px 1fr 80px 45px;
            gap: 6px;
            padding: 4px 8px;
            border-bottom: 1px solid var(--paper-dark);
        }
        .log-geo {
            color: var(--ink-muted);
            font-size: 9px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .log-geo.loading { color: var(--three); }
        .log-geo.found { color: var(--four); }
        .log-dur { text-align: left; }
        .log-ip {
            color: var(--ink-muted);
            font-size: 9px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .log-row.attack {
            background: rgba(255, 50, 50, 0.15);
            border-left: 2px solid var(--one);
        }
        .log-row.attack .log-uri { color: var(--one); }
        .log-row:hover { background: var(--paper-light); }
        .log-row:last-child { border-bottom: none; }
        .log-row.log-error { background: rgba(255,100,100,0.1); }
        .log-row.log-info { background: rgba(100,100,255,0.05); }
        .log-time { color: var(--ink-muted); font-size: 9px; }
        .log-status { text-align: center; font-weight: 600; }
        .log-status.s2xx { color: var(--two); }
        .log-status.s3xx { color: var(--ink-muted); }
        .log-status.s4xx { color: var(--three); }
        .log-status.s5xx { color: var(--one); }
        .log-method { color: var(--four); font-weight: 500; }
        .log-uri { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .log-dur { color: var(--ink-muted); text-align: right; }
        .log-raw {
            padding: 4px 8px;
            color: var(--ink-muted);
            font-size: 9px;
            border-bottom: 1px solid var(--paper-dark);
            word-break: break-all;
        }
        .log-msg {
            grid-column: 3 / -1;
            color: var(--ink-muted);
            font-style: italic;
        }
        .log-row.scanner-group {
            background: rgba(255, 200, 100, 0.08);
            border-left: 2px solid var(--three);
        }
        .log-row.scanner-group:hover {
            background: rgba(255, 200, 100, 0.15);
        }
        .scanner-info {
            grid-column: 3 / -1;
            display: flex;
            gap: 8px;
            align-items: center;
            color: var(--ink-muted);
            font-size: 9px;
        }
        .scanner-count {
            color: var(--three);
            font-weight: 600;
        }
        .scanner-paths {
            color: var(--ink-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .scanner-ip {
            color: var(--one);
            font-family: var(--font-mono);
        }

        /* Top List */
        .top-list { background: var(--paper-mid); border-radius: 3px; }
        .top-row {
            display: grid;
            grid-template-columns: 45px 1fr 50px;
            gap: 8px;
            padding: 5px 10px;
            border-bottom: 1px solid var(--paper-dark);
            align-items: center;
            font-size: 10px;
        }
        .top-row:last-child { border-bottom: none; }
        .top-count { text-align: right; font-weight: 600; color: var(--four); font-family: var(--font-mono); }
        .top-value { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-family: var(--font-mono); }
        .top-value.clickable { cursor: pointer; }
        .top-value.clickable:hover { color: var(--four); text-decoration: underline; }
        .top-value.grouped { color: var(--three); font-style: italic; }
        .btn-sm {
            padding: 2px 6px;
            font-size: 8px;
            background: var(--paper-mid);
            border: 1px solid var(--border);
            color: var(--ink-muted);
            cursor: pointer;
            border-radius: 2px;
        }
        .btn-sm:hover { background: var(--paper-light); }
        .btn-sm.active { background: var(--four); color: white; border-color: var(--four); }
        .stats-toolbar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 8px;
        }
        .top-bar { height: 4px; background: var(--paper-dark); border-radius: 2px; }
        .top-bar-fill { height: 100%; background: var(--four); border-radius: 2px; }

        /* Ban */
        .ban-list { background: var(--paper-mid); border-radius: 3px; }
        .ban-row {
            display: flex;
            padding: 6px 10px;
            border-bottom: 1px solid var(--paper-dark);
            gap: 10px;
            align-items: center;
        }
        .ban-row:last-child { border-bottom: none; }
        .ban-ip { font-family: var(--font-mono); color: var(--one); font-weight: 600; }
        .ban-jail { font-size: 9px; color: var(--four); background: var(--paper-dark); padding: 2px 6px; border-radius: 2px; }
        .ban-time { margin-left: auto; color: var(--ink-muted); font-size: 9px; }

        /* States */
        .empty { color: var(--ink-muted); text-align: center; padding: 16px; font-style: italic; }
        .error { color: var(--one); padding: 16px; text-align: center; }

        /* Debug */
        .debug-box {
            background: var(--paper-dark);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 8px;
            margin-top: 12px;
            font-family: var(--font-mono);
            font-size: 9px;
            color: var(--ink-muted);
            max-height: 150px;
            overflow: auto;
            display: none;
        }
        .debug-box.show { display: block; }
        .debug-box pre { margin: 0; white-space: pre-wrap; word-break: break-all; }

        /* Help */
        .help-section { margin-bottom: 20px; }
        .help-section h3 {
            font-size: 11px;
            color: var(--ink);
            margin: 0 0 8px 0;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border);
        }
        .help-section p, .help-section li {
            font-size: 10px;
            color: var(--ink-muted);
            line-height: 1.5;
            margin: 4px 0;
        }
        .help-section ul { margin: 4px 0; padding-left: 16px; }
        .help-section code {
            background: var(--paper-dark);
            padding: 1px 4px;
            border-radius: 2px;
            font-family: var(--font-mono);
            font-size: 9px;
        }
        .help-diagram {
            background: var(--paper-dark);
            border-radius: 3px;
            padding: 10px;
            font-family: var(--font-mono);
            font-size: 9px;
            white-space: pre;
            overflow-x: auto;
            color: var(--ink-muted);
            margin: 8px 0;
        }
        .help-path {
            display: flex;
            gap: 8px;
            padding: 4px 8px;
            background: var(--paper-mid);
            border-radius: 2px;
            margin: 4px 0;
            font-family: var(--font-mono);
            font-size: 9px;
        }
        .help-path-label { color: var(--four); min-width: 80px; }
        .help-path-value { color: var(--ink); }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--paper-dark);
            color: var(--ink);
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
        }
        .toast.show { opacity: 1; }

        /* Insights Bar */
        .insights-bar {
            display: flex;
            gap: 12px;
            padding: 6px 8px;
            background: var(--paper-dark);
            border-radius: 3px;
            margin-bottom: 8px;
            font-size: 9px;
            flex-wrap: wrap;
            align-items: center;
        }
        .insights-bar.hidden { display: none; }
        .insight-item {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--ink-muted);
        }
        .insight-label { color: var(--ink-muted); }
        .insight-value {
            font-family: var(--font-mono);
            font-weight: 600;
            color: var(--ink);
        }
        .insight-value.good { color: var(--two); }
        .insight-value.warn { color: var(--three); }
        .insight-value.bad { color: var(--one); }
        .insight-scanner {
            color: var(--ink-muted);
            font-style: italic;
        }
        .insight-alert {
            background: rgba(255, 100, 100, 0.15);
            color: var(--one);
            padding: 2px 6px;
            border-radius: 2px;
            font-weight: 500;
        }
        .btn-badge {
            background: var(--four);
            color: white;
            padding: 1px 5px;
            border-radius: 8px;
            font-size: 9px;
            margin-left: 4px;
        }
        .btn-badge.zero { background: var(--paper-light); color: var(--ink-muted); }

        /* Log file info card */
        .log-file-info {
            background: var(--paper-mid);
            border-radius: 3px;
            padding: 10px;
            margin-top: 8px;
        }
        .log-file-info .info-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 10px;
        }
        .log-file-info .info-label { color: var(--ink-muted); }
        .log-file-info .info-value {
            font-family: var(--font-mono);
            color: var(--ink);
        }

        /* Log detail popover */
        .log-detail-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .log-detail-overlay.hidden { display: none; }
        .log-detail-popover {
            background: var(--paper);
            border: 1px solid var(--border);
            border-radius: 4px;
            width: 90%;
            max-width: 680px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .log-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            background: var(--paper-mid);
        }
        .log-detail-title { font-weight: 600; font-size: 11px; }
        .log-detail-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--ink-muted);
            padding: 0 4px;
        }
        .log-detail-close:hover { color: var(--ink); }
        .log-detail-body {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: grid;
            grid-template-columns: 1fr 180px;
            gap: 12px;
        }
        .log-detail-left { display: flex; flex-direction: column; gap: 12px; min-width: 0; }
        .log-detail-right {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-left: 12px;
            border-left: 1px solid var(--border);
        }
        .log-detail-summary {
            display: grid;
            grid-template-columns: 70px 1fr;
            gap: 4px 8px;
            font-size: 10px;
        }
        .log-detail-summary .label { color: var(--ink-muted); }
        .log-detail-summary .value { font-family: var(--font-mono); word-break: break-all; }
        .log-detail-json {
            background: var(--paper-dark);
            padding: 8px;
            border-radius: 3px;
            font-family: var(--font-mono);
            font-size: 9px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
            color: var(--ink-muted);
            margin: 0;
            flex: 1;
            min-height: 100px;
        }
        /* Detail right panel */
        .detail-section {
            background: var(--paper-dark);
            border-radius: 3px;
            padding: 8px;
            margin-bottom: 8px;
        }
        .detail-section:last-child { margin-bottom: 0; }
        .detail-section-title {
            color: var(--ink-muted);
            text-transform: uppercase;
            font-size: 8px;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .btn-tiny {
            background: var(--paper-mid);
            border: 1px solid var(--border);
            border-radius: 2px;
            color: var(--ink-muted);
            cursor: pointer;
            padding: 2px 6px;
            font-size: 8px;
        }
        .btn-tiny:hover { background: var(--paper-light); color: var(--ink); }

        /* IP Info */
        .ip-info { font-size: 9px; }
        .ip-address {
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: 600;
            color: var(--ink);
            margin-bottom: 4px;
        }
        .ip-location {
            color: var(--four);
            margin-bottom: 4px;
        }
        .ip-meta {
            color: var(--ink-muted);
            font-size: 8px;
        }
        .ip-meta span { display: block; }

        /* Actions */
        .detail-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .detail-action-btn {
            background: var(--paper-mid);
            border: 1px solid var(--border);
            border-radius: 3px;
            color: var(--ink);
            cursor: pointer;
            padding: 6px 8px;
            font-size: 9px;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .detail-action-btn:hover { background: var(--paper-light); }
        .detail-action-btn .action-icon { font-size: 11px; }
        #btn-ban-this-ip { border-color: var(--one); }
        #btn-ban-this-ip:hover { background: var(--one); color: white; }

        /* Curl preview */
        .curl-preview {
            background: var(--paper-mid);
            border-radius: 2px;
            padding: 6px;
            font-family: var(--font-mono);
            font-size: 8px;
            color: var(--ink-muted);
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 120px;
            margin: 0;
        }
        .log-detail-footer {
            padding: 8px 12px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
        }
        .log-row { cursor: pointer; }

        /* Time histogram */
        .time-histogram {
            margin-bottom: 8px;
            padding: 6px 8px;
            background: var(--paper-dark);
            border-radius: 3px;
        }
        .time-histogram.hidden { display: none; }
        .histogram-bars {
            display: flex;
            align-items: flex-end;
            gap: 1px;
            height: 24px;
        }
        .histogram-bar {
            flex: 1;
            min-width: 2px;
            background: var(--four);
            border-radius: 1px 1px 0 0;
            transition: height 0.2s;
        }
        .histogram-bar:hover {
            background: var(--ink);
        }
        .histogram-bar.has-error {
            background: linear-gradient(to top, var(--four) 0%, var(--one) 100%);
        }
        .histogram-labels {
            display: flex;
            justify-content: space-between;
            font-size: 8px;
            color: var(--ink-muted);
            margin-top: 2px;
            font-family: var(--font-mono);
        }
        /* Config tab */
        .env-lifecycle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: var(--paper-mid);
            border-radius: 3px;
        }
        .env-stage {
            padding: 8px 12px;
            background: var(--paper-dark);
            border: 1px solid var(--border);
            border-radius: 3px;
            text-align: center;
            min-width: 70px;
        }
        .env-stage.active {
            border-color: var(--four);
            background: rgba(var(--four-rgb, 100, 100, 255), 0.1);
        }
        .env-label { font-weight: 600; font-size: 11px; }
        .env-detail { font-size: 9px; color: var(--ink-muted); margin-top: 2px; }
        .env-stage.active .env-label { color: var(--four); }
        .env-arrow { color: var(--ink-muted); font-size: 14px; }
        .config-pre {
            background: var(--paper-mid);
            border-radius: 3px;
            padding: 10px;
            font-family: var(--font-mono);
            font-size: 10px;
            overflow: auto;
            max-height: calc(100vh - 380px);
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
            line-height: 1.5;
        }
        .config-pre .cfg-comment { color: var(--ink-muted); }
        .config-pre .cfg-site { color: var(--four); }
        .config-pre .cfg-directive { color: var(--two); }
        .config-pre .cfg-port { color: var(--one); }
        .config-pre .cfg-snippet { color: var(--three); }
        .config-pre .cfg-section { color: var(--three); font-weight: 600; }
        .tree-file {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 10px;
            font-size: 10px;
            font-family: var(--font-mono);
            border-bottom: 1px solid var(--paper-dark);
        }
        .tree-file:last-child { border-bottom: none; }
        .tree-icon { color: var(--ink-muted); font-size: 9px; }
        .tree-name { color: var(--ink); }
        .tree-name.active { color: var(--four); font-weight: 600; }
        .tree-badge {
            font-size: 8px;
            padding: 1px 5px;
            border-radius: 8px;
            background: var(--paper-dark);
            color: var(--ink-muted);
            margin-left: auto;
        }

    </style>
</head>
<body>
    <div class="panel-header">
        <div class="panel-title">
            <span class="status-dot loading" id="status-dot"></span>
            <span>Caddy</span>
        </div>
        <div class="header-info">
            <span id="env-badge" class="env-badge local">local</span>
            <button class="refresh-toggle" id="refresh-toggle" title="Toggle auto-refresh">
                <span class="refresh-icon">‚ü≥</span>
                <span class="refresh-status" id="refresh-status">10s</span>
            </button>
            <span class="icon-refresh" data-action="refresh" style="cursor:pointer" title="Refresh now"></span>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="overview">Overview</div>
        <div class="tab" data-tab="logs">Logs</div>
        <div class="tab" data-tab="stats">Stats</div>
        <div class="tab" data-tab="ban">Ban <span id="ban-count" class="count zero">0</span></div>
        <div class="tab" data-tab="config">Config</div>
        <div class="tab" data-tab="help">Help</div>
    </div>

    <!-- Overview -->
    <div id="tab-overview" class="content">
        <div class="section">
            <div class="section-title">Service</div>
            <div class="grid grid-4" id="status-grid">
                <div class="card"><div class="label">Status</div><div class="value" id="svc-status">--</div></div>
                <div class="card"><div class="label">Listen</div><div class="value" id="svc-listen">--</div></div>
                <div class="card"><div class="label">Version</div><div class="value" id="svc-version">--</div></div>
                <div class="card"><div class="label">API</div><div class="value" id="svc-api">--</div></div>
            </div>
        </div>
        <div class="section">
            <div class="section-title">Routes</div>
            <div id="routes" class="route-list"><div class="empty">Loading...</div></div>
        </div>
        <div class="section">
            <div class="section-title">Paths</div>
            <div class="grid grid-2">
                <div class="card"><div class="label">Caddyfile</div><div class="value" id="cfg-file" style="font-size:9px">--</div></div>
                <div class="card"><div class="label">Log</div><div class="value" id="cfg-log" style="font-size:9px">--</div></div>
            </div>
        </div>
    </div>

    <!-- Logs -->
    <div id="tab-logs" class="content hidden">
        <div class="log-toolbar">
            <div class="time-filters">
                <button class="btn time-btn active" data-time="all">All</button>
                <button class="btn time-btn" data-time="1h">1h</button>
                <button class="btn time-btn" data-time="24h">24h</button>
                <button class="btn time-btn" data-time="today">Today</button>
            </div>
            <input type="text" id="log-filter" placeholder="Filter by path, method, status...">
            <div class="filter-presets">
                <button class="preset-btn" data-preset="" title="Clear filter">All</button>
                <button class="preset-btn" data-preset="500|502|503|504" title="5xx errors only">Errors</button>
                <button class="preset-btn" data-preset="200" title="Successful requests">200s</button>
                <button class="preset-btn" data-preset="/api" title="API calls">/api</button>
                <button class="preset-btn" data-preset="\.\./" title="Path traversal attacks">LFI</button>
            </div>
            <button class="btn btn-ghost active" id="btn-hide-nop" title="Hide internal Caddy messages">NOP</button>
            <button class="btn" id="btn-geo" title="Lookup geo for all IPs">Geo</button>
            <button class="btn" id="btn-copy" title="Copy logs to clipboard">Copy<span id="copy-badge" class="btn-badge zero">0</span></button>
            <button class="btn" id="btn-json" title="Export as JSON">JSON</button>
            <button class="btn" id="btn-follow" title="Follow new entries (faster refresh)">Follow</button>
            <button class="btn" id="btn-raw">Raw</button>
            <button class="btn" id="btn-debug">Debug</button>
        </div>
        <div id="insights-bar" class="insights-bar hidden">
            <div class="insight-item">
                <span class="insight-label">Traffic:</span>
                <span id="insight-traffic" class="insight-value">-</span>
            </div>
            <div class="insight-item">
                <span class="insight-label">Errors:</span>
                <span id="insight-errors" class="insight-value">-</span>
            </div>
            <div class="insight-item">
                <span class="insight-label">Hot:</span>
                <span id="insight-hot" class="insight-value">-</span>
            </div>
            <div id="insight-alert-container" class="insight-item" style="display:none">
                <span id="insight-alert" class="insight-alert"></span>
            </div>
        </div>
        <div id="time-histogram" class="time-histogram hidden">
            <div class="histogram-bars" id="histogram-bars"></div>
            <div class="histogram-labels">
                <span id="histogram-start">--</span>
                <span id="histogram-end">--</span>
            </div>
        </div>
        <div class="log-container">
            <div class="log-header" id="log-header">
                <span class="log-col-header" data-col="time" data-sort="desc">Time <span class="sort-indicator">‚ñº</span></span>
                <span class="log-col-header" data-col="status">Code</span>
                <span class="log-col-header" data-col="method">Method</span>
                <span class="log-col-header" data-col="ip" data-aggregate="true">IP</span>
                <span class="log-col-header" data-col="path" data-aggregate="true">Path</span>
                <span class="log-col-header" data-col="geo">Geo</span>
                <span class="log-col-header" data-col="duration">Dur</span>
            </div>
            <div id="logs"><div class="empty">Loading...</div></div>
        </div>
        <div id="debug-box" class="debug-box"><pre id="debug-data"></pre></div>
    </div>

    <!-- Stats -->
    <div id="tab-stats" class="content hidden">
        <div class="stats-toolbar">
            <button class="btn" id="btn-copy-stats" title="Copy stats to clipboard">Copy Stats</button>
        </div>
        <div class="section">
            <div class="section-title">Summary</div>
            <div class="grid grid-4">
                <div class="card"><div class="label">Requests</div><div class="value" id="stat-total">--</div></div>
                <div class="card"><div class="label">Errors</div><div class="value" id="stat-errors">--</div></div>
                <div class="card"><div class="label">Latency</div><div class="value" id="stat-latency">--</div></div>
                <div class="card"><div class="label">IPs</div><div class="value" id="stat-ips">--</div></div>
            </div>
        </div>
        <div class="section">
            <div class="section-title">
                <span>Top Paths</span>
                <button class="btn btn-sm" id="btn-group-paths" title="Toggle path grouping">Group</button>
            </div>
            <div id="top-paths" class="top-list"><div class="empty">Loading...</div></div>
        </div>
        <div class="section">
            <div class="section-title">Status Codes</div>
            <div id="top-codes" class="top-list"><div class="empty">Loading...</div></div>
        </div>
        <div class="section">
            <div class="section-title">Top IPs</div>
            <div id="top-ips" class="top-list"><div class="empty">Loading...</div></div>
        </div>
    </div>

    <!-- Ban -->
    <div id="tab-ban" class="content hidden">
        <div class="section">
            <div class="section-title">
                <span>Service</span>
                <button class="btn btn-sm" id="btn-ban-ip">+ Ban IP</button>
            </div>
            <div class="grid grid-3">
                <div class="card"><div class="label">Status</div><div class="value" id="f2b-status">--</div></div>
                <div class="card"><div class="label">Jails</div><div class="value" id="f2b-jails">--</div></div>
                <div class="card"><div class="label">Banned</div><div class="value bad" id="f2b-total">0</div></div>
            </div>
        </div>
        <div class="section">
            <div class="section-title">Banned IPs</div>
            <div id="ban-list" class="ban-list"><div class="empty">None</div></div>
        </div>
        <div class="section">
            <div class="section-title">Top Offenders (from logs)</div>
            <div id="top-offenders" class="ban-list"><div class="empty">Load logs first</div></div>
        </div>
        <div class="section">
            <div class="section-title">Recent Activity</div>
            <div id="ban-recent" class="top-list"><div class="empty">No activity</div></div>
        </div>
    </div>

    <!-- Config -->
    <div id="tab-config" class="content hidden">
        <div class="section">
            <div class="section-title">Env Lifecycle</div>
            <div id="env-lifecycle" class="env-lifecycle">
                <div class="env-stage" data-env="local">
                    <div class="env-label">local</div>
                    <div class="env-detail">caddy run</div>
                </div>
                <span class="env-arrow">‚Üí</span>
                <div class="env-stage" data-env="dev">
                    <div class="env-label">dev</div>
                    <div class="env-detail">rsync deploy</div>
                </div>
                <span class="env-arrow">‚Üí</span>
                <div class="env-stage" data-env="staging">
                    <div class="env-label">staging</div>
                    <div class="env-detail">rsync deploy</div>
                </div>
                <span class="env-arrow">‚Üí</span>
                <div class="env-stage" data-env="prod">
                    <div class="env-label">prod</div>
                    <div class="env-detail">rsync deploy</div>
                </div>
            </div>
        </div>
        <div class="section">
            <div class="section-title">Config Tree</div>
            <div id="config-tree" class="top-list"><div class="empty">Loading...</div></div>
        </div>
        <div class="section">
            <div class="section-title">
                <span>Resolved Caddyfile</span>
                <div style="display:flex;gap:4px">
                    <button class="btn btn-sm" id="btn-copy-config">Copy</button>
                </div>
            </div>
            <pre id="resolved-config" class="config-pre"><span class="empty">Loading...</span></pre>
        </div>
    </div>

    <!-- Help -->
    <div id="tab-help" class="content hidden">
        <div class="help-section">
            <h3>Architecture Overview</h3>
            <div class="help-diagram">
Browser Request
      |
      v
+-------------+     +------------------+     +-----------------+
|   Caddy     | --> | fail2ban watches | --> | iptables blocks |
| (port 443)  |     | Caddy access log |     | banned IPs      |
+-------------+     +------------------+     +-----------------+
      |
      | reverse_proxy
      v
+-----------------+
| Backend Service |
| (localhost:XXX) |
+-----------------+</div>
            <p>Caddy is the single entry point for all HTTP/HTTPS traffic. It handles TLS termination,
            routing, and reverse proxying to backend services.</p>
        </div>

        <div class="help-section">
            <h3>Components</h3>
            <ul>
                <li><strong>Caddy</strong> - Web server with automatic HTTPS. Runs as systemd service on remote, or via <code>tsm start caddy</code> locally.</li>
                <li><strong>tcaddy</strong> - Bash CLI for managing Caddy. Commands: <code>tcaddy status</code>, <code>tcaddy logs</code>, <code>tcaddy reload</code></li>
                <li><strong>Dashboard API</strong> - Node.js API at <code>/api/caddy/*</code> that queries Caddy's admin API (localhost:2019) or runs SSH commands for remote.</li>
                <li><strong>Admin API</strong> - Caddy's built-in REST API on port 2019. Used for config reload, status, and route inspection.</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>fail2ban: How Banning Works</h3>
            <p>fail2ban monitors log files for suspicious patterns and temporarily blocks offending IPs:</p>
            <ol>
                <li><strong>Watch</strong> - fail2ban reads Caddy's access log looking for patterns (e.g., repeated 401s, 403s, or 404s)</li>
                <li><strong>Match</strong> - When a "jail" filter matches (e.g., 5 failed logins in 10 minutes), it triggers</li>
                <li><strong>Ban</strong> - fail2ban adds an iptables rule: <code>iptables -I INPUT -s [IP] -j REJECT</code></li>
                <li><strong>Log</strong> - Ban event is logged to <code>/var/log/fail2ban.log</code></li>
                <li><strong>Expire</strong> - After bantime (default 10m-24h), the iptables rule is removed</li>
            </ol>
            <p><strong>Jails</strong> are configured in <code>/etc/fail2ban/jail.local</code>. Common jails:</p>
            <ul>
                <li><code>caddy-auth</code> - Failed authentication attempts (401 responses)</li>
                <li><code>caddy-badbots</code> - Known malicious user agents</li>
                <li><code>caddy-noscript</code> - Attempts to access common exploit paths</li>
            </ul>
            <p><strong>Manual commands:</strong></p>
            <ul>
                <li><code>fail2ban-client status</code> - List all jails</li>
                <li><code>fail2ban-client status caddy-auth</code> - Show banned IPs for a jail</li>
                <li><code>fail2ban-client set caddy-auth unbanip 1.2.3.4</code> - Manually unban an IP</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>Log Files &amp; Rotation</h3>
            <p><strong>Local Development:</strong></p>
            <div class="help-path">
                <span class="help-path-label">Access Log</span>
                <span class="help-path-value">$TETRA_DIR/run/logs/caddy.log</span>
            </div>
            <div class="help-path">
                <span class="help-path-label">Caddyfile</span>
                <span class="help-path-value">$TETRA_DIR/orgs/$ORG/caddy/Caddyfile</span>
            </div>
            <p>Local logs are rotated by Caddy itself (configured in Caddyfile with <code>roll_size</code> and <code>roll_keep</code>).</p>

            <p><strong>Remote/Production:</strong></p>
            <div class="help-path">
                <span class="help-path-label">Access Log</span>
                <span class="help-path-value">/var/log/caddy/access.log</span>
            </div>
            <div class="help-path">
                <span class="help-path-label">Error Log</span>
                <span class="help-path-value">/var/log/caddy/error.log</span>
            </div>
            <div class="help-path">
                <span class="help-path-label">Caddyfile</span>
                <span class="help-path-value">/etc/caddy/Caddyfile</span>
            </div>
            <div class="help-path">
                <span class="help-path-label">fail2ban</span>
                <span class="help-path-value">/var/log/fail2ban.log</span>
            </div>

            <p><strong>Log Rotation Ownership:</strong></p>
            <ul>
                <li><strong>Caddy logs</strong> - Caddy handles its own rotation via config: <code>roll_size 10mb</code>, <code>roll_keep 5</code></li>
                <li><strong>fail2ban logs</strong> - Rotated by logrotate (<code>/etc/logrotate.d/fail2ban</code>)</li>
                <li><strong>System journal</strong> - journald handles Caddy's systemd output, use <code>journalctl -u caddy</code></li>
            </ul>
            <p><strong>Current Log File:</strong></p>
            <div id="log-file-info" class="log-file-info">
                <div class="info-row"><span class="info-label">Size</span><span id="log-info-size" class="info-value">--</span></div>
                <div class="info-row"><span class="info-label">Entries</span><span id="log-info-entries" class="info-value">--</span></div>
                <div class="info-row"><span class="info-label">Policy</span><span id="log-info-policy" class="info-value">roll_size 10mb, roll_keep 5</span></div>
                <div class="info-row"><span class="info-label">Modified</span><span id="log-info-modified" class="info-value">--</span></div>
            </div>
        </div>

        <div class="help-section">
            <h3>Log Entry Types</h3>
            <p>Caddy outputs JSON logs. Entry types you'll see:</p>
            <ul>
                <li><strong>HTTP Request</strong> - Has <code>request.method</code>, <code>request.uri</code>, <code>status</code>, <code>duration</code></li>
                <li><strong>Error</strong> - Has <code>level: "error"</code>, <code>msg</code> describing the issue</li>
                <li><strong>Info</strong> - Startup messages, config reloads, TLS certificate events</li>
            </ul>
            <p>Logs showing "-" for Method/Path are non-request entries (errors, info messages).</p>
        </div>

        <div class="help-section">
            <h3>Troubleshooting</h3>
            <ul>
                <li><strong>502 Bad Gateway</strong> - Backend service not running or wrong port</li>
                <li><strong>Logs show "-" for method/path</strong> - These are non-HTTP entries (startup, errors). Click "Raw" to see full JSON.</li>
                <li><strong>Admin API not responding</strong> - Caddy not running or admin disabled in config</li>
                <li><strong>Remote SSH fails</strong> - Check tetra.toml has correct host/user, verify SSH key access</li>
            </ul>
            <p>Use the <strong>Debug</strong> button to see raw API response data.</p>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <!-- Request detail popover -->
    <div id="log-detail" class="log-detail-overlay hidden">
        <div class="log-detail-popover">
            <div class="log-detail-header">
                <span class="log-detail-title">Request Details</span>
                <button class="log-detail-close" id="log-detail-close">&times;</button>
            </div>
            <div class="log-detail-body">
                <div class="log-detail-left">
                    <div id="log-detail-summary" class="log-detail-summary"></div>
                    <pre id="log-detail-json" class="log-detail-json"></pre>
                </div>
                <div class="log-detail-right">
                    <!-- IP Info & Location -->
                    <div class="detail-section" id="ip-info-section">
                        <div class="detail-section-title">IP Info</div>
                        <div class="ip-info">
                            <div class="ip-address" id="detail-ip">-</div>
                            <div class="ip-location" id="detail-location">-</div>
                            <div class="ip-meta" id="detail-ip-meta"></div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="detail-section">
                        <div class="detail-section-title">Actions</div>
                        <div class="detail-actions">
                            <button class="detail-action-btn" id="btn-ban-this-ip" title="Ban this IP">
                                <span class="action-icon">üö´</span> Ban IP
                            </button>
                            <button class="detail-action-btn" id="btn-filter-ip" title="Filter logs by this IP">
                                <span class="action-icon">üîç</span> Filter IP
                            </button>
                            <button class="detail-action-btn" id="btn-filter-path" title="Filter logs by this path">
                                <span class="action-icon">üîç</span> Filter Path
                            </button>
                        </div>
                    </div>

                    <!-- Curl Command -->
                    <div class="detail-section" id="curl-section">
                        <div class="detail-section-title">
                            <span>curl</span>
                            <button class="btn-tiny" id="btn-copy-curl" title="Copy full curl">Copy</button>
                        </div>
                        <pre class="curl-preview" id="curl-preview"></pre>
                    </div>
                </div>
            </div>
            <div class="log-detail-footer">
                <button class="btn" id="log-detail-copy">Copy JSON</button>
            </div>
        </div>
    </div>

    <!-- Ban dialog -->
    <div id="ban-dialog" class="log-detail-overlay hidden">
        <div class="log-detail-popover" style="max-width: 360px">
            <div class="log-detail-header">
                <span class="log-detail-title">Ban IP</span>
                <button class="log-detail-close" id="ban-dialog-close">&times;</button>
            </div>
            <div class="log-detail-body">
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="font-size: 10px; color: var(--ink-muted);">IP Address</label>
                    <input type="text" id="ban-ip-input" placeholder="e.g. 185.177.72.13" style="padding: 6px 8px; background: var(--paper-mid); border: 1px solid var(--border); color: var(--ink); font-size: 11px; font-family: var(--font-mono); border-radius: 2px;">
                    <label style="font-size: 10px; color: var(--ink-muted);">Jail</label>
                    <select id="ban-jail-select" style="padding: 6px 8px; background: var(--paper-mid); border: 1px solid var(--border); color: var(--ink); font-size: 10px; border-radius: 2px;">
                        <option value="caddy-noscript">caddy-noscript</option>
                        <option value="caddy-auth">caddy-auth</option>
                        <option value="caddy-badbots">caddy-badbots</option>
                    </select>
                    <label style="font-size: 10px; color: var(--ink-muted);">Duration</label>
                    <select id="ban-duration-select" style="padding: 6px 8px; background: var(--paper-mid); border: 1px solid var(--border); color: var(--ink); font-size: 10px; border-radius: 2px;">
                        <option value="">Default (jail setting)</option>
                        <option value="10m">10 minutes</option>
                        <option value="1h">1 hour</option>
                        <option value="24h">24 hours</option>
                        <option value="7d">7 days</option>
                        <option value="permanent">Permanent</option>
                    </select>
                </div>
            </div>
            <div class="log-detail-footer">
                <button class="btn" id="ban-dialog-submit" style="background: var(--one); color: white; border-color: var(--one);">Ban</button>
            </div>
        </div>
    </div>

    <script src="ui-helpers.js"></script>
    <script src="/js/terrain-iframe.js"></script>
    <!-- Caddy modules (order matters: state/formatters/geo first, index last) -->
    <script src="/js/caddy/state.js"></script>
    <script src="/js/caddy/formatters.js"></script>
    <script src="/js/caddy/geo.js"></script>
    <script src="/js/caddy/helpers.js"></script>
    <script src="/js/caddy/scanner.js"></script>
    <script src="/js/caddy/insights.js"></script>
    <script src="/js/caddy/detail.js"></script>
    <script src="/js/caddy/refresh.js"></script>
    <script src="/js/caddy/logs.js"></script>
    <script src="/js/caddy/stats.js"></script>
    <script src="/js/caddy/ban.js"></script>
    <script src="/js/caddy/config.js"></script>
    <script src="/js/caddy/api.js"></script>
    <script src="/js/caddy/index.js"></script>
</body>
</html>
