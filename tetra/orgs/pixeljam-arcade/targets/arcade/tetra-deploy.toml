# Arcade Deploy Configuration
# Usage: deploy arcade dev

[target]
name = "arcade"
description = "PixelJam Arcade - SvelteKit game platform"
repo = "git@github.com:mricos/pixeljam.git"
source = "build/"
cwd = "/home/{{user}}/src/pixeljam/pja/arcade"
remote_build = true

# Environment definitions
[env.dev]
ssh = "root@dev.pixeljamarcade.com"
user = "dev"
domain = "dev.pixeljamarcade.com"
branch = "develop"
port = 8480
confirm = false

[env.staging]
ssh = "root@staging.pixeljamarcade.com"
user = "staging"
domain = "staging.pixeljamarcade.com"
branch = "main"
port = 8480
confirm = true

[env.prod]
ssh = "root@pixeljamarcade.com"
user = "prod"
domain = "pixeljamarcade.com"
branch = "release"
port = 8480
confirm = true

# Build commands (run locally, but we use remote for server builds)
[build]
pre = "echo 'Deploying arcade to {{env}}'"

# Remote commands (run on server via SSH)
# Note: tetra_init sources tetra.sh and activates nvm
[remote]
tetra_init = "source ~/tetra/tetra.sh && tetra_nvm_activate"
pull = "cd {{cwd}} && git fetch origin && git checkout {{branch}} && git pull origin {{branch}}"
deps = "cd {{cwd}} && source ~/tetra/tetra.sh && tetra_nvm_activate && npm ci"
build = "cd {{cwd}} && source ~/tetra/tetra.sh && tetra_nvm_activate && npm run build"
tsm_restart = "source ~/tetra/tetra.sh && cd {{cwd}} && source tsm/arcade-{{env}}.tsm && tsm restart arcade-$TSM_PORT 2>/dev/null || tsm start \"$TSM_COMMAND\" --name arcade --port $TSM_PORT"
tsm_status = "source ~/tetra/tetra.sh && tsm list | grep arcade"

# Pipelines
[pipeline]
default = ["remote:pull", "remote:deps", "remote:build", "remote:tsm_restart", "remote:tsm_status"]
quick = ["remote:pull", "remote:build", "remote:tsm_restart"]
restart = ["remote:tsm_restart", "remote:tsm_status"]
status = ["remote:tsm_status"]

# Aliases
[alias]
q = "quick"
r = "restart"
s = "status"
