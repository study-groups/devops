# Tetra Organization Compilation System

**Version:** 1.0.0
**TES Version:** 2.1
**Date:** 2025-10-10
**Status:** Production

---

## Table of Contents

1. [Overview](#overview)
2. [Directory Structure](#directory-structure)
3. [File Specifications](#file-specifications)
4. [Compilation Process](#compilation-process)
5. [TES Symbol Resolution](#tes-symbol-resolution)
6. [Security Model](#security-model)
7. [Workflow Examples](#workflow-examples)
8. [Version Control Strategy](#version-control-strategy)
9. [Best Practices](#best-practices)
10. [Troubleshooting](#troubleshooting)

---

## Overview

### Purpose

The Tetra Organization Compilation System transforms infrastructure data and configuration files into a unified, TES-compliant `tetra.toml` configuration file. This system separates concerns:

- **Schema files** define structure (safe to share/commit)
- **Secrets files** contain credentials (never committed)
- **Compiled output** merges schema + secrets (never committed)

### Key Principles

1. **Separation of Secrets**: Credentials live in `secrets.env`, structure lives in schema files
2. **TES Compliance**: Uses progressive symbol resolution (`@dev` → address → connector → locator)
3. **Immutability**: Input files are source of truth, never modified by compiler
4. **Auditability**: All changes create timestamped backups
5. **Git Safety**: Clear rules on what gets committed vs. gitignored

### Compilation Equation

```
digitalocean.json  (infrastructure)
  + mapping.json   (environment mappings)
  + resources.toml (file sync schema)
  + ports.json     (optional port registry)
  + secrets.env    (actual credentials)
  ──────────────────────────────────────
  = tetra.toml     (TES 2.1 compliant config)
```

---

## Directory Structure

### Base Convention

```
$TETRA_DIR/org/${org_name}/
```

Example for organization "pixeljam-arcade":
```
$TETRA_DIR/org/pixeljam-arcade/
```

### Complete Directory Layout

```
$TETRA_DIR/org/${org_name}/
├── digitalocean.json          # Infrastructure data (CAN commit)
├── mapping.json               # Environment mappings (CAN commit)
├── resources.toml             # File sync schema (CAN commit)
├── ports.json                 # Port registry (CAN commit, optional)
├── secrets.env                # SECRETS (NEVER commit) [600 perms]
├── tetra.toml                 # COMPILED OUTPUT (NEVER commit)
│
├── services/                  # Service configuration templates
│   ├── app.service.toml
│   └── arcade.service.toml
│
├── nginx/                     # Nginx configs per environment
│   ├── dev.conf
│   ├── staging.conf
│   └── prod.conf
│
├── deployment/                # Deployment strategies
│   └── strategy.deploy.toml
│
├── backups/                   # Timestamped backups
│   ├── digitalocean.json.backup.20251010_143022
│   ├── mapping.json.backup.20251010_143022
│   └── tetra.toml.backup.20251010_143045
│
└── deployed/                  # Deployment history
    ├── dev.toml
    ├── staging.toml
    └── prod.toml
```

---

## File Specifications

### Input Files (Schema - Can Commit)

#### 1. `digitalocean.json`

**Source:** NodeHolder (NH) via `doctl` wrapper
**Format:** JSON
**Purpose:** Raw infrastructure topology from DigitalOcean API
**Contains:** Droplets, IPs, domains, volumes, floating IPs
**Secrets:** None

Example structure:
```json
[
  {
    "Droplets": [
      {
        "id": 437858577,
        "name": "pxjam-arcade-dev01",
        "networks": {
          "v4": [
            {"type": "public", "ip_address": "137.184.226.163"},
            {"type": "private", "ip_address": "10.124.0.4"}
          ]
        },
        "region": {"slug": "sfo3"},
        "tags": ["dev", "arcade"]
      }
    ]
  },
  {
    "Domains": [
      {
        "name": "pixeljamarcade.com",
        "zone_file": "..."
      }
    ]
  }
]
```

#### 2. `mapping.json`

**Source:** Generated by `bash/org/discovery.sh`
**Format:** JSON
**Purpose:** Explicit infrastructure → environment mapping
**Contains:** Semantic environment mappings (@dev, @staging, @prod)
**Secrets:** None

Example structure:
```json
{
  "org_name": "pixeljam-arcade",
  "discovered_at": "2025-10-10T19:30:00Z",
  "source": "/path/to/digitalocean.json",
  "environments": {
    "local": {
      "type": "localhost",
      "address": "127.0.0.1"
    },
    "dev": {
      "droplet_id": 437858577,
      "droplet_name": "pxjam-arcade-dev01",
      "address": "137.184.226.163",
      "private_ip": "10.124.0.4",
      "domain": "dev.pixeljamarcade.com",
      "auth_user": "root",
      "work_user": "dev"
    },
    "staging": {
      "droplet_id": 381467504,
      "droplet_name": "pxjam-arcade-qa01",
      "address": "24.199.72.22",
      "floating_ip": "24.199.72.22",
      "domain": "qa.pixeljamarcade.com"
    },
    "prod": {
      "droplet_id": 395274922,
      "droplet_name": "pxjam-arcade-prod01",
      "address": "164.90.247.44",
      "floating_ip": "164.90.247.44",
      "domain": "pixeljamarcade.com"
    }
  },
  "ports": {
    "tetra": 4444,
    "devpages": 4000,
    "arcade": 8400,
    "api": 8000
  }
}
```

#### 3. `resources.toml`

**Source:** Hand-authored by developer
**Format:** TOML
**Purpose:** File sync definitions using TES symbols
**Contains:** What files to sync where, using semantic symbols
**Secrets:** None (uses symbol references like `@dev`)

See `bash/org/resources.example.toml` for complete example.

Key sections:
```toml
[_config]
org_name = "pixeljam-arcade"
tes_version = "2.1"

[resources.env_config]
type = "env"
operation = "push"

[resources.env_config.source]
symbol = "@local"
locator = "env/{environment}.env"

[resources.env_config.targets]
"@dev" = "/app/.env"
"@staging" = "/app/.env"
"@prod" = "/app/.env"
```

#### 4. `ports.json` (Optional)

**Source:** Hand-authored or embedded in `mapping.json`
**Format:** JSON
**Purpose:** Service name → port number registry
**Contains:** Port mappings for TES port resolution
**Secrets:** None

Example:
```json
{
  "tetra": 4444,
  "devpages": 4000,
  "arcade": 8400,
  "pbase": 2600,
  "api": 8000,
  "admin": 9000
}
```

### Secret Files (NEVER Commit)

#### 5. `secrets.env`

**Source:** Hand-authored by developer
**Format:** Shell environment variables
**Purpose:** Actual credentials and secrets
**Contains:** DB passwords, API keys, tokens
**Permissions:** Must be 600 (owner read/write only)

Example structure:
```bash
# Database credentials
DB_HOST=prod-postgres.internal
DB_PORT=5432
DB_NAME=arcade_prod
DB_USER=arcade_app
DB_PASSWORD=super_secret_password_123

# API Keys
DO_SPACES_KEY=DO00GXQ243FCVDLQT9CF
DO_SPACES_SECRET=+kH1E4zhaaisTmKwQRoJS9nfDRK2j9ZOigXmm0PJygY
STRIPE_SECRET_KEY=sk_live_...
SENDGRID_API_KEY=SG....

# JWT/Session
JWT_SECRET=random_256_bit_secret
SESSION_SECRET=another_random_secret
```

**Security requirements:**
- File permissions: `600` (enforced by compiler)
- Location: `$TETRA_DIR/org/${org_name}/secrets.env`
- Git: MUST be in .gitignore
- Initialization: `bash/org/secrets_manager.sh init <org_name>`

### Compiled Output (NEVER Commit)

#### 6. `tetra.toml`

**Source:** Generated by `bash/org/compiler.sh`
**Format:** TOML (TES 2.1 compliant)
**Purpose:** Final configuration with embedded secrets
**Contains:** All sections merged with secrets interpolated
**Secrets:** YES - contains embedded credentials

Generated sections:
```toml
[metadata]
[org]
[symbols]        # TES Level 0: Semantic labels
[connectors]     # TES Level 3: Authenticated channels
[ports]          # Service port registry
[infrastructure] # Reference data
[environments.*] # Environment configs
[domains]        # DNS configuration
[resources.*]    # File sync definitions
```

---

## Compilation Process

### High-Level Flow

```
┌─────────────────────┐
│  Input Files        │
├─────────────────────┤
│ digitalocean.json   │───┐
│ mapping.json        │───┤
│ resources.toml      │───├──> COMPILER ──> tetra.toml
│ ports.json          │───┤                 (with secrets)
│ secrets.env (600)   │───┘
└─────────────────────┘
```

### Detailed Compilation Steps

#### Phase 1: Validation
```bash
compiler.sh compile <org_name>
  └─> [1/6] Validate input files exist
      ├─> digitalocean.json ✓
      ├─> mapping.json ✓
      └─> secrets.env ✓ (check 600 perms)
```

#### Phase 2: Secrets Loading
```bash
  └─> [2/6] Validate secrets.env content
      ├─> Check for empty values
      └─> Load into environment
          $ set -a
          $ source secrets.env
          $ set +a
```

#### Phase 3: Backup
```bash
  └─> [3/6] Backup existing tetra.toml
      └─> backups/tetra.toml.backup.20251010_143045
```

#### Phase 4: Base Generation
```bash
  └─> [4/6] Generate base TOML
      ├─> converter.sh: digitalocean.json + mapping.json
      ├─> Creates [symbols], [connectors], [ports]
      └─> Output: /tmp/pixeljam_base_12345.toml
```

#### Phase 5: Resources Addition
```bash
  └─> [5/6] Append resources section
      ├─> Parse resources.toml
      └─> Append [resources.*] sections
```

#### Phase 6: Secrets Interpolation
```bash
  └─> [6/6] Interpolate secrets
      ├─> Replace ${DB_PASSWORD} with actual value
      ├─> Replace ${DO_SPACES_KEY} with actual value
      └─> Write final tetra.toml
```

### Compiler Command Reference

```bash
# Full compilation
bash/org/compiler.sh compile pixeljam-arcade

# Force overwrite
bash/org/compiler.sh compile pixeljam-arcade --force

# Quick recompile (skip validation)
bash/org/compiler.sh quick pixeljam-arcade

# Validate output
bash/org/compiler.sh validate pixeljam-arcade
```

---

## TES Symbol Resolution

### Progressive Resolution Chain

Resources use TES symbols that resolve at runtime:

```
Level 0: Symbol        @dev
  ↓
Level 1: Address       143.198.45.123
  ↓
Level 2: Channel       dev@143.198.45.123
  ↓
Level 3: Connector     root:dev@143.198.45.123 -i ~/.ssh/id_rsa
  ↓
Level 4: Handle        ✓ (validated SSH connection)
  ↓
Level 5: Locator       dev@143.198.45.123:/app/.env
  ↓
Level 6: Binding       write(Locator) with permissions 600
  ↓
Level 7: Plan          scp local.env root@143...:/tmp/; ssh ... 'sudo -u dev mv...'
```

### Example: Environment File Sync

**In resources.toml (schema - no secrets):**
```toml
[resources.env_config.source]
symbol = "@local"
locator = "env/dev.env"

[resources.env_config.targets]
"@dev" = "/app/.env"
```

**Resolution at runtime:**

1. **Symbol `@local`:**
   - Resolved from `[symbols]` section in tetra.toml
   - Result: `{ address = "127.0.0.1", type = "local" }`

2. **Symbol `@dev`:**
   - Resolved from `[symbols]`: `{ address = "143.198.45.123", ... }`
   - Resolved from `[connectors]`: `{ auth_user = "root", work_user = "dev", ... }`
   - Result: Full SSH connector specification

3. **Execution Plan:**
   ```bash
   scp -i ~/.ssh/id_rsa env/dev.env root@143.198.45.123:/tmp/dev.env && \
   ssh -i ~/.ssh/id_rsa root@143.198.45.123 \
     "sudo -u dev cp /tmp/dev.env /app/.env && \
      sudo -u dev chmod 600 /app/.env && \
      rm /tmp/dev.env"
   ```

### Variable Expansion

Resources support these variables:

| Variable | Expands To | Example |
|----------|-----------|---------|
| `{environment}` | dev, staging, prod | `env/{environment}.env` → `env/dev.env` |
| `{work_user}` | From connector | `{work_user}:{work_user}` → `dev:dev` |
| `{org_name}` | From _config | `backups/{org_name}/` → `backups/pixeljam-arcade/` |
| `{timestamp}` | ISO timestamp | `db_{timestamp}.sql` → `db_20251010_143045.sql` |

---

## Security Model

### What Gets Committed to Git

#### ✅ SAFE TO COMMIT (Schema Files)

```
org/*/digitalocean.json   # Infrastructure topology (no secrets)
org/*/mapping.json        # Environment mappings (no secrets)
org/*/resources.toml      # File sync schema (uses symbols, no secrets)
org/*/ports.json          # Port registry (no secrets)
org/*/services/           # Service templates (no secrets)
org/*/nginx/              # Nginx templates (no secrets)
```

**Why safe?** These files contain **structure**, not **values**. They use symbolic references (`@dev`, `${DB_PASSWORD}`) that get resolved at compile time.

#### ❌ NEVER COMMIT (Secrets & Compiled Output)

```
org/*/secrets.env         # Contains actual credentials
org/*/tetra.toml          # Contains embedded secrets
org/*/backups/*.env       # Backup of secrets
org/*/backups/*.toml      # Backup of compiled config
```

**Why unsafe?** These files contain **actual credential values**.

### .gitignore Configuration

Required `.gitignore` entries:

```gitignore
# Tetra secrets (CRITICAL)
org/*/secrets.env
org/*/tetra.toml
org/*/backups/*.env
org/*/backups/*.toml

# Alternative org directory name
orgs/*/secrets.env
orgs/*/tetra.toml
```

See `bash/org/gitignore.template` for complete template.

### Permission Requirements

| File | Required Permissions | Enforced By |
|------|---------------------|-------------|
| `secrets.env` | `600` (rw-------) | `compiler.sh`, `secrets_manager.sh` |
| `tetra.toml` | `600` (rw-------) | Recommended |
| Other inputs | `644` (rw-r--r--) | Default |

Compiler automatically fixes `secrets.env` permissions if incorrect.

### Secrets Validation

The compiler validates secrets before compilation:

```bash
# Check secrets exist
tetra org secrets validate pixeljam-arcade

# Output shows:
# ✅ Secrets file validated
# ⚠️  Found 3 empty secrets:
#   - STRIPE_SECRET_KEY
#   - SENDGRID_API_KEY
#   - JWT_SECRET
```

---

## Workflow Examples

### Initial Setup

```bash
# 1. Create organization structure
mkdir -p $TETRA_DIR/org/pixeljam-arcade

# 2. Add infrastructure data
cp ~/downloads/digitalocean.json $TETRA_DIR/org/pixeljam-arcade/

# 3. Run discovery to create mapping
bash/org/discovery.sh discover \
  $TETRA_DIR/org/pixeljam-arcade/digitalocean.json \
  pixeljam-arcade

# 4. Create resources.toml (copy example and customize)
cp bash/org/resources.example.toml \
   $TETRA_DIR/org/pixeljam-arcade/resources.toml

# 5. Initialize secrets
bash/org/secrets_manager.sh init pixeljam-arcade

# 6. Edit secrets
$EDITOR $TETRA_DIR/org/pixeljam-arcade/secrets.env

# 7. Compile tetra.toml
bash/org/compiler.sh compile pixeljam-arcade
```

### Refresh Workflow

```bash
# Full refresh with new infrastructure data
bash/org/refresh.sh refresh pixeljam-arcade ~/downloads/digitalocean.json

# Full refresh, force re-discovery
bash/org/refresh.sh refresh pixeljam-arcade --rediscover

# Quick refresh (just recompile)
bash/org/refresh.sh quick pixeljam-arcade

# Check if refresh needed
bash/org/refresh.sh status pixeljam-arcade
```

### Updating Secrets

```bash
# Edit secrets
$EDITOR $TETRA_DIR/org/pixeljam-arcade/secrets.env

# Validate
bash/org/secrets_manager.sh validate pixeljam-arcade

# Recompile with new secrets
bash/org/compiler.sh quick pixeljam-arcade
```

### Updating Resources

```bash
# Edit resources
$EDITOR $TETRA_DIR/org/pixeljam-arcade/resources.toml

# Recompile
bash/org/compiler.sh quick pixeljam-arcade

# Validate
bash/org/compiler.sh validate pixeljam-arcade
```

---

## Version Control Strategy

### Team Collaboration

**Scenario:** Multiple developers working on same organization

#### Repository Structure

```
your-app/
├── .gitignore                    # Include tetra gitignore rules
├── tetra/
│   └── org/
│       └── pixeljam-arcade/
│           ├── digitalocean.json  # ✅ COMMIT
│           ├── mapping.json       # ✅ COMMIT
│           ├── resources.toml     # ✅ COMMIT
│           ├── services/          # ✅ COMMIT
│           ├── nginx/             # ✅ COMMIT
│           ├── secrets.env        # ❌ NEVER COMMIT
│           └── tetra.toml         # ❌ NEVER COMMIT
```

#### Workflow

1. **Developer A** updates infrastructure:
   ```bash
   # Download new infrastructure
   doctl export > digitalocean.json

   # Run discovery
   bash/org/refresh.sh refresh pixeljam-arcade digitalocean.json

   # Commit schema files
   git add org/pixeljam-arcade/digitalocean.json
   git add org/pixeljam-arcade/mapping.json
   git commit -m "Update infrastructure: add staging-02 droplet"
   git push
   ```

2. **Developer B** pulls changes:
   ```bash
   git pull

   # Recompile with their local secrets
   bash/org/compiler.sh quick pixeljam-arcade

   # Their secrets.env is already local, so tetra.toml gets regenerated
   # with new infrastructure + their secrets
   ```

#### Secrets Distribution

**Problem:** How do team members get `secrets.env`?

**Options:**

1. **1Password/Vault** (Recommended):
   ```bash
   # Store secrets.env in 1Password
   op document create secrets.env --vault DevOps

   # Team members retrieve
   op document get secrets.env > $TETRA_DIR/org/pixeljam-arcade/secrets.env
   chmod 600 $TETRA_DIR/org/pixeljam-arcade/secrets.env
   ```

2. **Encrypted in repo** (Alternative):
   ```bash
   # Encrypt with GPG
   gpg --encrypt --recipient team@example.com secrets.env

   # Commit encrypted version
   git add secrets.env.gpg
   git commit -m "Add encrypted secrets"

   # Team members decrypt
   gpg --decrypt secrets.env.gpg > secrets.env
   chmod 600 secrets.env
   ```

3. **Separate secrets repo** (Enterprise):
   ```
   pixeljam-arcade-secrets/  (private repo)
   └── secrets.env
   ```

---

## Best Practices

### 1. Never Commit Secrets

- Always add `org/*/secrets.env` and `org/*/tetra.toml` to `.gitignore`
- Validate `.gitignore` rules before first commit:
  ```bash
  git check-ignore org/*/secrets.env org/*/tetra.toml
  # Should output the file paths (meaning they're ignored)
  ```

### 2. Backup Before Changes

The compiler automatically creates backups, but you can also:

```bash
# Manual backup
cp $TETRA_DIR/org/pixeljam-arcade/tetra.toml \
   $TETRA_DIR/org/pixeljam-arcade/backups/tetra.toml.manual.$(date +%Y%m%d_%H%M%S)
```

### 3. Validate After Compilation

```bash
# Always validate after compile
bash/org/compiler.sh compile pixeljam-arcade
bash/org/compiler.sh validate pixeljam-arcade
```

### 4. Use Descriptive Resource Names

**Good:**
```toml
[resources.nginx_ssl_config]
[resources.prod_db_backup]
[resources.game_assets_cdn]
```

**Bad:**
```toml
[resources.config1]
[resources.file2]
[resources.stuff]
```

### 5. Document Custom Ports

```toml
[_config]
# ... in resources.toml or mapping.json

[ports]
tetra = 4444      # Tetra core service
devpages = 4000   # Documentation server
arcade = 8400     # Game API
pbase = 2600      # Database admin
```

### 6. Separate Environments in Resources

```toml
# Development - relaxed security
[resources.dev_env]
permissions = "644"
backup = false

# Production - strict security
[resources.prod_env]
permissions = "600"
backup = true
required = true
post_sync = "sudo systemctl restart app"
```

---

## Troubleshooting

### Compilation Fails: Missing Files

**Error:**
```
❌ Missing: digitalocean.json
❌ Missing: mapping.json
```

**Solution:**
```bash
# Run discovery first
bash/org/discovery.sh discover \
  path/to/digitalocean.json \
  pixeljam-arcade
```

### Secrets Validation Fails

**Error:**
```
⚠️  Found 5 empty secrets:
  - DB_PASSWORD
  - API_KEY
  ...
```

**Solution:**
```bash
# Edit and fill in secrets
$EDITOR $TETRA_DIR/org/pixeljam-arcade/secrets.env

# Validate
bash/org/secrets_manager.sh validate pixeljam-arcade
```

### Permission Errors

**Error:**
```
⚠️  secrets.env has insecure permissions: 644
```

**Solution:**
Compiler automatically fixes this, but you can also:
```bash
chmod 600 $TETRA_DIR/org/pixeljam-arcade/secrets.env
```

### Unresolved Variables in Output

**Error:**
```
⚠️  Found unresolved variables:
  ${DATABASE_URL}
  ${REDIS_PASSWORD}
```

**Solution:**
These variables exist in tetra.toml but weren't found in secrets.env:

```bash
# Add missing variables to secrets.env
echo "DATABASE_URL=postgres://..." >> secrets.env
echo "REDIS_PASSWORD=secret123" >> secrets.env

# Recompile
bash/org/compiler.sh quick pixeljam-arcade
```

### Git Accidentally Committed Secrets

**If you committed `secrets.env` or `tetra.toml`:**

```bash
# DO NOT just delete and recommit - history still has secrets!
# You must rewrite history

# Remove from history
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch org/*/secrets.env org/*/tetra.toml" \
  --prune-empty --tag-name-filter cat -- --all

# Force push (DESTRUCTIVE - coordinate with team!)
git push origin --force --all

# Rotate all secrets (they were exposed!)
# Update secrets.env with new credentials
```

---

## Appendix A: File Format Reference

### digitalocean.json Schema

```json
{
  "type": "array",
  "items": {
    "oneOf": [
      {
        "Droplets": [/* droplet objects */]
      },
      {
        "Domains": [/* domain objects */]
      },
      {
        "FloatingIPs": [/* floating IP objects */]
      },
      {
        "Volumes": [/* volume objects */]
      }
    ]
  }
}
```

### mapping.json Schema

```json
{
  "org_name": "string",
  "discovered_at": "ISO 8601 timestamp",
  "source": "path to digitalocean.json",
  "environments": {
    "<env_name>": {
      "type": "localhost | remote",
      "address": "IP address",
      "droplet_id": "number (if remote)",
      "droplet_name": "string (if remote)",
      "private_ip": "string (optional)",
      "floating_ip": "string (optional)",
      "domain": "string (optional)",
      "auth_user": "string (default: root)",
      "work_user": "string (default: env_name)"
    }
  },
  "ports": {
    "<service_name>": "port_number"
  }
}
```

### resources.toml Schema

See `bash/org/resources.example.toml` for annotated example.

---

## Appendix B: Command Reference

### Compiler Commands

```bash
# Full compilation
bash/org/compiler.sh compile <org_name> [--force]

# Quick recompile
bash/org/compiler.sh quick <org_name>

# Validate output
bash/org/compiler.sh validate <org_name>
```

### Refresh Commands

```bash
# Full refresh
bash/org/refresh.sh refresh <org_name> [json_source] [--rediscover]

# Quick refresh
bash/org/refresh.sh quick <org_name>

# Check status
bash/org/refresh.sh status <org_name>
```

### Secrets Commands

```bash
# Initialize
bash/org/secrets_manager.sh init <org_name> [--force]

# Validate
bash/org/secrets_manager.sh validate <org_name>

# List (keys only, no values)
bash/org/secrets_manager.sh list <org_name>

# Load into environment
bash/org/secrets_manager.sh load <org_name> [environment]

# Copy between orgs
bash/org/secrets_manager.sh copy <source_org> <target_org>
```

### Discovery Commands

```bash
# Run discovery
bash/org/discovery.sh discover <json_file> <org_name> [output_mapping]
```

---

## Appendix C: Migration Guide

### From Manual TOML to Compiled System

**Current state:** Hand-maintained tetra.toml with embedded secrets

**Migration steps:**

1. **Extract secrets to secrets.env:**
   ```bash
   # Create secrets file
   bash/org/secrets_manager.sh init my-org

   # Extract values from old tetra.toml
   grep -E '(password|secret|key)' old_tetra.toml > secrets.env

   # Edit to proper format
   $EDITOR secrets.env
   ```

2. **Get infrastructure data:**
   ```bash
   # If you have NH data
   cp ~/nh/my-org/digocean.json org/my-org/

   # Or export fresh
   doctl export > org/my-org/digitalocean.json
   ```

3. **Run discovery:**
   ```bash
   bash/org/discovery.sh discover \
     org/my-org/digitalocean.json \
     my-org
   ```

4. **Create resources.toml:**
   ```bash
   cp bash/org/resources.example.toml org/my-org/resources.toml
   # Edit to match your needs
   ```

5. **Compile:**
   ```bash
   bash/org/compiler.sh compile my-org
   ```

6. **Validate:**
   ```bash
   diff old_tetra.toml org/my-org/tetra.toml
   # Check that all important sections match
   ```

---

## Revision History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2025-10-10 | Initial release |

---

**End of Document**
