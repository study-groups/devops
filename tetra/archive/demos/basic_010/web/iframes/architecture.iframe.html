<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architecture Overview</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #fff;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }

        .arch-container {
            max-width: 100%;
            margin: 0 auto;
        }

        .arch-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .arch-header h2 {
            color: #007AFF;
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .arch-diagram {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
            overflow-x: auto;
        }

        .layer {
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            background: white;
            border-left: 5px solid;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .layer.presentation { border-left-color: #007AFF; }
        .layer.business { border-left-color: #34C759; }
        .layer.framework { border-left-color: #FF9500; }
        .layer.data { border-left-color: #AF52DE; }

        .layer-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #495057;
        }

        .layer-description {
            color: #6c757d;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .layer-modules {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .module-chip {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .module-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .module-chip.core { border-left: 3px solid #007AFF; }
        .module-chip.component { border-left: 3px solid #34C759; }
        .module-chip.test { border-left: 3px solid #FF9500; }
        .module-chip.framework { border-left: 3px solid #AF52DE; }

        .module-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }

        .module-stats {
            font-size: 12px;
            color: #6c757d;
        }

        .dependencies-section {
            margin-top: 40px;
        }

        .dependencies-title {
            font-size: 1.5em;
            color: #495057;
            margin-bottom: 20px;
            text-align: center;
        }

        .dependency-graph {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .dependency-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .dep-source {
            font-family: 'SF Mono', Monaco, monospace;
            font-weight: 600;
            color: #007AFF;
            min-width: 150px;
        }

        .dep-arrow {
            margin: 0 15px;
            color: #6c757d;
        }

        .dep-targets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .dep-target {
            background: #e9ecef;
            color: #495057;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .metrics-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .metric-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .metric-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
        }

        .metric-list {
            list-style: none;
            padding: 0;
        }

        .metric-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .metric-list li:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #495057;
        }

        .metric-value {
            font-weight: 600;
            color: #007AFF;
        }

        .data-flow {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .flow-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #495057;
        }

        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .flow-node {
            background: white;
            border: 2px solid #007AFF;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            min-width: 120px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .flow-arrow {
            font-size: 1.5em;
            color: #007AFF;
            margin: 0 10px;
        }

        .pattern-section {
            margin-top: 40px;
        }

        .pattern-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .pattern-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #007AFF;
            margin-bottom: 10px;
        }

        .pattern-description {
            color: #495057;
            margin-bottom: 15px;
        }

        .pattern-examples {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="arch-container">
        <div class="arch-header">
            <h2>System Architecture</h2>
            <p>Modular design patterns and component relationships</p>
        </div>

        <div class="arch-diagram">
            <div class="layer presentation">
                <div class="layer-title">Application Layer (bash/app/)</div>
                <div class="layer-description">
                    Core application entry points: demo.sh, input.sh, output.sh, repl.sh
                </div>
                <div class="layer-modules" id="presentationModules">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div class="layer business">
                <div class="layer-title">Utilities Layer (bash/utils/)</div>
                <div class="layer-description">
                    Shared utilities: enhanced_signatures.sh, nouns_verbs.sh, top_status.sh, and test runners
                </div>
                <div class="layer-modules" id="businessModules">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div class="layer framework">
                <div class="layer-title">Framework & TUI Layer (bash/modules/, bash/tui/)</div>
                <div class="layer-description">
                    Core framework (tetra_framework.sh, local_ast.sh) and TUI components (colors, display, events)
                </div>
                <div class="layer-modules" id="frameworkModules">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div class="layer data">
                <div class="layer-title">Testing & Debug Layer</div>
                <div class="layer-description">
                    Test suites, debugging tools, and development utilities
                </div>
                <div class="layer-modules" id="testModules">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <div class="data-flow">
            <div class="flow-title">Data Flow Architecture</div>
            <div class="flow-diagram">
                <div class="flow-node">User Input</div>
                <div class="flow-arrow">→</div>
                <div class="flow-node">Input Handler</div>
                <div class="flow-arrow">→</div>
                <div class="flow-node">Business Logic</div>
                <div class="flow-arrow">→</div>
                <div class="flow-node">Renderer</div>
                <div class="flow-arrow">→</div>
                <div class="flow-node">Display</div>
            </div>
        </div>

        <div class="dependencies-section">
            <h3 class="dependencies-title">Module Dependencies</h3>
            <div class="dependency-graph" id="dependencyGraph">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <div class="metrics-section">
            <div class="metric-card">
                <div class="metric-title">Module Metrics</div>
                <ul class="metric-list" id="moduleMetrics">
                    <li><span class="metric-label">Loading...</span></li>
                </ul>
            </div>

            <div class="metric-card">
                <div class="metric-title">Complexity Analysis</div>
                <ul class="metric-list" id="complexityMetrics">
                    <li><span class="metric-label">Loading...</span></li>
                </ul>
            </div>

            <div class="metric-card">
                <div class="metric-title">Quality Indicators</div>
                <ul class="metric-list" id="qualityMetrics">
                    <li><span class="metric-label">Loading...</span></li>
                </ul>
            </div>
        </div>

        <div class="pattern-section">
            <h3 class="dependencies-title">Design Patterns</h3>

            <div class="pattern-card">
                <div class="pattern-title">Layered Architecture</div>
                <div class="pattern-description">
                    Clear separation between data management, presentation logic, and user interaction layers.
                </div>
                <div class="pattern-examples">
Data Layer: nouns_verbs.sh, enhanced_signatures.sh
Presentation Layer: output.sh, top_status.sh
Interaction Layer: input.sh, repl.sh, demo.sh
                </div>
            </div>

            <div class="pattern-card">
                <div class="pattern-title">Pub-Sub Architecture</div>
                <div class="pattern-description">
                    Event-driven communication using publish-subscribe pattern for loose coupling.
                </div>
                <div class="pattern-examples">
# Framework provides pub-sub infrastructure
tetra_subscribe "state.changed" "update_handler"
tetra_publish "user.action" "data"
                </div>
            </div>

            <div class="pattern-card">
                <div class="pattern-title">Component System</div>
                <div class="pattern-description">
                    Reusable UI components with unified rendering across multiple targets.
                </div>
                <div class="pattern-examples">
# Same component, different targets
tetra_render_component "module_card" "$RENDER_TERMINAL"
tetra_render_component "module_card" "$RENDER_HTML"
                </div>
            </div>

            <div class="pattern-card">
                <div class="pattern-title">Strategy Pattern</div>
                <div class="pattern-description">
                    Different rendering strategies for terminal, HTML, and JSON output.
                </div>
                <div class="pattern-examples">
case "$render_target" in
    "$RENDER_TERMINAL") _render_terminal ;;
    "$RENDER_HTML") _render_html ;;
    "$RENDER_JSON") _render_json ;;
esac
                </div>
            </div>
        </div>
    </div>

    <script>
        class ArchitectureView {
            constructor() {
                this.moduleData = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.requestData();
            }

            setupEventListeners() {
                window.addEventListener('message', (event) => {
                    if (event.data.type === 'MODULE_DATA') {
                        this.moduleData = event.data.data;
                        this.renderArchitecture();
                    }
                });
            }

            requestData() {
                window.parent.postMessage({ type: 'REQUEST_DATA' }, '*');
            }

            renderArchitecture() {
                if (!this.moduleData) return;

                this.renderLayeredModules();
                this.renderDependencies();
                this.renderMetrics();
            }

            renderLayeredModules() {
                const modules = Object.entries(this.moduleData.modules);

                // Categorize modules by new bash directory structure
                const layers = {
                    presentation: modules.filter(([name, m]) =>
                        name.includes('bash/app/demo') || name.includes('bash/app/output') ||
                        name.includes('bash/utils/top_status') || m.type === 'component'),
                    business: modules.filter(([name, m]) =>
                        name.includes('bash/app/input') || name.includes('bash/app/repl') ||
                        name.includes('bash/utils/nouns_verbs') || m.type === 'core'),
                    framework: modules.filter(([name, m]) =>
                        name.includes('bash/modules/') || name.includes('bash/tui/') ||
                        m.type === 'framework' || name.includes('tetra_framework') || name.includes('local_ast')),
                    test: modules.filter(([_, m]) =>
                        m.type === 'test' || m.type === 'debug' || m.type === 'theme' || m.type === 'utility')
                };

                // Render each layer
                Object.entries(layers).forEach(([layerName, layerModules]) => {
                    const container = document.getElementById(`${layerName}Modules`);
                    if (container) {
                        container.innerHTML = layerModules.map(([name, module]) =>
                            this.createModuleChip(name, module)
                        ).join('');
                    }
                });
            }

            createModuleChip(name, module) {
                return `
                    <div class="module-chip ${module.type}" data-module="${name}">
                        <div class="module-name">${name}</div>
                        <div class="module-stats">
                            ${module.functions.length} functions, ${module.lines} lines
                        </div>
                    </div>
                `;
            }

            renderDependencies() {
                const modules = Object.entries(this.moduleData.modules);
                const dependencies = modules
                    .filter(([_, module]) => module.dependencies && module.dependencies.length > 0)
                    .map(([name, module]) => ({ name, deps: module.dependencies }));

                const dependencyHtml = dependencies.length > 0
                    ? dependencies.map(({ name, deps }) => `
                        <div class="dependency-item">
                            <div class="dep-source">${name}</div>
                            <div class="dep-arrow">→</div>
                            <div class="dep-targets">
                                ${deps.map(dep => `<span class="dep-target">${dep}</span>`).join('')}
                            </div>
                        </div>
                    `).join('')
                    : '<p style="text-align: center; color: #6c757d; font-style: italic;">No explicit dependencies found in module metadata.</p>';

                document.getElementById('dependencyGraph').innerHTML = dependencyHtml;
            }

            renderMetrics() {
                const modules = Object.values(this.moduleData.modules);

                // Module metrics
                const totalModules = modules.length;
                const totalFunctions = modules.reduce((sum, m) => sum + m.functions.length, 0);
                const totalLines = modules.reduce((sum, m) => sum + m.lines, 0);
                const avgFunctionsPerModule = Math.round(totalFunctions / totalModules);

                document.getElementById('moduleMetrics').innerHTML = `
                    <li><span class="metric-label">Total Modules</span><span class="metric-value">${totalModules}</span></li>
                    <li><span class="metric-label">Total Functions</span><span class="metric-value">${totalFunctions}</span></li>
                    <li><span class="metric-label">Total Lines</span><span class="metric-value">${totalLines.toLocaleString()}</span></li>
                    <li><span class="metric-label">Avg Functions/Module</span><span class="metric-value">${avgFunctionsPerModule}</span></li>
                `;

                // Complexity metrics
                const complexityDistribution = this.getComplexityDistribution(modules);
                const avgComplexity = this.calculateAvgComplexity(modules);

                document.getElementById('complexityMetrics').innerHTML = `
                    <li><span class="metric-label">Low Complexity</span><span class="metric-value">${complexityDistribution.low}</span></li>
                    <li><span class="metric-label">Medium Complexity</span><span class="metric-value">${complexityDistribution.medium}</span></li>
                    <li><span class="metric-label">High Complexity</span><span class="metric-value">${complexityDistribution.high}</span></li>
                    <li><span class="metric-label">Average Complexity</span><span class="metric-value">${avgComplexity}</span></li>
                `;

                // Quality metrics
                const tviewIntegrated = modules.filter(m => m.tview_integration).length;
                const testCoverage = Math.round(
                    (modules.filter(m => m.type === 'test').length /
                     modules.filter(m => m.type === 'core').length) * 100
                );
                const codeQuality = this.calculateOverallQuality(modules);

                document.getElementById('qualityMetrics').innerHTML = `
                    <li><span class="metric-label">TView Integration</span><span class="metric-value">${tviewIntegrated}/${totalModules}</span></li>
                    <li><span class="metric-label">Test Coverage</span><span class="metric-value">${testCoverage}%</span></li>
                    <li><span class="metric-label">Code Quality</span><span class="metric-value">${codeQuality}%</span></li>
                    <li><span class="metric-label">Maintainability</span><span class="metric-value">High</span></li>
                `;
            }

            getComplexityDistribution(modules) {
                return modules.reduce((dist, module) => {
                    const complexity = module.complexity || 'medium';
                    dist[complexity] = (dist[complexity] || 0) + 1;
                    return dist;
                }, { low: 0, medium: 0, high: 0 });
            }

            calculateAvgComplexity(modules) {
                const complexityMap = { low: 1, medium: 2, high: 3 };
                const total = modules.reduce((sum, m) => sum + (complexityMap[m.complexity] || 2), 0);
                const avg = total / modules.length;

                if (avg <= 1.3) return 'Low';
                if (avg <= 2.3) return 'Medium';
                return 'High';
            }

            calculateOverallQuality(modules) {
                // Simple quality heuristic based on various factors
                let score = 70; // Base score

                const avgFunctionRatio = modules.reduce((sum, m) =>
                    sum + (m.functions.length / Math.max(m.lines, 1)), 0) / modules.length;

                if (avgFunctionRatio > 0.05) score += 10;
                else if (avgFunctionRatio > 0.02) score += 5;

                const lowComplexityRatio =
                    modules.filter(m => m.complexity === 'low').length / modules.length;
                score += lowComplexityRatio * 20;

                return Math.min(Math.max(Math.round(score), 0), 100);
            }
        }

        // Initialize the architecture view
        new ArchitectureView();
    </script>
</body>
</html>