# Actions and Message Handling in Tubes

**Document**: `docs/tea/002.md`  
**Purpose**: Deep dive into Tubes' Redux-like action/message system

---

## Message-Driven Architecture

In Tubes, every state change is triggered by a **message** (analogous to Redux actions). All messages implement the `tea.Msg` interface, creating a type-safe action system.

## Message Types (Actions)

### 1. Built-in Bubbletea Messages

#### `tea.KeyMsg`
```go
// User input actions
case tea.KeyMsg:
    if msg.Type == tea.KeyCtrlC {
        return m, tea.Quit  // QUIT action
    }
    if msg.Type == tea.KeyTab {
        m.cyclePanes()      // CYCLE_PANES action  
    }
```

#### `tea.WindowSizeMsg` 
```go
// Layout actions
case tea.WindowSizeMsg:
    m.width, m.height = msg.Width, msg.Height  // RESIZE action
```

### 2. Custom Tubes Messages

#### `autoCompleteMsg`
```go
type autoCompleteMsg struct {
    time time.Time
}

// Async autocomplete updates
case autoCompleteMsg:
    cmds = append(cmds, autoCompleteCmd())
```

#### Command Result Messages (Future)
```go
type commandResultMsg struct {
    command string
    result  string
    error   error
}
```

## Command System as Action Creators

Tubes' command system (`/help`, `/ui`, etc.) acts as **action creators**. Each command generates state changes:

### Command Execution Flow
```
/ui split 0.3 → parseCommand() → executeCommand() → Model state change
```

### Implementation
```go
// Location: internal/tui/commands.go:178
"/ui": {
    Executor: func(mm *Model, args []string) (string, error) {
        // Action creator logic
        switch args[0] {
        case "split":
            mm.col1Ratio = ratio  // Direct state mutation (Redux anti-pattern!)
            return fmt.Sprintf("Split set to %.1f", ratio), nil
        }
    },
}
```

## Redux Pattern Violations & Improvements

### Current Issues

#### 1. Direct State Mutation
```go
// ❌ Anti-pattern: Direct mutation
mm.col1Ratio = ratio
```

#### 2. Mixed Concerns
Command executors both compute actions AND mutate state.

### Redux-Compliant Approach

#### Action Creators
```go
type UIAction struct {
    Type  string
    Ratio float64
}

func SetSplitRatio(ratio float64) UIAction {
    return UIAction{Type: "SET_SPLIT_RATIO", Ratio: ratio}
}
```

#### Pure Reducer
```go
func uiReducer(state UIState, action UIAction) UIState {
    switch action.Type {
    case "SET_SPLIT_RATIO":
        return UIState{...state, Col1Ratio: action.Ratio}
    }
    return state
}
```

## Message Patterns

### 1. Synchronous Messages
Direct state updates within `Update()`:
```go
case tea.KeyMsg:
    m.activePane = nextPane  // Immediate state change
    return m, nil
```

### 2. Asynchronous Messages  
Commands that trigger future messages:
```go
case tea.KeyMsg:
    return m, fetchDataCmd()  // Returns command
    
// Later...
case dataFetchedMsg:
    m.data = msg.data  // Process async result
```

### 3. Batch Messages
Multiple state changes atomically:
```go
return m, tea.Batch(
    saveStateCmd(),
    refreshUICmd(), 
    logEventCmd(),
)
```

## Best Practices

### ✅ Type-Safe Messages
```go
type UIMsg interface {
    tea.Msg
    UIMessageType() string
}

type SplitRatioMsg struct {
    Ratio float64
}
func (s SplitRatioMsg) UIMessageType() string { return "SPLIT_RATIO" }
```

### ✅ Message Validation
```go
func (m *Model) validateMessage(msg tea.Msg) error {
    // Validate message structure/data
    return nil
}
```

### ✅ Message Logging  
```go
func (m *Model) logMessage(msg tea.Msg) {
    log.Printf("Processing: %T %+v", msg, msg)
}
```

## Command-to-Message Translation

Current Tubes commands could be converted to messages:

| Command | Redux Message |
|---------|---------------|
| `/ui split 0.3` | `{type: "SET_SPLIT_RATIO", ratio: 0.3}` |
| `/mode self` | `{type: "CHANGE_MODE", mode: "self"}` |
| `/open file.go` | `{type: "SELECT_FILE", path: "file.go"}` |
| `/quit` | `{type: "QUIT"}` |

This would make the state flow more explicit and debuggable.

---

**Previous**: [001.md - Redux Pattern Overview](./001.md)  
**Next**: [003.md - State Management Patterns](./003.md)