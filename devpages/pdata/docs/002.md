# PData: A Technical Narrative

## Overview

**PData** is a secure, multi-tenant file management and user authentication system designed for Node.js applications. It provides a comprehensive abstraction layer over the filesystem, implementing role-based access control, path sandboxing, and user directory management within a unified API surface.

## Architectural Philosophy

PData follows a **layered orchestration pattern** with clear separation of concerns. The system is built around three core principles:

1. **Security by Design**: Every file operation is mediated through permission checks and path validation
2. **User Isolation**: Each user operates within their own sandboxed directory space
3. **Administrative Flexibility**: Admin users can access the entire content hierarchy while regular users are restricted to their designated areas

## Core Architecture

### The Orchestration Layer: `PData`

The main `PData` class serves as an orchestration layer that coordinates between specialized managers. It implements the **Facade pattern**, providing a simplified interface while delegating complex operations to focused subsystems:

```javascript
class PData {
    constructor(config) {
        this._validateConfig();      // Environment validation
        this._initializePaths();     // Directory structure setup  
        this._initializeManagers();  // Subsystem coordination
    }
}
```

The orchestrator maintains backward compatibility while internally distributing responsibilities to:

### User Management Subsystem: `UserManager`

The `UserManager` handles all aspects of user lifecycle and authentication:

- **Credential Storage**: CSV-based persistence for users and roles
- **Password Security**: PBKDF2-SHA512 hashing with per-user salts
- **Role Management**: Support for hierarchical roles (`admin`, `user`, `project`, `guest`, `dev`)
- **Session Integration**: Seamless integration with Passport.js authentication

The user data model is deliberately simple yet secure:
```csv
username,salt,hash
testuser,a1b2c3...,9f8e7d...
```

### File Management Subsystem: `FileManager`

The `FileManager` provides secure file operations with automatic permission enforcement:

- **Path Resolution**: Integration with `PathManager` for secure path handling
- **Directory Lifecycle**: Smart creation of user directories only when needed
- **Permission Gates**: Every operation validates user permissions before execution
- **Symlink Support**: Safe symlink traversal with permission inheritance

### Path Security: `PathManager`

The `PathManager` implements the security model through sophisticated path resolution:

#### User Path Resolution Algorithm

1. **Admin Users**: Full filesystem access relative to content root (`$PD_DIR/data`)
2. **Regular Users**: Restricted to user-specific directories:
   - Primary: `$PD_DIR/data/users/<username>`
   - Alternative: `$PD_DIR/data/projects/<username>` (for project users)
3. **Special Paths**: Controlled access to shared resources like uploads

#### Security Boundaries

The system implements multiple security layers:

```javascript
// Path traversal prevention
const resolvedPath = path.resolve(userPath);
if (!resolvedPath.startsWith(allowedRoot)) {
    throw new Error('Security Violation: Path escape attempt');
}
```

## Directory Structure Convention

PData enforces a specific directory hierarchy:

```
$PD_DIR/                    # Root data directory
├── data/                   # Content root
│   ├── users/             # User-specific directories
│   │   └── <username>/    # Individual user space
│   ├── projects/          # Project-specific directories
│   │   └── <project>/     # Project workspace
│   └── uploads/           # Shared upload area
├── uploads/               # File upload staging
├── db/                    # Database/metadata storage
├── users.csv              # User credentials
└── roles.csv              # Role assignments
```

## Permission Model

### Role Hierarchy

PData implements a role-based access control system:

- **`admin`**: Full system access, can read/write anywhere in content root
- **`user`**: Restricted to personal directory and shared spaces
- **`project`**: Enhanced access for project-specific workflows
- **`guest`**: Limited read-only access
- **`dev`**: Development-specific permissions

### Operation-Level Permissions

Each file operation is validated through the permission matrix:

```javascript
async can(username, action, resourcePath) {
    // Check user roles
    // Validate path boundaries  
    // Assess operation type (read/write/delete/list)
    // Return permission decision
}
```

## API Design Patterns

### Method Signatures

PData follows consistent method signatures across all operations:

```javascript
// Pattern: async method(username, relativePath, ...params)
await pdata.readFile(username, 'documents/notes.md');
await pdata.writeFile(username, 'documents/draft.md', content);
await pdata.listDirectory(username, 'projects');
```

### Error Handling Strategy

The system implements descriptive error messages with security considerations:

- **Permission Denied**: Clear indication without revealing system structure
- **Path Validation**: Prevents information disclosure through path probing
- **User Feedback**: Meaningful errors for legitimate operations

### Response Patterns

File operations return consistent response structures:

```javascript
// Directory listing
{ dirs: ['folder1', 'folder2'], files: ['file1.md'], exists: true }

// File operations  
true | Error  // Simple success/failure for write/delete operations
```

## Integration Patterns

### Express.js Middleware Integration

PData integrates seamlessly with Express applications:

```javascript
app.use((req, res, next) => {
    req.pdata = pdataInstance;  // Attach PData instance
    next();
});

// Route handlers can then use req.pdata
await req.pdata.listDirectory(req.user.username, path);
```

### Session Management

The system works with standard session libraries:

```javascript
// Passport.js integration
passport.serializeUser((user, done) => {
    done(null, user.username);
});

passport.deserializeUser(async (username, done) => {
    const roles = pdata.getUserRoles(username);
    done(null, { username, roles });
});
```

## Symlink and Advanced Features

### Symlink Security Model

PData supports symlinks with inherited permission checking:

1. **Target Resolution**: Symlinks are resolved to their ultimate targets
2. **Permission Inheritance**: Operations on symlinks check permissions on target files
3. **Cross-User Protection**: Users cannot access other users' files through symlinks unless explicitly permitted

### Upload Management

The system provides secure file upload handling:

- **Staging Area**: Files are initially placed in temporary upload directories
- **Atomic Operations**: File moves are atomic to prevent corruption
- **Permission Integration**: Uploaded files respect user directory permissions

## Performance Considerations

### Caching Strategy

- **Path Resolution Cache**: Frequently accessed paths are cached for performance
- **Permission Cache**: Role-based permissions are memoized per request cycle
- **Directory Existence**: Smart caching of directory existence checks

### Scalability Design

- **Stateless Operations**: All file operations are stateless and thread-safe
- **Lazy Loading**: User directories are created only when needed
- **Efficient Validation**: Path validation uses optimized string operations

## Configuration and Environment

### Environment Variables

PData requires specific environment configuration:

```bash
PD_DIR=/absolute/path/to/data/root     # Required: Data root directory
DB_ROOT=/path/to/database              # Optional: Database location
```

### Validation Strategy

The system performs comprehensive startup validation:

- **Path Verification**: Ensures all required paths exist and are accessible
- **Permission Testing**: Validates read/write permissions on data directories
- **Configuration Consistency**: Checks for conflicting or invalid settings

## Testing and Quality Assurance

### Test Architecture

PData includes a comprehensive test suite:

- **Unit Tests**: Individual component testing with mocked dependencies
- **Integration Tests**: Full API testing with temporary filesystem
- **Security Tests**: Permission boundary testing and attack simulation
- **Regression Tests**: Automated validation of core functionality

### Coverage Areas

The test suite validates:

- Authentication flows and session management
- File operation security and permissions
- Directory creation and management
- Symlink handling and security
- Admin vs. user permission boundaries
- Error handling and edge cases

## Conclusion

PData represents a mature approach to secure, multi-tenant file management in Node.js applications. Through its layered architecture, comprehensive security model, and extensive testing, it provides developers with a robust foundation for building applications that require secure file operations and user management.

The system's design prioritizes security without sacrificing usability, making it suitable for applications ranging from simple document management to complex multi-tenant platforms.