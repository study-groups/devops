<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=1">
    <meta name="app-version" content="v0.13m1">
    <title>DevPages</title>
    <link rel="icon" type="image/x-icon" href="/client/favicon.ico">

    <!-- CRITICAL: Synchronous theme initialization MUST run BEFORE CSS loads -->
    <!-- This ensures CSS variables are set before CSS bundles parse -->
    <script src="/client/services/ThemeInitializer.js"></script>

    <!-- All CSS is now loaded via bundles. Preloads are no longer necessary. -->

    <!-- CSS Loading Strategy: Bundled for Performance -->
    <!-- Core Bundle: Critical foundation styles (load immediately) -->
    <link rel="stylesheet" href="/css/bundles/core.bundle.css?v=3" data-scope="editor">

    <!-- Layout Bundle: Critical workspace layout (load immediately) -->
    <link rel="stylesheet" href="/css/bundles/layout.bundle.css?v=3" data-scope="editor">

    <!-- Features Bundle: Major features (load async) -->
    <link rel="stylesheet" href="/css/bundles/features.bundle.css?v=3" media="print" onload="this.media='all'" data-scope="editor">

    <!-- Panels Bundle: Panel-specific styles (load immediately) -->
    <link rel="stylesheet" href="/css/bundles/panels.bundle.css?v=4" data-scope="editor">

    <!-- Design Tokens Panel CSS (fallback) -->
    <link rel="stylesheet" href="/client/styles/design-tokens-panel.css" data-scope="editor">

    <!-- Theme Management Panel CSS -->
    <link rel="stylesheet" href="/client/styles/theme-management-panel.css" data-scope="editor">

    <!-- Log CSS -->
    <link rel="stylesheet" href="/client/log/log-display.css" data-scope="editor">
    
    
    <!-- Introspection System: Load for debugging and development -->
    <script type="module" src="/client/utils/IntrospectionBootstrap.js"></script>
    
    <!-- Fallback for browsers that don't support onload -->
    <noscript>
        <link rel="stylesheet" href="/css/bundles/core.bundle.css">
        <link rel="stylesheet" href="/css/bundles/layout.bundle.css">
        <link rel="stylesheet" href="/css/bundles/features.bundle.css">
        <link rel="stylesheet" href="/css/bundles/panels.bundle.css">
    </noscript>

    <script src="/client/errorTracker.js"></script>

    <!-- Import Map for ES Module Resolution -->
    <script type="importmap">
    {
        "imports": {
            "@reduxjs/toolkit": "/node_modules/@reduxjs/toolkit/dist/redux-toolkit.browser.mjs?v=1",
            "@reduxjs/toolkit/query": "/node_modules/@reduxjs/toolkit/dist/query/rtk-query.browser.mjs",
            "@standard-schema/utils": "/node_modules/@standard-schema/utils/dist/index.js",
            "redux": "/node_modules/redux/dist/redux.browser.mjs",
            "redux-thunk": "/node_modules/redux-thunk/dist/redux-thunk.mjs",
            "immer": "/node_modules/immer/dist/immer.production.mjs",
            "reselect": "/node_modules/reselect/dist/reselect.browser.mjs",
            "/appState.js": "/client/appState.js",
            "/eventBus.js": "/client/eventBus.js",
            "/panels/": "/client/panels/",
            "/store/": "/client/store/",
            "/utils/": "/client/utils/",
            "/log/": "/client/log/",
            "/api/": "/client/api/",
            "/services/": "/client/services/",
            "/components/": "/client/components/",
            "/layout/": "/client/layout/",
            "/core/": "/client/core/"
        }
    }
    </script>
    
    <!-- Markdown-it Loader: Required for the preview panel -->
    <script>
        function initMarkdownIt() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = '/client/vendor/scripts/markdown-it.min.js';
                script.onload = () => {
                    window.APP.services = window.APP.services || {};
                    window.APP.services.markdownit = window.markdownit;
                    resolve();
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
    </script>
</head>
<body class="splash-active">
    <!-- Body theme class is set by ThemeInitializer.js in head -->
    <div id="devpages-splash">
        <div class="splash-content">
            <div class="splash-logo">DevPages</div>
            <div class="splash-version">v0.13m1</div>
        </div>
    </div>

    <nav class="top-bar top-bar-full">
        <div id="context-manager-container" class="nav-group context-selector"></div>
        <div id="view-controls-container" class="nav-group view-controls">
            <button id="sidebar-toggle" class="btn btn-ghost btn-sm" data-action="toggleSidebar" title="Toggle Sidebar"></button>
            <button id="edit-toggle" class="btn btn-ghost btn-sm" data-action="toggleEdit" title="Toggle Editor"></button>
            <button id="preview-toggle" class="btn btn-ghost btn-sm" data-action="togglePreview" title="Toggle Preview"></button>
            <button id="log-toggle-btn" class="btn btn-ghost btn-sm" data-action="toggleLogVisibility" title="Toggle Log"></button>
            <button id="refresh-btn" class="btn btn-ghost btn-sm" data-action="refreshPreview" title="Refresh Preview"></button>
        </div>
        <div class="nav-group right-group">
            <button id="save-btn" class="btn btn-sm" data-action="saveFile" title="Save File (Ctrl+S)" disabled>Save</button>
            <div id="auth-component-container" class="auth-info"></div>
        </div>
    </nav>

    <!-- Main Workspace -->
    <div class="workspace-container">
        <!-- Sidebar (Left) -->
        <div id="workspace-sidebar" class="workspace-sidebar"></div>

        <!-- Resizer -->
        <div class="resizer" data-resizer-for="sidebar"></div>

        <!-- Editor (Center) -->
        <div id="workspace-editor" class="workspace-editor"></div>

        <!-- Resizer -->
        <div class="resizer" data-resizer-for="preview"></div>

        <!-- Preview (Right) -->
        <div id="workspace-preview" class="workspace-preview"></div>
    </div>

    <!-- Log/Terminal (Bottom) -->
    <!-- Default: log-visible to match Redux default logVisible: true -->
    <div id="log-container" class="log-visible"></div>

    <!-- Tetra Analytics -->
    <script src="/tetra/tetra.js"></script>
    <script>
        // Initialize Tetra client tracking
        if (window.TetraClientTracker) {
            // Load saved preferences from localStorage
            const savedPrefs = (() => {
                try {
                    const saved = localStorage.getItem('tetraPreferences');
                    const parsed = saved ? JSON.parse(saved) : {};
                    console.log('[Tetra] Loaded preferences from localStorage:', parsed);
                    return parsed;
                } catch (error) {
                    console.error('[Tetra] Failed to load preferences:', error);
                    return {};
                }
            })();

            // Merge saved preferences with defaults
            const tetraConfig = {
                environment: 'development',
                enableConsoleLogging: savedPrefs.enableConsoleLogging !== undefined ? savedPrefs.enableConsoleLogging : true,
                enableAnalytics: savedPrefs.enableAnalytics !== undefined ? savedPrefs.enableAnalytics : true,
                enablePerformanceTracking: savedPrefs.enablePerformanceTracking !== undefined ? savedPrefs.enablePerformanceTracking : true,
                enableMouseTracking: savedPrefs.enableMouseTracking !== undefined ? savedPrefs.enableMouseTracking : false,
                logSearchQueries: false, // Don't log sensitive search data
                includeEventsInFlush: false // Keep logs clean
            };
            console.log('[Tetra] Initializing with config:', tetraConfig);
            window.tetra = new TetraClientTracker(tetraConfig);

            // Track feature usage
            document.addEventListener('DOMContentLoaded', function() {
                // Track major UI interactions
                document.addEventListener('click', function(e) {
                    const button = e.target.closest('button');
                    const link = e.target.closest('a');

                    if (button && button.id) {
                        tetra.trackFeatureUse(`button_${button.id}`);
                    }

                    if (link && link.href) {
                        tetra.trackFeatureUse('link_click', {
                            href: link.href,
                            text: link.textContent?.substring(0, 50)
                        });
                    }
                });

                // Track panel interactions
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            const target = mutation.target;
                            if (target.classList.contains('panel-active') && target.id) {
                                tetra.trackFeatureUse(`panel_${target.id}`, {
                                    action: 'activated'
                                });
                            }
                        }
                    });
                });

                observer.observe(document.body, {
                    attributes: true,
                    subtree: true,
                    attributeFilter: ['class']
                });

                // Track search when available
                const searchInput = document.querySelector('input[type="search"], .search-input');
                if (searchInput) {
                    searchInput.addEventListener('input', function(e) {
                        if (e.target.value.length >= 3) {
                            tetra.trackSearch('[search_query]', 0, false);
                        }
                    });
                }
            });

            console.log('Tetra client tracking initialized');
        }
    </script>

    <script type="module" src="/client/index.js"></script>
</body>
</html>
