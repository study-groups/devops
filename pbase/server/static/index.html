<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PBase - Game API Dashboard</title>
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/console.css">
</head>
<body>
    <header>
        <h1>PBase</h1>
        <nav>
            <button class="tab-btn active" data-tab="games">Workspace</button>
            <button class="tab-btn" data-tab="s3">S3 Browser</button>
            <button class="tab-btn" data-tab="settings">Settings</button>
        </nav>
        <div class="workspace-controls">
            <label for="org-select">Org:</label>
            <select id="org-select"></select>
            <button id="refresh-games" class="icon-btn" title="Refresh">↻</button>
            <button id="console-toggle" class="console-toggle-btn" title="Toggle Console">
                <span>Console</span>
            </button>
        </div>
        <div class="auth-status">
            <span id="user-display">anonymous</span>
            <button id="auth-btn">Login</button>
        </div>
    </header>

    <main>
        <!-- Games/Workspace Tab -->
        <section id="games-tab" class="tab-content active">
            <!-- Console View -->
            <div id="console-view"></div>

            <!-- Cards View -->
            <div id="games-cards-view">
                <div id="workspace-info" class="info-bar"></div>
                <div id="games-list" class="card-grid"></div>
            </div>

            <!-- Detail View -->
            <div id="game-detail-view" class="hidden">
                <div class="detail-toolbar">
                    <button class="back-btn" id="game-back-btn">← Back</button>
                    <h2 id="game-detail-title">Game Details</h2>
                    <div class="detail-actions">
                        <button class="action-btn" id="game-launch-btn">Launch</button>
                        <button class="action-btn" id="game-console-btn">Console</button>
                        <button class="action-btn" id="game-refresh-btn">Refresh</button>
                        <button class="action-btn" id="game-compare-btn">Compare All</button>
                    </div>
                </div>
                <div class="detail-content">
                    <div class="detail-sidebar">
                        <section class="detail-section" id="game-meta">
                            <h4>Metadata</h4>
                            <dl></dl>
                        </section>
                        <section class="detail-section" id="game-access">
                            <h4>Access Control</h4>
                            <dl></dl>
                        </section>
                        <section class="detail-section" id="game-paths">
                            <h4>Paths</h4>
                            <dl></dl>
                        </section>
                    </div>
                    <div class="detail-main">
                        <section class="detail-section" id="game-files">
                            <h4>Files <span class="file-source-label">(Local + S3)</span></h4>
                            <div class="file-table-container">
                                <table class="file-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Size</th>
                                            <th>Modified</th>
                                            <th>Sync</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </section>
                        <div id="game-file-viewer" class="file-viewer-pane">
                            <div class="file-viewer-header">
                                <span class="file-viewer-title"></span>
                                <div class="file-viewer-actions">
                                    <button class="edit-btn" title="Edit file">Edit</button>
                                    <button class="save-btn" title="Save changes">Save</button>
                                    <button class="cancel-btn" title="Cancel editing">Cancel</button>
                                    <button class="compare-btn" title="Compare with S3">Compare</button>
                                    <button class="close-viewer-btn" title="Close">×</button>
                                </div>
                            </div>
                            <div class="file-viewer-body">
                                <pre><code></code></pre>
                                <textarea class="file-editor"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- S3 Browser Tab -->
        <section id="s3-tab" class="tab-content">
            <div class="s3-tab-layout">
                <!-- Left: Manifest Manager -->
                <div class="manifest-manager">
                    <!-- Summary Section -->
                    <div class="manifest-section">
                        <div class="section-header">
                            <h3>Manifest Summary</h3>
                            <button id="refresh-manifest-btn" class="icon-btn" title="Refresh">↻</button>
                        </div>
                        <div id="manifest-summary" class="manifest-summary">
                            <div class="summary-loading">Loading...</div>
                        </div>
                    </div>

                    <!-- Game Editor Section -->
                    <div class="manifest-section game-editor-section">
                        <div class="section-header">
                            <h3>Game Editor</h3>
                        </div>
                        <div class="game-selector">
                            <select id="game-toml-select">
                                <option value="">Select a game...</option>
                            </select>
                        </div>
                        <form id="game-toml-form" class="game-toml-form">
                            <div class="form-row">
                                <label>Name <input type="text" name="name" placeholder="Game Name"></label>
                                <label>ID <input type="text" name="id" placeholder="slug"></label>
                            </div>
                            <div class="form-row">
                                <label>Summary <input type="text" name="summary" placeholder="Short description"></label>
                            </div>
                            <div class="form-row">
                                <label>Author <input type="text" name="author" placeholder="Author name"></label>
                                <label>Version <input type="text" name="version" placeholder="1.0.0"></label>
                            </div>
                            <div class="form-row">
                                <label>Entry <input type="text" name="entry" placeholder="index.html"></label>
                                <label>Thumbnail <input type="text" name="thumbnail" placeholder="thumb.png"></label>
                            </div>
                            <div class="form-row">
                                <label>Tags <input type="text" name="tags" placeholder="arcade, puzzle"></label>
                            </div>
                            <div class="form-row">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="requires_auth">
                                    Requires Auth
                                </label>
                                <label>Min Role
                                    <select name="min_role">
                                        <option value="guest">guest</option>
                                        <option value="user">user</option>
                                        <option value="dev">dev</option>
                                        <option value="admin">admin</option>
                                    </select>
                                </label>
                            </div>
                            <div class="form-actions">
                                <button type="button" id="save-game-toml-btn" class="primary-btn" disabled>Save game.toml</button>
                            </div>
                        </form>
                    </div>

                    <!-- Aggregate Section -->
                    <div class="manifest-section aggregate-section">
                        <div class="section-header">
                            <h3>Build Manifest</h3>
                        </div>
                        <p class="section-desc">Generate games.json from all game.toml files</p>
                        <div class="aggregate-actions">
                            <button id="preview-manifest-btn" class="action-btn">Preview games.json</button>
                            <button id="commit-manifest-btn" class="action-btn primary" disabled>Commit to S3</button>
                        </div>
                        <div id="manifest-preview" class="manifest-preview"></div>
                    </div>
                </div>

                <!-- Right: File Browser -->
                <div class="s3-file-browser">
                    <div class="browser-header">
                        <h3>S3 Files</h3>
                        <div class="breadcrumb" id="s3-breadcrumb">
                            <button class="crumb" data-prefix="">root</button>
                        </div>
                    </div>
                    <div class="s3-browser-container">
                        <div id="s3-list" class="file-list"></div>
                        <div id="s3-content" class="s3-content-pane">
                            <div id="s3-content-header" class="s3-content-header"></div>
                            <div id="s3-content-body" class="s3-content-body"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Settings Tab -->
        <section id="settings-tab" class="tab-content">
            <div class="settings-layout">
                <!-- Config Panel -->
                <div class="settings-panel" id="config-panel">
                    <div class="panel-header">
                        <h3>Server Config</h3>
                        <button id="refresh-config" class="icon-btn" title="Refresh">↻</button>
                    </div>
                    <div id="config-content" class="config-list">
                        <div class="config-section" id="config-service">
                            <h4>Service</h4>
                            <dl></dl>
                        </div>
                        <div class="config-section" id="config-paths">
                            <h4>Paths</h4>
                            <dl></dl>
                        </div>
                        <div class="config-section" id="config-s3">
                            <h4>S3 Storage</h4>
                            <dl></dl>
                        </div>
                        <div class="config-section" id="config-runtime">
                            <h4>Runtime</h4>
                            <dl></dl>
                        </div>
                    </div>
                </div>

                <!-- Users Panel -->
                <div class="settings-panel" id="users-panel">
                    <div class="panel-header">
                        <h3>Users</h3>
                        <button id="add-user-btn" class="icon-btn" title="Add User">+</button>
                    </div>
                    <div id="admin-content">
                        <table id="users-table">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Login Modal -->
    <dialog id="login-modal">
        <h3>Login</h3>
        <form id="login-form">
            <label>
                Username or Email
                <input type="text" name="identifier" required placeholder="admin or you@example.com" autocomplete="username">
            </label>
            <div id="password-field">
                <label>
                    Password
                    <input type="password" name="password" placeholder="Required for username login" autocomplete="current-password">
                </label>
            </div>
            <div class="login-help">
                <strong>Two ways to login:</strong>
                <ul>
                    <li><span class="method">Username + Password</span> - Enter your username and password</li>
                    <li><span class="method">Magic Email</span> - Enter email address, we'll send a login link</li>
                </ul>
            </div>
            <div id="login-status" class="login-status"></div>
            <div id="login-diagnostics" class="login-diagnostics"></div>
            <div class="form-actions">
                <button type="button" class="cancel">Cancel</button>
                <button type="submit" id="login-submit-btn">Login</button>
            </div>
        </form>
    </dialog>

    <!-- Add User Modal -->
    <dialog id="add-user-modal">
        <h3>Add User</h3>
        <form id="add-user-form" autocomplete="off">
            <label>
                Username
                <input type="text" name="username" required pattern="[a-zA-Z0-9_-]{3,32}" autocomplete="off">
            </label>
            <label>
                Password
                <input type="password" name="password" required minlength="8" autocomplete="new-password">
            </label>
            <label>
                Role
                <select name="role">
                    <option value="user">user</option>
                    <option value="dev">dev</option>
                    <option value="admin">admin</option>
                    <option value="guest">guest</option>
                </select>
            </label>
            <div class="form-actions">
                <button type="button" class="cancel">Cancel</button>
                <button type="submit">Create</button>
            </div>
        </form>
    </dialog>

    <script type="module" src="js/main.js"></script>
</body>
</html>
