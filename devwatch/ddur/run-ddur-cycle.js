#!/usr/bin/env node

/**
 * D2UR Cycle Runner
 * Executes Data-Driven UI Refinement cycles and generates comprehensive documentation
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

class D2URCycleRunner {
    constructor() {
        this.baseDir = __dirname;
        this.loopsDir = path.join(this.baseDir, 'loops');
        this.resultsDir = path.join(this.baseDir, 'results');
        this.ensureDirectories();
    }

    ensureDirectories() {
        [this.loopsDir, this.resultsDir].forEach(dir => {
            if (!fs.existsSync(dir)) {
                fs.mkdirSync(dir, { recursive: true });
            }
        });
    }

    async runCycle(testFile, options = {}) {
        const timestamp = new Date().toISOString();
        const cycleId = `D2UR-${Date.now()}`;
        
        console.log(`\nðŸ”„ Starting D2UR Cycle: ${cycleId}`);
        console.log(`ðŸ“… Timestamp: ${timestamp}`);
        console.log(`ðŸŽ¯ Test File: ${testFile}`);
        
        try {
            // Run Playwright test
            const command = `npx playwright test ${testFile} --reporter=json`;
            console.log(`\nðŸš€ Executing: ${command}`);
            
            const result = execSync(command, { 
                encoding: 'utf8',
                cwd: path.dirname(this.baseDir)
            });
            
            console.log('âœ… Test execution completed');
            
            // Generate summary report
            this.generateSummaryReport(cycleId, testFile, timestamp);
            
            return { success: true, cycleId };
            
        } catch (error) {
            console.error('âŒ Test execution failed:', error.message);
            
            // Still generate a report for failed cycles
            this.generateSummaryReport(cycleId, testFile, timestamp, error);
            
            return { success: false, cycleId, error: error.message };
        }
    }

    generateSummaryReport(cycleId, testFile, timestamp, error = null) {
        const summaryReport = {
            cycleId,
            timestamp,
            testFile,
            status: error ? 'FAILED' : 'COMPLETED',
            error: error ? error.message : null,
            artifacts: {
                loops: this.getLoopArtifacts(),
                results: this.getResultArtifacts(),
                screenshots: this.getScreenshotArtifacts()
            },
            metadata: {
                nodeVersion: process.version,
                platform: process.platform,
                cwd: process.cwd()
            }
        };

        const reportPath = path.join(this.resultsDir, `summary-${cycleId}.json`);
        fs.writeFileSync(reportPath, JSON.stringify(summaryReport, null, 2));
        
        console.log(`ðŸ“Š Summary report generated: ${reportPath}`);
        
        // Generate human-readable report
        this.generateHumanReadableReport(summaryReport);
    }

    generateHumanReadableReport(summaryReport) {
        const reportContent = `
# D2UR Cycle Report

**Cycle ID:** ${summaryReport.cycleId}
**Timestamp:** ${summaryReport.timestamp}
**Status:** ${summaryReport.status}
**Test File:** ${summaryReport.testFile}

## Execution Summary

${summaryReport.error ? `**Error:** ${summaryReport.error}` : '**Result:** Test completed successfully'}

## Artifacts Generated

### Loop Data
${summaryReport.artifacts.loops.map(file => `- ${file}`).join('\n')}

### Result Files
${summaryReport.artifacts.results.map(file => `- ${file}`).join('\n')}

### Screenshots
${summaryReport.artifacts.screenshots.map(file => `- ${file}`).join('\n')}

## Environment

- **Node Version:** ${summaryReport.metadata.nodeVersion}
- **Platform:** ${summaryReport.metadata.platform}
- **Working Directory:** ${summaryReport.metadata.cwd}

---
*Generated by D2UR Cycle Runner at ${new Date().toISOString()}*
`;

        const readableReportPath = path.join(this.resultsDir, `report-${summaryReport.cycleId}.md`);
        fs.writeFileSync(readableReportPath, reportContent);
        
        console.log(`ðŸ“ Human-readable report: ${readableReportPath}`);
    }

    getLoopArtifacts() {
        try {
            return fs.readdirSync(this.loopsDir).filter(file => 
                file.endsWith('.json') || file.endsWith('.png')
            );
        } catch {
            return [];
        }
    }

    getResultArtifacts() {
        try {
            return fs.readdirSync(this.resultsDir).filter(file => 
                file.endsWith('.json')
            );
        } catch {
            return [];
        }
    }

    getScreenshotArtifacts() {
        try {
            return fs.readdirSync(this.loopsDir).filter(file => 
                file.endsWith('.png')
            );
        } catch {
            return [];
        }
    }

    listPreviousCycles() {
        try {
            const summaryFiles = fs.readdirSync(this.resultsDir)
                .filter(file => file.startsWith('summary-'))
                .sort()
                .reverse();

            console.log('\nðŸ“š Previous D2UR Cycles:');
            summaryFiles.forEach(file => {
                const content = JSON.parse(fs.readFileSync(path.join(this.resultsDir, file), 'utf8'));
                console.log(`  ${content.cycleId} - ${content.status} - ${content.timestamp}`);
            });
        } catch {
            console.log('ðŸ“š No previous cycles found');
        }
    }
}

// CLI Interface
if (require.main === module) {
    const runner = new D2URCycleRunner();
    const args = process.argv.slice(2);
    
    if (args.length === 0) {
        console.log(`
ðŸ”„ D2UR Cycle Runner

Usage:
  node run-ddur-cycle.js <test-file>     Run a D2UR cycle
  node run-ddur-cycle.js --list          List previous cycles

Examples:
  node run-ddur-cycle.js magnifier-ddur-test.js
  node run-ddur-cycle.js --list
`);
        process.exit(1);
    }

    if (args[0] === '--list') {
        runner.listPreviousCycles();
    } else {
        const testFile = args[0];
        runner.runCycle(testFile)
            .then(result => {
                if (result.success) {
                    console.log(`\nâœ… D2UR Cycle completed successfully: ${result.cycleId}`);
                    process.exit(0);
                } else {
                    console.log(`\nâŒ D2UR Cycle failed: ${result.cycleId}`);
                    process.exit(1);
                }
            })
            .catch(error => {
                console.error('ðŸ’¥ Runner error:', error);
                process.exit(1);
            });
    }
}

module.exports = D2URCycleRunner;
