<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevWatch Dashboard</title>
    <link rel="stylesheet" href="/static/css/devwatch.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <link rel="stylesheet" href="/static/css/components/devwatch-info-panel.css">
    <script>
        // Initialize minimal APP namespace for compatibility
        window.APP = window.APP || { env: null };
    </script>
</head>
<body class="devwatch-pre-theme-load">
    <div class="container"> <!-- Restored the original "container" class -->
        <div id="dashboard-header" class="header" style="display: flex; justify-content: space-between; align-items: center; padding: 10px;">
            <div><h1 style="margin: 0; display: inline-block;">DevWatch</h1>
                        <span class="header-left">v1.0</span></div>

            <div class="header-right">
                <div id="user-info-display" class="user-info-display">
                    <span class="loading-user">Loading user...</span>
                </div>
            </div>
        </div>

        <!-- New Settings Panel -->
        <div id="dashboard-settings-panel" class="settings-panel">
            <div class="settings-panel-content">
                <h3>Dashboard Settings</h3>
                <p class="popup-description">Manage your dashboard layout. Changes are temporary until you click "Save".</p>

                <!-- App Picker -->
                <div class="app-picker">
                    <h4 class="app-picker-title">Add App</h4>
                    <div id="app-picker-list" class="app-picker-list">
                        <!-- Apps will be populated by JS -->
                    </div>
                </div>

                <div class="popup-actions">
                    <button id="reset-dashboard-btn" class="devwatch-button devwatch-button--ghost">Reset Layout</button>
                </div>
                <div class="popup-actions">
                    <button id="save-apps-btn" class="devwatch-button devwatch-button--primary">Save Changes</button>
                    <button id="revert-apps-btn" class="devwatch-button devwatch-button--ghost">Revert Changes</button>
                </div>
                <div id="auth-actions-container" style="margin-top: var(--devwatch-space-md);"></div>
            </div>
        </div>

        <div id="dynamic-sections" class="dynamic-sections">
            <!-- Iframers will be dynamically inserted here -->
        </div>
    </div>

    <!-- Floating quick open button for logs drawer -->
    <button id="logs-fab" class="logs-fab devwatch-button devwatch-button--primary" onclick="openLogsDrawer()" title="Open System Logs">Logs</button>

    <!-- Logs Drawer -->
    <div id="logs-drawer" class="logs-drawer" aria-hidden="true">
        <div id="logs-drawer-resizer" class="logs-drawer-resizer"></div>
        <div class="logs-drawer-toolbar">
            <div class="logs-drawer-title">System Logs</div>
            <div class="logs-drawer-actions">
                <button id="logs-drawer-close" class="btn-mini">Close</button>
            </div>
        </div>
        <iframe id="logs-drawer-iframe" class="logs-drawer-iframe" src="about:blank"></iframe>
    </div>
    
    <!-- The floating action button has been removed from here. -->

    <svg style="display: none;">
        <defs>
            <!-- Basic icons -->
            <g id="icon-check">
                <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="m9 12 2 2 4-4" fill="none" stroke="currentColor" stroke-width="2"/>
            </g>
            <g id="icon-x">
                <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="m15 9-6 6" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="m9 9 6 6" fill="none" stroke="currentColor" stroke-width="2"/>
            </g>
            <g id="icon-wrench">
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" fill="currentColor"/>
            </g>
            <g id="icon-git-branch">
                <line x1="6" y1="3" x2="6" y2="15" stroke="currentColor" stroke-width="2"/>
                <circle cx="18" cy="6" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
                <circle cx="6" cy="18" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
                <path d="m18 9a9 9 0 0 1-9 9" fill="none" stroke="currentColor" stroke-width="2"/>
            </g>
            <g id="icon-server">
                <rect width="20" height="8" x="2" y="2" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2"/>
                <rect width="20" height="8" x="2" y="14" rx="2" ry="2" fill="none" stroke="currentColor" stroke-width="2"/>
                <line x1="6" y1="6" x2="6.01" y2="6" stroke="currentColor" stroke-width="2"/>
                <line x1="6" y1="18" x2="6.01" y2="18" stroke="currentColor" stroke-width="2"/>
            </g>
        </defs>
    </svg>

    <!-- All scripts moved from <head> to the end of <body> -->
    <!-- <script src="/static/js/devwatch-namespace.js"></script> -->
    <script src="/static/js/theme-manager.js"></script>
    <!-- <script src="/static/js/notification-system.js"></script> -->
    <script src="/static/js/devwatch-iframer.js"></script>
    <script src="/static/js/logger.js"></script>
    <script src="/static/js/logs-drawer.js"></script>
    <script src="/static/js/devwatch-icon-picker.js"></script>
    <script src="/static/js/dashboard.js"></script> <!-- The new module -->

    <script>
    // User info management
    async function loadUserInfo() {
        const userDisplay = document.getElementById('user-info-display');
        
        try {
            const response = await fetch('/api/user');
            console.log('User fetch response:', response);
            
            if (response.ok) {
                const userInfo = await response.json();
                console.log('User info:', userInfo);
                displayUserInfo(userInfo);
            } else {
                const errorText = await response.text();
                console.error('User fetch error:', errorText);
                throw new Error('Failed to fetch user info');
            }
        } catch (error) {
            console.warn('Could not load user info:', error);
            userDisplay.innerHTML = `
                <button class="devwatch-button devwatch-button--ghost auth-toggle" id="auth-toggle-btn">
                    <span class="auth-icon-anon">üë§</span>
                    <span class="auth-label">anonymous</span>
                </button>
            `;
        }
    }

    function displayUserInfo(userInfo) {
        const userDisplay = document.getElementById('user-info-display');
        const authActionsContainer = document.getElementById('auth-actions-container');

        const isAuth = userInfo.isAuthenticated;
        const activeClass = isAuth ? 'is-active' : '';
        const userIcon = isAuth ? 'üîê' : 'üë§';
        const authLabel = isAuth ? userInfo.user : 'anonymous';

        userDisplay.innerHTML = `
            <button class="devwatch-button devwatch-button--ghost auth-toggle ${activeClass}" id="auth-toggle-btn" title="${isAuth ? 'Authenticated via basic auth' : 'Not authenticated'}">
                <span class="auth-icon">${userIcon}</span>
                <span class="auth-label">${authLabel}</span>
            </button>
        `;

        // Toggle button shows auth status panel
        const authToggle = document.getElementById('auth-toggle-btn');
        if (authToggle) {
            authToggle.addEventListener('click', () => {
                const settingsPanel = document.getElementById('dashboard-settings-panel');
                if (settingsPanel) {
                    settingsPanel.classList.toggle('is-open');
                }
            });
        }

        if (isAuth) {
            authActionsContainer.innerHTML = `
                <button id="logout-btn" class="devwatch-button devwatch-button--ghost full-width">Logout</button>
            `;
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
        } else {
            authActionsContainer.innerHTML = '';
        }
        
        console.log('[DASHBOARD] User info loaded:', userInfo);
    }

    function handleLogout() {
        if (confirm('Are you sure you want to logout?')) {
            // Clear any local storage/session data
            localStorage.clear();
            sessionStorage.clear();
            
            // Redirect to logout or login page
            // Since we're using basic auth, we can't really "logout" 
            // but we can redirect to a page that requires re-authentication
            window.location.href = '/logout';
        }
    }

    // A single, consolidated startup script.
    document.addEventListener('DOMContentLoaded', () => {
        // Load user info first
        loadUserInfo();
        
        if (window.DevWatchDashboard) {
            window.DevWatchDashboard.init();
        }
    });
    </script>

    <script>
        // Theme selector moved to system control panel
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Dashboard loaded - theme selector is now in system control panel');
        });
    </script>
</body>
</html>